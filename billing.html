<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Cake Bliss | Advanced Billing System</title>
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    />
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <style>
      /* ==================== BASE STYLES ==================== */
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
        -webkit-tap-highlight-color: transparent;
        -webkit-font-smoothing: antialiased;
      }

      :root {
        --primary: #ff7bac;
        --secondary: #ffb347;
        --accent: #9d4edd;
        --light: #fff9fb;
        --dark: #333333;
        --success: #4caf50;
        --warning: #ff9800;
        --danger: #f44336;
        --info: #2196f3;
        --safe-area-top: env(safe-area-inset-top);
        --safe-area-bottom: env(safe-area-inset-bottom);
      }

      html {
        font-size: 16px;
        -webkit-text-size-adjust: 100%;
      }

      body {
        background: linear-gradient(135deg, #ffecd2 0%, #fcb69f 100%);
        color: var(--dark);
        min-height: 100vh;
        padding: 10px;
        padding-top: calc(10px + var(--safe-area-top));
        padding-bottom: calc(10px + var(--safe-area-bottom));
      }

      .container {
        max-width: 1400px;
        margin: 0 auto;
        width: 100%;
      }

      /* ==================== TYPOGRAPHY ==================== */
      h1 {
        font-size: clamp(1.5rem, 4vw, 2rem);
      }
      h2 {
        font-size: clamp(1.3rem, 3.5vw, 1.8rem);
      }
      h3 {
        font-size: clamp(1.1rem, 3vw, 1.5rem);
      }
      h4 {
        font-size: clamp(0.9rem, 2.5vw, 1.2rem);
      }

      p,
      span,
      label {
        font-size: clamp(0.875rem, 2.5vw, 1rem);
      }

      /* ==================== HEADER ==================== */
      header {
        background-color: white;
        border-radius: 16px;
        padding: clamp(15px, 3vw, 25px) clamp(20px, 4vw, 40px);
        margin-bottom: clamp(15px, 3vw, 30px);
        box-shadow: 0 8px 20px rgba(0, 0, 0, 0.08);
        display: flex;
        flex-direction: column;
        gap: 15px;
      }

      .logo-container {
        display: flex;
        align-items: center;
        gap: 12px;
        flex-wrap: wrap;
      }

      .logo {
        width: clamp(50px, 10vw, 60px);
        height: clamp(50px, 10vw, 60px);
        background: linear-gradient(45deg, var(--primary), var(--secondary));
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-size: clamp(20px, 5vw, 28px);
        flex-shrink: 0;
      }

      .logo-text h1 {
        color: var(--primary);
        font-weight: 800;
        letter-spacing: 0.5px;
        line-height: 1.2;
      }

      .logo-text p {
        color: var(--dark);
        opacity: 0.8;
        margin-top: 4px;
      }

      nav {
        width: 100%;
        overflow-x: auto;
        -webkit-overflow-scrolling: touch;
        padding-bottom: 5px;
      }

      nav ul {
        display: flex;
        list-style: none;
        gap: clamp(10px, 2vw, 25px);
        min-width: min-content;
      }

      nav a {
        text-decoration: none;
        color: var(--dark);
        font-weight: 600;
        font-size: clamp(0.8rem, 2.5vw, 1rem);
        padding: 8px 15px;
        border-radius: 50px;
        transition: all 0.3s ease;
        white-space: nowrap;
        display: flex;
        align-items: center;
        gap: 8px;
      }

      nav a:hover,
      nav a.active {
        background-color: var(--primary);
        color: white;
      }

      /* ==================== MAIN CONTENT LAYOUT ==================== */
      .main-content {
        display: flex;
        gap: clamp(15px, 3vw, 30px);
        flex-wrap: wrap;
      }

      /* Mobile: Stack all cards */
      @media (max-width: 768px) {
        .main-content {
          flex-direction: column;
        }

        .billing-card,
        .product-catalog,
        .catalog-card,
        .recent-orders,
        .coupons-section .catalog-card {
          width: 100%;
          min-width: 100%;
        }
      }

      /* ==================== BILLING FORM ==================== */
      .billing-card {
        background-color: white;
        border-radius: 16px;
        padding: clamp(20px, 4vw, 35px);
        box-shadow: 0 8px 20px rgba(0, 0, 0, 0.08);
        flex: 2;
        min-width: 300px;
      }

      .form-subtitle {
        color: #666;
        margin-bottom: 20px;
        font-size: clamp(0.8rem, 2.5vw, 0.95rem);
      }

      .form-row {
        display: flex;
        flex-wrap: wrap;
        gap: clamp(10px, 2vw, 20px);
        margin-bottom: 20px;
      }

      .form-group {
        flex: 1;
        min-width: 100%;
      }

      @media (min-width: 480px) {
        .form-group {
          min-width: calc(50% - 10px);
        }
      }

      @media (min-width: 768px) {
        .form-group {
          min-width: calc(50% - 15px);
        }
      }

      .form-group label {
        display: block;
        margin-bottom: 8px;
        font-weight: 600;
        color: var(--dark);
        display: flex;
        align-items: center;
        gap: 5px;
        font-size: clamp(0.85rem, 2.5vw, 0.95rem);
      }

      .form-group input,
      .form-group select {
        width: 100%;
        padding: clamp(12px, 3vw, 14px) clamp(14px, 3vw, 18px);
        border: 2px solid #eee;
        border-radius: 10px;
        font-size: clamp(0.9rem, 2.5vw, 1rem);
        transition: all 0.3s;
        -webkit-appearance: none;
      }

      .form-group input:focus,
      .form-group select:focus {
        border-color: var(--primary);
        outline: none;
        box-shadow: 0 0 0 3px rgba(255, 123, 172, 0.2);
      }

      /* Phone input group */
      .phone-input-group {
        display: flex;
        gap: 10px;
        flex-wrap: wrap;
      }

      .phone-input-group input {
        flex: 1;
        min-width: 200px;
      }

      /* ==================== ITEMS SECTION ==================== */
      .items-section {
        margin: 25px 0;
        border: 2px solid #f0f0f0;
        border-radius: 12px;
        padding: clamp(15px, 3vw, 20px);
        overflow-x: auto;
      }

      .items-header {
        display: flex;
        flex-direction: column;
        gap: 15px;
        margin-bottom: 20px;
      }

      @media (min-width: 480px) {
        .items-header {
          flex-direction: row;
          justify-content: space-between;
          align-items: center;
        }
      }

      .add-item-btn {
        background-color: var(--accent);
        color: white;
        border: none;
        padding: 10px 20px;
        border-radius: 10px;
        cursor: pointer;
        font-weight: 600;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 8px;
        transition: all 0.3s;
        font-size: clamp(0.85rem, 2.5vw, 1rem);
        width: 100%;
        min-height: 44px; /* Minimum touch target size */
      }

      @media (min-width: 480px) {
        .add-item-btn {
          width: auto;
        }
      }

      .add-item-btn:hover {
        background-color: #8a2be2;
        transform: translateY(-2px);
      }

      /* ==================== ITEMS TABLE - MOBILE FRIENDLY ==================== */
      .items-table-wrapper {
        overflow-x: auto;
        -webkit-overflow-scrolling: touch;
        border-radius: 8px;
      }

      .items-table {
        width: 100%;
        border-collapse: collapse;
        min-width: 600px; /* Minimum width for table to be scrollable on mobile */
      }

      .items-table th {
        background-color: #f8f9fa;
        padding: 12px 10px;
        text-align: left;
        font-weight: 600;
        color: var(--dark);
        border-bottom: 2px solid #eee;
        font-size: clamp(0.8rem, 2.5vw, 0.9rem);
        white-space: nowrap;
      }

      .items-table td {
        padding: 12px 10px;
        border-bottom: 1px solid #eee;
        vertical-align: middle;
      }

      /* Mobile: Stack table cells */
      @media (max-width: 480px) {
        .items-table td:last-child {
          border-bottom: none;
        }

        .items-table td::before {
          content: attr(data-label);
          position: absolute;
          left: 10px;
          top: 8px;
          width: 40%;
          font-weight: 600;
          color: var(--dark);
          font-size: 0.85rem;
        }

        .item-total {
          font-weight: bold;
          font-size: 16px;
        }

        .remove-item {
          width: 100%;
          text-align: center;
          padding: 10px;
          border-radius: 8px;
          background-color: rgba(244, 67, 54, 0.1);
          margin-top: 10px;
        }
      }

      .item-row input,
      .item-row select {
        width: 100%;
        padding: 10px;
        border: 1px solid #ddd;
        border-radius: 8px;
        font-size: clamp(0.85rem, 2.5vw, 0.9rem);
        min-height: 44px;
      }

      .item-row .item-qty {
        width: 70px;
        text-align: center;
      }

      .item-row .item-price {
        width: 100px;
      }

      .remove-item {
        color: var(--danger);
        background: none;
        border: none;
        font-size: 18px;
        cursor: pointer;
        padding: 8px;
        border-radius: 8px;
        transition: all 0.3s;
        min-width: 44px;
        min-height: 44px;
        display: flex;
        align-items: center;
        justify-content: center;
      }

      .remove-item:hover {
        background-color: rgba(244, 67, 54, 0.1);
      }

      /* ==================== QUANTITY CONTROLS ==================== */
      .quantity-controls {
        display: flex;
        align-items: center;
        gap: 8px;
      }

      .qty-btn {
        width: 36px;
        height: 36px;
        display: flex;
        align-items: center;
        justify-content: center;
        border: 1px solid #ddd;
        background-color: #f8f9fa;
        border-radius: 6px;
        cursor: pointer;
        transition: all 0.2s;
        font-size: 14px;
        min-width: 44px;
        min-height: 44px;
      }

      .qty-btn:hover {
        background-color: #e9ecef;
        border-color: #999;
      }

      .qty-btn.decrease {
        color: var(--danger);
      }

      .qty-btn.increase {
        color: var(--success);
      }

      /* ==================== SUMMARY SECTION ==================== */
      .summary-card {
        background-color: #fff9fb;
        border-radius: 12px;
        padding: clamp(15px, 3vw, 25px);
        margin-top: 25px;
        border-left: 5px solid var(--accent);
      }

      .summary-row {
        display: flex;
        justify-content: space-between;
        padding: 10px 0;
        border-bottom: 1px solid #eee;
        font-size: clamp(0.9rem, 2.5vw, 1rem);
      }

      .summary-row.total {
        font-size: clamp(1.1rem, 3vw, 1.5rem);
        font-weight: 800;
        color: var(--accent);
        border-bottom: none;
        margin-top: 10px;
        padding-top: 15px;
        border-top: 2px solid #eee;
      }

      .summary-label {
        font-weight: 600;
      }

      /* ==================== PRODUCT CATALOG - MOBILE STACK ==================== */
      .product-catalog {
        flex: 1;
        min-width: 100%;
      }

      @media (min-width: 992px) {
        .product-catalog {
          min-width: 300px;
        }
      }

      .catalog-card {
        background-color: white;
        border-radius: 16px;
        padding: clamp(15px, 3vw, 25px);
        box-shadow: 0 8px 20px rgba(0, 0, 0, 0.08);
        margin-bottom: clamp(15px, 3vw, 30px);
        max-height: 500px;
        overflow-y: auto;
      }

      .catalog-header {
        display: flex;
        flex-direction: column;
        gap: 15px;
        margin-bottom: 20px;
      }

      @media (min-width: 480px) {
        .catalog-header {
          flex-direction: row;
          justify-content: space-between;
          align-items: center;
        }
      }

      /* MOBILE: Products stack one below another */
      .product-category {
        margin-bottom: 20px;
      }

      .category-title {
        color: var(--secondary);
        font-size: clamp(0.9rem, 2.5vw, 1rem);
        font-weight: 600;
        margin-bottom: 15px;
        padding-bottom: 5px;
        border-bottom: 2px solid #ffecd2;
        display: flex;
        align-items: center;
        justify-content: space-between;
      }

      .product-item {
        display: flex;
        align-items: center;
        padding: 12px;
        border-radius: 10px;
        margin-bottom: 10px;
        cursor: pointer;
        transition: all 0.3s;
        border: 2px solid transparent;
        width: 100%;
        text-align: left;
        background: white;
      }

      .product-item:hover {
        background-color: #fff9fb;
        transform: translateX(5px);
      }

      /* Mobile: Stack product items */
      @media (max-width: 768px) {
        .product-item {
          flex-direction: column;
          align-items: stretch;
          padding: 15px;
          gap: 10px;
        }

        .product-item .product-icon {
          margin-right: 0;
          margin-bottom: 10px;
          align-self: center;
        }

        .product-details {
          text-align: center;
        }

        .product-price {
          margin-top: 8px;
          font-size: 1.1rem;
        }

        .stock-display-container {
          text-align: center;
          justify-content: center;
        }
      }

      .product-item .product-icon {
        width: 50px;
        height: 50px;
        background: linear-gradient(45deg, var(--secondary), var(--primary));
        border-radius: 10px;
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-size: 20px;
        margin-right: 15px;
        flex-shrink: 0;
      }

      .product-details {
        flex: 1;
        min-width: 0; /* Allow text truncation */
      }

      .product-details h4 {
        color: var(--dark);
        margin-bottom: 5px;
        font-size: clamp(0.9rem, 2.5vw, 1rem);
        line-height: 1.3;
        word-break: break-word;
      }

      .product-details .product-code {
        font-size: 0.8rem;
        color: #666;
        font-family: monospace;
        background-color: #f5f5f5;
        padding: 3px 8px;
        border-radius: 4px;
        display: inline-block;
        margin-bottom: 5px;
      }

      .product-price {
        color: var(--accent);
        font-weight: 700;
        font-size: clamp(1rem, 2.5vw, 1.2rem);
        text-align: right;
        min-width: 80px;
      }

      /* ==================== RECENT ORDERS ==================== */
      .recent-orders {
        background-color: white;
        border-radius: 16px;
        padding: clamp(15px, 3vw, 25px);
        box-shadow: 0 8px 20px rgba(0, 0, 0, 0.08);
      }

      .orders-header {
        display: flex;
        flex-direction: column;
        gap: 15px;
        margin-bottom: 20px;
      }

      @media (min-width: 480px) {
        .orders-header {
          flex-direction: row;
          justify-content: space-between;
          align-items: center;
        }
      }

      .order-count {
        background-color: var(--primary);
        color: white;
        padding: 6px 15px;
        border-radius: 50px;
        font-weight: 600;
        font-size: clamp(0.8rem, 2.5vw, 0.9rem);
        text-align: center;
      }

      .order-item {
        display: flex;
        flex-direction: column;
        gap: 8px;
        padding: 12px 0;
        border-bottom: 1px solid #eee;
      }

      @media (min-width: 480px) {
        .order-item {
          flex-direction: row;
          justify-content: space-between;
          align-items: center;
          padding: 12px 0;
        }
      }

      .order-item:last-child {
        border-bottom: none;
      }

      .order-products {
        font-weight: 600;
        color: var(--dark);
        font-size: clamp(0.85rem, 2.5vw, 0.9rem);
        line-height: 1.4;
      }

      .order-price {
        color: var(--accent);
        font-weight: 700;
        font-size: clamp(0.9rem, 2.5vw, 1rem);
      }

      /* ==================== BUTTONS ==================== */
      .button-group {
        display: flex;
        flex-direction: column;
        gap: 15px;
        margin-top: 25px;
      }

      @media (min-width: 480px) {
        .button-group {
          flex-direction: row;
          flex-wrap: wrap;
        }
      }

      .btn {
        padding: clamp(14px, 3vw, 16px) clamp(20px, 4vw, 30px);
        border-radius: 10px;
        border: none;
        font-size: clamp(0.9rem, 2.5vw, 1rem);
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s;
        flex: 1;
        min-width: 100%;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 10px;
        min-height: 50px; /* Better touch target */
        text-align: center;
      }

      @media (min-width: 480px) {
        .btn {
          min-width: 150px;
        }
      }

      .btn-primary {
        background-color: var(--primary);
        color: white;
      }

      .btn-primary:hover {
        background-color: #ff5a9c;
        transform: translateY(-2px);
        box-shadow: 0 5px 15px rgba(255, 123, 172, 0.4);
      }

      .btn-secondary {
        background-color: var(--secondary);
        color: white;
      }

      .btn-secondary:hover {
        background-color: #ff9e1f;
        transform: translateY(-2px);
        box-shadow: 0 5px 15px rgba(255, 179, 71, 0.4);
      }

      .btn-success {
        background-color: #25d366 !important;
        color: white !important;
      }

      .btn-success:hover {
        background-color: #1da851 !important;
        transform: translateY(-2px);
        box-shadow: 0 5px 15px rgba(37, 211, 102, 0.4);
      }

      /* ==================== NOTIFICATIONS ==================== */
      .notification {
        position: fixed;
        top: clamp(20px, 5vw, 30px);
        right: clamp(10px, 3vw, 20px);
        left: clamp(10px, 3vw, 20px);
        padding: clamp(12px, 3vw, 15px) clamp(15px, 3vw, 25px);
        border-radius: 10px;
        color: white;
        font-weight: 600;
        z-index: 1000;
        display: flex;
        align-items: center;
        gap: 10px;
        transform: translateY(-150%);
        transition: transform 0.3s ease;
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        max-width: 500px;
        margin: 0 auto;
      }

      @media (min-width: 768px) {
        .notification {
          left: auto;
          max-width: 400px;
        }
      }

      .notification.show {
        transform: translateY(0);
      }

      .notification.success {
        background-color: var(--success);
      }
      .notification.error {
        background-color: var(--danger);
      }
      .notification.info {
        background-color: var(--info);
      }
      .notification.warning {
        background-color: var(--warning);
      }

      /* ==================== MODALS ==================== */
      .coupon-modal {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.7);
        z-index: 2000;
        align-items: center;
        justify-content: center;
        padding: 20px;
        overflow-y: auto;
      }

      .coupon-modal-content {
        background: white;
        border-radius: 16px;
        padding: clamp(20px, 4vw, 30px);
        width: 100%;
        max-width: 500px;
        max-height: 90vh;
        overflow-y: auto;
        box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        position: relative;
      }

      /* Modal header */
      .modal-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
        flex-wrap: wrap;
        gap: 10px;
      }

      .modal-close {
        background: none;
        border: none;
        font-size: 24px;
        color: #666;
        cursor: pointer;
        padding: 5px;
        min-width: 44px;
        min-height: 44px;
        display: flex;
        align-items: center;
        justify-content: center;
      }

      /* ==================== COUPONS ==================== */
      .coupons-table-container {
        margin-top: 20px;
        max-height: 300px;
        overflow-y: auto;
        border: 1px solid #e0e0e0;
        border-radius: 10px;
      }

      .coupons-table {
        width: 100%;
        border-collapse: collapse;
        font-size: clamp(0.8rem, 2.5vw, 0.85rem);
      }

      .coupons-table th {
        background: linear-gradient(45deg, var(--primary), var(--secondary));
        color: white;
        padding: 12px;
        text-align: left;
        position: sticky;
        top: 0;
        z-index: 10;
        white-space: nowrap;
      }

      .coupons-table td {
        padding: 10px;
        border-bottom: 1px solid #f0f0f0;
        word-break: break-word;
      }

      /* Mobile coupons table */
      @media (max-width: 480px) {
        .coupons-table {
          display: block;
        }

        .coupons-table thead {
          display: none;
        }

        .coupons-table tr {
          display: block;
          margin-bottom: 15px;
          border: 1px solid #e0e0e0;
          border-radius: 8px;
          padding: 15px;
        }

        .coupons-table td {
          display: block;
          padding: 8px 0;
          border: none;
          border-bottom: 1px solid #f0f0f0;
          position: relative;
          padding-left: 50%;
        }

        .coupons-table td:last-child {
          border-bottom: none;
        }

        .coupons-table td::before {
          content: attr(data-label);
          position: absolute;
          left: 10px;
          top: 8px;
          width: 45%;
          font-weight: 600;
          color: var(--dark);
          font-size: 0.8rem;
        }
      }

      /* Quick coupons */
      .quick-coupons {
        display: flex;
        flex-wrap: wrap;
        gap: 10px;
        margin-top: 10px;
      }

      .quick-coupon {
        background-color: #f0f0f0;
        border: none;
        padding: 10px 15px;
        border-radius: 20px;
        cursor: pointer;
        font-size: clamp(0.8rem, 2.5vw, 0.85rem);
        font-weight: 600;
        transition: all 0.3s;
        display: flex;
        align-items: center;
        gap: 5px;
        min-height: 40px;
        white-space: nowrap;
      }

      .quick-coupon:hover {
        background-color: var(--primary);
        color: white;
        transform: translateY(-2px);
      }

      .quick-coupon.active {
        background-color: var(--primary);
        color: white;
      }

      /* ==================== STOCK BADGES ==================== */
      .stock-badge {
        display: inline-block;
        padding: 4px 8px;
        border-radius: 6px;
        font-size: 10px;
        font-weight: bold;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        margin-left: 8px;
        line-height: 1;
      }

      .stock-badge.out-of-stock {
        background-color: #f44336;
        color: white;
      }

      .stock-badge.low-stock {
        background-color: #ff9800;
        color: white;
      }

      .stock-badge.medium-stock {
        background-color: #ffc107;
        color: #333;
      }

      .stock-badge.in-stock {
        background-color: #4caf50;
        color: white;
      }

      /* ==================== COUPON DISPLAY ==================== */
      .coupon-applied {
        background-color: rgba(76, 175, 80, 0.1);
        border: 2px solid var(--success);
        border-radius: 10px;
        padding: 15px;
        margin: 15px 0;
        animation: slideIn 0.3s ease;
      }

      .coupon-applied .coupon-header {
        display: flex;
        flex-direction: column;
        gap: 10px;
        margin-bottom: 10px;
      }

      @media (min-width: 480px) {
        .coupon-applied .coupon-header {
          flex-direction: row;
          justify-content: space-between;
          align-items: center;
        }
      }

      /* ==================== FORM GRIDS ==================== */
      .coupon-form-grid {
        display: grid;
        grid-template-columns: 1fr;
        gap: 15px;
        margin: 20px 0;
      }

      @media (min-width: 480px) {
        .coupon-form-grid {
          grid-template-columns: repeat(2, 1fr);
        }
      }

      .coupon-form-group.full-width {
        grid-column: 1 / -1;
      }

      /* ==================== FOOTER ==================== */
      footer {
        text-align: center;
        margin-top: 30px;
        padding: 20px;
        color: #666;
        font-size: clamp(0.8rem, 2.5vw, 0.9rem);
      }

      .footer-links {
        display: flex;
        flex-wrap: wrap;
        justify-content: center;
        gap: 15px;
        margin-top: 10px;
      }

      .footer-links a {
        color: var(--primary);
        text-decoration: none;
        padding: 5px;
        min-height: 44px;
        display: flex;
        align-items: center;
        gap: 5px;
        white-space: nowrap;
      }

      /* ==================== ANIMATIONS ==================== */
      @keyframes pulse {
        0% {
          opacity: 1;
        }
        50% {
          opacity: 0.5;
        }
        100% {
          opacity: 1;
        }
      }

      @keyframes slideIn {
        from {
          opacity: 0;
          transform: translateY(-10px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      @keyframes pulseWarning {
        0% {
          opacity: 1;
        }
        50% {
          opacity: 0.7;
        }
        100% {
          opacity: 1;
        }
      }

      @keyframes shake {
        0%,
        100% {
          transform: translateX(0);
        }
        25% {
          transform: translateX(-5px);
        }
        75% {
          transform: translateX(5px);
        }
      }

      /* ==================== KEYBOARD NAVIGATION ==================== */
      .keyboard-focus {
        outline: 3px solid var(--accent) !important;
        outline-offset: 2px !important;
        box-shadow: 0 0 0 3px rgba(157, 78, 221, 0.3) !important;
        position: relative;
        z-index: 10;
      }

      /* ==================== DATABASE STATUS ==================== */
      .db-status {
        display: inline-flex;
        align-items: center;
        gap: 8px;
        padding: 6px 12px;
        border-radius: 50px;
        font-size: clamp(0.8rem, 2.5vw, 0.85rem);
        font-weight: 600;
        margin-top: 8px;
      }

      .db-status.connected {
        background-color: rgba(76, 175, 80, 0.1);
        color: var(--success);
      }

      .db-status.disconnected {
        background-color: rgba(244, 67, 54, 0.1);
        color: var(--danger);
      }

      .status-dot {
        width: 10px;
        height: 10px;
        border-radius: 50%;
      }

      .status-dot.connected {
        background-color: var(--success);
        animation: pulse 2s infinite;
      }

      .status-dot.disconnected {
        background-color: var(--danger);
      }

      /* ==================== LOADING STATES ==================== */
      .loading-products {
        text-align: center;
        padding: 40px;
        color: #666;
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 15px;
      }

      .loading-products i {
        font-size: 2rem;
      }

      /* ==================== UTILITY CLASSES ==================== */
      .mobile-only {
        display: block;
      }
      .desktop-only {
        display: none;
      }

      @media (min-width: 768px) {
        .mobile-only {
          display: none;
        }
        .desktop-only {
          display: block;
        }
      }

      .no-wrap {
        white-space: nowrap;
      }
      .text-center {
        text-align: center;
      }
      .text-right {
        text-align: right;
      }
      .text-left {
        text-align: left;
      }

      /* ==================== TOUCH OPTIMIZATIONS ==================== */
      @media (hover: none) and (pointer: coarse) {
        /* Disable hover effects on touch devices */
        .btn:hover,
        .add-item-btn:hover,
        .quick-coupon:hover,
        .product-item:hover {
          transform: none;
          box-shadow: none;
        }

        /* Increase touch targets */
        input,
        select,
        button {
          min-height: 44px;
        }

        /* Better spacing for touch */
        .form-group {
          margin-bottom: 20px;
        }

        /* Hide desktop-only elements */
        .desktop-only {
          display: none;
        }

        /* Show mobile-optimized elements */
        .mobile-optimized {
          display: block;
        }
      }

      /* ==================== PRINT STYLES ==================== */
      @media print {
        body {
          background: white;
          padding: 0;
        }

        .container {
          max-width: 100%;
          margin: 0;
        }

        header,
        footer,
        .product-catalog,
        .button-group,
        nav {
          display: none !important;
        }

        .billing-card {
          box-shadow: none;
          border: 1px solid #ddd;
          margin: 0;
          padding: 20px;
        }
      }

      /* ==================== HIGH CONTRAST MODE ==================== */
      @media (prefers-contrast: high) {
        .btn,
        .add-item-btn,
        .quick-coupon {
          border: 2px solid currentColor;
        }

        .notification {
          border: 2px solid white;
        }
      }

      /* ==================== REDUCED MOTION ==================== */
      @media (prefers-reduced-motion: reduce) {
        *,
        *::before,
        *::after {
          animation-duration: 0.01ms !important;
          animation-iteration-count: 1 !important;
          transition-duration: 0.01ms !important;
        }
      }

      /* ==================== VERY SMALL SCREENS ==================== */
      @media (max-width: 320px) {
        body {
          padding: 5px;
        }

        .billing-card,
        .catalog-card,
        .recent-orders {
          padding: 12px;
          border-radius: 12px;
        }

        .btn {
          padding: 12px 15px;
          font-size: 0.85rem;
        }

        nav a {
          padding: 6px 10px;
          font-size: 0.8rem;
        }
      }

      /* ==================== LARGE SCREENS ==================== */
      @media (min-width: 1600px) {
        .container {
          max-width: 1500px;
        }

        body {
          font-size: 18px;
        }
      }
      /* ==================== ITEMS TABLE - MOBILE FRIENDLY ==================== */
      @media (max-width: 480px) {
        .items-table {
          display: block;
          min-width: 100%;
        }

        .items-table thead {
          display: none;
        }

        .items-table tr {
          display: flex;
          flex-direction: column;
          margin-bottom: 15px;
          border: 2px solid #f0f0f0;
          border-radius: 10px;
          padding: 15px;
          background: white;
          gap: 12px;
        }

        .items-table td {
          display: flex;
          flex-direction: column;
          padding: 0;
          border: none;
          position: relative;
          padding-left: 0;
          min-height: auto;
          gap: 6px;
        }

        .items-table td::before {
          content: attr(data-label);
          position: static;
          width: 100%;
          font-weight: 600;
          color: var(--dark);
          font-size: 0.85rem;
          margin-bottom: 4px;
          padding-bottom: 4px;
          border-bottom: 1px dashed #eee;
        }

        /* Input styling for mobile */
        .items-table input,
        .items-table select {
          width: 100%;
          padding: 12px;
          border: 2px solid #eee;
          border-radius: 8px;
          font-size: 16px; /* Better for mobile touch */
          min-height: 44px;
        }

        /* Quantity controls on mobile */
        .quantity-controls {
          display: flex;
          align-items: center;
          gap: 10px;
          margin-top: 5px;
        }

        .item-qty {
          width: 70px !important;
          text-align: center;
          font-size: 16px;
          padding: 12px !important;
        }

        .qty-btn {
          min-width: 44px !important;
          min-height: 44px !important;
          font-size: 16px !important;
        }

        /* Remove button styling */
        .remove-item {
          width: 100% !important;
          text-align: center;
          padding: 12px !important;
          border-radius: 8px;
          background-color: rgba(244, 67, 54, 0.1);
          margin-top: 10px;
          font-size: 16px !important;
          min-height: 44px;
        }

        /* Product name and code inputs */
        .item-name,
        .item-code {
          font-size: 16px !important;
        }

        /* Price input */
        .item-price {
          font-size: 16px !important;
          padding: 12px !important;
        }

        /* Total display */
        .item-total {
          font-size: 18px !important;
          text-align: center;
          padding: 10px;
          background-color: #f8f9fa;
          border-radius: 8px;
          margin-top: 5px;
        }

        /* Stock badge positioning */
        .stock-badge {
          align-self: flex-start;
          margin-top: 5px;
        }

        /* Expiry info */
        .expiry-info {
          font-size: 12px;
          color: #666;
          margin-top: 5px;
          padding-top: 5px;
          border-top: 1px dashed #eee;
        }

        /* Stock info message */
        .stock-info-message {
          font-size: 12px !important;
          padding: 8px;
          background-color: #f8f9fa;
          border-radius: 6px;
          margin-top: 8px !important;
        }
      }

      /* ==================== ITEMS SECTION - MOBILE OPTIMIZATION ==================== */
      @media (max-width: 480px) {
        .items-section {
          margin: 15px 0;
          padding: 12px;
          border-width: 1px;
        }

        .items-header {
          flex-direction: column;
          gap: 12px;
        }

        .add-item-btn {
          width: 100%;
          padding: 14px;
          font-size: 16px;
          min-height: 50px;
        }

        /* Make sure table wrapper doesn't create horizontal scroll unless needed */
        .items-table-wrapper {
          overflow-x: visible;
        }
      }

      /* ==================== TOUCH OPTIMIZATIONS FOR MOBILE ==================== */
      @media (max-width: 480px) {
        /* Increase touch targets for all interactive elements in items table */
        .item-row input,
        .item-row button,
        .item-row select {
          min-height: 44px;
        }

        /* Better spacing between form elements */
        .form-group {
          margin-bottom: 20px;
        }

        /* Reduce padding on smaller screens */
        @media (max-width: 320px) {
          .items-table tr {
            padding: 10px;
          }

          .items-table input,
          .items-table select {
            padding: 10px;
          }
        }
      }

      /* ==================== ITEM ROW SPECIFIC MOBILE STYLES ==================== */
      /* Add these to ensure proper data-label attributes work */
      @media (max-width: 480px) {
        .items-table td:nth-child(1) {
          data-label: "Product";
        }

        .items-table td:nth-child(2) {
          data-label: "Code";
        }

        .items-table td:nth-child(3) {
          data-label: "Quantity";
        }

        .items-table td:nth-child(4) {
          data-label: "Price";
        }

        .items-table td:nth-child(5) {
          data-label: "Total";
        }

        .items-table td:nth-child(6) {
          data-label: "Action";
        }
      }
    </style>
  </head>
  <body>
    <div class="container">
      <!-- Header -->
      <header>
        <div class="logo-container">
          <div class="logo">
            <i class="fas fa-birthday-cake"></i>
          </div>
          <div class="logo-text">
            <h1>Cake Bliss</h1>
            <p>Advanced Billing System with Multiple Items</p>
            <div id="dbStatus" class="db-status disconnected">
              <div class="status-dot disconnected"></div>
              <span>Database: Disconnected</span>
            </div>
          </div>
        </div>
        <nav>
          <ul>
            <li>
              <a href="billing.html" class="active"
                ><i class="fas fa-receipt"></i> Billing</a
              >
            </li>
            <!-- Add this to your header navigation -->
            <li>
              <a href="inventory.html" id="inventoryBtn">
                <i class="fas fa-boxes"></i> Inventory
              </a>
            </li>
            <li>
              <a href="reports.html"
                ><i class="fas fa-chart-bar"></i> Reports</a
              >
            </li>
            <li>
              <a href="promotions.html"
                ><i class="fas fa-bullhorn"></i> Promotions</a
              >
            </li>
          </ul>
        </nav>
      </header>

      <div class="main-content">
        <!-- Billing Form -->
        <div class="billing-card">
          <h2><i class="fas fa-cash-register"></i> Create New Bill</h2>
          <p class="form-subtitle">
            Enter customer details and add multiple items
          </p>

          <form id="billingForm">
            <!-- Customer Information -->
            <div class="form-row">
              <div class="form-group">
                <label for="purchaserPhone"
                  ><i class="fas fa-phone"></i> Purchaser Phone *</label
                >
                <div style="display: flex; gap: 10px">
                  <input
                    type="tel"
                    id="purchaserPhone"
                    placeholder="1234567890"
                    required
                    style="flex: 1"
                    pattern="[0-9]{10}"
                    title="Please enter exactly 10 digits"
                    maxlength="10"
                    minlength="10"
                    oninput="this.value = this.value.replace(/[^0-9]/g, '').slice(0, 10); validatePhoneLength(this)"
                  />
                  <button
                    type="button"
                    id="checkCustomerBtn"
                    class="btn"
                    style="
                      padding: 10px 15px;
                      background-color: #f0f0f0;
                      min-width: auto;
                    "
                  >
                    <i class="fas fa-search"></i> Check
                  </button>
                </div>
                <small
                  id="purchaserPhoneError"
                  style="color: var(--danger); font-size: 12px; display: none"
                >
                  <i class="fas fa-exclamation-circle"></i> Please enter exactly
                  10 digits
                </small>
                <div
                  id="customerInfo"
                  style="margin-top: 10px; display: none"
                ></div>
              </div>
              <div class="form-group">
                <label for="purchaserName"
                  ><i class="fas fa-user"></i> Purchaser Name *</label
                >
                <input
                  type="text"
                  id="purchaserName"
                  placeholder="Enter full name"
                  required
                />
              </div>
            </div>

            <div class="form-row">
              <div class="form-group">
                <label for="birthdayPersonName"
                  ><i class="fas fa-birthday-cake"></i> Birthday Person Name
                  *</label
                >
                <input
                  type="text"
                  id="birthdayPersonName"
                  placeholder="Name of person celebrating"
                  required
                />
              </div>
              <div class="form-group">
                <label for="birthdayPersonPhone"
                  ><i class="fas fa-mobile-alt"></i> Birthday Person
                  Phone</label
                >
                <input
                  type="tel"
                  id="birthdayPersonPhone"
                  placeholder="Optional (must be 10 digits)"
                  pattern="[0-9]{10}"
                  title="Please enter exactly 10 digits or leave blank"
                  maxlength="10"
                  minlength="10"
                  oninput="this.value = this.value.replace(/[^0-9]/g, '').slice(0, 10); validateOptionalPhoneLength(this)"
                />
                <small
                  id="birthdayPhoneError"
                  style="color: var(--danger); font-size: 12px; display: none"
                >
                  <i class="fas fa-exclamation-circle"></i> Must be exactly 10
                  digits if provided
                </small>
              </div>
            </div>

            <div class="form-row">
              <div class="form-group">
                <label for="purchaserBirthdate"
                  ><i class="fas fa-calendar-day"></i> Purchaser
                  Birthdate</label
                >
                <input type="date" id="purchaserBirthdate" />
              </div>
              <div class="form-group">
                <label for="birthdayPersonBirthdate"
                  ><i class="fas fa-calendar-check"></i> Birthday Person
                  Birthdate *</label
                >
                <input type="date" id="birthdayPersonBirthdate" required />
              </div>
            </div>

            <!-- Items Section -->
            <div class="items-section">
              <div class="items-header">
                <h3><i class="fas fa-shopping-cart"></i> Items in Order</h3>
                <div>
                  <button type="button" id="addItemBtn" class="add-item-btn">
                    <i class="fas fa-plus"></i> Add Item
                  </button>
                </div>
              </div>

              <table class="items-table">
                <thead>
                  <tr>
                    <th width="40%">Product</th>
                    <th width="15%">Product Code</th>
                    <th width="15%">Quantity</th>
                    <th width="20%">Price</th>
                    <th width="20%">Total</th>
                    <th width="5%"></th>
                  </tr>
                </thead>
                <tbody id="itemsTableBody">
                  <!-- Items will be added here dynamically -->
                </tbody>
              </table>
            </div>

            <!-- Coupon Display Section -->
            <div id="couponDisplaySection" style="display: none">
              <div class="coupon-applied">
                <div class="coupon-header">
                  <div>
                    <strong><i class="fas fa-tag"></i> Coupon Applied</strong>
                    <div style="font-size: 12px; color: #666; margin-top: 5px">
                      Code:
                      <span id="appliedCouponCode" class="coupon-code"></span>
                    </div>
                  </div>
                  <div>
                    <div
                      id="appliedCouponDiscount"
                      class="coupon-discount"
                    ></div>
                    <button
                      type="button"
                      id="removeCouponBtn"
                      class="remove-coupon"
                    >
                      <i class="fas fa-times"></i>
                    </button>
                  </div>
                </div>
                <div style="font-size: 13px; margin-top: 10px">
                  <div id="appliedCouponDescription"></div>
                  <div id="appliedCouponValidUntil" style="color: #666"></div>
                </div>
              </div>
            </div>

            <!-- Summary Section -->
            <div class="summary-card">
              <div class="summary-row">
                <span class="summary-label">Subtotal:</span>
                <span id="subtotal">₹0.00</span>
              </div>
              <div class="summary-row">
                <span class="summary-label">Discount:</span>
                <span id="discountAmount">₹0.00</span>
              </div>
              <div class="summary-row total">
                <span>GRAND TOTAL:</span>
                <span id="grandTotal">₹0.00</span>
              </div>
            </div>

            <!-- Additional Information -->
            <div class="form-row" style="margin-top: 20px">
              <div class="form-group">
                <label for="couponCode"
                  ><i class="fas fa-tag"></i> Coupon Code</label
                >
                <input
                  type="text"
                  id="couponCode"
                  placeholder="Enter coupon code if any"
                />
              </div>
              <div class="form-group">
                <label for="orderNotes"
                  ><i class="fas fa-sticky-note"></i> Order Notes</label
                >
                <input
                  type="text"
                  id="orderNotes"
                  placeholder="Any special instructions?"
                />
              </div>
            </div>

            <!-- Quick Coupons -->
            <div class="quick-coupons" id="quickCoupons">
              <!-- Will be populated dynamically -->
            </div>

            <!-- Action Buttons -->
            <div class="button-group">
              <button type="submit" class="btn btn-primary" id="submitBill">
                <i class="fas fa-file-invoice-dollar"></i> Generate & Send Bill
                (Ctrl+S)
              </button>
              <button type="button" class="btn btn-secondary" id="resetForm">
                <i class="fas fa-redo"></i> Reset Form (Ctrl+R)
              </button>
            </div>
          </form>
        </div>

        <!-- Product Catalog -->
        <div class="product-catalog">
          <div class="catalog-card">
            <!-- In your catalog-card header -->
            <div
              style="
                display: flex;
                justify-content: space-between;
                align-items: center;
                margin-bottom: 20px;
              "
            >
              <h3><i class="fas fa-boxes"></i> Product Catalog</h3>
              <div style="display: flex; gap: 10px">
                <button
                  onclick="showAllBatchDetails()"
                  class="btn"
                  style="
                    padding: 8px 15px;
                    font-size: 14px;
                    background-color: var(--secondary);
                    color: white;
                    border: none;
                    border-radius: 8px;
                    cursor: pointer;
                  "
                >
                  <i class="fas fa-list"></i> View All Batches
                </button>
                <!-- Change this line in your HTML: -->
                <button
                  onclick="refreshProductCatalog()"
                  class="btn"
                  style="
                    padding: 8px 15px;
                    font-size: 14px;
                    background-color: var(--accent);
                    color: white;
                    border: none;
                    border-radius: 8px;
                    cursor: pointer;
                  "
                >
                  <i class="fas fa-sync-alt"></i> Refresh
                </button>
              </div>
            </div>

            <!-- Dynamic Content Container -->
            <div id="dynamicProductCatalog">
              <div class="loading-products">
                <i class="fas fa-spinner fa-spin"></i> Loading products...
              </div>
            </div>
          </div>

          <!-- Recent Orders -->
          <div class="recent-orders">
            <div class="orders-header">
              <h3><i class="fas fa-history"></i> Recent Bills</h3>
              <div class="order-count" id="recentBillsCount">0</div>
            </div>
            <div id="recentBillsList">
              <div class="order-item">
                <div class="order-products">Loading bills...</div>
                <div class="order-price">₹0.00</div>
              </div>
            </div>
          </div>

          <!-- Coupons Management Section -->
          <div class="coupons-section" style="margin-top: 30px">
            <div class="catalog-card">
              <div
                style="
                  display: flex;
                  justify-content: space-between;
                  align-items: center;
                  margin-bottom: 20px;
                "
              >
                <h3><i class="fas fa-tags"></i> Coupons Management</h3>
              </div>

              <div style="margin-bottom: 15px">
                <button
                  id="manageCouponsBtn"
                  class="btn btn-primary"
                  style="width: 100%; margin-bottom: 10px"
                >
                  <i class="fas fa-tags"></i> Manage All Coupons
                </button>

                <div
                  class="quick-coupons"
                  id="quickCouponsSidebar"
                  style="margin-top: 15px"
                >
                  <!-- Quick coupons will be loaded here -->
                </div>
              </div>

              <div
                id="activeCouponsCount"
                style="
                  text-align: center;
                  color: #666;
                  font-size: 14px;
                  margin-top: 10px;
                "
              >
                <i class="fas fa-info-circle"></i>
                <span id="couponsCount">0</span> active coupons
              </div>
            </div>
          </div>
        </div>
      </div>

      <footer>
        <p>&copy; 2023 Cake Bliss Billing System. All rights reserved.</p>
        <div class="footer-links">
          <a href="#" id="setupDbBtn"
            ><i class="fas fa-database"></i> Setup Database</a
          >
          <a href="#"><i class="fas fa-question-circle"></i> Help</a>
          <a href="#"><i class="fas fa-print"></i> Print</a>
        </div>
      </footer>
    </div>

    <!-- Notification -->
    <div id="notification" class="notification">
      <i class="fas fa-check-circle"></i>
      <span>Notification message</span>
    </div>

    <!-- Database Setup Modal -->
    <div
      id="dbInfoModal"
      style="
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.5);
        z-index: 1001;
        align-items: center;
        justify-content: center;
      "
    >
      <div
        style="
          background: white;
          padding: 30px;
          border-radius: 20px;
          max-width: 500px;
          width: 90%;
        "
      >
        <h3 style="color: var(--primary); margin-bottom: 20px">
          <i class="fas fa-database"></i> Connect to Supabase
        </h3>
        <p style="margin-bottom: 15px">
          To connect to your existing <strong>cake-bills</strong> table:
        </p>

        <div
          style="
            margin-bottom: 20px;
            font-size: 13px;
            background-color: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
          "
        >
          <strong>Your table structure:</strong><br />
          id, bill_number, purchaser_name, birthday_person_name,
          purchaser_birthdate, birthday_person_birthdate, purchaser_phone,
          birthday_person_phone, cake_name, cake_price, total_price,
          coupon_code, created_at, is_returning_customer, last_visit_date
        </div>

        <p style="margin-bottom: 20px">
          The system will store multiple items as a JSON array in the
          <strong>cake_name</strong> field.
        </p>

        <div style="margin-top: 30px">
          <label style="display: block; margin-bottom: 5px; font-weight: 600"
            >Supabase URL:</label
          >
          <input
            type="text"
            id="sbUrlInput"
            style="
              width: 100%;
              padding: 10px;
              border: 2px solid #eee;
              border-radius: 8px;
              margin-bottom: 15px;
            "
            placeholder="https://your-project.supabase.co"
          />

          <label style="display: block; margin-bottom: 5px; font-weight: 600"
            >Supabase Anon Key:</label
          >
          <input
            type="text"
            id="sbKeyInput"
            style="
              width: 100%;
              padding: 10px;
              border: 2px solid #eee;
              border-radius: 8px;
            "
            placeholder="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9..."
          />

          <div style="display: flex; gap: 10px; margin-top: 20px">
            <button id="saveDbConfig" class="btn btn-primary" style="flex: 1">
              Save Configuration
            </button>
            <button
              id="closeDbModal"
              class="btn"
              style="flex: 1; background-color: #f0f0f0"
            >
              Close
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Coupons Management Modal -->
    <div id="couponsModal" class="coupon-modal">
      <div class="coupon-modal-content">
        <div
          style="
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
          "
        >
          <h3 style="color: var(--primary)">
            <i class="fas fa-tags"></i> Manage Coupons
          </h3>
          <button
            id="closeCouponsModal"
            style="
              background: none;
              border: none;
              font-size: 24px;
              color: #666;
              cursor: pointer;
            "
          >
            <i class="fas fa-times"></i>
          </button>
        </div>

        <!-- New Coupon Button -->
        <button
          id="newCouponBtn"
          class="btn btn-primary"
          style="margin-bottom: 20px; width: 100%"
        >
          <i class="fas fa-plus-circle"></i> Create New Coupon
        </button>

        <!-- Coupons Table -->
        <div class="coupons-table-container">
          <table class="coupons-table" id="couponsTable">
            <thead>
              <tr>
                <th>Code</th>
                <th>Discount</th>
                <th>Type</th>
                <th>Status</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody id="couponsTableBody">
              <!-- Coupons will be loaded here -->
            </tbody>
          </table>
        </div>

        <!-- No Coupons Message -->
        <div
          id="noCouponsMessage"
          class="no-data"
          style="display: none; padding: 40px"
        >
          <i
            class="fas fa-tags"
            style="font-size: 40px; color: #ddd; margin-bottom: 15px"
          ></i>
          <p>No coupons found</p>
          <button
            id="createFirstCouponBtn"
            class="btn btn-primary"
            style="margin-top: 15px"
          >
            <i class="fas fa-plus"></i> Create Your First Coupon
          </button>
        </div>

        <div
          style="
            margin-top: 20px;
            text-align: center;
            color: #666;
            font-size: 12px;
          "
        >
          <p>
            <i class="fas fa-info-circle"></i> Double-click a coupon to use it
          </p>
        </div>
      </div>
    </div>

    <!-- Add/Edit Coupon Modal -->
    <div id="couponFormModal" class="coupon-modal">
      <div class="coupon-modal-content">
        <div
          style="
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
          "
        >
          <h3 id="couponFormTitle" style="color: var(--primary)">
            <i class="fas fa-tag"></i> Create New Coupon
          </h3>
          <button
            id="closeCouponFormModal"
            style="
              background: none;
              border: none;
              font-size: 24px;
              color: #666;
              cursor: pointer;
            "
          >
            <i class="fas fa-times"></i>
          </button>
        </div>

        <form id="couponForm">
          <div class="coupon-form-grid">
            <div class="coupon-form-group">
              <label for="couponCodeInput"
                ><i class="fas fa-barcode"></i> Coupon Code *</label
              >
              <input
                type="text"
                id="couponCodeInput"
                required
                placeholder="e.g., SAVE10"
              />
            </div>

            <div class="coupon-form-group">
              <label for="couponDiscountType"
                ><i class="fas fa-percentage"></i> Discount Type *</label
              >
              <select id="couponDiscountType" required>
                <option value="percentage">Percentage (%)</option>
                <option value="fixed">Fixed Amount (₹)</option>
                <option value="bogo">Buy One Get One</option>
              </select>
            </div>

            <div class="coupon-form-group">
              <label for="couponDiscountValue"
                ><i class="fas fa-rupee-sign"></i> Discount Value *</label
              >
              <input
                type="number"
                id="couponDiscountValue"
                required
                step="0.01"
                placeholder="e.g., 10"
              />
            </div>

            <div class="coupon-form-group">
              <label for="couponMinPurchase"
                ><i class="fas fa-shopping-bag"></i> Minimum Purchase</label
              >
              <input
                type="number"
                id="couponMinPurchase"
                step="0.01"
                placeholder="e.g., 100"
              />
            </div>

            <div class="coupon-form-group">
              <label for="couponMaxDiscount"
                ><i class="fas fa-chart-line"></i> Max Discount</label
              >
              <input
                type="number"
                id="couponMaxDiscount"
                step="0.01"
                placeholder="e.g., 50"
              />
            </div>

            <div class="coupon-form-group">
              <label for="couponUsageLimit"
                ><i class="fas fa-users"></i> Usage Limit</label
              >
              <input
                type="number"
                id="couponUsageLimit"
                min="1"
                placeholder="e.g., 100"
              />
            </div>

            <div class="coupon-form-group">
              <label for="couponStartDate"
                ><i class="fas fa-calendar-plus"></i> Start Date</label
              >
              <input type="date" id="couponStartDate" />
            </div>

            <div class="coupon-form-group">
              <label for="couponEndDate"
                ><i class="fas fa-calendar-times"></i> End Date</label
              >
              <input type="date" id="couponEndDate" />
            </div>

            <div class="coupon-form-group full-width">
              <label for="couponDescription"
                ><i class="fas fa-align-left"></i> Description</label
              >
              <textarea
                id="couponDescription"
                rows="3"
                placeholder="Describe what this coupon is for..."
              ></textarea>
            </div>
          </div>

          <!-- Coupon Usage Stats (for editing) -->
          <div
            id="couponUsageStats"
            class="coupon-usage-stats"
            style="display: none"
          >
            <h4 style="color: var(--primary); margin-bottom: 10px">
              Usage Statistics
            </h4>
            <div class="usage-stat">
              <span>Used Count:</span>
              <span id="couponUsedCount" class="value">0</span>
            </div>
            <div class="usage-stat">
              <span>Remaining:</span>
              <span id="couponRemainingCount" class="value">∞</span>
            </div>
            <div class="usage-stat">
              <span>Total Discount Given:</span>
              <span id="couponTotalDiscount" class="value">₹0.00</span>
            </div>
          </div>

          <div class="coupon-form-actions">
            <button
              type="submit"
              class="btn btn-primary"
              id="saveCouponBtn"
              style="flex: 2"
            >
              <i class="fas fa-save"></i> Save Coupon
            </button>
            <button
              type="button"
              class="btn"
              id="cancelCouponBtn"
              style="flex: 1; background-color: #f0f0f0"
            >
              <i class="fas fa-times"></i> Cancel
            </button>
          </div>
        </form>
      </div>
    </div>

    <datalist id="globalProductNames"></datalist>
    <datalist id="globalProductCodes"></datalist>
    <script>
      (function () {
        // Supabase Configuration
        let supabase = null;
        let isConnected = false;
        let lastCustomerData = null;
        let allProducts = []; // Store products from Supabase
        let currentFieldIndex = 0;
        let formFields = [];
        let currentItemRow = null;
        let currentItemField = 0; // 0=name, 1=code, 2=qty, 3=price
        let itemRows = [];

        // Coupons Management System
        let currentCoupons = [];
        let editingCouponId = null;
        let appliedCoupon = null;

        // Default configuration (using your credentials)
        const DEFAULT_CONFIG = {
          supabaseUrl: "https://vdbwzmutxjonnpfwfpbn.supabase.co",
          supabaseKey:
            "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZkYnd6bXV0eGpvbm5wZndmcGJuIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQ5OTcwMjQsImV4cCI6MjA4MDU3MzAyNH0.n0ERxgLgYU1Tvw5QONihv1C3A7o7rcxrcn5MjZ5UnEM",
        };

        // Load configuration from localStorage or use defaults
        // Load configuration from localStorage or use defaults
        let config = DEFAULT_CONFIG;
        try {
          const savedConfig = localStorage.getItem("cakeBlissConfig");
          if (savedConfig) {
            const parsedConfig = JSON.parse(savedConfig);
            if (
              parsedConfig &&
              parsedConfig.supabaseUrl &&
              parsedConfig.supabaseKey
            ) {
              config = parsedConfig;
            }
          }
        } catch (error) {
          console.warn("Failed to load saved config, using defaults:", error);
          config = DEFAULT_CONFIG;
        }

        function setDefaultCouponStartDate() {
          const today = new Date().toISOString().split("T")[0];
          const startDateInput = document.getElementById("couponStartDate");
          if (startDateInput && !startDateInput.value) {
            startDateInput.value = today;
          }
        }

        // ==================== KEYBOARD NAVIGATION SETUP ====================
        function initializeKeyboardNavigation() {
          console.log("Initializing keyboard navigation...");

          // Update form fields collection to include all interactive elements
          formFields = Array.from(
            document.querySelectorAll(
              "#purchaserPhone, #checkCustomerBtn, #purchaserName, #birthdayPersonName, #birthdayPersonPhone, #purchaserBirthdate, #birthdayPersonBirthdate, #couponCode, #orderNotes, #addItemBtn, #submitBill, #resetForm, #manageCouponsBtn"
            )
          ).filter((el) => el && el.offsetParent !== null);

          // Add global keyboard event listener
          document.addEventListener("keydown", handleGlobalKeyboard);

          console.log(
            "Keyboard navigation initialized with",
            formFields.length,
            "fields"
          );
        }

        // Helper function to format dates for input fields
        function formatDateForInput(dateString) {
          if (!dateString) return "";

          try {
            const date = new Date(dateString);

            // Check if date is valid
            if (isNaN(date.getTime())) {
              console.warn("Invalid date:", dateString);
              return "";
            }

            // Format as YYYY-MM-DD
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, "0");
            const day = String(date.getDate()).padStart(2, "0");

            return `${year}-${month}-${day}`;
          } catch (error) {
            console.error("Error formatting date:", error);
            return "";
          }
        }

        async function generateBillPDF(billData) {
          try {
            console.log("Generating PDF for bill:", billData.bill_number);

            // Create HTML structure for PDF
            const pdfHTML = `
      <div class="pdf-container" id="pdf-content">
          <div class="pdf-header">
              <h2>🎂 Cake Bliss</h2>
              <p>Delicious Cakes & Pastries</p>
              <div class="pdf-bill-number">Bill: ${billData.bill_number}</div>
              <div style="font-size: 12px; color: #666;">
                  Date: ${new Date(billData.created_at).toLocaleDateString()}
              </div>
          </div>
          
          <div class="pdf-section">
              <div class="pdf-section-title">
                  <i class="fas fa-user"></i> Customer Details
              </div>
              <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                  <div>
                      <strong>Purchaser:</strong><br>
                      ${billData.purchaser_name}<br>
                      📱 ${billData.purchaser_phone}
                  </div>
                  <div>
                      <strong>Birthday Person:</strong><br>
                      ${billData.birthday_person_name}<br>
                      ${
                        billData.birthday_person_phone
                          ? "📱 " + billData.birthday_person_phone
                          : ""
                      }
                  </div>
              </div>
          </div>
          
          <div class="pdf-section">
              <div class="pdf-section-title">
                  <i class="fas fa-shopping-cart"></i> Order Items
              </div>
              <table class="pdf-table">
                  <thead>
                      <tr>
                          <th>Item</th>
                          <th>Qty</th>
                          <th>Price</th>
                          <th>Total</th>
                      </tr>
                  </thead>
                  <tbody id="pdf-items">
                      ${await generatePDFItemsHTML(billData.cake_name)}
                  </tbody>
              </table>
          </div>
          
          <div class="pdf-total">
              <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                  <span>Subtotal:</span>
                  <span>₹${parseFloat(billData.cake_price).toFixed(2)}</span>
              </div>
              ${
                billData.coupon_code
                  ? `
              <div style="display: flex; justify-content: space-between; margin-bottom: 5px; color: var(--success);">
                  <span>Discount (${billData.coupon_code}):</span>
                  <span>-₹${(
                    parseFloat(billData.cake_price) -
                    parseFloat(billData.total_price)
                  ).toFixed(2)}</span>
              </div>
              `
                  : ""
              }
              <div style="display: flex; justify-content: space-between; font-size: 18px; font-weight: bold; margin-top: 10px; color: var(--accent);">
                  <span>GRAND TOTAL:</span>
                  <span>₹${parseFloat(billData.total_price).toFixed(2)}</span>
              </div>
          </div>
          
          <div class="pdf-footer">
              <p>Thank you for choosing Cake Bliss! 🎂</p>
              <p>For any queries, call: ${billData.purchaser_phone}</p>
              <p style="font-size: 10px; margin-top: 10px;">
                  Bill generated on ${new Date().toLocaleString()}
              </p>
          </div>
      </div>
    `;

            // Create and show the PDF content temporarily to ensure it renders
            const tempDiv = document.createElement("div");
            tempDiv.style.position = "fixed";
            tempDiv.style.top = "0";
            tempDiv.style.left = "0";
            tempDiv.style.width = "800px";
            tempDiv.style.height = "100vh";
            tempDiv.style.overflow = "scroll";
            tempDiv.style.background = "white";
            tempDiv.style.zIndex = "9999";
            tempDiv.style.padding = "20px";
            tempDiv.innerHTML = pdfHTML;
            document.body.appendChild(tempDiv);

            // Wait for content to render
            await new Promise((resolve) => setTimeout(resolve, 500));

            // Generate PDF
            const options = {
              margin: [15, 15],
              filename: `CakeBliss_Bill_${billData.bill_number}.pdf`,
              image: {
                type: "jpeg",
                quality: 0.98,
              },
              html2canvas: {
                scale: 2,
                useCORS: true,
                logging: false,
                backgroundColor: "#ffffff",
                windowWidth: 800,
                windowHeight: tempDiv.scrollHeight,
                onclone: function (clonedDoc) {
                  // Ensure all content is visible
                  clonedDoc.body.style.overflow = "visible";
                  clonedDoc.body.style.height = "auto";
                },
              },
              jsPDF: {
                unit: "mm",
                format: "a4",
                orientation: "portrait",
              },
            };

            // Generate PDF
            const worker = html2pdf().set(options).from(tempDiv);
            const pdfBlob = await worker.outputPdf("blob");

            // Remove temporary div
            document.body.removeChild(tempDiv);

            console.log("PDF generated successfully, size:", pdfBlob.size);
            return pdfBlob;
          } catch (error) {
            console.error("Error generating PDF:", error);

            // Fallback: Create a simple text PDF
            const fallbackPDF = await generateFallbackPDF(billData);
            return fallbackPDF;
          }
        }

        // Update the generatePDFItemsHTML function to ensure it's async
        async function generatePDFItemsHTML(itemsJSON) {
          try {
            const items = JSON.parse(itemsJSON);
            if (!Array.isArray(items))
              return '<tr><td colspan="4">No items</td></tr>';

            return items
              .map(
                (item) => `
        <tr>
            <td>${item.name || "Item"}</td>
            <td>${item.quantity || 1}</td>
            <td>₹${parseFloat(item.unit_price || 0).toFixed(2)}</td>
            <td>₹${parseFloat(item.total_price || 0).toFixed(2)}</td>
        </tr>
    `
              )
              .join("");
          } catch (e) {
            console.error("Error parsing items:", e);

            // Try to extract items from string if not valid JSON
            if (typeof itemsJSON === "string" && itemsJSON.includes("[")) {
              try {
                // Try to manually parse if JSON is malformed
                const cleanedJSON = itemsJSON.replace(/\\/g, "");
                const items = JSON.parse(cleanedJSON);
                if (Array.isArray(items)) {
                  return items
                    .map(
                      (item, index) => `
            <tr>
                <td>Item ${index + 1}</td>
                <td>${item.quantity || 1}</td>
                <td>₹${parseFloat(item.unit_price || 0).toFixed(2)}</td>
                <td>₹${parseFloat(item.total_price || 0).toFixed(2)}</td>
            </tr>
          `
                    )
                    .join("");
                }
              } catch (parseError) {
                console.error("Manual parse failed:", parseError);
              }
            }

            return '<tr><td colspan="4">Error loading items</td></tr>';
          }
        }

        // Add a fallback PDF generator
        async function generateFallbackPDF(billData) {
          console.log(
            "Using fallback PDF generator for bill:",
            billData.bill_number
          );

          // Create a simple text-based PDF
          const doc = new window.jspdf.jsPDF({
            orientation: "portrait",
            unit: "mm",
            format: "a4",
          });

          // Add header
          doc.setFontSize(20);
          doc.setTextColor(255, 123, 172); // Primary color
          doc.text("🎂 Cake Bliss", 105, 20, { align: "center" });

          doc.setFontSize(12);
          doc.setTextColor(128, 128, 128);
          doc.text("Delicious Cakes & Pastries", 105, 27, { align: "center" });

          doc.setFontSize(14);
          doc.setTextColor(157, 78, 221); // Accent color
          doc.text(`Bill: ${billData.bill_number}`, 105, 35, {
            align: "center",
          });

          // Add customer details
          doc.setFontSize(11);
          doc.setTextColor(0, 0, 0);
          doc.text("Customer Details:", 20, 50);
          doc.setFontSize(10);
          doc.text(`Purchaser: ${billData.purchaser_name}`, 25, 57);
          doc.text(`Phone: ${billData.purchaser_phone}`, 25, 62);
          doc.text(`Birthday Person: ${billData.birthday_person_name}`, 25, 67);

          if (billData.birthday_person_phone) {
            doc.text(
              `Birthday Phone: ${billData.birthday_person_phone}`,
              25,
              72
            );
          }

          // Add items
          doc.setFontSize(11);
          doc.text("Order Items:", 20, 85);

          let yPos = 92;
          try {
            const items = JSON.parse(billData.cake_name);
            if (Array.isArray(items)) {
              items.forEach((item, index) => {
                if (yPos > 250) {
                  doc.addPage();
                  yPos = 20;
                }
                doc.text(
                  `${item.name || "Item"} x${
                    item.quantity || 1
                  } - ₹${parseFloat(item.total_price || 0).toFixed(2)}`,
                  25,
                  yPos
                );
                yPos += 7;
              });
            }
          } catch (e) {
            doc.text("Multiple items in order", 25, yPos);
            yPos += 7;
          }

          // Add totals
          yPos += 10;
          doc.setFontSize(11);
          doc.text(
            `Subtotal: ₹${parseFloat(billData.cake_price).toFixed(2)}`,
            140,
            yPos
          );
          yPos += 7;

          if (billData.coupon_code) {
            doc.text(
              `Discount (${billData.coupon_code}): -₹${(
                parseFloat(billData.cake_price) -
                parseFloat(billData.total_price)
              ).toFixed(2)}`,
              140,
              yPos
            );
            yPos += 7;
          }

          doc.setFontSize(14);
          doc.setTextColor(157, 78, 221);
          doc.text(
            `GRAND TOTAL: ₹${parseFloat(billData.total_price).toFixed(2)}`,
            140,
            yPos
          );

          // Add footer
          yPos += 20;
          doc.setFontSize(10);
          doc.setTextColor(128, 128, 128);
          doc.text("Thank you for choosing Cake Bliss! 🎂", 105, yPos, {
            align: "center",
          });
          yPos += 7;
          doc.text(
            `For any queries, call: ${billData.purchaser_phone}`,
            105,
            yPos,
            { align: "center" }
          );
          yPos += 7;
          doc.text(
            `Bill generated on ${new Date().toLocaleString()}`,
            105,
            yPos,
            { align: "center" }
          );

          // Return PDF blob
          return doc.output("blob");
        }

        async function uploadPDFToStorage(pdfBlob, billNumber) {
          try {
            console.log("Starting PDF upload...");

            // Clean filename - NO FOLDERS!
            const fileName = `bill_${billNumber}_${Date.now()}.pdf`;

            console.log("Uploading to bucket 'bills', file:", fileName);

            // Simple upload - no complex options
            const { data, error } = await supabase.storage
              .from("bills") // Only specify bucket here
              .upload(fileName, pdfBlob);

            if (error) {
              console.error("SUPABASE UPLOAD ERROR:", error);
              console.error("Error details:", JSON.stringify(error, null, 2));
              throw error;
            }

            console.log("Upload successful, data:", data);

            // Get URL
            const { data: urlData } = supabase.storage
              .from("bills")
              .getPublicUrl(fileName);

            console.log("Generated URL:", urlData.publicUrl);

            return {
              fileName,
              publicUrl: urlData.publicUrl,
            };
          } catch (error) {
            console.error("COMPLETE UPLOAD FAILURE:", error);
            throw error;
          }
        }

        async function debugStorage() {
          console.log("=== STORAGE DEBUG ===");

          // 1. List buckets
          console.log("1. Listing buckets...");
          const { data: buckets, error: bucketsError } =
            await supabase.storage.listBuckets();
          console.log("Buckets:", buckets);
          console.log("Buckets error:", bucketsError);

          // 2. Check bills bucket specifically
          console.log("\n2. Checking 'bills' bucket...");
          const billsBucket = buckets?.find((b) => b.name === "bills");
          console.log("Bills bucket found:", billsBucket);
          console.log("Is public?", billsBucket?.public);

          // 3. Test upload
          console.log("\n3. Testing upload...");
          const testBlob = new Blob(["TEST"], { type: "text/plain" });
          try {
            const { data, error } = await supabase.storage
              .from("bills")
              .upload("debug_test.txt", testBlob);
            console.log("Test upload result:", data);
            console.log("Test upload error:", error);

            if (!error) {
              // 4. List files to confirm
              console.log("\n4. Listing files in bucket...");
              const { data: files } = await supabase.storage
                .from("bills")
                .list();
              console.log("Files in bucket:", files);
            }
          } catch (err) {
            console.error("Test failed:", err);
          }

          console.log("=== DEBUG END ===");
        }

        async function verifyBucket() {
          console.log("Verifying bucket exists...");

          const { data: buckets, error } = await supabase.storage.listBuckets();

          if (error) {
            console.error("Error listing buckets:", error);
            return;
          }

          console.log("All buckets:", buckets);

          const billsBucket = buckets?.find((b) => b.name === "bills");
          if (billsBucket) {
            console.log("✅ SUCCESS: 'bills' bucket found:", billsBucket);
            console.log("Is public?", billsBucket.public);

            // Test upload
            console.log("Testing upload...");
            const testBlob = new Blob(["Test file"], { type: "text/plain" });
            const uploadResult = await supabase.storage
              .from("bills")
              .upload("verify.txt", testBlob);

            console.log("Upload test:", uploadResult);

            if (!uploadResult.error) {
              alert("🎉 COMPLETE SUCCESS! Bucket created and upload works!");
            }
          } else {
            console.log("❌ 'bills' bucket NOT found");
          }
        }

        // Helper function to check URL accessibility
        async function checkURLAccessibility(url) {
          try {
            const response = await fetch(url, {
              method: "HEAD",
              mode: "no-cors",
            });
            return true; // If no-cors succeeds, URL is accessible
          } catch (error) {
            console.log("URL accessibility check failed:", error);
            return false;
          }
        }

        // Create a direct download link
        function createDirectDownloadLink(pdfUrl) {
          // For Supabase Storage, we need to ensure the URL is direct
          if (pdfUrl.includes("supabase.co/storage/v1/object/public/")) {
            // This should already be a public URL
            return pdfUrl;
          }

          // Try to force download by adding ?download=1 parameter
          if (!pdfUrl.includes("?")) {
            return pdfUrl + "?download=1";
          }

          return pdfUrl;
        }

        // Update the openWhatsAppWithBill function to include discount in the message
        function openWhatsAppWithBill(billData, pdfUrl) {
          try {
            // Format WhatsApp message with customer phone number
            const customerPhone = billData.purchaser_phone;

            // Remove any non-numeric characters and ensure it starts with 91 for India
            const cleanPhone = customerPhone.replace(/\D/g, "");
            const phoneWithCountryCode = cleanPhone.startsWith("91")
              ? cleanPhone
              : "91" + cleanPhone;

            // Format items for WhatsApp - pass the billData to include discount info
            const itemsText = formatItemsForWhatsApp(billData);

            // Calculate discount amount
            const subtotal = parseFloat(billData.cake_price) || 0;
            const total = parseFloat(billData.total_price) || 0;
            const discountAmount = subtotal - total;

            // Create a simpler, more WhatsApp-friendly message
            const message = `🎂 *Cake Bliss - Bill Confirmation* 🎂

*Bill Number:* ${billData.bill_number}
*Customer Name:* ${billData.purchaser_name}
*Date:* ${new Date(billData.created_at).toLocaleDateString("en-IN")}

*Order Items:*
${itemsText}

*Bill Summary:*
Subtotal: ₹${subtotal.toFixed(2)}
${discountAmount > 0 ? `Discount: -₹${discountAmount.toFixed(2)}` : ""}
${billData.coupon_code ? `Coupon Used: ${billData.coupon_code}` : ""}

*Total Amount:* ₹${total.toFixed(2)}
Thank you for your order! 🎂

For any queries, please call: +91 9168281183

-- Cake Bliss Team`;

            // Encode message for URL
            const encodedMessage = encodeURIComponent(message);

            // Create WhatsApp URL
            const whatsappUrl = `https://wa.me/${phoneWithCountryCode}?text=${encodedMessage}`;

            console.log("Opening WhatsApp with URL:", whatsappUrl);
            console.log("PDF URL being sent:", pdfUrl);

            // Check if PDF URL is accessible
            checkURLAccessibility(pdfUrl).then((isAccessible) => {
              if (!isAccessible) {
                console.warn("PDF URL might not be publicly accessible");
                showNotification(
                  "PDF might not be accessible publicly. Checking alternative...",
                  "warning"
                );

                // Try to create a direct download link
                const directDownloadLink = createDirectDownloadLink(pdfUrl);
                if (directDownloadLink) {
                  console.log(
                    "Using direct download link:",
                    directDownloadLink
                  );
                }
              }

              // Open WhatsApp
              const newWindow = window.open(
                whatsappUrl,
                "_blank",
                "noopener,noreferrer"
              );

              if (newWindow) {
                newWindow.focus();
              } else {
                // If popup blocked, provide alternative
                handleWhatsAppPopupBlock(whatsappUrl, message);
              }
            });

            return whatsappUrl;
          } catch (error) {
            console.error("Error creating WhatsApp URL:", error);

            // Fallback: Create a simpler message without PDF link
            const fallbackMessage = `🎂 Cake Bliss Bill\nBill: ${
              billData.bill_number
            }\nAmount: ₹${billData.total_price}\nDate: ${new Date(
              billData.created_at
            ).toLocaleDateString()}`;
            const fallbackUrl = `https://wa.me/91${billData.purchaser_phone.replace(
              /\D/g,
              ""
            )}?text=${encodeURIComponent(fallbackMessage)}`;

            window.open(fallbackUrl, "_blank");
            return null;
          }
        }

        // Update the formatItemsForWhatsApp function to handle the full bill data
        function formatItemsForWhatsApp(billData) {
          try {
            // Try to parse items from cake_name field
            let items = [];

            if (billData.cake_name) {
              // Check if it's a JSON string or already an object
              if (typeof billData.cake_name === "string") {
                try {
                  items = JSON.parse(billData.cake_name);
                } catch (e) {
                  // If not JSON, try to extract items from string
                  console.warn("Could not parse items as JSON:", e);
                  items = [{ name: billData.cake_name, quantity: 1 }];
                }
              } else if (Array.isArray(billData.cake_name)) {
                items = billData.cake_name;
              }
            }

            if (!Array.isArray(items) || items.length === 0) {
              return "No items in order";
            }

            let itemsText = "";
            items.forEach((item, index) => {
              const name = item.name || "Item";
              const qty = item.quantity || 1;
              const price = parseFloat(item.unit_price || item.price || 0);
              const total = parseFloat(item.total_price || price * qty);

              itemsText += `${index + 1}. ${name}\n`;
              itemsText += `   Qty: ${qty} × ₹${price.toFixed(
                2
              )} = ₹${total.toFixed(2)}\n`;
            });

            return itemsText;
          } catch (e) {
            console.error("Error formatting items:", e);
            return "Multiple items in order - see bill for details";
          }
        }

        // Also update the fallback message in case of errors
        function handleWhatsAppPopupBlock(whatsappUrl, message) {
          const userChoice = confirm(
            "WhatsApp window was blocked by your browser.\n\n" +
              "What would you like to do?\n\n" +
              "1. Copy message to clipboard (Recommended)\n" +
              "2. Open link manually"
          );

          if (userChoice) {
            // Copy to clipboard
            navigator.clipboard
              .writeText(message)
              .then(() => {
                alert(
                  "WhatsApp message copied to clipboard!\n\n" +
                    "Please paste it in WhatsApp to send the bill.\n\n" +
                    "You can also access the bill PDF here:\n" +
                    window.lastPdfUrl
                );
              })
              .catch(() => {
                // Fallback for older browsers
                const textArea = document.createElement("textarea");
                textArea.value = message;
                document.body.appendChild(textArea);
                textArea.focus();
                textArea.select();

                try {
                  document.execCommand("copy");
                  alert(
                    "WhatsApp message copied to clipboard!\n\n" +
                      "Please paste it in WhatsApp to send the bill."
                  );
                } catch (err) {
                  alert(
                    "Please manually copy this message and send via WhatsApp:\n\n" +
                      message +
                      "\n\n" +
                      "Bill PDF: " +
                      window.lastPdfUrl
                  );
                }

                document.body.removeChild(textArea);
              });
          } else {
            // Show the URL for manual opening
            alert(
              "Please open this link in WhatsApp:\n\n" +
                whatsappUrl.substring(0, 100) +
                "...\n\n" +
                "Or copy this link: " +
                whatsappUrl
            );
          }
        }

        async function saveBillWithWhatsAppFlow() {
          // ======== ADD THIS BLOCKER AT THE START ========
          if (window.isProcessingBill) {
            console.log("Already processing a bill, please wait...");
            return;
          }
          window.isProcessingBill = true;
          // ===============================================

          const submitBtn = document.getElementById("submitBill");
          const originalText = submitBtn.innerHTML;

          try {
            // Step 1: Validate form
            if (!validateFormBeforeSubmission()) {
              throw new Error("Form validation failed");
            }

            // Step 2: Check items
            const itemRows = document.querySelectorAll(".item-row");
            if (itemRows.length === 0) {
              throw new Error("Please add at least one item");
            }

            // Step 3: Save bill to Supabase
            showNotification("Saving bill to database...", "info");
            const savedBill = await saveBillWithInventoryCheck();

            if (!savedBill) {
              throw new Error("Failed to save bill");
            }

            showNotification("Bill saved! Generating PDF...", "success");

            // Step 4: Generate PDF
            showNotification("Generating PDF...", "info");
            submitBtn.innerHTML =
              '<i class="fas fa-spinner fa-spin"></i> Generating PDF...';

            await new Promise((resolve) => setTimeout(resolve, 1000));
            const pdfBlob = await generateBillPDF(savedBill);

            // Step 5: Upload PDF to Supabase Storage
            showNotification("Uploading PDF to cloud storage...", "info");
            submitBtn.innerHTML =
              '<i class="fas fa-spinner fa-spin"></i> Uploading PDF...';

            const uploadResult = await uploadPDFToStorage(
              pdfBlob,
              savedBill.bill_number
            );

            // Step 6: Update bill record with PDF URL
            try {
              await supabase
                .from("cake_bills")
                .update({
                  pdf_url: uploadResult.publicUrl,
                  updated_at: new Date().toISOString(),
                })
                .eq("id", savedBill.id);
            } catch (updateError) {
              console.warn("Update bill with PDF URL failed:", updateError);
            }

            // Step 7: AUTO-SEND TO WHATSAPP
            showNotification("Opening WhatsApp...", "success");

            window.lastSavedBill = savedBill;
            window.lastPdfUrl = uploadResult.publicUrl;

            window.dispatchEvent(
              new CustomEvent("billSaved", {
                detail: {
                  bill: savedBill,
                  pdfUrl: uploadResult.publicUrl,
                },
              })
            );

            openWhatsAppWithBill(savedBill, uploadResult.publicUrl);

            // Step 8: Reset form automatically after 2 seconds
            setTimeout(() => {
              showNotification(
                `Bill #${savedBill.bill_number} sent to WhatsApp!`,
                "success"
              );

              const autoReset = confirm(
                `✅ Bill #${savedBill.bill_number} sent to WhatsApp!\n\n` +
                  `Do you want to reset the form for a new bill?`
              );

              if (autoReset) {
                document.getElementById("resetForm").click();
              }
            }, 2000);
          } catch (error) {
            console.error("Error in save flow:", error);
            showNotification(
              error.message || "Failed to process bill",
              "error"
            );
          } finally {
            // ======== IMPORTANT: Reset the blocker ========
            window.isProcessingBill = false;
            submitBtn.classList.remove("btn-loading");
            submitBtn.disabled = false;
            submitBtn.innerHTML = originalText;
            // ==============================================
          }
        }
        // Phone number validation functions
        function validatePhoneLength(input) {
          const errorElement = document.getElementById("purchaserPhoneError");
          const value = input.value.trim();

          if (value.length === 0) {
            errorElement.style.display = "none";
            input.style.borderColor = "#eee";
            return true;
          }

          if (value.length !== 10) {
            errorElement.style.display = "block";
            input.style.borderColor = "var(--danger)";
            return false;
          }

          errorElement.style.display = "none";
          input.style.borderColor = "var(--success)";
          return true;
        }

        function validateOptionalPhoneLength(input) {
          const errorElement = document.getElementById("birthdayPhoneError");
          const value = input.value.trim();

          // If empty, it's optional - no error
          if (value.length === 0) {
            errorElement.style.display = "none";
            input.style.borderColor = "#eee";
            return true;
          }

          // If not empty, must be exactly 10 digits
          if (value.length !== 10) {
            errorElement.style.display = "block";
            input.style.borderColor = "var(--danger)";
            return false;
          }

          errorElement.style.display = "none";
          input.style.borderColor = "var(--success)";
          return true;
        }

        function handleGlobalKeyboard(e) {
          if ((e.ctrlKey || e.metaKey) && e.key === "s") {
            e.preventDefault();
            e.stopPropagation();

            // Your save logic
            if (document.getElementById("submitBill")) {
              document.getElementById("submitBill").click();
            }
            return;
          }
          // Don't interfere with text input or textarea
          if (
            (e.target.tagName === "INPUT" && e.target.type === "text") ||
            (e.target.tagName === "INPUT" && e.target.type === "tel") ||
            (e.target.tagName === "INPUT" && e.target.type === "number") ||
            (e.target.tagName === "INPUT" && e.target.type === "date") ||
            e.target.tagName === "TEXTAREA"
          ) {
            // Let the input-specific handlers deal with Enter key
            handleInputKeyboard(e);
            return;
          }

          // Global shortcuts (work everywhere)
          if (e.ctrlKey || e.metaKey) {
            handleControlShortcuts(e);
            return;
          }

          if (e.altKey) {
            handleAltShortcuts(e);
            return;
          }

          // Function keys
          if (e.key.startsWith("F")) {
            handleFunctionKeys(e);
            return;
          }

          // Navigation keys
          switch (e.key) {
            case "Tab":
              e.preventDefault();
              if (e.shiftKey) {
                moveToPreviousField();
              } else {
                moveToNextField();
              }
              break;

            case "ArrowDown":
              e.preventDefault();
              if (currentItemRow) {
                navigateItemRows("down");
              } else {
                moveToNextField();
              }
              break;

            case "ArrowUp":
              e.preventDefault();
              if (currentItemRow) {
                navigateItemRows("up");
              } else {
                moveToPreviousField();
              }
              break;

            case "ArrowRight":
              e.preventDefault();
              if (currentItemRow) {
                navigateItemFields("right");
              }
              break;

            case "ArrowLeft":
              e.preventDefault();
              if (currentItemRow) {
                navigateItemFields("left");
              }
              break;

            case "Escape":
              e.preventDefault();
              clearCurrentField();
              break;

            case "Insert":
              e.preventDefault();
              addItemRow();
              break;

            case "Delete":
              e.preventDefault();
              if (currentItemRow && confirm("Delete current item?")) {
                removeItem(currentItemRow.id);
              }
              break;
          }
        }

        // Add this function to force refresh when page comes into focus
        function setupPageFocusRefresh() {
          window.addEventListener("focus", async function () {
            console.log("Page gained focus, refreshing product catalog...");
            await refreshProductCatalog();
            showNotification("Product catalog refreshed", "info");
          });
        }

        function handleInputKeyboard(e) {
          const target = e.target;

          switch (e.key) {
            case "Enter":
              // Handle Enter based on which field we're in

              if (target.id === "purchaserPhone" && !e.shiftKey) {
                e.preventDefault();

                // Validate phone before checking customer
                if (validatePhoneLength(target)) {
                  manualCheckCustomer();
                } else {
                  showNotification(
                    "Please enter a valid 10-digit phone number",
                    "error"
                  );
                  target.focus();
                  target.select();
                }
              } else if (target.id === "birthdayPersonPhone" && !e.shiftKey) {
                e.preventDefault();

                // Validate optional phone
                if (validateOptionalPhoneLength(target)) {
                  // Valid phone, move to next field
                  moveToNextField();
                } else {
                  showNotification(
                    "Birthday phone must be 10 digits if provided",
                    "error"
                  );
                  target.focus();
                  target.select();
                }
              } else if (target.classList.contains("item-price")) {
                // In price field, Enter adds new item
                e.preventDefault();
                addItemRow();
              } else if (
                target.classList.contains("item-name") ||
                target.classList.contains("item-code") ||
                target.classList.contains("item-qty")
              ) {
                // In item table fields, move to next field
                e.preventDefault();

                const row = target.closest(".item-row");
                if (row) {
                  const inputs = row.querySelectorAll(
                    "input.item-name, input.item-code, input.item-qty, input.item-price"
                  );
                  const currentIndex = Array.from(inputs).indexOf(target);

                  if (currentIndex < inputs.length - 1) {
                    // Move to next field in same row
                    inputs[currentIndex + 1].focus();
                    inputs[currentIndex + 1].select();
                  } else {
                    // Last field in row (price field), add new item
                    addItemRow();
                    setTimeout(() => {
                      document
                        .querySelector(".item-row:last-child .item-name")
                        .focus();
                    }, 50);
                  }
                }
              } else if (target.type === "button" || target.type === "submit") {
                // For buttons, let the click handler work
                return;
              } else {
                // For all other inputs, move to next field
                e.preventDefault();

                // Validate phone fields on Enter before moving
                if (target.id === "purchaserPhone") {
                  if (!validatePhoneLength(target)) {
                    showNotification(
                      "Please enter a valid 10-digit phone number",
                      "error"
                    );
                    target.focus();
                    target.select();
                    return;
                  }
                } else if (target.id === "birthdayPersonPhone") {
                  if (!validateOptionalPhoneLength(target)) {
                    showNotification(
                      "Birthday phone must be 10 digits if provided",
                      "error"
                    );
                    target.focus();
                    target.select();
                    return;
                  }
                }

                moveToNextField();
              }
              break;

            case "Tab":
              e.preventDefault();

              // Validate phone fields before moving away
              if (target.id === "purchaserPhone") {
                if (!validatePhoneLength(target)) {
                  showNotification(
                    "Purchaser phone must be 10 digits",
                    "error"
                  );
                  target.focus();
                  target.select();
                  return;
                }
              } else if (target.id === "birthdayPersonPhone") {
                const value = target.value.trim();
                if (value && !validateOptionalPhoneLength(target)) {
                  showNotification(
                    "Birthday phone must be 10 digits if provided",
                    "error"
                  );
                  target.focus();
                  target.select();
                  return;
                }
              }

              if (e.shiftKey) {
                moveToPreviousField();
              } else {
                moveToNextField();
              }
              break;

            case "Escape":
              e.preventDefault();
              e.target.value = "";

              // Clear phone validation styling
              // if (target.id === "purchaserPhone" || target.id === "birthdayPersonPhone") {
              //     target.style.borderColor = "#eee";
              //     document.getElementById(`${target.id}Error`)?.style.display = "none";
              // }
              break;

            case "ArrowDown":
              if (
                target.classList.contains("item-name") ||
                target.classList.contains("item-code")
              ) {
                // Allow default behavior for datalist dropdown
                return;
              }
              e.preventDefault();

              // Validate phone before moving
              if (
                target.id === "purchaserPhone" &&
                !validatePhoneLength(target)
              ) {
                showNotification(
                  "Please enter a valid 10-digit phone number",
                  "error"
                );
                return;
              } else if (target.id === "birthdayPersonPhone") {
                const value = target.value.trim();
                if (value && !validateOptionalPhoneLength(target)) {
                  showNotification(
                    "Birthday phone must be 10 digits if provided",
                    "error"
                  );
                  return;
                }
              }

              if (currentItemRow) {
                navigateItemRows("down");
              } else {
                moveToNextField();
              }
              break;

            case "ArrowUp":
              if (
                target.classList.contains("item-name") ||
                target.classList.contains("item-code")
              ) {
                // Allow default behavior for datalist dropdown
                return;
              }
              e.preventDefault();

              // Validate phone before moving
              if (
                target.id === "purchaserPhone" &&
                !validatePhoneLength(target)
              ) {
                showNotification(
                  "Please enter a valid 10-digit phone number",
                  "error"
                );
                return;
              } else if (target.id === "birthdayPersonPhone") {
                const value = target.value.trim();
                if (value && !validateOptionalPhoneLength(target)) {
                  showNotification(
                    "Birthday phone must be 10 digits if provided",
                    "error"
                  );
                  return;
                }
              }

              if (currentItemRow) {
                navigateItemRows("up");
              } else {
                moveToPreviousField();
              }
              break;

            case "Backspace":
            case "Delete":
              // Allow normal backspace/delete behavior in phone fields
              if (
                target.id === "purchaserPhone" ||
                target.id === "birthdayPersonPhone"
              ) {
                // Just let the normal behavior happen
                // The oninput handler will validate after the keypress
                return;
              }
              break;

            default:
              // For phone fields, restrict to numbers only
              if (
                (target.id === "purchaserPhone" ||
                  target.id === "birthdayPersonPhone") &&
                !e.ctrlKey &&
                !e.metaKey &&
                !e.altKey
              ) {
                // Allow navigation keys
                if (e.key.length === 1 && !/[0-9]/.test(e.key)) {
                  e.preventDefault();
                  showNotification(
                    "Phone number can only contain digits 0-9",
                    "warning"
                  );
                  return;
                }

                // If pressing a number, check if we'll exceed 10 digits
                if (/[0-9]/.test(e.key)) {
                  const currentValue = target.value.replace(/[^0-9]/g, "");
                  if (currentValue.length >= 10 && !target.selectionStart) {
                    e.preventDefault();
                    showNotification(
                      "Phone number is limited to 10 digits",
                      "warning"
                    );
                    return;
                  }
                }
              }
              break;
          }
        }

        function handleControlShortcuts(e) {
          switch (e.key.toLowerCase()) {
            case "s": // Save/Create bill with Ctrl+S
              e.preventDefault();
              e.stopPropagation(); // Prevent any other handlers

              // Validate and submit
              if (document.getElementById("submitBill")) {
                document.getElementById("submitBill").click();
              }
              break;

            // In handleAltShortcuts function
            case "c": // Coupons management
              e.preventDefault();
              document.getElementById("manageCouponsBtn")?.click();
              break;

            case "r": // Reset form
              e.preventDefault();
              document.getElementById("resetForm")?.click();
              break;

            case "n": // New item
              e.preventDefault();
              addItemRow();
              break;

            case "d": // Duplicate current item
              e.preventDefault();
              duplicateCurrentItem();
              break;

            case "f": // Find customer
              e.preventDefault();
              manualCheckCustomer();
              break;

            case "p": // Print/View receipt
              e.preventDefault();
              showKeyboardHelp();
              break;

            case "h": // Help
              e.preventDefault();
              showKeyboardHelp();
              break;

            case "l": // Load recent bills
              e.preventDefault();
              loadRecentBills();
              showNotification("Recent bills refreshed", "info");
              break;

            case "1": // Focus on phone field
              e.preventDefault();
              focusField("purchaserPhone");
              break;

            case "2": // Focus on name field
              e.preventDefault();
              focusField("purchaserName");
              break;

            case "3": // Add new item
              e.preventDefault();
              addItemRow();
              break;
          }
        }

        function handleAltShortcuts(e) {
          switch (
            e.key.toLowerCase() // Use lowercase to match both cases
          ) {
            case "1": // Go to phone field
              e.preventDefault();
              focusField("purchaserPhone");
              break;

            case "2": // Go to purchaser name
              e.preventDefault();
              focusField("purchaserName");
              break;

            case "3": // Go to birthday person name
              e.preventDefault();
              focusField("birthdayPersonName");
              break;

            case "4": // Go to birthday person phone
              e.preventDefault();
              focusField("birthdayPersonPhone");
              break;

            case "5": // Add item
              e.preventDefault();
              addItemRow();
              break;

            case "6": // Go to discount field
              e.preventDefault();
              focusField("couponCode");
              break;

            case "7": // Submit bill
              e.preventDefault();
              document.getElementById("submitBill")?.click();
              break;

            case "8": // Reset form
              e.preventDefault();
              document.getElementById("resetForm")?.click();
              break;

            case "9": // Check customer
              e.preventDefault();
              manualCheckCustomer();
              break;

            case "0": // Database setup
              e.preventDefault();
              document.getElementById("setupDbBtn")?.click();
              break;

            case "d": // Discount field (new shortcut)
              e.preventDefault();
              focusField("couponCode");
              break;

            case "h": // Help
              e.preventDefault();
              showKeyboardHelp();
              break;
          }
        }

        function handleFunctionKeys(e) {
          e.preventDefault();
          switch (e.key) {
            case "F1": // Help
              showKeyboardHelp();
              break;

            case "F2": // Check customer
              manualCheckCustomer();
              break;

            case "F3": // Add item
              addItemRow();
              break;

            case "F4": // Duplicate item
              duplicateCurrentItem();
              break;

            case "F5": // Refresh products - FIX THIS
              refreshProductCatalog(); // Changed from refreshProducts()
              break;

            case "F6": // Clear current field
              clearCurrentField();
              break;

            case "F7": // Today's date in birthday field
              setTodaysDate();
              break;

            case "F8": // Repeat last customer
              repeatLastCustomer();
              break;

            case "F9": // Quick save
              document.getElementById("submitBill")?.click();
              break;

            case "F10": // Quick reset
              document.getElementById("resetForm")?.click();
              break;

            case "F11": // Toggle fullscreen
              toggleFullscreen();
              break;

            case "F12": // Developer tools (let default)
              return;
          }
        }

        function moveToNextField() {
          removeFocusIndicators();

          if (currentItemRow) {
            // If in item table, move to next item field
            if (currentItemField < 3) {
              currentItemField++;
              focusCurrentItemField();
            } else {
              // Last field in item row, go to Add Item button
              currentItemRow = null;
              currentItemField = 0;
              focusField("addItemBtn");
            }
          } else {
            // Move to next form field (skip item table)
            currentFieldIndex = (currentFieldIndex + 1) % formFields.length;
            const nextField = formFields[currentFieldIndex];

            // Skip item table fields (they're handled separately)
            if (nextField && nextField.id === "addItemBtn") {
              // If next is Add Item button, that's fine
              nextField.focus();
              nextField.classList.add("keyboard-focus");
            } else if (nextField) {
              nextField.focus();
              nextField.classList.add("keyboard-focus");
              if (
                nextField.tagName === "INPUT" &&
                nextField.type !== "button"
              ) {
                setTimeout(() => nextField.select(), 10);
              }
            }
          }
        }

        function moveToPreviousField() {
          removeFocusIndicators();

          if (currentItemRow) {
            // If in item table, move to previous item field
            if (currentItemField > 0) {
              currentItemField--;
              focusCurrentItemField();
            } else {
              // First field in item row, go to previous form field
              currentItemRow = null;
              currentItemField = 0;
              moveToPreviousFieldInForm();
            }
          } else {
            moveToPreviousFieldInForm();
          }
        }

        function moveToPreviousFieldInForm() {
          // Move to previous form field
          currentFieldIndex =
            currentFieldIndex > 0
              ? currentFieldIndex - 1
              : formFields.length - 1;
          const prevField = formFields[currentFieldIndex];

          if (prevField) {
            prevField.focus();
            prevField.classList.add("keyboard-focus");
            if (prevField.tagName === "INPUT" && prevField.type !== "button") {
              setTimeout(() => prevField.select(), 10);
            }
          }
        }

        function focusField(fieldId) {
          const field = document.getElementById(fieldId);
          if (field) {
            removeFocusIndicators();
            field.focus();
            field.classList.add("keyboard-focus");
            if (field.tagName === "INPUT" && field.type !== "button") {
              setTimeout(() => field.select(), 10);
            }

            // Update current field index
            currentFieldIndex = formFields.findIndex((f) => f.id === fieldId);
            if (currentFieldIndex === -1) currentFieldIndex = 0;
          }
        }

        function removeFocusIndicators() {
          document.querySelectorAll(".keyboard-focus").forEach((el) => {
            el.classList.remove("keyboard-focus");
          });
          document.querySelectorAll(".current-item-row").forEach((el) => {
            el.classList.remove("current-item-row");
          });
          document.querySelectorAll(".current-item-field").forEach((el) => {
            el.classList.remove("current-item-field");
          });
        }

        function clearCurrentField() {
          const active = document.activeElement;
          if (
            active &&
            (active.type === "text" ||
              active.type === "tel" ||
              active.type === "number")
          ) {
            active.value = "";
            showNotification("Field cleared", "info");
          }
        }

        function setTodaysDate() {
          const today = new Date().toISOString().split("T")[0];
          document.getElementById("birthdayPersonBirthdate").value = today;
          showNotification("Today's date set in birthday field", "info");
        }

        function repeatLastCustomer() {
          if (lastCustomerData) {
            autoFillCustomerForm(lastCustomerData);
            showNotification("Last customer details repeated", "success");
          } else {
            showNotification("No previous customer found", "warning");
          }
        }

        function toggleFullscreen() {
          if (!document.fullscreenElement) {
            document.documentElement.requestFullscreen();
          } else if (document.exitFullscreen) {
            document.exitFullscreen();
          }
        }

        function duplicateCurrentItem() {
          if (currentItemRow) {
            const name = currentItemRow.querySelector(".item-name").value;
            const code = currentItemRow.querySelector(".item-code").value;
            const price =
              parseFloat(currentItemRow.querySelector(".item-price").value) ||
              0;
            const qty =
              parseInt(currentItemRow.querySelector(".item-qty").value) || 1;

            addItemRow(code, name, price, qty);
            showNotification("Item duplicated", "success");
          }
        }

        function navigateItemRows(direction) {
          updateItemRows();

          if (itemRows.length === 0) return;

          let currentIndex = currentItemRow
            ? itemRows.indexOf(currentItemRow)
            : -1;

          if (direction === "down") {
            if (currentIndex < itemRows.length - 1) {
              currentIndex++;
            } else {
              // Exit item table, go to next form field
              currentItemRow = null;
              currentItemField = 0;
              moveToNextField();
              return;
            }
          } else {
            // up
            if (currentIndex > 0) {
              currentIndex--;
            } else {
              // Exit item table, go to previous form field
              currentItemRow = null;
              currentItemField = 0;
              moveToPreviousField();
              return;
            }
          }

          currentItemRow = itemRows[currentIndex];
          currentItemField = 0;
          highlightCurrentItem();
          focusCurrentItemField();
        }

        function navigateItemFields(direction) {
          if (!currentItemRow) return;

          if (direction === "right") {
            if (currentItemField < 3) {
              currentItemField++;
            }
          } else {
            // left
            if (currentItemField > 0) {
              currentItemField--;
            }
          }

          focusCurrentItemField();
        }

        function updateItemRows() {
          itemRows = Array.from(document.querySelectorAll(".item-row"));
        }

        function highlightCurrentItem() {
          document.querySelectorAll(".item-row").forEach((row) => {
            row.classList.remove("current-item-row");
          });
          if (currentItemRow) {
            currentItemRow.classList.add("current-item-row");
            currentItemRow.scrollIntoView({
              behavior: "smooth",
              block: "nearest",
            });
          }
        }

        function focusCurrentItemField() {
          if (!currentItemRow) return;

          const fields = [
            currentItemRow.querySelector(".item-name"),
            currentItemRow.querySelector(".item-code"),
            currentItemRow.querySelector(".item-qty"),
            currentItemRow.querySelector(".item-price"),
          ];

          document.querySelectorAll(".item-row input").forEach((input) => {
            input.classList.remove("current-item-field");
          });

          if (fields[currentItemField]) {
            fields[currentItemField].focus();
            fields[currentItemField].classList.add("current-item-field");
            if (fields[currentItemField].type !== "number") {
              setTimeout(() => fields[currentItemField].select(), 10);
            }
          }

          highlightCurrentItem();
        }

        function showKeyboardHelp() {
          const helpText = `
      ╔══════════════════════════════════════════════════════════════╗
      ║                    🎂 CAKE BLISS - KEYBOARD SHORTCUTS 🎂    ║
      ╠══════════════════════════════════════════════════════════════╣
      ║ NAVIGATION:                                                  ║
      ║   Tab / Shift+Tab  → Next/Previous field                     ║
      ║   Enter            → Next field / Add new item               ║
      ║   Esc              → Clear current field                     ║
      ║   ↑↓←→             → Navigate items table                    ║
      ║                                                              ║
      ║ ITEM TABLE:                                                  ║
      ║   Enter in last field (price) → Add new item                 ║
      ║   Insert                      → Add new item                 ║
      ║   Delete                      → Delete current item          ║
      ║   ↑↓                          → Move between rows            ║
      ║   ←→                          → Move between fields in row   ║
      ║                                                              ║
      ║ FUNCTION KEYS:                                               ║
      ║   F1  → This help                                            ║
      ║   F2  → Check customer                                       ║
      ║   F3  → Add new item                                         ║
      ║   F4  → Duplicate current item                               ║
      ║   F5  → Refresh products                                     ║
      ║   F6  → Clear field                                          ║
      ║   F7  → Set today's date                                     ║
      ║   F8  → Repeat last customer                                 ║
      ║   F9  → Quick save (Submit)                                  ║
      ║   F10 → Quick reset                                          ║
      ║   F11 → Toggle fullscreen                                    ║
      ║                                                              ║
      ║ CONTROL SHORTCUTS (Ctrl+):                                   ║
      ║   S  → Save/Submit bill                                      ║
      ║   R  → Reset form                                            ║
      ║   N  → New item                                              ║
      ║   D  → Duplicate item                                        ║
      ║   F  → Find customer                                         ║
      ║   H  → Help                                                  ║
      ║   1  → Phone field                                           ║
      ║   2  → Name field                                            ║
      ║   3  → Add item                                              ║
      ║                                                              ║
      ║ ALT SHORTCUTS (Alt+):                                        ║
      ║   1 → Phone field                                            ║
      ║   2 → Purchaser name                                         ║
      ║   3 → Birthday person name                                   ║
      ║   4 → Birthday person phone                                  ║
      ║   5 → Add new item                                           ║
      ║   6 → Discount code field                                    ║
      ║   7 → Submit bill                                            ║
      ║   8 → Reset form                                             ║
      ║   9 → Check customer                                         ║
      ║   0 → Database setup                                         ║
      ║   D → Discount code field                                    ║
      ║   H → Help                                                   ║
      ╚══════════════════════════════════════════════════════════════╝
          `;

          alert(helpText);
        }

        // ==================== SUPABASE & CORE FUNCTIONS ====================

        async function initSupabase() {
          if (config.supabaseUrl && config.supabaseKey) {
            try {
              supabase = window.supabase.createClient(
                config.supabaseUrl,
                config.supabaseKey
              );
              updateDbStatus(true);

              // Test connection by checking if we can query
              console.log("Testing Supabase connection...");

              // Load products from Supabase
              await loadProductsFromSupabase();

              // Load coupons from Supabase
              await loadCoupons();

              // Load recent bills
              await loadRecentBills();

              console.log("Supabase connected successfully");
              showNotification("Connected to Supabase database!", "success");
              return true;
            } catch (error) {
              console.error("Error initializing Supabase:", error);
              updateDbStatus(false);
              showNotification(
                "Failed to connect to Supabase: " + error.message,
                "error"
              );
              return false;
            }
          } else {
            updateDbStatus(false);
            return false;
          }
        }

        // Update database connection status
        function updateDbStatus(connected) {
          isConnected = connected;
          const dbStatus = document.getElementById("dbStatus");
          const statusDot = dbStatus.querySelector(".status-dot");
          const statusText = dbStatus.querySelector("span");

          if (connected) {
            dbStatus.className = "db-status connected";
            statusDot.className = "status-dot connected";
            statusText.textContent = "Supabase: Connected";
          } else {
            dbStatus.className = "db-status disconnected";
            statusDot.className = "status-dot disconnected";
            statusText.textContent = "Supabase: Disconnected";
          }
        }

        // Show notification
        function showNotification(message, type = "success") {
          const notification = document.getElementById("notification");
          const icon = notification.querySelector("i");
          const text = notification.querySelector("span");

          notification.className = `notification ${type}`;
          text.textContent = message;

          if (type === "success") {
            icon.className = "fas fa-check-circle";
          } else if (type === "error") {
            icon.className = "fas fa-exclamation-circle";
          } else {
            icon.className = "fas fa-info-circle";
          }

          notification.classList.add("show");

          setTimeout(() => {
            notification.classList.remove("show");
          }, 3000);
        }

        // Load products from product_batches table
        async function loadProductsFromSupabase() {
          if (!supabase) {
            console.log("Supabase not initialized");
            return;
          }

          try {
            console.log("Fetching products from product_batches...");

            // Get today's date for expiry filtering
            const today = new Date().toISOString().split("T")[0];

            // Fetch all active batches (not expired, with remaining quantity)
            const { data: batches, error } = await supabase
              .from("product_batches")
              .select(
                `
              *,
              products:product_code (product_name, category, unit_price, description, is_active)
            `
              )
              .gte("remaining_quantity", 1)
              .gte("expiry_date", today)
              .order("expiry_date", { ascending: true }); // Nearest expiry first

            if (error) {
              console.error("Error loading batches:", error);
              showNotification(
                "Failed to load products: " + error.message,
                "error"
              );
              return;
            }

            if (batches && batches.length > 0) {
              // Process batches to group by product and aggregate stock
              const productsByCode = {};

              batches.forEach((batch) => {
                const productCode = batch.product_code;

                if (!productsByCode[productCode]) {
                  // Create product entry from first batch
                  productsByCode[productCode] = {
                    product_code: productCode,
                    product_name: batch.products?.product_name || productCode,
                    category: batch.products?.category || "Uncategorized",
                    unit_price:
                      batch.products?.unit_price || batch.unit_cost || 0,
                    description: batch.products?.description || "",
                    is_active: batch.products?.is_active !== false,
                    total_stock: 0,
                    batches: [],
                    nearest_expiry: batch.expiry_date,
                  };
                }

                // Add to total stock
                productsByCode[productCode].total_stock +=
                  batch.remaining_quantity;

                // Add batch details
                productsByCode[productCode].batches.push({
                  id: batch.id,
                  quantity: batch.quantity,
                  remaining_quantity: batch.remaining_quantity,
                  unit_cost: batch.unit_cost,
                  manufacture_date: batch.manufacture_date,
                  expiry_date: batch.expiry_date,
                  shelf_life_days: batch.shelf_life_days,
                  days_until_expiry: Math.ceil(
                    (new Date(batch.expiry_date) - new Date()) /
                      (1000 * 60 * 60 * 24)
                  ),
                });

                // Update nearest expiry if this batch expires sooner
                if (
                  new Date(batch.expiry_date) <
                  new Date(productsByCode[productCode].nearest_expiry)
                ) {
                  productsByCode[productCode].nearest_expiry =
                    batch.expiry_date;
                }
              });

              // Convert to array and filter active products
              const products = Object.values(productsByCode).filter(
                (product) => product.is_active
              );

              allProducts = products;
              updateProductCatalog(products);
              updateGlobalDatalists(products);

              // Update stock display (already included in the product data)
              updateStockDisplayFromBatches(products);

              console.log(
                `Loaded ${products.length} products from ${batches.length} batches`
              );
              showNotification(
                `Loaded ${products.length} products (${batches.length} batches)`,
                "success"
              );
            } else {
              console.log("No active batches found in database");
              showNotification("No active products available", "warning");

              // Clear product catalog
              const dynamicContainer = document.getElementById(
                "dynamicProductCatalog"
              );
              dynamicContainer.innerHTML = `
              <div class="no-products" style="text-align: center; padding: 40px;">
                <i class="fas fa-box-open" style="font-size: 48px; color: #ddd; margin-bottom: 15px;"></i>
                <p style="color: #666;">No active products available</p>
                <p style="color: #999; font-size: 12px; margin-top: 10px;">All batches are expired or out of stock</p>
              </div>
            `;
            }
          } catch (error) {
            console.error("Error loading products:", error);
            showNotification("Failed to load products from database", "error");
          }
        }

        // Helper function to update stock display from batches
        function updateStockDisplayFromBatches(products) {
          products.forEach((product) => {
            const productItem = document.getElementById(
              `product-${product.product_code}`
            );
            if (!productItem) return;

            const detailsDiv = productItem.querySelector(".product-details");
            if (!detailsDiv) return;

            // Remove ALL existing stock elements completely
            const existingStockContainer = productItem.querySelector(
              ".stock-display-container"
            );
            if (existingStockContainer) {
              existingStockContainer.remove();
            }

            // Determine stock status
            let stockBadge = "";
            let stockText = "";
            let batchInfo = "";
            let stockClass = "";

            if (product.total_stock === 0) {
              stockBadge = '<span class="stock-badge out-of-stock">OUT</span>';
              stockText = "Out of stock";
              stockClass = "out-of-stock";
              productItem.classList.add("out-of-stock");
            } else if (product.total_stock <= 3) {
              stockBadge = '<span class="stock-badge low-stock">LOW</span>';
              stockText = `Stock: ${product.total_stock} units`;
              stockClass = "low-stock";
            } else if (product.total_stock <= 10) {
              stockBadge = '<span class="stock-badge medium-stock">MED</span>';
              stockText = `Stock: ${product.total_stock} units`;
              stockClass = "medium-stock";
            } else {
              stockBadge = '<span class="stock-badge in-stock">IN</span>';
              stockText = `Stock: ${product.total_stock} units`;
              stockClass = "in-stock";
            }

            // Add batch info if available
            if (product.batches && product.batches.length > 0) {
              const nearestExpiry = new Date(
                product.nearest_expiry
              ).toLocaleDateString();
              batchInfo = ` | Exp: ${nearestExpiry}`;
              if (product.batches.length > 1) {
                batchInfo += ` (${product.batches.length} batches)`;
              }
            }

            // Create a single container for all stock info
            const stockContainer = document.createElement("div");
            stockContainer.className = "stock-display-container";
            stockContainer.style.marginTop = "2px";

            // Add stock info message
            stockContainer.innerHTML = `
            <div style="display: flex; align-items: center; gap: 4px;">
              ${stockBadge}
              <span style="font-size: 9px; color: #666;">
                ${stockText}${batchInfo}
              </span>
            </div>
          `;

            detailsDiv.appendChild(stockContainer);

            // Update dataset
            productItem.dataset.stock = product.total_stock;
            productItem.dataset.hasStock =
              product.total_stock > 0 ? "true" : "false";
            productItem.dataset.batchCount = product.batches?.length || 0;

            // Update tooltip with batch details
            let tooltipText = product.description || "";
            if (product.batches && product.batches.length > 0) {
              tooltipText += `\n\nBatch Details:\n`;
              product.batches.forEach((batch, index) => {
                const expDate = new Date(
                  batch.expiry_date
                ).toLocaleDateString();
                const manDate = new Date(
                  batch.manufacture_date
                ).toLocaleDateString();
                tooltipText += `Batch ${index + 1}: ${
                  batch.remaining_quantity
                } units\n`;
                tooltipText += `  Manufactured: ${manDate}\n`;
                tooltipText += `  Expires: ${expDate}\n`;
                if (batch.shelf_life_days) {
                  tooltipText += `  Shelf Life: ${batch.shelf_life_days} days\n`;
                }
                tooltipText += `\n`;
              });
            }
            productItem.title = tooltipText;

            // Update warning class on product name
            const productName = detailsDiv.querySelector("h4");
            if (productName) {
              if (product.total_stock <= 3) {
                productName.classList.add("stock-warning");
              } else {
                productName.classList.remove("stock-warning");
              }
            }
          });
        }

        // NEW: Fetch all stock data in one query from product_batches
        async function getAllProductStock() {
          if (!supabase) return {};

          try {
            const today = new Date().toISOString().split("T")[0];

            // Fetch ALL active batches in ONE query
            const { data: allBatches, error } = await supabase
              .from("product_batches")
              .select("product_code, remaining_quantity, expiry_date")
              .gte("remaining_quantity", 1)
              .gte("expiry_date", today);

            if (error) {
              console.error("Error fetching all batches:", error);
              return {};
            }

            // Group batches by product code
            const stockByProduct = {};
            if (allBatches) {
              allBatches.forEach((batch) => {
                if (!stockByProduct[batch.product_code]) {
                  stockByProduct[batch.product_code] = {
                    totalStock: 0,
                    batches: [],
                  };
                }
                stockByProduct[batch.product_code].totalStock +=
                  batch.remaining_quantity;
                stockByProduct[batch.product_code].batches.push(batch);
              });
            }

            return stockByProduct;
          } catch (error) {
            console.error("Error in getAllProductStock:", error);
            return {};
          }
        }

        // NEW: Optimized stock update function
        async function updateStockForAllProducts(products) {
          if (!products || !products.length) return;

          try {
            // Fetch all stock data ONCE
            const stockByProduct = await getAllProductStock();

            // Update each product
            products.forEach((product) => {
              const productCode = product.product_code;
              const productItem = document.getElementById(
                `product-${productCode}`
              );

              if (!productItem) return;

              const stockData = stockByProduct[productCode];
              const totalStock = stockData ? stockData.totalStock : 0;
              const batches = stockData ? stockData.batches : [];

              // Update stock badge
              let stockBadge = "";
              let stockText = "";
              let stockClass = "";

              if (totalStock === 0) {
                stockBadge =
                  '<span class="stock-badge out-of-stock">OUT</span>';
                stockText = "Out of stock";
                stockClass = "out-of-stock";
                productItem.classList.add("out-of-stock");
              } else if (totalStock <= 3) {
                stockBadge = '<span class="stock-badge low-stock">LOW</span>';
                stockText = `Stock: ${totalStock} units`;
                stockClass = "low-stock";
              } else if (totalStock <= 10) {
                stockBadge =
                  '<span class="stock-badge medium-stock">MED</span>';
                stockText = `Stock: ${totalStock} units`;
                stockClass = "medium-stock";
              } else {
                stockBadge = '<span class="stock-badge in-stock">IN</span>';
                stockText = `Stock: ${totalStock} units`;
                stockClass = "in-stock";
              }

              // Add batch info if available
              let batchInfo = "";
              if (batches.length > 0) {
                const nearestExpiry = new Date(
                  batches[0].expiry_date
                ).toLocaleDateString();
                batchInfo = ` | Exp: ${nearestExpiry}`;
                if (batches.length > 1) {
                  batchInfo += ` (${batches.length} batches)`;
                }
              }

              // Update the product item
              const detailsDiv = productItem.querySelector(".product-details");
              if (!detailsDiv) return;

              // Remove existing stock elements
              const existingBadge = productItem.querySelector(".stock-badge");
              const existingMessage = productItem.querySelector(
                ".stock-info-message"
              );
              if (existingBadge) existingBadge.remove();
              if (existingMessage) existingMessage.remove();

              // Add stock badge after product code
              const productCodeElement =
                detailsDiv.querySelector(".product-code");
              if (productCodeElement) {
                const badgeContainer = document.createElement("div");
                badgeContainer.style.display = "inline-block";
                badgeContainer.style.marginLeft = "8px";
                badgeContainer.innerHTML = stockBadge;
                productCodeElement.parentNode.insertBefore(
                  badgeContainer,
                  productCodeElement.nextSibling
                );
              }

              // Add stock info message
              const stockMessage = document.createElement("div");
              stockMessage.className = "stock-info-message";
              stockMessage.style.fontSize = "9px";
              stockMessage.style.color = "#666";
              stockMessage.style.marginTop = "2px";
              stockMessage.textContent = stockText + batchInfo;
              detailsDiv.appendChild(stockMessage);

              // Update dataset
              productItem.dataset.stock = totalStock;
              productItem.dataset.hasStock = totalStock > 0 ? "true" : "false";

              // Update tooltip with batch details
              let tooltipText = productItem.title.split("\n")[0];
              if (batches.length > 0) {
                tooltipText += `\nBatch Details:\n`;
                batches.forEach((batch, index) => {
                  const expDate = new Date(
                    batch.expiry_date
                  ).toLocaleDateString();
                  tooltipText += `Batch ${index + 1}: ${
                    batch.remaining_quantity
                  } units (Exp: ${expDate})\n`;
                });
              }
              productItem.title = tooltipText;

              // Update warning class on product name
              const productName = detailsDiv.querySelector("h4");
              if (productName) {
                if (totalStock <= 3) {
                  productName.classList.add("stock-warning");
                } else {
                  productName.classList.remove("stock-warning");
                }
              }
            });

            console.log(`Stock updated for ${products.length} products`);
          } catch (error) {
            console.error("Error updating stock for all products:", error);

            // Set a default "Stock: Unknown" message if there's an error
            products.forEach((product) => {
              const productItem = document.getElementById(
                `product-${product.product_code}`
              );
              if (productItem) {
                const detailsDiv =
                  productItem.querySelector(".product-details");
                if (detailsDiv) {
                  const stockMessage = document.createElement("div");
                  stockMessage.className = "stock-info-message";
                  stockMessage.style.fontSize = "9px";
                  stockMessage.style.color = "#999";
                  stockMessage.style.marginTop = "2px";
                  stockMessage.textContent = "Stock: Checking...";
                  detailsDiv.appendChild(stockMessage);
                }
              }
            });
          }
        }

        // Update product catalog with data from Supabase
        function updateProductCatalog(products) {
          const catalogCard = document.querySelector(".catalog-card");
          if (!catalogCard) {
            console.error("Catalog card element not found");
            return;
          }

          // Clear existing static content
          catalogCard.innerHTML = `
          <h3><i class="fas fa-boxes"></i> Product Catalog</h3>
          <div id="dynamicProductCatalog"></div>
        `;

          const dynamicContainer = document.getElementById(
            "dynamicProductCatalog"
          );

          if (!products || products.length === 0) {
            dynamicContainer.innerHTML = `
            <div class="no-products" style="text-align: center; padding: 40px;">
              <i class="fas fa-box-open" style="font-size: 48px; color: #ddd; margin-bottom: 15px;"></i>
              <p style="color: #666;">No products found in database</p>
              <button onclick="refreshProducts()" class="btn" style="margin-top: 15px;">
                <i class="fas fa-sync-alt"></i> Refresh Products
              </button>
            </div>
          `;
            return;
          }

          // Group products by category
          const productsByCategory = {};
          products.forEach((product) => {
            if (!product.category) {
              product.category = "Uncategorized"; // Default category
            }

            if (!productsByCategory[product.category]) {
              productsByCategory[product.category] = [];
            }
            productsByCategory[product.category].push(product);
          });

          // Get category icons mapping
          const categoryIcons = {
            Cakes: "fa-birthday-cake",
            Pastries: "fa-cookie-bite",
            Decorations: "fa-gift",
            Beverages: "fa-coffee",
            Cookies: "fa-cookie",
            Desserts: "fa-ice-cream",
            Uncategorized: "fa-box",
          };

          // Generate HTML for each category
          let catalogHTML = "";

          // Sort categories alphabetically
          const sortedCategories = Object.keys(productsByCategory).sort();

          if (sortedCategories.length === 0) {
            dynamicContainer.innerHTML = `
            <div class="no-products" style="text-align: center; padding: 40px;">
              <i class="fas fa-box-open" style="font-size: 48px; color: #ddd; margin-bottom: 15px;"></i>
              <p style="color: #666;">No products available</p>
            </div>
          `;
            return;
          }

          sortedCategories.forEach((category) => {
            const icon = categoryIcons[category] || "fa-box";
            const categoryProducts = productsByCategory[category];

            if (categoryProducts.length === 0) return;

            catalogHTML += `
            <div class="product-category">
              <div class="category-title">
                <i class="fas ${icon}"></i> ${category}
                <span style="font-size: 12px; color: #999; margin-left: 10px;">
                  (${categoryProducts.length} items)
                </span>
              </div>
          `;

            // In updateProductCatalog(), update the product item HTML:
            categoryProducts.forEach((product) => {
              const nearestExpiry = product.nearest_expiry
                ? new Date(product.nearest_expiry).toLocaleDateString()
                : "N/A";
              const batchCount = product.batches?.length || 0;

              catalogHTML += `
      <div class="product-item"
           data-code="${product.product_code}"
           data-name="${product.product_name}"
           data-price="${product.unit_price}"
           data-category="${product.category}"
           data-stock="${product.total_stock}"
           data-batches="${batchCount}"
           title="${product.description || ""}"
           tabindex="0"
           id="product-${product.product_code}">
        <div class="product-icon">
          <i class="fas ${getProductIcon(product.category)}"></i>
        </div>
        <div class="product-details">
          <h4>${product.product_name}</h4>
          <div class="product-code">${product.product_code}</div>
          <!-- Stock info will be added here by updateStockDisplayFromBatches() -->
        </div>
        <div class="product-price">₹${parseFloat(product.unit_price).toFixed(
          2
        )}</div>
      </div>
      `;
            });
            catalogHTML += `</div>`;
          });

          dynamicContainer.innerHTML = catalogHTML;

          // Add event listeners to product items
          addProductItemEventListeners();
        }

        // In showBatchDetails(), update the message to be more informative:
        async function showBatchDetails(productCode, productName) {
          if (!supabase) {
            showNotification("Database not connected", "error");
            return;
          }

          try {
            const today = new Date().toISOString().split("T")[0];
            const { data: batches, error } = await supabase
              .from("product_batches")
              .select("*")
              .eq("product_code", productCode)
              .gte("remaining_quantity", 1)
              .gte("expiry_date", today)
              .order("expiry_date", { ascending: true });

            if (error) {
              console.error("Error fetching batch details:", error);
              return;
            }

            if (!batches || batches.length === 0) {
              alert(`${productName}\n\nNo active batches available.`);
              return;
            }

            let message = `🍰 ${productName} (${productCode})\n\n`;
            message += "══════════════════════════════════════════\n\n";
            message += "📅 **EXPIRY INFORMATION**\n\n";

            let totalStock = 0;
            batches.forEach((batch, index) => {
              const manDate = new Date(
                batch.manufacture_date
              ).toLocaleDateString();
              const expDate = new Date(batch.expiry_date).toLocaleDateString();
              const daysLeft = Math.ceil(
                (new Date(batch.expiry_date) - new Date()) /
                  (1000 * 60 * 60 * 24)
              );

              message += `**Batch ${index + 1}:**\n`;
              message += `• Stock: ${batch.remaining_quantity} units\n`;
              message += `• Manufactured: ${manDate}\n`;
              message += `• Expires: ${expDate}\n`;
              message += `• Days left: ${daysLeft} day(s)\n`;

              if (batch.shelf_life_days) {
                message += `• Shelf Life: ${batch.shelf_life_days} days\n`;
              }

              message += `\n`;

              totalStock += batch.remaining_quantity;
            });

            message += `══════════════════════════════════════════\n`;
            message += `📦 **TOTAL AVAILABLE STOCK:** ${totalStock} units\n`;
            message += `⏰ **NEAREST EXPIRY:** ${new Date(
              batches[0].expiry_date
            ).toLocaleDateString()}\n`;

            alert(message);
          } catch (error) {
            console.error("Error showing batch details:", error);
            showNotification("Failed to load batch details", "error");
          }
        }

        // NEW: Optimized stock update function - REPLACE THE ENTIRE FUNCTION
        async function updateStockForAllProducts(products) {
          if (!products || !products.length) return;

          try {
            // First, remove any existing stock messages
            products.forEach((product) => {
              const productItem = document.getElementById(
                `product-${product.product_code}`
              );
              if (productItem) {
                const existingMessage = productItem.querySelector(
                  ".stock-info-message"
                );
                if (existingMessage) {
                  existingMessage.remove();
                }
                // Remove out-of-stock class initially
                productItem.classList.remove("out-of-stock");
              }
            });

            // Fetch all stock data at once
            const today = new Date().toISOString().split("T")[0];

            console.log("Fetching all batch data...");
            const { data: allBatches, error } = await supabase
              .from("product_batches")
              .select("product_code, remaining_quantity, expiry_date")
              .gte("remaining_quantity", 1)
              .gte("expiry_date", today);

            if (error) {
              console.error("Error fetching batch data:", error);
              // Set default "Stock: Unknown" for all products
              products.forEach((product) => {
                updateProductStockDisplay(product.product_code, 0, []);
              });
              return;
            }

            console.log(`Fetched ${allBatches?.length || 0} active batches`);

            // Group batches by product code
            const stockByProduct = {};
            if (allBatches) {
              allBatches.forEach((batch) => {
                if (!stockByProduct[batch.product_code]) {
                  stockByProduct[batch.product_code] = {
                    totalStock: 0,
                    batches: [],
                  };
                }
                stockByProduct[batch.product_code].totalStock +=
                  batch.remaining_quantity;
                stockByProduct[batch.product_code].batches.push(batch);
              });
            }

            // Update each product
            products.forEach((product) => {
              const productCode = product.product_code;
              const stockData = stockByProduct[productCode];
              const totalStock = stockData ? stockData.totalStock : 0;
              const batches = stockData ? stockData.batches : [];

              updateProductStockDisplay(productCode, totalStock, batches);
            });

            console.log(`Stock updated for ${products.length} products`);
          } catch (error) {
            console.error("Error updating stock for all products:", error);

            // Set a default "Stock: Unknown" message for all products
            products.forEach((product) => {
              updateProductStockDisplay(product.product_code, 0, []);
            });
          }
        }

        // Helper function to update product display
        function updateProductStockDisplay(productCode, totalStock, batches) {
          const productItem = document.getElementById(`product-${productCode}`);
          if (!productItem) return;

          // Update stock badge and text
          let stockBadge = "";
          let stockText = "";
          let badgeColor = "";

          if (totalStock === 0) {
            stockBadge = '<span class="stock-badge out-of-stock">OUT</span>';
            stockText = "Out of stock";
            badgeColor = "#f44336";
            productItem.classList.add("out-of-stock");
          } else if (totalStock <= 3) {
            stockBadge = '<span class="stock-badge low-stock">LOW</span>';
            stockText = `Stock: ${totalStock} units`;
            badgeColor = "#ff9800";
          } else if (totalStock <= 10) {
            stockBadge = '<span class="stock-badge medium-stock">MED</span>';
            stockText = `Stock: ${totalStock} units`;
            badgeColor = "#ffc107";
          } else {
            stockBadge = '<span class="stock-badge in-stock">IN</span>';
            stockText = `Stock: ${totalStock} units`;
            badgeColor = "#4caf50";
          }

          // Add batch info if available
          let batchInfo = "";
          if (batches.length > 0) {
            // Sort batches by expiry date
            batches.sort(
              (a, b) => new Date(a.expiry_date) - new Date(b.expiry_date)
            );
            const nearestExpiry = new Date(
              batches[0].expiry_date
            ).toLocaleDateString();
            batchInfo = ` | Exp: ${nearestExpiry}`;
            if (batches.length > 1) {
              batchInfo += ` (${batches.length} batches)`;
            }
          }

          // Update the product details
          const detailsDiv = productItem.querySelector(".product-details");
          if (!detailsDiv) return;

          // Remove existing stock elements
          const existingBadge = productItem.querySelector(".stock-badge");
          const existingMessage = productItem.querySelector(
            ".stock-info-message"
          );
          if (existingBadge) existingBadge.remove();
          if (existingMessage) existingMessage.remove();

          // Create and add stock message
          const stockMessage = document.createElement("div");
          stockMessage.className = "stock-info-message";
          stockMessage.style.fontSize = "9px";
          stockMessage.style.color = "#666";
          stockMessage.style.marginTop = "2px";
          stockMessage.style.minHeight = "12px";
          stockMessage.innerHTML = `
          ${stockBadge} ${stockText}${batchInfo}
        `;
          detailsDiv.appendChild(stockMessage);

          // Update dataset
          productItem.dataset.stock = totalStock;
          productItem.dataset.hasStock = totalStock > 0 ? "true" : "false";

          // Update tooltip with batch details
          let tooltipText = productItem.title.split("\n")[0] || "";
          if (batches.length > 0) {
            tooltipText += `\nBatch Details:\n`;
            batches.forEach((batch, index) => {
              const expDate = new Date(batch.expiry_date).toLocaleDateString();
              tooltipText += `Batch ${index + 1}: ${
                batch.remaining_quantity
              } units (Exp: ${expDate})\n`;
            });
          }
          productItem.title = tooltipText;

          // Update warning class on product name
          const productName = detailsDiv.querySelector("h4");
          if (productName) {
            if (totalStock <= 3) {
              productName.classList.add("stock-warning");
            } else {
              productName.classList.remove("stock-warning");
            }
          }
        }

        async function refreshProductCatalog() {
          if (!supabase) {
            showNotification("Database not connected", "error");
            return;
          }

          showNotification("Refreshing product catalog...", "info");

          try {
            // Clear current catalog and products
            const dynamicContainer = document.getElementById(
              "dynamicProductCatalog"
            );
            dynamicContainer.innerHTML = `
            <div class="loading-products">
              <i class="fas fa-spinner fa-spin"></i> Loading products from batches...
            </div>
          `;

            // Clear existing products
            allProducts = [];

            // Reload batches - use a fresh query
            const today = new Date().toISOString().split("T")[0];

            const { data: batches, error } = await supabase
              .from("product_batches")
              .select(
                `
              *,
              products:product_code (product_name, category, unit_price, description, is_active)
            `
              )
              .gte("remaining_quantity", 1)
              .gte("expiry_date", today)
              .order("expiry_date", { ascending: true });

            if (error) throw error;

            // Process batches to group by product
            const productsByCode = {};

            batches.forEach((batch) => {
              const productCode = batch.product_code;

              if (!productsByCode[productCode]) {
                productsByCode[productCode] = {
                  product_code: productCode,
                  product_name: batch.products?.product_name || productCode,
                  category: batch.products?.category || "Uncategorized",
                  unit_price:
                    batch.products?.unit_price || batch.unit_cost || 0,
                  description: batch.products?.description || "",
                  is_active: batch.products?.is_active !== false,
                  total_stock: 0,
                  batches: [],
                  nearest_expiry: batch.expiry_date,
                };
              }

              productsByCode[productCode].total_stock +=
                batch.remaining_quantity;
              productsByCode[productCode].batches.push(batch);

              if (
                new Date(batch.expiry_date) <
                new Date(productsByCode[productCode].nearest_expiry)
              ) {
                productsByCode[productCode].nearest_expiry = batch.expiry_date;
              }
            });

            const products = Object.values(productsByCode).filter(
              (product) => product.is_active
            );

            allProducts = products;

            // Update the catalog display
            updateProductCatalog(products);
            updateGlobalDatalists(products);

            // Update stock display - IMPORTANT: pass the actual products array
            updateStockDisplayFromBatches(products);

            // Re-add event listeners
            addProductItemEventListeners();

            showNotification(
              `Refreshed ${products.length} products from ${batches.length} batches`,
              "success"
            );
          } catch (error) {
            console.error("Error refreshing products:", error);
            showNotification("Failed to load products from batches", "error");

            const dynamicContainer = document.getElementById(
              "dynamicProductCatalog"
            );
            dynamicContainer.innerHTML = `
            <div style="text-align: center; padding: 40px; color: #666;">
              <i class="fas fa-exclamation-triangle" style="font-size: 48px; margin-bottom: 15px;"></i>
              <p>Failed to load products from batches</p>
              <button onclick="refreshProductCatalog()" style="
                margin-top: 15px;
                padding: 10px 20px;
                background-color: var(--primary);
                color: white;
                border: none;
                border-radius: 8px;
                cursor: pointer;
              ">
                <i class="fas fa-redo"></i> Try Again
              </button>
            </div>
          `;
          }
        }

        function retryLoadProducts() {
          refreshProductCatalog();
        }

        async function ensureCatalogLoaded() {
          const dynamicContainer = document.getElementById(
            "dynamicProductCatalog"
          );
          if (!dynamicContainer) return;

          // Check if catalog is stuck in loading state
          const loadingElement =
            dynamicContainer.querySelector(".loading-products");
          if (
            loadingElement &&
            loadingElement.textContent.includes("Loading products...")
          ) {
            // If stuck for more than 5 seconds, show retry option
            setTimeout(() => {
              if (dynamicContainer.querySelector(".loading-products")) {
                dynamicContainer.innerHTML = `
                <div class="no-products" style="text-align: center; padding: 40px;">
                  <i class="fas fa-spinner fa-spin" style="font-size: 48px; color: #ddd; margin-bottom: 15px;"></i>
                  <p style="color: #666;">Taking longer than expected...</p>
                  <button onclick="refreshProductCatalog()" class="btn" style="margin-top: 15px;">
                    <i class="fas fa-sync-alt"></i> Retry Loading
                  </button>
                </div>
              `;
              }
            }, 5000);
          }
        }

        // Add event listeners to product items
        function addProductItemEventListeners() {
          document.querySelectorAll(".product-item").forEach((item) => {
            // Remove existing listeners first
            const newItem = item.cloneNode(true);
            item.parentNode.replaceChild(newItem, item);

            // In addProductItemEventListeners(), update the click event:
            newItem.addEventListener("dblclick", function (e) {
              e.stopPropagation();
              const code = this.dataset.code;
              const name = this.dataset.name;
              showBatchDetails(code, name);
            });

            // In addProductItemEventListeners(), update the click event:
            newItem.addEventListener("click", async function (e) {
              if (e.detail === 1) {
                // Single click
                if (this.classList.contains("out-of-stock")) {
                  const proceed = confirm(
                    `"${this.dataset.name}" is out of stock.\n\n` +
                      `Do you want to add it anyway (for pre-order/backorder)?`
                  );
                  if (!proceed) return;
                }

                const code = this.dataset.code;
                const name = this.dataset.name;
                const price = parseFloat(this.dataset.price);

                const nearestExpiry = await getNearestExpiryDate(code); // FIXED: changed productCode to code

                // Add item with expiry info
                const addedItem = addItemRow(code, name, price, 1); // Changed variable name from newItem to addedItem

                if (addedItem && nearestExpiry) {
                  showNotification(
                    `${name} added (Expires: ${nearestExpiry})`,
                    "success"
                  );
                } else {
                  showNotification(`${name} added to order`, "success");
                }
              }
            });

            // Add keyboard support
            newItem.addEventListener("keydown", function (e) {
              if (e.key === "Enter" || e.key === " ") {
                e.preventDefault();
                if (this.classList.contains("out-of-stock")) {
                  const proceed = confirm(
                    `"${this.dataset.name}" is out of stock.\n\n` +
                      `Do you want to add it anyway (for pre-order/backorder)?`
                  );
                  if (!proceed) return;
                }

                const code = this.dataset.code;
                const name = this.dataset.name;
                const price = parseFloat(this.dataset.price);
                addItemRow(code, name, price, 1);
                showNotification(`${name} added to order`, "success");
              }
            });

            // Add hover effects
            newItem.addEventListener("mouseenter", function () {
              if (!this.classList.contains("out-of-stock")) {
                this.style.transform = "translateX(5px)";
                this.style.boxShadow = "0 5px 15px rgba(0,0,0,0.1)";
              }
            });

            newItem.addEventListener("mouseleave", function () {
              if (!this.classList.contains("out-of-stock")) {
                this.style.transform = "translateX(0)";
                this.style.boxShadow = "none";
              }
            });
          });
        }

        // Function to check and highlight near-expiry items
        async function checkAndHighlightExpiry(productCode, row) {
          if (!supabase || !productCode || !row) return;

          try {
            const today = new Date();
            const { data: batches, error } = await supabase
              .from("product_batches")
              .select("expiry_date")
              .eq("product_code", productCode)
              .gte("remaining_quantity", 1)
              .order("expiry_date", { ascending: true })
              .limit(1);

            if (error || !batches || batches.length === 0) return;

            const expiryDate = new Date(batches[0].expiry_date);
            const daysUntilExpiry = Math.ceil(
              (expiryDate - today) / (1000 * 60 * 60 * 24)
            );

            const expirySpan = row.querySelector(".item-expiry");
            if (!expirySpan) return;

            // Remove previous expiry classes
            expirySpan.classList.remove("expiry-warning", "expiry-critical");

            // Add warning/critical classes based on days until expiry
            if (daysUntilExpiry <= 3) {
              expirySpan.classList.add("expiry-critical");
              expirySpan.title = `Expires in ${daysUntilExpiry} day(s)!`;
            } else if (daysUntilExpiry <= 7) {
              expirySpan.classList.add("expiry-warning");
              expirySpan.title = `Expires in ${daysUntilExpiry} days`;
            } else {
              expirySpan.title = `Expires: ${expiryDate.toLocaleDateString()}`;
            }
          } catch (error) {
            console.error("Error checking expiry:", error);
          }
        }

        // Load inventory data
        async function loadInventoryData() {
          if (!supabase) {
            showNotification("Database not connected", "error");
            return;
          }

          try {
            const { data: products, error } = await supabase
              .from("products")
              .select("*")
              .order("category")
              .order("product_name");

            if (error) throw error;

            const tbody = document.getElementById("inventoryTableBody");
            tbody.innerHTML = "";

            products.forEach((product) => {
              const stock = product.stock_quantity || 0;
              let status = "";
              let statusClass = "";

              if (stock === 0) {
                status = "Out of Stock";
                statusClass = "status-expired";
              } else if (stock <= 3) {
                status = "Critical";
                statusClass = "status-expired";
              } else if (stock <= 10) {
                status = "Low";
                statusClass = "status-scheduled";
              } else {
                status = "In Stock";
                statusClass = "status-active";
              }

              const row = document.createElement("tr");
              row.innerHTML = `
              <td><div class="coupon-code">${product.product_code}</div></td>
              <td>${product.product_name}</td>
              <td>${product.category || "Uncategorized"}</td>
              <td>
                <div style="display: flex; align-items: center; gap: 10px;">
                  <span style="font-weight: bold; font-size: 16px;">${stock}</span>
                  <button class="action-btn" onclick="adjustStock('${
                    product.product_code
                  }', ${stock}, 'increase')" title="Increase Stock">
                    <i class="fas fa-plus"></i>
                  </button>
                  <button class="action-btn" onclick="adjustStock('${
                    product.product_code
                  }', ${stock}, 'decrease')" title="Decrease Stock">
                    <i class="fas fa-minus"></i>
                  </button>
                </div>
              </td>
              <td>
                <span class="coupon-status ${statusClass}">
                  <i class="fas fa-circle"></i> ${status}
                </span>
              </td>
              <td>₹${parseFloat(product.unit_price).toFixed(2)}</td>
              <td>
                <button class="action-btn edit" onclick="editProductStock('${
                  product.product_code
                }')" title="Edit Stock">
                  <i class="fas fa-edit"></i>
                </button>
                <button class="action-btn" onclick="viewStockHistory('${
                  product.product_code
                }')" title="View History">
                  <i class="fas fa-history"></i>
                </button>
              </td>
            `;

              // Double-click to edit stock
              row.addEventListener("dblclick", () => {
                editProductStock(product.product_code);
              });

              tbody.appendChild(row);
            });
          } catch (error) {
            console.error("Error loading inventory:", error);
            showNotification("Failed to load inventory data", "error");
          }
        }

        // Adjust stock
        async function adjustStock(productCode, currentStock, action) {
          const amount = prompt(`Enter amount to ${action}:`, "1");
          if (!amount || isNaN(amount) || parseInt(amount) <= 0) return;

          const newStock =
            action === "increase"
              ? currentStock + parseInt(amount)
              : Math.max(0, currentStock - parseInt(amount));

          try {
            const { error } = await supabase
              .from("products")
              .update({ stock_quantity: newStock })
              .eq("product_code", productCode);

            if (error) throw error;

            showNotification(`Stock updated to ${newStock}`, "success");
            loadInventoryData();
            updateProductStockDisplay();
          } catch (error) {
            console.error("Error adjusting stock:", error);
            showNotification("Failed to update stock", "error");
          }
        }

        // Edit product stock
        async function editProductStock(productCode) {
          const newStock = prompt("Enter new stock quantity:", "0");
          if (newStock === null) return;

          const stockQty = parseInt(newStock);
          if (isNaN(stockQty) || stockQty < 0) {
            showNotification("Invalid stock quantity", "error");
            return;
          }

          try {
            const { error } = await supabase
              .from("products")
              .update({ stock_quantity: stockQty })
              .eq("product_code", productCode);

            if (error) throw error;

            showNotification(`Stock updated to ${stockQty}`, "success");
            loadInventoryData();
            updateProductStockDisplay();
          } catch (error) {
            console.error("Error updating stock:", error);
            showNotification("Failed to update stock", "error");
          }
        }

        // Export inventory to CSV
        function exportInventoryCSV() {
          const rows = document.querySelectorAll("#inventoryTableBody tr");
          let csvContent = "data:text/csv;charset=utf-8,";
          csvContent +=
            "Product Code,Product Name,Category,Stock,Status,Price\n";

          rows.forEach((row) => {
            const cells = row.querySelectorAll("td");
            const rowData = [];

            cells.forEach((cell, index) => {
              if (index === 3) {
                // Stock quantity
                const stockSpan = cell.querySelector("span");
                rowData.push(stockSpan ? stockSpan.textContent.trim() : "0");
              } else if (index === 4) {
                // Status
                const statusSpan = cell.querySelector(".coupon-status");
                rowData.push(statusSpan ? statusSpan.textContent.trim() : "");
              } else if (index === 5) {
                // Price
                rowData.push(cell.textContent.trim());
              } else if (index !== 6) {
                // Skip actions column
                rowData.push(cell.textContent.trim());
              }
            });

            csvContent += rowData.join(",") + "\n";
          });

          const encodedUri = encodeURI(csvContent);
          const link = document.createElement("a");
          link.setAttribute("href", encodedUri);
          link.setAttribute(
            "download",
            `inventory_${new Date().toISOString().split("T")[0]}.csv`
          );
          document.body.appendChild(link);
          link.click();
          document.body.removeChild(link);
        }

        // Show low stock report
        function showLowStockReport() {
          const rows = document.querySelectorAll("#inventoryTableBody tr");
          const lowStockItems = [];

          rows.forEach((row) => {
            const statusCell = row.querySelector(".coupon-status");
            if (
              (statusCell && statusCell.textContent.includes("Low")) ||
              statusCell.textContent.includes("Critical")
            ) {
              const cells = row.querySelectorAll("td");
              lowStockItems.push({
                code: cells[0].textContent.trim(),
                name: cells[1].textContent.trim(),
                stock:
                  cells[3].querySelector("span")?.textContent.trim() || "0",
                status: statusCell.textContent.trim(),
              });
            }
          });

          if (lowStockItems.length === 0) {
            alert("No low stock items found!");
            return;
          }

          let report = "LOW STOCK REPORT\n\n";
          report += "══════════════════════════════════════════\n\n";

          lowStockItems.forEach((item) => {
            report += `• ${item.code} - ${item.name}\n`;
            report += `  Stock: ${item.stock} | Status: ${item.status}\n\n`;
          });

          alert(report);
        }

        // Add keyboard shortcut for inventory (Alt+I)
        document.addEventListener("keydown", (e) => {
          if (e.altKey && e.key.toLowerCase() === "i") {
            e.preventDefault();
            showInventoryModal();
          }
        });

        // Update global datalists with all products
        function updateGlobalDatalists(products) {
          const productNamesDatalist =
            document.getElementById("globalProductNames");
          const productCodesDatalist =
            document.getElementById("globalProductCodes");

          if (productNamesDatalist && productCodesDatalist) {
            // Clear existing options
            productNamesDatalist.innerHTML = "";
            productCodesDatalist.innerHTML = "";

            // Add all products to datalists
            products.forEach((product) => {
              const nameOption = document.createElement("option");
              nameOption.value = product.product_name;
              nameOption.setAttribute("data-code", product.product_code);
              nameOption.textContent = `${product.product_code} - ₹${product.unit_price}`;
              productNamesDatalist.appendChild(nameOption);

              const codeOption = document.createElement("option");
              codeOption.value = product.product_code;
              codeOption.textContent = `${product.product_name} - ₹${product.unit_price}`;
              productCodesDatalist.appendChild(codeOption);
            });

            console.log(
              `Updated global datalists with ${products.length} products`
            );
          }
        }

        // Helper function to get icon based on category
        function getProductIcon(category) {
          const icons = {
            Cakes: "fa-cookie",
            Pastries: "fa-pie-chart",
            Decorations: "fa-sparkles",
            Beverages: "fa-wine-bottle",
            Cookies: "fa-cookie",
            Desserts: "fa-ice-cream",
            Uncategorized: "fa-box",
          };
          return icons[category] || "fa-box";
        }

        // Get product by code from batches
        function getProductByCode(code) {
          return allProducts.find((product) => product.product_code === code);
        }

        // Get product by name
        function getProductByName(name) {
          return allProducts.find(
            (product) =>
              product.product_name.toLowerCase() === name.toLowerCase()
          );
        }

        // Function to show all batch details
        async function showAllBatchDetails() {
          if (!supabase) {
            showNotification("Database not connected", "error");
            return;
          }

          try {
            const today = new Date().toISOString().split("T")[0];
            const { data: batches, error } = await supabase
              .from("product_batches")
              .select(
                `
                      *,
                      products(product_name)
                  `
              )
              .gte("remaining_quantity", 1)
              .gte("expiry_date", today)
              .order("product_code")
              .order("expiry_date", { ascending: true });

            if (error) {
              console.error("Error fetching all batches:", error);
              showNotification("Failed to load batch details", "error");
              return;
            }

            if (!batches || batches.length === 0) {
              alert("No active batches found.");
              return;
            }

            let message = "📦 ALL ACTIVE BATCHES\n\n";
            message += "══════════════════════════════════════════\n\n";

            // Group by product
            const batchesByProduct = {};
            batches.forEach((batch) => {
              if (!batchesByProduct[batch.product_code]) {
                batchesByProduct[batch.product_code] = [];
              }
              batchesByProduct[batch.product_code].push(batch);
            });

            // Generate report
            Object.keys(batchesByProduct).forEach((productCode) => {
              const productBatches = batchesByProduct[productCode];
              const productName =
                productBatches[0].products?.product_name || productCode;

              message += `📌 ${productName} (${productCode})\n`;

              let productTotal = 0;
              productBatches.forEach((batch, index) => {
                const expDate = new Date(
                  batch.expiry_date
                ).toLocaleDateString();
                const daysLeft = Math.ceil(
                  (new Date(batch.expiry_date) - new Date()) /
                    (1000 * 60 * 60 * 24)
                );

                message += `  ${index + 1}. ${
                  batch.remaining_quantity
                } units (Exp: ${expDate}, ${daysLeft} days left)\n`;
                productTotal += batch.remaining_quantity;
              });

              message += `  Total: ${productTotal} units\n\n`;
            });

            message += "══════════════════════════════════════════\n";
            message += `GRAND TOTAL: ${batches.length} active batches`;

            alert(message);
          } catch (error) {
            console.error("Error showing all batch details:", error);
            showNotification("Failed to load batch details", "error");
          }
        }

        // Helper function to get nearest expiry date for a product
        async function getNearestExpiryDate(productCode) {
          if (!supabase) return null;

          try {
            const today = new Date().toISOString().split("T")[0];

            const { data: batches, error } = await supabase
              .from("product_batches")
              .select("expiry_date")
              .eq("product_code", productCode)
              .gte("remaining_quantity", 1)
              .gte("expiry_date", today)
              .order("expiry_date", { ascending: true })
              .limit(1);

            if (error || !batches || batches.length === 0) {
              return null;
            }

            const expiryDate = new Date(batches[0].expiry_date);
            return expiryDate.toLocaleDateString();
          } catch (error) {
            console.error("Error getting expiry date:", error);
            return null;
          }
        }

        async function addItemRow(
          productCode = "",
          productName = "",
          price = 0,
          quantity = 1,
          showSuccessNotification = true
        ) {
          const tableBody = document.getElementById("itemsTableBody");
          const rowId = `item-${Date.now()}`;

          let finalProductCode = productCode;
          let finalProductName = productName;
          let finalPrice = price;
          let finalQuantity = quantity;
          let stockInfo = null;
          let stockCheckResult = null;

          // If product code provided, get product details from Supabase
          if (productCode && allProducts.length > 0) {
            const product = getProductByCode(productCode);
            if (product) {
              finalProductName = product.product_name;
              finalPrice = product.unit_price;
              finalProductCode = product.product_code;

              // Check stock availability
              stockCheckResult = await checkStockAvailability(
                productCode,
                quantity
              );
              stockInfo = {
                currentStock: stockCheckResult.stock,
                available: stockCheckResult.available,
                productName: product.product_name,
              };

              // Handle stock issues
              if (!stockCheckResult.available) {
                if (
                  stockCheckResult.canPartiallyFulfill &&
                  stockCheckResult.stock > 0
                ) {
                  // Partially available - ask user
                  const proceed = confirm(
                    `⚠️ **Stock Alert**\n\n` +
                      `Product: ${product.product_name}\n` +
                      `Available Stock: ${stockCheckResult.stock} units\n` +
                      `Requested Quantity: ${quantity}\n\n` +
                      `Would you like to adjust the quantity to ${stockCheckResult.stock} units?`
                  );

                  if (proceed) {
                    finalQuantity = stockCheckResult.stock;
                    stockCheckResult = await checkStockAvailability(
                      productCode,
                      finalQuantity
                    );

                    if (showSuccessNotification) {
                      showNotification(
                        `Quantity adjusted to available stock (${finalQuantity} units)`,
                        "warning"
                      );
                    }
                  } else {
                    if (showSuccessNotification) {
                      showNotification(
                        `Only ${stockCheckResult.stock} units available for ${product.product_name}`,
                        "error"
                      );
                    }
                    return null; // Don't add item
                  }
                } else if (stockCheckResult.stock === 0) {
                  // Completely out of stock
                  if (showSuccessNotification) {
                    showNotification(
                      `${product.product_name} is currently out of stock`,
                      "error"
                    );
                  }

                  // Show out of stock modal with options
                  const proceed = confirm(
                    `❌ **Out of Stock**\n\n` +
                      `Product: ${product.product_name}\n` +
                      `Current Stock: 0 units\n\n` +
                      `Do you want to:\n` +
                      `1. Add to order anyway (for backorder/pre-order)?\n` +
                      `2. Cancel adding this item?`
                  );

                  if (!proceed) {
                    return null;
                  } else {
                    // User wants to add anyway (for backorder)
                    if (showSuccessNotification) {
                      showNotification(
                        `${product.product_name} added as backorder (0 stock)`,
                        "warning"
                      );
                    }
                  }
                }
              }
            }
          }

          // If product name provided but no code, try to find by name
          else if (productName && !productCode && allProducts.length > 0) {
            const product = getProductByName(productName);
            if (product) {
              finalProductCode = product.product_code;
              finalPrice = product.unit_price;
              finalProductName = product.product_name;

              // Check stock availability
              stockCheckResult = await checkStockAvailability(
                finalProductCode,
                quantity
              );
              stockInfo = {
                currentStock: stockCheckResult.stock,
                available: stockCheckResult.available,
                productName: product.product_name,
              };
            }
          }

          // Get expiry date for this product
          let expiryDisplay = "";
          if (finalProductCode) {
            const nearestExpiry = await getNearestExpiryDate(finalProductCode);
            if (nearestExpiry) {
              expiryDisplay = `
              <div class="expiry-info">
                <i class="fas fa-calendar-alt"></i> Expiry:
                <span class="item-expiry" id="expiry-${rowId}">${nearestExpiry}</span>
              </div>
            `;
            }
          }

          // Create the table row
          const row = document.createElement("tr");
          row.className = "item-row";
          row.id = rowId;

          // Determine stock status styling
          let stockBadge = "";
          let stockWarningStyle = "";

          if (stockInfo) {
            if (stockInfo.currentStock === 0) {
              stockBadge =
                '<span class="stock-badge out-of-stock" title="Out of stock">OUT</span>';
              stockWarningStyle =
                'style="border-left: 3px solid #f44336; background-color: rgba(244, 67, 54, 0.05);"';
            } else if (stockInfo.currentStock <= 3) {
              stockBadge =
                '<span class="stock-badge low-stock" title="Low stock">LOW</span>';
              stockWarningStyle =
                'style="border-left: 3px solid #ff9800; background-color: rgba(255, 152, 0, 0.05);"';
            } else if (stockInfo.currentStock <= 10) {
              stockBadge =
                '<span class="stock-badge medium-stock" title="Medium stock">MED</span>';
              stockWarningStyle =
                'style="border-left: 3px solid #ffc107; background-color: rgba(255, 193, 7, 0.05);"';
            }
          }

          // Updated row HTML with expiry date
          row.innerHTML = `
          <td ${stockWarningStyle}>
            <div style="display: flex; align-items: center; gap: 10px;">
              <input
                type="text"
                class="item-name"
                value="${finalProductName}"
                placeholder="Product name"
                tabindex="0"
                autocomplete="off"
                data-row="${rowId}"
                style="flex: 1;"
              >
              ${stockBadge}
            </div>
            ${
              stockInfo && stockInfo.currentStock <= 10
                ? `
              <div class="stock-info-message" style="font-size: 11px; color: ${
                stockInfo.currentStock === 0
                  ? "#f44336"
                  : stockInfo.currentStock <= 3
                  ? "#ff9800"
                  : "#ffc107"
              }; margin-top: 4px;">
                <i class="fas fa-box"></i> Stock: ${
                  stockInfo.currentStock
                } units
              </div>
            `
                : ""
            }
            ${expiryDisplay}
          </td>
          <td>
            <input
              type="text"
              class="item-code"
              value="${finalProductCode}"
              placeholder="e.g., CK-001"
              tabindex="0"
              autocomplete="off"
              data-row="${rowId}"
            >
          </td>
          <td>
            <div style="display: flex; align-items: center; gap: 5px;">
              <button type="button" class="qty-btn decrease" title="Decrease Quantity" data-row="${rowId}">
                <i class="fas fa-minus"></i>
              </button>
              <input
                type="number"
                class="item-qty"
                min="1"
                value="${finalQuantity}"
                step="1"
                tabindex="0"
                data-row="${rowId}"
                style="width: 60px; text-align: center;"
              >
              <button type="button" class="qty-btn increase" title="Increase Quantity" data-row="${rowId}">
                <i class="fas fa-plus"></i>
              </button>
            </div>
          </td>
          <td>
            <div style="display: flex; align-items: center; gap: 5px;">
              <span style="font-weight: bold;">₹</span>
              <input
                type="number"
                class="item-price"
                step="0.01"
                value="${finalPrice}"
                tabindex="0"
                data-row="${rowId}"
                style="width: 100px;"
              >
            </div>
          </td>
          <td class="item-total" style="font-weight: bold; font-size: 14px;">
            ₹${(finalPrice * finalQuantity).toFixed(2)}
          </td>
          <td>
  <button type="button" class="remove-item" onclick="window.removeItem('${rowId}')" tabindex="0" title="Remove Item">
    <i class="fas fa-trash"></i>
  </button>
</td>
        `;

          tableBody.appendChild(row);
          updateItemRows();

          // Add event listeners
          const qtyInput = row.querySelector(".item-qty");
          const codeInput = row.querySelector(".item-code");
          const nameInput = row.querySelector(".item-name");
          const priceInput = row.querySelector(".item-price");
          const removeBtn = row.querySelector(".remove-item");
          const decreaseBtn = row.querySelector(".qty-btn.decrease");
          const increaseBtn = row.querySelector(".qty-btn.increase");

          // Link inputs to global datalists
          nameInput.setAttribute("list", "globalProductNames");
          codeInput.setAttribute("list", "globalProductCodes");

          // Quantity decrease/increase buttons
          decreaseBtn.addEventListener("click", function () {
            const currentQty = parseInt(qtyInput.value) || 1;
            if (currentQty > 1) {
              qtyInput.value = currentQty - 1;
              updateItemTotal.call(qtyInput);

              // Check stock after decreasing
              if (codeInput.value) {
                checkAndUpdateStockDisplay(
                  codeInput.value,
                  qtyInput.value,
                  row
                );
              }
            }
          });

          increaseBtn.addEventListener("click", function () {
            const currentQty = parseInt(qtyInput.value) || 1;
            qtyInput.value = currentQty + 1;
            updateItemTotal.call(qtyInput);

            // Check stock after increasing
            if (codeInput.value) {
              checkAndUpdateStockDisplay(codeInput.value, qtyInput.value, row);
            }
          });

          // Update totals
          qtyInput.addEventListener("input", async function () {
            updateItemTotal.call(qtyInput);

            // Check stock on quantity change
            if (codeInput.value) {
              await checkAndUpdateStockDisplay(
                codeInput.value,
                qtyInput.value,
                row
              );
            }
          });

          priceInput.addEventListener("input", updateItemTotal);

          // When code changes, update name, price, and expiry
          codeInput.addEventListener("change", async function () {
            const product = getProductByCode(this.value);
            if (product) {
              nameInput.value = product.product_name;
              priceInput.value = product.unit_price;
              updateItemTotal.call(qtyInput);

              // Check stock for the new product
              await checkAndUpdateStockDisplay(this.value, qtyInput.value, row);

              // Check and highlight expiry
              await checkAndHighlightExpiry(this.value, row);
            }
          });

          codeInput.addEventListener("blur", async function () {
            if (this.value && !getProductByCode(this.value)) {
              // Invalid product code
              const useAnyway = confirm(
                `Product code "${this.value}" not found in inventory.\n\n` +
                  `Do you want to:\n` +
                  `1. Use this code anyway (for custom/non-inventory items)?\n` +
                  `2. Clear and select from list?`
              );

              if (!useAnyway) {
                this.value = "";
                nameInput.value = "";
                priceInput.value = "";
                updateItemTotal.call(qtyInput);

                // Remove stock warnings and expiry
                const stockBadge = row.querySelector(".stock-badge");
                const stockMessage = row.querySelector(".stock-info-message");
                const expiryDiv = row.querySelector(".expiry-info");
                if (stockBadge) stockBadge.remove();
                if (stockMessage) stockMessage.remove();
                if (expiryDiv) expiryDiv.remove();
                row.querySelector("td").style = "";
              }
            }
          });

          // When name changes, update code and price from Supabase
          nameInput.addEventListener("change", async function () {
            const product = getProductByName(this.value);
            if (product) {
              codeInput.value = product.product_code;
              priceInput.value = product.unit_price;
              updateItemTotal.call(qtyInput);

              // Check stock for the new product
              await checkAndUpdateStockDisplay(
                product.product_code,
                qtyInput.value,
                row
              );
            }
          });

          // Keyboard navigation for the row
          [nameInput, codeInput, qtyInput, priceInput].forEach(
            (input, index) => {
              input.addEventListener("focus", () => {
                currentItemRow = row;
                currentItemField = index;
                highlightCurrentItem();
              });

              input.addEventListener("keydown", async function (e) {
                // Check stock on Enter in quantity field (but don't prevent default)
                if (e.key === "Enter" && index === 2 && codeInput.value) {
                  const stockCheck = await checkStockAvailability(
                    codeInput.value,
                    this.value
                  );
                  if (!stockCheck.available && stockCheck.stock > 0) {
                    const adjust = confirm(
                      `Only ${stockCheck.stock} units available.\n` +
                        `Adjust quantity to ${stockCheck.stock}?`
                    );
                    if (adjust) {
                      qtyInput.value = stockCheck.stock;
                      updateItemTotal.call(qtyInput);
                      await checkAndUpdateStockDisplay(
                        codeInput.value,
                        stockCheck.stock,
                        row
                      );
                    }
                  }
                  // Let the global handler handle navigation
                  return;
                }

                if (e.key === "Tab") {
                  e.preventDefault();

                  const fields = [nameInput, codeInput, qtyInput, priceInput];

                  if (e.shiftKey) {
                    if (index > 0) {
                      fields[index - 1].focus();
                      fields[index - 1].select();
                    } else {
                      focusField("addItemBtn");
                    }
                  } else {
                    if (index < 3) {
                      fields[index + 1].focus();
                      fields[index + 1].select();
                    } else {
                      focusField("couponCode");
                    }
                  }
                }

                // Quantity shortcuts
                if (e.ctrlKey && index === 2) {
                  if (e.key === "ArrowUp") {
                    e.preventDefault();
                    increaseBtn.click();
                  } else if (e.key === "ArrowDown") {
                    e.preventDefault();
                    decreaseBtn.click();
                  }
                }

                // Quick price adjustment
                if (e.ctrlKey && index === 3) {
                  if (e.key === "ArrowUp") {
                    e.preventDefault();
                    priceInput.value = (parseFloat(priceInput.value) || 0) + 1;
                    updateItemTotal.call(priceInput);
                  } else if (e.key === "ArrowDown") {
                    e.preventDefault();
                    priceInput.value = Math.max(
                      0,
                      (parseFloat(priceInput.value) || 0) - 1
                    );
                    updateItemTotal.call(priceInput);
                  }
                }
              });
            }
          );

          // Add keyboard support to quantity buttons
          decreaseBtn.addEventListener("keydown", function (e) {
            if (e.key === "Enter" || e.key === " ") {
              e.preventDefault();
              this.click();
            }
          });

          increaseBtn.addEventListener("keydown", function (e) {
            if (e.key === "Enter" || e.key === " ") {
              e.preventDefault();
              this.click();
            }
          });

          // Add keyboard support to remove button
          removeBtn.addEventListener("keydown", function (e) {
            if (e.key === "Enter" || e.key === " ") {
              e.preventDefault();
              removeItem(rowId);
            }
          });

          // Double-click to duplicate item
          row.addEventListener("dblclick", function (e) {
            if (
              !e.target.classList.contains("remove-item") &&
              !e.target.classList.contains("qty-btn") &&
              e.target.tagName !== "BUTTON"
            ) {
              duplicateItem(rowId);
            }
          });

          // Update order summary
          updateOrderSummary();

          // Auto-focus on the new item
          if (!productCode && !productName) {
            currentItemRow = row;
            currentItemField = 0;
            highlightCurrentItem();
            setTimeout(() => {
              nameInput.focus();
              nameInput.select();
            }, 10);
          } else {
            // If added from catalog, focus on quantity field
            currentItemRow = row;
            currentItemField = 2; // Focus on quantity field
            highlightCurrentItem();
            setTimeout(() => {
              qtyInput.focus();
              qtyInput.select();
            }, 10);
          }

          // Scroll to the new item
          row.scrollIntoView({ behavior: "smooth", block: "nearest" });

          // Show success notification
          if (showSuccessNotification && finalProductName) {
            const stockMsg = stockInfo
              ? stockInfo.currentStock === 0
                ? " (Out of stock - backorder)"
                : stockInfo.currentStock <= 3
                ? " (Low stock)"
                : stockInfo.currentStock <= 10
                ? " (Medium stock)"
                : ""
              : "";

            showNotification(
              `${finalProductName} added to order${stockMsg}`,
              stockInfo && stockInfo.currentStock === 0
                ? "warning"
                : stockInfo && stockInfo.currentStock <= 10
                ? "info"
                : "success"
            );
          }

          // Return the created row for reference
          return {
            rowId,
            productCode: finalProductCode,
            productName: finalProductName,
            price: finalPrice,
            quantity: finalQuantity,
            stockInfo,
            element: row,
          };
        }

        // Duplicate item function
        function duplicateItem(rowId) {
          const sourceRow = document.getElementById(rowId);
          if (!sourceRow) return;

          const code = sourceRow.querySelector(".item-code").value;
          const name = sourceRow.querySelector(".item-name").value;
          const price =
            parseFloat(sourceRow.querySelector(".item-price").value) || 0;
          const qty = parseInt(sourceRow.querySelector(".item-qty").value) || 1;

          addItemRow(code, name, price, qty);
          showNotification(`${name} duplicated`, "success");
        }

        // Add CSS for stock badges
        const stockBadgeCSS = `
      /* Stock Badge Styles */
      .stock-badge {
        display: inline-block;
        padding: 2px 6px;
        border-radius: 4px;
        font-size: 10px;
        font-weight: bold;
        text-transform: uppercase;
        letter-spacing: 0.5px;
      }

      .stock-badge.in-stock {
        background-color: #4caf50;
        color: white;
      }

      .stock-badge.medium-stock {
        background-color: #ffc107;
        color: #333;
      }

      .stock-badge.low-stock {
        background-color: #ff9800;
        color: white;
      }

      .stock-badge.out-of-stock {
        background-color: #f44336;
        color: white;
      }

      /* Quantity buttons */
      .qty-btn {
        width: 24px;
        height: 24px;
        display: flex;
        align-items: center;
        justify-content: center;
        border: 1px solid #ddd;
        background-color: #f8f9fa;
        border-radius: 4px;
        cursor: pointer;
        transition: all 0.2s;
        font-size: 12px;
      }

      .qty-btn:hover {
        background-color: #e9ecef;
        border-color: #999;
      }

      .qty-btn:active {
        transform: scale(0.95);
      }

      .qty-btn.decrease {
        color: #f44336;
      }

      .qty-btn.increase {
        color: #4caf50;
      }
      `;

        // Add the CSS to the document
        const style = document.createElement("style");
        style.textContent = stockBadgeCSS;
        document.head.appendChild(style);
        // Remove item row
        // Remove item row - UPDATED TO BE GLOBALLY ACCESSIBLE
        window.removeItem = function (rowId) {
          const row = document.getElementById(rowId);
          if (row) {
            const wasCurrent = row === window.currentItemRow;
            row.remove();
            window.updateItemRows(); // Make sure to use window.updateItemRows
            window.updateOrderSummary(); // Make sure to use window.updateOrderSummary

            if (wasCurrent) {
              if (window.itemRows.length > 0) {
                window.currentItemRow = window.itemRows[0];
                window.currentItemField = 0;
                window.highlightCurrentItem();
                window.focusCurrentItemField();
              } else {
                window.currentItemRow = null;
                window.currentItemField = 0;
                // Focus back on add item button
                window.focusField("addItemBtn");
              }
            }

            window.showNotification("Item removed", "info");
          }
        };

        // Update item total
        function updateItemTotal() {
          const row = this.closest("tr");
          if (!row) return;

          const qty = parseFloat(row.querySelector(".item-qty").value) || 0;
          const price = parseFloat(row.querySelector(".item-price").value) || 0;
          const total = qty * price;

          row.querySelector(".item-total").textContent = `₹${total.toFixed(2)}`;
          updateOrderSummary();
        }

        // Update order summary
        function updateOrderSummary() {
          let subtotal = 0;
          const rows = document.querySelectorAll(".item-row");

          rows.forEach((row) => {
            const totalText = row.querySelector(".item-total").textContent;
            const total = parseFloat(totalText.replace("₹", "")) || 0;
            subtotal += total;
          });

          const discount = appliedCoupon
            ? calculateDiscount(subtotal, appliedCoupon)
            : 0;

          document.getElementById(
            "subtotal"
          ).textContent = `₹${subtotal.toFixed(2)}`;
          document.getElementById(
            "discountAmount"
          ).textContent = `-₹${discount.toFixed(2)}`;
          document.getElementById("grandTotal").textContent = `₹${(
            subtotal - discount
          ).toFixed(2)}`;
        }

        // Generate bill number
        function generateBillNumber() {
          const date = new Date();
          const year = date.getFullYear().toString().slice(-2);
          const month = (date.getMonth() + 1).toString().padStart(2, "0");
          const day = date.getDate().toString().padStart(2, "0");
          const random = Math.floor(Math.random() * 1000)
            .toString()
            .padStart(3, "0");
          return `BILL-${year}${month}${day}-${random}`;
        }

        // Get items as JSON array
        function getItemsAsJSON() {
          const items = [];
          document.querySelectorAll(".item-row").forEach((row) => {
            items.push({
              code: row.querySelector(".item-code").value,
              name: row.querySelector(".item-name").value,
              quantity: parseInt(row.querySelector(".item-qty").value),
              unit_price: parseFloat(row.querySelector(".item-price").value),
              total_price: parseFloat(
                row.querySelector(".item-total").textContent.replace("₹", "")
              ),
            });
          });
          return JSON.stringify(items);
        }

        // Get items summary text (for display)
        function getItemsSummary() {
          const items = [];
          document.querySelectorAll(".item-row").forEach((row) => {
            const name = row.querySelector(".item-name").value;
            const qty = row.querySelector(".item-qty").value;
            items.push(`${name} x${qty}`);
          });
          return items.join(", ");
        }

        // Save bill to Supabase
        async function saveBillToDatabase() {
          if (!isConnected || !supabase) {
            showNotification(
              "Not connected to database. Please setup Supabase first.",
              "error"
            );
            return null;
          }

          const itemsJSON = getItemsAsJSON();
          const itemsSummary = getItemsSummary();
          const subtotal = parseFloat(
            document.getElementById("subtotal").textContent.replace("₹", "")
          );
          const total = parseFloat(
            document.getElementById("grandTotal").textContent.replace("₹", "")
          );

          // Check if this is a returning customer
          const phone = document.getElementById("purchaserPhone").value.trim();
          const isReturningCustomer = await checkIfReturningCustomer(phone);

          const billData = {
            bill_number: generateBillNumber(),
            purchaser_name: document.getElementById("purchaserName").value,
            birthday_person_name:
              document.getElementById("birthdayPersonName").value,
            purchaser_birthdate:
              document.getElementById("purchaserBirthdate").value || null,
            birthday_person_birthdate: document.getElementById(
              "birthdayPersonBirthdate"
            ).value,
            purchaser_phone: phone,
            birthday_person_phone:
              document.getElementById("birthdayPersonPhone").value || null,
            cake_name: itemsJSON, // Store items as JSON in cake_name field
            cake_price: subtotal, // Use subtotal as cake_price
            total_price: total,
            coupon_code: appliedCoupon ? appliedCoupon.code : null,
            created_at: new Date().toISOString(),
            is_returning_customer: isReturningCustomer,
            last_visit_date: new Date().toISOString(),
          };

          console.log("Saving bill data:", billData);

          try {
            const { data, error } = await supabase
              .from("cake_bills")
              .insert([billData])
              .select();

            if (error) {
              console.error("Error saving bill:", error);
              showNotification(
                "Failed to save bill: " + error.message,
                "error"
              );
              return null;
            }

            // Update coupon usage if applied
            if (appliedCoupon) {
              const discount = calculateDiscount(subtotal, appliedCoupon);
              await updateCouponUsage(appliedCoupon.id, discount);
            }

            showNotification(
              `Bill #${billData.bill_number} saved successfully!`,
              "success"
            );
            loadRecentBills();
            return data[0];
          } catch (error) {
            console.error("Error saving bill:", error);
            showNotification("Failed to save bill: " + error.message, "error");
            return null;
          }
        }

        // Check if customer exists
        async function checkIfReturningCustomer(phoneNumber) {
          if (!isConnected || !supabase) {
            console.log("Supabase not connected");
            return false;
          }

          try {
            const { data, error } = await supabase
              .from("cake_bills")
              .select("purchaser_phone")
              .eq("purchaser_phone", phoneNumber.trim())
              .limit(1);

            if (error) {
              console.error("Error checking customer:", error);
              return false;
            }

            console.log("Customer check result:", data);
            return data && data.length > 0;
          } catch (error) {
            console.error("Error checking customer:", error);
            return false;
          }
        }

        // Build complete customer profile from all bills
        function buildCompleteCustomerProfile(customerBills) {
          if (!customerBills || customerBills.length === 0) return null;

          // Start with the most recent bill
          const latestBill = customerBills[0];
          const profile = { ...latestBill };

          // Add additional data from all bills
          profile.total_bills = customerBills.length;
          profile.total_spent = customerBills.reduce(
            (sum, bill) => sum + (parseFloat(bill.total_price) || 0),
            0
          );
          profile.first_purchase_date =
            customerBills[customerBills.length - 1].created_at;
          profile.last_purchase_date = latestBill.created_at;

          // Look for missing data in older bills
          customerBills.forEach((bill) => {
            // Fill in missing purchaser data
            if (!profile.purchaser_name && bill.purchaser_name) {
              profile.purchaser_name = bill.purchaser_name;
            }

            if (!profile.purchaser_birthdate && bill.purchaser_birthdate) {
              profile.purchaser_birthdate = bill.purchaser_birthdate;
            }

            // Fill in missing birthday person data
            if (!profile.birthday_person_name && bill.birthday_person_name) {
              profile.birthday_person_name = bill.birthday_person_name;
            }

            if (!profile.birthday_person_phone && bill.birthday_person_phone) {
              profile.birthday_person_phone = bill.birthday_person_phone;
            }

            if (
              !profile.birthday_person_birthdate &&
              bill.birthday_person_birthdate
            ) {
              profile.birthday_person_birthdate =
                bill.birthday_person_birthdate;
            }
          });

          return profile;
        }

        async function checkReturningCustomer(phoneNumber) {
          console.log("checkReturningCustomer called with:", phoneNumber);

          if (!isConnected || !supabase) {
            console.log("Supabase not connected");
            showNotification("Database not connected", "error");
            return null;
          }

          if (!phoneNumber || phoneNumber.trim().length < 5) {
            console.log("Phone number too short:", phoneNumber);
            return null;
          }

          try {
            console.log("Querying Supabase for complete customer data...");

            // Fetch ALL customer bills and compile complete profile
            const { data: customerBills, error } = await supabase
              .from("cake_bills")
              .select("*")
              .eq("purchaser_phone", phoneNumber.trim())
              .order("created_at", { ascending: false });

            if (error) {
              console.error("Error checking customer:", error);
              showNotification("Database error: " + error.message, "error");
              return null;
            }

            console.log(
              "Found",
              customerBills?.length || 0,
              "bills for this customer"
            );

            if (!customerBills || customerBills.length === 0) {
              console.log("No customer found");
              return null;
            }

            // Build a comprehensive customer profile from ALL bills
            const customerProfile = buildCompleteCustomerProfile(customerBills);

            console.log("Complete customer profile:", customerProfile);
            return customerProfile;
          } catch (error) {
            console.error("Error checking customer:", error);
            showNotification("Error checking customer", "error");
            return null;
          }
        }
        // Load recent bills from Supabase
        async function loadRecentBills() {
          if (!isConnected || !supabase) {
            console.log("Cannot load bills: Supabase not connected");
            return;
          }

          try {
            const { data, error } = await supabase
              .from("cake_bills")
              .select(
                "bill_number, cake_name, total_price, created_at, purchaser_name"
              )
              .order("created_at", { ascending: false })
              .limit(5);

            if (error) {
              console.error("Error loading bills:", error);
              return;
            }

            const billsList = document.getElementById("recentBillsList");
            const billsCount = document.getElementById("recentBillsCount");

            if (data && data.length > 0) {
              billsList.innerHTML = "";
              data.forEach((bill) => {
                const billDate = new Date(bill.created_at).toLocaleDateString();
                let cakeName = "Multiple Items";

                try {
                  const items = JSON.parse(bill.cake_name);
                  if (Array.isArray(items) && items.length > 0) {
                    cakeName =
                      items.length === 1
                        ? items[0].name
                        : `${items.length} items`;
                  }
                } catch (e) {
                  // If not JSON, use as-is
                  cakeName = bill.cake_name || "Order";
                }

                const billItem = document.createElement("div");
                billItem.className = "order-item";
                billItem.innerHTML = `
                  <div class="order-products">
                    <div>${bill.purchaser_name}</div>
                    <div style="font-size: 12px; color: #666;">${cakeName}</div>
                  </div>
                  <div class="order-price">₹${parseFloat(
                    bill.total_price
                  ).toFixed(2)}</div>
                `;
                billsList.appendChild(billItem);
              });

              billsCount.textContent = data.length;
            } else {
              billsList.innerHTML =
                '<div class="order-item"><div class="order-products">No bills yet</div><div class="order-price">$0.00</div></div>';
              billsCount.textContent = "0";
            }
          } catch (error) {
            console.error("Error loading bills:", error);
          }
        }

        function autoFillCustomerForm(customerData) {
          console.log(
            "Auto-filling form with complete customer data:",
            customerData
          );

          if (!customerData) {
            console.error("No customer data provided");
            return;
          }

          // Always fill purchaser name if available
          if (customerData.purchaser_name) {
            document.getElementById("purchaserName").value =
              customerData.purchaser_name;
          }

          // Fill birthday person name (check multiple sources)
          const birthdayPersonName =
            customerData.birthday_person_name ||
            customerData.purchaser_name ||
            "";
          if (birthdayPersonName) {
            document.getElementById("birthdayPersonName").value =
              birthdayPersonName;
          }

          // Fill birthday person phone
          if (customerData.birthday_person_phone) {
            document.getElementById("birthdayPersonPhone").value =
              customerData.birthday_person_phone;
          } else if (customerData.purchaser_phone) {
            // Use purchaser phone as fallback
            document.getElementById("birthdayPersonPhone").value =
              customerData.purchaser_phone;
          }

          // Fill purchaser birthdate
          if (customerData.purchaser_birthdate) {
            // Format date for input field (YYYY-MM-DD)
            const purchaserDate = formatDateForInput(
              customerData.purchaser_birthdate
            );
            if (purchaserDate) {
              document.getElementById("purchaserBirthdate").value =
                purchaserDate;
            }
          }

          // Fill birthday person birthdate (PRIORITY FIELD)
          if (customerData.birthday_person_birthdate) {
            const birthdayDate = formatDateForInput(
              customerData.birthday_person_birthdate
            );
            if (birthdayDate) {
              document.getElementById("birthdayPersonBirthdate").value =
                birthdayDate;
            }
          } else if (customerData.purchaser_birthdate) {
            // Fallback to purchaser birthdate
            const fallbackDate = formatDateForInput(
              customerData.purchaser_birthdate
            );
            if (fallbackDate) {
              document.getElementById("birthdayPersonBirthdate").value =
                fallbackDate;
            }
          }

          updateOrderSummary();

          // Show success message with customer stats
          const statsMessage =
            customerData.total_bills > 1
              ? `Welcome back ${customerData.purchaser_name}! (${
                  customerData.total_bills
                } previous orders, ₹${customerData.total_spent.toFixed(
                  2
                )} spent)`
              : `Welcome back ${customerData.purchaser_name}!`;

          showNotification(statsMessage, "success");

          // Focus on next field after auto-fill
          setTimeout(() => {
            // Determine which field to focus next
            if (!document.getElementById("birthdayPersonPhone").value) {
              focusField("birthdayPersonPhone");
            } else if (
              !document.getElementById("birthdayPersonBirthdate").value
            ) {
              focusField("birthdayPersonBirthdate");
            } else {
              // All fields filled, go to item section
              addItemRow();
            }
          }, 100);
        }

        // Manual check for returning customers
        async function manualCheckCustomer() {
          console.log("manualCheckCustomer called");

          const phoneInput = document.getElementById("purchaserPhone");
          const phoneNumber = document
            .getElementById("purchaserPhone")
            .value.trim();
          console.log("Phone number:", phoneNumber);

          // Validate phone number before proceeding
          if (!validatePhoneLength(phoneInput)) {
            showNotification(
              "Please enter a valid 10-digit phone number",
              "error"
            );
            phoneInput.focus();
            return;
          }

          if (!phoneNumber) {
            showNotification("Please enter a phone number first", "error");
            return;
          }

          const returningCustomer = await checkReturningCustomer(phoneNumber);

          if (returningCustomer) {
            autoFillCustomerForm(returningCustomer);

            // Inside manualCheckCustomer(), replace the customerInfoDiv HTML with:
            const customerInfoDiv = document.getElementById("customerInfo");
            if (returningCustomer) {
              customerInfoDiv.innerHTML = `
          <div style="background-color: #f8f9fa; padding: 15px; border-radius: 10px; border-left: 4px solid var(--success);">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
              <strong style="color: var(--success);">
                <i class="fas fa-user-check"></i> Returning Customer Found
              </strong>
              <span style="font-size: 12px; background: var(--success); color: white; padding: 2px 8px; border-radius: 10px;">
                ${returningCustomer.total_bills || 1} order${
                returningCustomer.total_bills > 1 ? "s" : ""
              }
              </span>
            </div>
            <div style="font-size: 14px;">
              <div><strong>Name:</strong> ${
                returningCustomer.purchaser_name
              }</div>
              <div><strong>Total Orders:</strong> ${
                returningCustomer.total_bills || 1
              }</div>
              <div><strong>Total Spent:</strong> ₹${(
                returningCustomer.total_spent ||
                returningCustomer.total_price ||
                0
              ).toFixed(2)}</div>
              <div><strong>First Order:</strong> ${new Date(
                returningCustomer.first_purchase_date ||
                  returningCustomer.created_at
              ).toLocaleDateString()}</div>
              <div><strong>Last Visit:</strong> ${new Date(
                returningCustomer.last_purchase_date ||
                  returningCustomer.created_at
              ).toLocaleDateString()}</div>
            </div>
          </div>
        `;
              customerInfoDiv.style.display = "block";
            }
            customerInfoDiv.style.display = "block";

            showNotification(
              `Welcome back ${returningCustomer.purchaser_name}! Details auto-filled.`,
              "success"
            );
          } else {
            const customerInfoDiv = document.getElementById("customerInfo");
            customerInfoDiv.innerHTML = `
              <div style="background-color: #fff3cd; padding: 15px; border-radius: 10px; border-left: 4px solid var(--warning); color: #856404;">
                <strong><i class="fas fa-user-plus"></i> New Customer</strong>
                <div style="font-size: 14px; margin-top: 5px;">No previous orders found with this phone number.</div>
              </div>
            `;
            customerInfoDiv.style.display = "block";
            showNotification(
              "No previous customer found with this phone number",
              "info"
            );

            // Focus on next field for new customer
            setTimeout(() => {
              focusField("purchaserName");
            }, 100);
          }
        }

        // ==================== INVENTORY MANAGEMENT SYSTEM ====================

        // Update product stock in batches table using your schema (FEFO)
        async function updateProductStock(productCode, quantitySold) {
          if (!supabase) {
            console.error("Supabase not connected");
            return false;
          }

          try {
            const today = new Date().toISOString().split("T")[0];

            // Get valid batches for this product (FEFO - First Expiry First Out)
            const { data: batches, error: fetchError } = await supabase
              .from("product_batches")
              .select("*")
              .eq("product_code", productCode)
              .gte("remaining_quantity", 1) // Only batches with stock
              .gte("expiry_date", today) // Not expired
              .order("expiry_date", { ascending: true }) // Oldest expiry first
              .order("manufacture_date", { ascending: true }); // Oldest manufacture first

            if (fetchError) {
              console.error("Error fetching batches:", fetchError);
              return false;
            }

            if (!batches || batches.length === 0) {
              console.error("No valid batches found for product:", productCode);
              return false;
            }

            let remainingQty = quantitySold;
            const updates = [];

            // Update batches using FEFO (First Expiry First Out)
            for (const batch of batches) {
              if (remainingQty <= 0) break;

              const availableInBatch = batch.remaining_quantity || 0;
              const qtyToDeduct = Math.min(availableInBatch, remainingQty);
              const newBatchQty = availableInBatch - qtyToDeduct;

              // Add to updates array
              updates.push({
                id: batch.id,
                remaining_quantity: newBatchQty,
              });

              remainingQty -= qtyToDeduct;
            }

            // Execute all updates
            for (const update of updates) {
              const { error: updateError } = await supabase
                .from("product_batches")
                .update({
                  remaining_quantity: update.remaining_quantity,
                })
                .eq("id", update.id);

              if (updateError) {
                console.error("Error updating batch:", updateError);
                return false;
              }
            }

            if (remainingQty > 0) {
              console.warn(
                `Not enough stock in all batches for ${productCode}. Missing: ${remainingQty}`
              );
              return false;
            }

            console.log(
              `Updated stock for ${productCode}: sold ${quantitySold} units`
            );
            return true;
          } catch (error) {
            console.error("Error updating product stock:", error);
            return false;
          }
        }

        // Update stock for all items in a bill
        async function updateInventoryForBill(items) {
          if (!items || items.length === 0) return;

          const updatePromises = items.map((item) =>
            updateProductStock(item.code, item.quantity)
          );

          const results = await Promise.allSettled(updatePromises);

          // Check for failures
          const failures = results.filter(
            (result) => result.status === "rejected" || !result.value
          );
          if (failures.length > 0) {
            console.error("Some inventory updates failed:", failures);
            return false;
          }

          return true;
        }

        // Check stock availability from product_batches with your schema
        async function checkStockAvailability(productCode, requestedQty) {
          if (!supabase) return { available: true, stock: 0 };

          try {
            // First, get product name
            const { data: product, error: productError } = await supabase
              .from("products")
              .select("product_name")
              .eq("product_code", productCode)
              .single();

            if (productError || !product) {
              return {
                available: true,
                stock: 0,
                productName: "Unknown",
                canPartiallyFulfill: false,
              };
            }

            // Get stock from product_batches using your schema
            const today = new Date().toISOString().split("T")[0];
            const { data: batches, error: batchError } = await supabase
              .from("product_batches")
              .select("id, remaining_quantity, expiry_date, manufacture_date")
              .eq("product_code", productCode)
              .gte("remaining_quantity", 1) // Only batches with stock
              .gte("expiry_date", today) // Not expired
              .order("expiry_date", { ascending: true }) // Oldest expiry first (FEFO)
              .order("manufacture_date", { ascending: true }); // Oldest manufacture first

            if (batchError) {
              console.error("Error checking stock from batches:", batchError);
              return {
                available: true,
                stock: 0,
                productName: product.product_name,
                canPartiallyFulfill: false,
              };
            }

            if (!batches || batches.length === 0) {
              return {
                available: false,
                stock: 0,
                productName: product.product_name,
                canPartiallyFulfill: false,
              };
            }

            // Calculate total available stock
            const totalStock = batches.reduce((sum, batch) => {
              return sum + (batch.remaining_quantity || 0);
            }, 0);

            const available = totalStock >= requestedQty;

            return {
              available,
              stock: totalStock,
              productName: product.product_name,
              canPartiallyFulfill: totalStock > 0,
              batches: batches, // Return batches for FEFO (First Expiry First Out)
            };
          } catch (error) {
            console.error("Error checking stock availability:", error);
            return {
              available: true,
              stock: 0,
              productName: "Unknown",
              canPartiallyFulfill: false,
            };
          }
        }

        // Show low stock warning
        function showLowStockWarning(productCode, productName, currentStock) {
          const warningDiv = document.createElement("div");
          warningDiv.id = `stock-warning-${productCode}`;
          warningDiv.className = "stock-warning";
          warningDiv.innerHTML = `
          <div style="background-color: #fff3cd; padding: 10px; border-radius: 8px; border-left: 4px solid #ff9800; margin-top: 5px;">
            <div style="display: flex; align-items: center; gap: 10px;">
              <i class="fas fa-exclamation-triangle" style="color: #ff9800;"></i>
              <strong>Low Stock Alert:</strong>
              <span>${productName} has only ${currentStock} units remaining</span>
            </div>
          </div>
        `;

          return warningDiv;
        }

        // Update stock display in product catalog
        function updateProductStockDisplay() {
          document.querySelectorAll(".product-item").forEach((item) => {
            const productCode = item.dataset.code;
            const product = getProductByCode(productCode);

            if (product) {
              const stockInfo = item.querySelector(".stock-info");
              const stock = product.stock_quantity || 0;

              if (stockInfo) {
                stockInfo.textContent = `Stock: ${stock}`;
                stockInfo.style.color =
                  stock === 0 ? "#f44336" : stock <= 5 ? "#ff9800" : "#4caf50";
              } else {
                // Add stock info if not present
                const productDetails = item.querySelector(".product-details");
                const stockDiv = document.createElement("div");
                stockDiv.className = "stock-info";
                stockDiv.style.fontSize = "10px";
                stockDiv.style.color =
                  stock === 0 ? "#f44336" : stock <= 5 ? "#ff9800" : "#4caf50";
                stockDiv.textContent = `Stock: ${stock}`;
                productDetails.appendChild(stockDiv);
              }

              // Disable product if out of stock
              if (stock === 0) {
                item.style.opacity = "0.6";
                item.style.cursor = "not-allowed";
                item.title = "Out of stock";
              } else {
                item.style.opacity = "1";
                item.style.cursor = "pointer";
                item.title = product.description || "";
              }
            }
          });
        }

        // Enhanced form submission validation
        function validateFormBeforeSubmission() {
          const purchaserPhone = document.getElementById("purchaserPhone");
          const birthdayPhone = document.getElementById("birthdayPersonPhone");

          // Validate purchaser phone (required)
          if (!validatePhoneLength(purchaserPhone)) {
            showNotification(
              "Purchaser phone must be exactly 10 digits",
              "error"
            );
            purchaserPhone.focus();
            return false;
          }

          // Validate birthday phone (optional but must be valid if provided)
          const birthdayValue = birthdayPhone.value.trim();
          if (birthdayValue && !validateOptionalPhoneLength(birthdayPhone)) {
            showNotification(
              "Birthday person phone must be exactly 10 digits if provided",
              "error"
            );
            birthdayPhone.focus();
            return false;
          }

          return true;
        }

        // Validate all items have sufficient stock
        async function validateStockAvailability() {
          const items = document.querySelectorAll(".item-row");
          const stockIssues = [];

          for (const row of items) {
            const code = row.querySelector(".item-code").value;
            const qty = parseInt(row.querySelector(".item-qty").value) || 0;
            const name = row.querySelector(".item-name").value;

            if (code && qty > 0) {
              const stockCheck = await checkStockAvailability(code, qty);
              if (!stockCheck.available) {
                stockIssues.push({
                  code,
                  name,
                  requested: qty,
                  available: stockCheck.stock,
                });

                // Highlight the problematic row
                row.style.border = "2px solid var(--danger)";
              }
            }
          }

          return stockIssues;
        }

        async function saveBillWithInventoryCheck() {
          // 1. Check stock availability
          const stockIssues = await validateStockAvailability();

          if (stockIssues.length > 0) {
            let message = "Stock issues found:\n\n";
            stockIssues.forEach((issue) => {
              message += `• ${issue.name}: ${issue.requested} requested, only ${issue.available} available\n`;
            });

            if (!confirm(`${message}\nDo you want to continue anyway?`)) {
              showNotification("Bill not saved due to stock issues", "error");
              return null;
            }
          }

          // 2. Save the bill first
          const savedBill = await saveBillToDatabase();

          if (savedBill) {
            // 3. Update inventory using FEFO method
            const items = JSON.parse(savedBill.cake_name);
            const inventoryUpdated = await updateInventoryForBill(items);

            if (inventoryUpdated) {
              // Show notification about updating inventory
              showNotification("Updating inventory...", "info");

              // Use setTimeout to make inventory update non-blocking
              setTimeout(async () => {
                try {
                  // Refresh product catalog in background
                  await loadProductsFromSupabase();

                  // Show success message
                  showNotification("Inventory updated successfully", "success");
                } catch (error) {
                  console.error("Error refreshing products:", error);
                }
              }, 100); // Small delay to not block the main save confirmation

              return savedBill;
            } else {
              showNotification(
                "Bill saved but inventory update failed",
                "warning"
              );
              return savedBill; // Still return saved bill even if inventory update failed
            }
          }

          return null;
        }

        // Refresh products from Supabase
        async function refreshProducts() {
          if (!isConnected || !supabase) {
            showNotification("Not connected to database", "error");
            return;
          }

          showNotification("Refreshing products...", "info");

          try {
            await loadProductsFromSupabase();
            showNotification(
              "Products and stock refreshed successfully",
              "success"
            );
          } catch (error) {
            console.error("Error refreshing products:", error);
            showNotification("Failed to refresh products", "error");
          }
        }

        // ==================== COUPONS MANAGEMENT SYSTEM ====================

        // Initialize coupons system
        async function initCouponsSystem() {
          await loadCoupons();
          setupCouponsEventListeners();
        }

        // Update the loadCoupons function to refresh display
        async function loadCoupons() {
          if (!supabase) {
            console.log("Supabase not connected, cannot load coupons");
            return;
          }

          try {
            console.log("Loading coupons from database...");

            const { data: coupons, error } = await supabase
              .from("coupons")
              .select("*")
              .order("created_at", { ascending: false });

            if (error) {
              console.error("Error loading coupons:", error);
              showNotification(
                "Failed to load coupons: " + error.message,
                "error"
              );
              return;
            }

            currentCoupons = coupons || [];
            updateCouponsTable();
            updateQuickCoupons();
            updateCouponsDisplay(); // Add this line
            console.log(`Loaded ${currentCoupons.length} coupons`);
          } catch (error) {
            console.error("Error loading coupons:", error);
            showNotification("Failed to load coupons", "error");
          }
        }

        // Update coupons table
        function updateCouponsTable() {
          const tbody = document.getElementById("couponsTableBody");
          const noCouponsMessage = document.getElementById("noCouponsMessage");

          tbody.innerHTML = "";

          if (currentCoupons.length === 0) {
            document.getElementById("couponsTable").style.display = "none";
            noCouponsMessage.style.display = "block";
            return;
          }

          document.getElementById("couponsTable").style.display = "table";
          noCouponsMessage.style.display = "none";

          currentCoupons.forEach((coupon) => {
            const row = document.createElement("tr");
            row.dataset.couponId = coupon.id;

            // Determine status
            let statusText = "Active";
            let statusClass = "status-active";
            const now = new Date();

            if (coupon.end_date && new Date(coupon.end_date) < now) {
              statusText = "Expired";
              statusClass = "status-expired";
            } else if (coupon.start_date && new Date(coupon.start_date) > now) {
              statusText = "Scheduled";
              statusClass = "status-scheduled";
            }

            // Determine discount display
            let discountText = "";
            switch (coupon.discount_type) {
              case "percentage":
                discountText = `${coupon.discount_value}%`;
                break;
              case "fixed":
                discountText = `₹${parseFloat(coupon.discount_value).toFixed(
                  2
                )}`;
                break;
              case "bogo":
                discountText = "BOGO";
                break;
            }

            row.innerHTML = `
  <td>
    <div class="coupon-code ${
      coupon.discount_type === "bogo" ? "bogo-coupon" : ""
    }">
      ${coupon.code}
    </div>
    <div style="font-size: 12px; color: #666;">
      ${coupon.description || ""}
    </div>
    ${
      coupon.discount_type === "bogo"
        ? '<div style="font-size: 10px; color: #f50057; margin-top: 2px;"><i class="fas fa-gift"></i> BOGO</div>'
        : ""
    }
  </td>
                  <td class="coupon-discount">${discountText}</td>
                  <td>${coupon.discount_type}</td>
                  <td>
                    <span class="coupon-status ${statusClass}">
                      <i class="fas fa-circle"></i> ${statusText}
                    </span>
                  </td>
                  <td>
                    <div class="coupon-actions">
                      <button class="action-btn use" onclick="applyCouponFromTable('${
                        coupon.code
                      }')" title="Apply Coupon">
                        <i class="fas fa-check"></i>
                      </button>
                      <button class="action-btn edit" onclick="editCoupon('${
                        coupon.id
                      }')" title="Edit Coupon">
                        <i class="fas fa-edit"></i>
                      </button>
                      <button class="action-btn delete" onclick="deleteCoupon('${
                        coupon.id
                      }')" title="Delete Coupon">
                        <i class="fas fa-trash"></i>
                      </button>
                    </div>
                  </td>
                `;

            // Double-click to apply
            row.addEventListener("dblclick", () => {
              applyCouponFromTable(coupon.code);
            });

            // Add status class to row
            if (statusClass.includes("expired")) {
              row.classList.add("expired");
            } else if (statusClass.includes("active")) {
              row.classList.add("active");
            }

            tbody.appendChild(row);
          });
        }

        // In your updateQuickCoupons function, update the button event listener code:

        function updateQuickCoupons() {
          const quickCouponsDiv = document.getElementById("quickCoupons");
          if (!quickCouponsDiv) return;

          quickCouponsDiv.innerHTML = "";

          // Get active coupons (max 5)
          const activeCoupons = currentCoupons
            .filter((coupon) => {
              const now = new Date();
              const valid =
                (!coupon.start_date || new Date(coupon.start_date) <= now) &&
                (!coupon.end_date || new Date(coupon.end_date) >= now) &&
                (!coupon.usage_limit || coupon.used_count < coupon.usage_limit);
              return valid;
            })
            .slice(0, 5);

          activeCoupons.forEach((coupon) => {
            const btn = document.createElement("button");
            btn.type = "button";
            btn.className = "quick-coupon";
            btn.dataset.code = coupon.code;
            btn.innerHTML = `
      <i class="fas fa-tag"></i>
      <span>${coupon.code}</span>
      <span style="font-size: 11px;">(${getDiscountText(coupon)})</span>
    `;

            // Add a specific class for easier selection
            btn.classList.add("quick-coupon-btn");

            btn.addEventListener("click", async (e) => {
              e.preventDefault();
              e.stopPropagation();
              await applyCoupon(coupon.code);
            });

            // Also make it respond to keyboard
            btn.addEventListener("keydown", async (e) => {
              if (e.key === "Enter" || e.key === " ") {
                e.preventDefault();
                e.stopPropagation();
                await applyCoupon(coupon.code);
              }
            });

            quickCouponsDiv.appendChild(btn);
          });
        }

        // Also update the discount display to show BOGO details
        function getDiscountText(coupon) {
          switch (coupon.discount_type) {
            case "percentage":
              return `${coupon.discount_value}% off`;
            case "fixed":
              return `₹${coupon.discount_value} off`;
            case "free_shipping":
              return "Free Shipping";
            case "bogo":
              return "Buy 1 Get 1 Free (Cheapest item)";
            default:
              return "Discount";
          }
        }

        function applyCouponFromTable(code) {
          applyCouponFromAnySource(code);
          document.getElementById("closeCouponsModal")?.click();
        }

        async function applyCoupon(code) {
          if (!code) {
            showNotification("Please enter a coupon code", "error");
            return;
          }

          // Clean the code
          const cleanCode = code.trim().toUpperCase();

          // Find the coupon
          const coupon = currentCoupons.find(
            (c) => c.code.toUpperCase() === cleanCode
          );

          if (!coupon) {
            showNotification(`Coupon "${cleanCode}" not found`, "error");
            return;
          }

          // Validate coupon
          const validation = validateCoupon(coupon);
          if (!validation.valid) {
            showNotification(validation.message, "error");
            return;
          }

          // Special validation for BOGO coupons
          if (coupon.discount_type === "bogo") {
            // Check if there are at least 2 items total
            let totalItems = 0;
            document.querySelectorAll(".item-row").forEach((row) => {
              const qty = parseInt(row.querySelector(".item-qty").value) || 0;
              totalItems += qty;
            });

            if (totalItems < 2) {
              showNotification("BOGO requires at least 2 items", "error");
              return;
            }
          }

          // Set applied coupon
          appliedCoupon = coupon;

          // Update the coupon code input field
          const couponCodeInput = document.getElementById("couponCode");
          if (couponCodeInput) {
            couponCodeInput.value = coupon.code;
          }

          // Update display
          updateAppliedCouponDisplay();

          // Update order summary with discount
          updateOrderSummary();

          // Show success notification
          const discountText = getDiscountText(coupon);
          showNotification(
            `Coupon "${coupon.code}" applied! ${discountText}`,
            "success"
          );
        }

        // Validate coupon
        function validateCoupon(coupon) {
          const now = new Date();
          const subtotal = parseFloat(
            document.getElementById("subtotal").textContent.replace("₹", "")
          );

          // Check start date
          if (coupon.start_date && new Date(coupon.start_date) > now) {
            return {
              valid: false,
              message: `Coupon is valid from ${new Date(
                coupon.start_date
              ).toLocaleDateString()}`,
            };
          }

          // Check end date
          if (coupon.end_date && new Date(coupon.end_date) < now) {
            return {
              valid: false,
              message: "Coupon has expired",
            };
          }

          // Check usage limit
          if (coupon.usage_limit && coupon.used_count >= coupon.usage_limit) {
            return {
              valid: false,
              message: "Coupon usage limit reached",
            };
          }

          // Check minimum purchase
          if (coupon.min_purchase && subtotal < coupon.min_purchase) {
            return {
              valid: false,
              message: `Minimum purchase of ₹${coupon.min_purchase} required`,
            };
          }

          return { valid: true, message: "Coupon is valid" };
        }

        // Update applied coupon display
        function updateAppliedCouponDisplay() {
          if (!appliedCoupon) return;

          const displaySection = document.getElementById(
            "couponDisplaySection"
          );
          displaySection.style.display = "block";

          document.getElementById("appliedCouponCode").textContent =
            appliedCoupon.code;
          document.getElementById("appliedCouponDescription").textContent =
            appliedCoupon.description || "No description";
          document.getElementById("appliedCouponDiscount").textContent =
            getDiscountText(appliedCoupon);

          // In updateAppliedCouponDisplay() function, update the BOGO details:
          if (appliedCoupon.discount_type === "bogo") {
            const discount = calculateBOGODiscount();

            // Calculate how many free items
            let totalUnits = 0;
            let uniqueProducts = 0;

            document.querySelectorAll(".item-row").forEach((row) => {
              const qty = parseInt(row.querySelector(".item-qty").value) || 1;
              totalUnits += qty;
              if (qty > 0) uniqueProducts++;
            });

            const freeItems = Math.floor(totalUnits / 2);

            // Remove existing BOGO message if any
            const existingBogoMsg =
              displaySection.querySelector(".bogo-message");
            if (existingBogoMsg) existingBogoMsg.remove();

            const bogoDetails = document.createElement("div");
            bogoDetails.className = "bogo-message";
            bogoDetails.innerHTML = `
    <i class="fas fa-gift"></i> 
    <div>
      <strong>BOGO Applied:</strong>
      <div style="font-size: 11px; margin-top: 4px;">
        • Buy 1 Get 1 Free (cheapest in pair)<br>
        • You have ${totalUnits} item(s)<br>
        • ${freeItems} item(s) will be free<br>
        • Total savings: ₹${discount.toFixed(2)}
      </div>
    </div>
  `;

            displaySection.appendChild(bogoDetails);
          }

          if (appliedCoupon.end_date) {
            const endDate = new Date(
              appliedCoupon.end_date
            ).toLocaleDateString();
            document.getElementById(
              "appliedCouponValidUntil"
            ).textContent = `Valid until: ${endDate}`;
          } else {
            document.getElementById("appliedCouponValidUntil").textContent =
              "No expiry date";
          }
        }

        // Calculate discount amount with BOGO support
        function calculateDiscount(subtotal, coupon) {
          if (!coupon) return 0;

          let discount = 0;

          switch (coupon.discount_type) {
            case "percentage":
              discount = (subtotal * coupon.discount_value) / 100;
              break;
            case "fixed":
              discount = parseFloat(coupon.discount_value);
              break;
            case "free_shipping":
              // For free shipping, you might want to handle this differently
              discount = 0; // Or your shipping cost
              break;
            case "bogo":
              // BOGO: Find the lowest priced item and discount it
              discount = calculateBOGODiscount();
              break;
          }

          // Apply max discount limit
          if (coupon.max_discount && discount > coupon.max_discount) {
            discount = parseFloat(coupon.max_discount);
          }

          // Don't discount more than subtotal
          if (discount > subtotal) {
            discount = subtotal;
          }

          return discount;
        }

        // Calculate BOGO discount - UPDATED to work for 2 different items
        function calculateBOGODiscount() {
          const itemRows = document.querySelectorAll(".item-row");
          if (itemRows.length === 0) return 0;

          // Create an array of all individual items (considering quantity)
          let allItems = [];

          itemRows.forEach((row) => {
            const priceInput = row.querySelector(".item-price");
            const qtyInput = row.querySelector(".item-qty");
            const nameInput = row.querySelector(".item-name");

            if (priceInput && qtyInput && nameInput) {
              const price = parseFloat(priceInput.value) || 0;
              const quantity = parseInt(qtyInput.value) || 1;
              const name = nameInput.value || "Item";

              // Add each unit as a separate item
              for (let i = 0; i < quantity; i++) {
                allItems.push({
                  name: name,
                  price: price,
                  rowId: row.id,
                  unitNumber: i + 1,
                });
              }
            }
          });

          // Only apply BOGO if there are at least 2 items total
          if (allItems.length < 2) {
            return 0; // No discount for single item
          }

          // Sort items by price (cheapest first)
          allItems.sort((a, b) => a.price - b.price);

          // For BOGO: For every 2 items, the cheaper one is free
          // So we pair items: [cheapest, more expensive], [next cheapest, next more expensive], etc.
          let totalDiscount = 0;
          let discountDetails = [];

          // Group items into pairs
          for (let i = 0; i < allItems.length; i += 2) {
            if (i + 1 < allItems.length) {
              // We have a pair
              const pairNumber = Math.floor(i / 2) + 1;
              const cheaperItem = allItems[i];
              const moreExpensiveItem = allItems[i + 1];

              // The cheaper item in this pair is free
              totalDiscount += cheaperItem.price;

              discountDetails.push({
                pair: pairNumber,
                freeItem: cheaperItem.name,
                freeItemPrice: cheaperItem.price,
                paidItem: moreExpensiveItem.name,
                paidItemPrice: moreExpensiveItem.price,
              });
            }
          }

          console.log("BOGO Discount Calculation:", {
            totalItems: allItems.length,
            pairs: Math.floor(allItems.length / 2),
            totalDiscount: totalDiscount,
            details: discountDetails,
            allItems: allItems,
          });

          return totalDiscount;
        }

        // Remove applied coupon
        function removeAppliedCoupon() {
          appliedCoupon = null;
          document.getElementById("couponCode").value = "";
          document.getElementById("couponDisplaySection").style.display =
            "none";
          updateOrderSummary();
          showNotification("Coupon removed", "info");
        }

        // Edit coupon
        function editCoupon(couponId) {
          const coupon = currentCoupons.find((c) => c.id === couponId);
          if (!coupon) return;

          editingCouponId = couponId;
          document.getElementById("couponFormTitle").innerHTML =
            '<i class="fas fa-edit"></i> Edit Coupon';

          // Fill form with coupon data
          document.getElementById("couponCodeInput").value = coupon.code;
          document.getElementById("couponDiscountType").value =
            coupon.discount_type;
          document.getElementById("couponDiscountValue").value =
            coupon.discount_value;
          document.getElementById("couponMinPurchase").value =
            coupon.min_purchase || "";
          document.getElementById("couponMaxDiscount").value =
            coupon.max_discount || "";
          document.getElementById("couponUsageLimit").value =
            coupon.usage_limit || "";
          document.getElementById("couponStartDate").value =
            coupon.start_date || "";
          document.getElementById("couponEndDate").value =
            coupon.end_date || "";
          document.getElementById("couponDescription").value =
            coupon.description || "";

          // Show usage stats
          const usageStats = document.getElementById("couponUsageStats");
          usageStats.style.display = "block";
          document.getElementById("couponUsedCount").textContent =
            coupon.used_count || 0;
          document.getElementById("couponRemainingCount").textContent =
            coupon.usage_limit
              ? coupon.usage_limit - (coupon.used_count || 0)
              : "∞";
          document.getElementById("couponTotalDiscount").textContent = `₹${(
            coupon.total_discount_given || 0
          ).toFixed(2)}`;

          // Show form modal
          document.getElementById("couponFormModal").style.display = "flex";
        }

        // Delete coupon
        async function deleteCoupon(couponId) {
          if (!confirm("Are you sure you want to delete this coupon?")) return;

          if (!supabase) {
            showNotification("Database not connected", "error");
            return;
          }

          try {
            const { error } = await supabase
              .from("coupons")
              .delete()
              .eq("id", couponId);

            if (error) {
              showNotification(
                "Failed to delete coupon: " + error.message,
                "error"
              );
              return;
            }

            // Remove from local array
            currentCoupons = currentCoupons.filter((c) => c.id !== couponId);

            // Update display
            updateCouponsTable();
            updateQuickCoupons();

            showNotification("Coupon deleted successfully", "success");
          } catch (error) {
            console.error("Error deleting coupon:", error);
            showNotification("Failed to delete coupon", "error");
          }
        }

        // Save coupon
        async function saveCoupon(event) {
          event.preventDefault();

          if (!supabase) {
            showNotification("Database not connected", "error");
            return;
          }

          const couponData = {
            code: document
              .getElementById("couponCodeInput")
              .value.toUpperCase(),
            discount_type: document.getElementById("couponDiscountType").value,
            discount_value: parseFloat(
              document.getElementById("couponDiscountValue").value
            ),
            min_purchase:
              document.getElementById("couponMinPurchase").value || null,
            max_discount:
              document.getElementById("couponMaxDiscount").value || null,
            usage_limit:
              document.getElementById("couponUsageLimit").value || null,
            start_date:
              document.getElementById("couponStartDate").value || null,
            end_date: document.getElementById("couponEndDate").value || null,
            description:
              document.getElementById("couponDescription").value || "",
            updated_at: new Date().toISOString(),
          };

          try {
            let result;

            if (editingCouponId) {
              // Update existing coupon
              const { data, error } = await supabase
                .from("coupons")
                .update(couponData)
                .eq("id", editingCouponId)
                .select();

              if (error) throw error;
              result = data[0];
              showNotification("Coupon updated successfully", "success");
            } else {
              // Create new coupon
              couponData.created_at = new Date().toISOString();
              couponData.used_count = 0;
              couponData.total_discount_given = 0;

              const { data, error } = await supabase
                .from("coupons")
                .insert([couponData])
                .select();

              if (error) throw error;
              result = data[0];
              showNotification("Coupon created successfully", "success");
            }

            // Update local array
            if (editingCouponId) {
              const index = currentCoupons.findIndex(
                (c) => c.id === editingCouponId
              );
              if (index !== -1) {
                currentCoupons[index] = result;
              }
            } else {
              currentCoupons.unshift(result);
            }

            // Update display
            updateCouponsTable();
            updateQuickCoupons();

            // Close modal
            document.getElementById("closeCouponFormModal").click();
            editingCouponId = null;
          } catch (error) {
            console.error("Error saving coupon:", error);
            showNotification(
              "Failed to save coupon: " + error.message,
              "error"
            );
          }
        }

        // Setup coupons event listeners
        function setupCouponsEventListeners() {
          // Discount type selector
          const discountTypeSelect =
            document.getElementById("couponDiscountType");
          if (discountTypeSelect) {
            discountTypeSelect.addEventListener("change", function () {
              const discountType = this.value;
              const discountValueInput = document.getElementById(
                "couponDiscountValue"
              );
              const discountValueLabel = document.querySelector(
                'label[for="couponDiscountValue"]'
              );

              if (discountType === "bogo") {
                discountValueInput.value = "0";
                discountValueInput.disabled = true;
                discountValueInput.placeholder =
                  "Auto-calculated (cheapest item free)";
                if (discountValueLabel) {
                  discountValueLabel.textContent = "BOGO Discount:";
                }
              } else if (discountType === "free_shipping") {
                discountValueInput.value = "0";
                discountValueInput.disabled = true;
                discountValueInput.placeholder = "Free shipping applied";
                if (discountValueLabel) {
                  discountValueLabel.textContent = "Shipping Value:";
                }
              } else {
                discountValueInput.disabled = false;
                discountValueInput.placeholder =
                  discountType === "percentage" ? "e.g., 10" : "e.g., 50";
                if (discountValueLabel) {
                  discountValueLabel.textContent =
                    discountType === "percentage"
                      ? "Discount %:"
                      : "Discount Amount (₹):";
                }
              }
            });
          }

          // Manage coupons button
          const manageCouponsBtn = document.getElementById("manageCouponsBtn");
          if (manageCouponsBtn) {
            manageCouponsBtn.addEventListener("click", () => {
              document.getElementById("couponsModal").style.display = "flex";
            });

            // Keyboard shortcut for coupons modal (Alt+C)
            document.addEventListener("keydown", (e) => {
              if (e.altKey && e.key.toLowerCase() === "c") {
                e.preventDefault();
                manageCouponsBtn.click();
              }
            });
          }

          // Close coupons modal
          const closeCouponsModal =
            document.getElementById("closeCouponsModal");
          if (closeCouponsModal) {
            closeCouponsModal.addEventListener("click", () => {
              document.getElementById("couponsModal").style.display = "none";
            });
          }

          // New coupon button
          const newCouponBtn = document.getElementById("newCouponBtn");
          if (newCouponBtn) {
            newCouponBtn.addEventListener("click", () => {
              editingCouponId = null;
              document.getElementById("couponForm").reset();
              document.getElementById("couponFormTitle").innerHTML =
                '<i class="fas fa-tag"></i> Create New Coupon';
              document.getElementById("couponUsageStats").style.display =
                "none";
              document.getElementById("couponFormModal").style.display = "flex";

              // Set today's date as default start date
              setTimeout(() => {
                setDefaultCouponStartDate();
              }, 10);
            });
          }

          // Create first coupon button
          const createFirstCouponBtn = document.getElementById(
            "createFirstCouponBtn"
          );
          if (createFirstCouponBtn) {
            createFirstCouponBtn.addEventListener("click", () => {
              editingCouponId = null;
              document.getElementById("couponForm").reset();
              document.getElementById("couponFormTitle").innerHTML =
                '<i class="fas fa-tag"></i> Create New Coupon';
              document.getElementById("couponUsageStats").style.display =
                "none";
              document.getElementById("couponFormModal").style.display = "flex";

              // Set today's date as default start date
              setTimeout(() => {
                setDefaultCouponStartDate();
              }, 10);
            });
          }

          // Close coupon form modal
          const closeCouponFormModal = document.getElementById(
            "closeCouponFormModal"
          );
          if (closeCouponFormModal) {
            closeCouponFormModal.addEventListener("click", () => {
              document.getElementById("couponFormModal").style.display = "none";
              editingCouponId = null;
            });
          }

          // Cancel coupon button
          const cancelCouponBtn = document.getElementById("cancelCouponBtn");
          if (cancelCouponBtn) {
            cancelCouponBtn.addEventListener("click", () => {
              document.getElementById("couponFormModal").style.display = "none";
              editingCouponId = null;
            });
          }

          // Save coupon form
          const couponForm = document.getElementById("couponForm");
          if (couponForm) {
            couponForm.addEventListener("submit", saveCoupon);
          }

          // Remove coupon button
          const removeCouponBtn = document.getElementById("removeCouponBtn");
          if (removeCouponBtn) {
            removeCouponBtn.addEventListener("click", removeAppliedCoupon);
          }

          // Auto-apply coupon when code is entered in main form
          const couponCodeInput = document.getElementById("couponCode");
          if (couponCodeInput) {
            // Apply on Enter key
            couponCodeInput.addEventListener("keydown", async (e) => {
              if (e.key === "Enter") {
                e.preventDefault();
                await applyCouponFromAnySource(couponCodeInput.value);
              }
            });

            // Also apply on blur (when user leaves the field)
            couponCodeInput.addEventListener("blur", async (e) => {
              if (couponCodeInput.value.trim() !== "") {
                await applyCouponFromAnySource(couponCodeInput.value);
              }
            });
          }

          // ===== EVENT DELEGATION FOR DYNAMIC QUICK COUPON BUTTONS =====

          // Event delegation for main billing area quick coupons
          document.addEventListener("click", async function (e) {
            // Check if clicked element is a quick coupon button in the billing form
            const quickCouponBtn = e.target.closest(".quick-coupon");

            if (
              quickCouponBtn &&
              !quickCouponBtn.closest("#quickCouponsSidebar")
            ) {
              e.preventDefault();
              e.stopPropagation();

              const couponCode =
                quickCouponBtn.dataset.code ||
                quickCouponBtn.querySelector("span")?.textContent;

              if (couponCode) {
                console.log("Quick coupon clicked:", couponCode);
                await applyCoupon(couponCode);

                // Add visual feedback
                quickCouponBtn.classList.add("active");
                setTimeout(() => {
                  quickCouponBtn.classList.remove("active");
                }, 1000);
              }
            }
          });

          // Event delegation for sidebar quick coupons
          const quickCouponsSidebar = document.getElementById(
            "quickCouponsSidebar"
          );
          if (quickCouponsSidebar) {
            quickCouponsSidebar.addEventListener("click", async function (e) {
              const couponElement = e.target.closest(".active-coupon-item");
              if (couponElement) {
                e.preventDefault();
                e.stopPropagation();

                const couponCodeElement =
                  couponElement.querySelector(".coupon-code");
                if (couponCodeElement) {
                  const couponCode = couponCodeElement.textContent.trim();
                  console.log("Sidebar coupon clicked:", couponCode);
                  await applyCoupon(couponCode);

                  // Add visual feedback
                  couponElement.style.transform = "scale(0.98)";
                  couponElement.style.backgroundColor =
                    "rgba(76, 175, 80, 0.1)";
                  setTimeout(() => {
                    couponElement.style.transform = "";
                    couponElement.style.backgroundColor = "";
                  }, 500);
                }
              }

              // Also handle "View all" button in sidebar
              const viewAllBtn = e.target.closest("button");
              if (viewAllBtn && viewAllBtn.textContent.includes("View all")) {
                e.preventDefault();
                document.getElementById("manageCouponsBtn")?.click();
              }
            });
          }

          // Event delegation for coupons table apply buttons
          document.addEventListener("click", async function (e) {
            // Check if clicked on "Apply Coupon" button in coupons table
            const applyBtn = e.target.closest(".action-btn.use");
            if (applyBtn) {
              e.preventDefault();
              e.stopPropagation();

              // Find the coupon code from the table row
              const tableRow = applyBtn.closest("tr");
              if (tableRow) {
                const couponCodeElement =
                  tableRow.querySelector(".coupon-code");
                if (couponCodeElement) {
                  const couponCode = couponCodeElement.textContent.trim();
                  console.log("Table apply button clicked:", couponCode);
                  await applyCoupon(couponCode);

                  // Close the coupons modal
                  document.getElementById("closeCouponsModal")?.click();
                }
              }
            }
          });

          // Add keyboard support for all coupon buttons
          document.addEventListener("keydown", async function (e) {
            // Enter key on quick coupon buttons
            if (e.key === "Enter" || e.key === " ") {
              const focusedElement = document.activeElement;
              if (
                focusedElement &&
                focusedElement.classList.contains("quick-coupon")
              ) {
                e.preventDefault();
                const couponCode = focusedElement.dataset.code;
                if (couponCode) {
                  await applyCoupon(couponCode);
                }
              }
            }
          });

          // Also handle coupon code input submit button if exists
          const applyCouponBtn = document.getElementById("applyCouponBtn");
          if (applyCouponBtn) {
            applyCouponBtn.addEventListener("click", async () => {
              const code = document.getElementById("couponCode").value;
              if (code) {
                await applyCouponFromAnySource(code);
              }
            });
          }

          // Add a debug function to help test coupon buttons
          window.debugCouponButtons = function () {
            console.log("=== Debugging Coupon Buttons ===");

            // Main area quick coupons
            const mainQuickCoupons = document.querySelectorAll(
              "#quickCoupons .quick-coupon"
            );
            console.log(`Main area quick coupons: ${mainQuickCoupons.length}`);
            mainQuickCoupons.forEach((btn, i) => {
              console.log(
                `  ${i + 1}. ${btn.textContent.trim()} - dataset.code: ${
                  btn.dataset.code
                }`
              );
            });

            // Sidebar coupons
            const sidebarCoupons = document.querySelectorAll(
              "#quickCouponsSidebar .active-coupon-item"
            );
            console.log(`Sidebar coupons: ${sidebarCoupons.length}`);
            sidebarCoupons.forEach((item, i) => {
              const code = item.querySelector(".coupon-code")?.textContent;
              console.log(`  ${i + 1}. ${code}`);
            });

            // Table apply buttons
            const tableApplyButtons =
              document.querySelectorAll(".action-btn.use");
            console.log(`Table apply buttons: ${tableApplyButtons.length}`);
          };

          // Log when event listeners are set up
          console.log("Coupon event listeners set up successfully");
        }

        // Update coupon usage
        async function updateCouponUsage(couponId, discountAmount) {
          if (!supabase) return;

          try {
            // Get current coupon
            const { data: coupon, error: fetchError } = await supabase
              .from("coupons")
              .select("used_count, total_discount_given")
              .eq("id", couponId)
              .single();

            if (fetchError) {
              console.error("Error fetching coupon:", fetchError);
              return;
            }

            // Update coupon
            const { error: updateError } = await supabase
              .from("coupons")
              .update({
                used_count: (coupon.used_count || 0) + 1,
                total_discount_given:
                  (coupon.total_discount_given || 0) + discountAmount,
              })
              .eq("id", couponId);

            if (updateError) {
              console.error("Error updating coupon:", updateError);
            } else {
              // Reload coupons to get updated counts
              await loadCoupons();
            }
          } catch (error) {
            console.error("Error updating coupon usage:", error);
          }
        }

        async function reduceStockForBill(items) {
          for (const item of items) {
            const code = item.code;
            const qty = item.quantity;

            // Fetch current stock
            const { data: product, error: productError } = await supabase
              .from("products")
              .select("stock_quantity")
              .eq("product_code", code)
              .single();

            if (productError) {
              console.error("Error fetching product:", code, productError);
              continue;
            }

            const newQty = product.stock_quantity - qty;

            if (newQty < 0) {
              console.warn(`Stock cannot go negative for product ${code}`);
            }

            // Update stock
            const { error: updateError } = await supabase
              .from("products")
              .update({ stock_quantity: Math.max(newQty, 0) })
              .eq("product_code", code);

            if (updateError) {
              console.error("Error updating stock:", updateError);
            }
          }

          console.log("Stock updated successfully!");
        }

        async function forceManualProductReload() {
          console.log("Forcing manual product reload...");

          if (!supabase) {
            console.error("Supabase not connected");
            return;
          }

          try {
            // Direct query to bypass any caching
            const today = new Date().toISOString().split("T")[0];
            const { data: batches, error } = await supabase
              .from("product_batches")
              .select("product_code, remaining_quantity")
              .gte("remaining_quantity", 1)
              .gte("expiry_date", today);

            if (error) throw error;

            console.log("Manual reload fetched", batches?.length, "batches");

            // If we got data, manually trigger a full catalog refresh
            if (batches && batches.length > 0) {
              // Clear any cached data
              allProducts = [];
              // Reload full product data
              await loadProductsFromSupabase();
              // Update display
              updateProductCatalog(allProducts);
              updateStockDisplayFromBatches(allProducts);
            }
          } catch (error) {
            console.error("Force reload failed:", error);
          }
        }

        function showQuickKeyboardGuide() {
          const guide = `
🎂 CAKE BLISS - QUICK KEYBOARD GUIDE 🎂

PRIMARY NAVIGATION:
• Enter → Next field / Confirm action
• Tab → Next field
• Shift+Tab → Previous field
• Esc → Clear field / Close modal

QUICK ACTIONS:
• Ctrl+S → Generate & Save Bill
• Ctrl+R → Reset Form
• Ctrl+N → Add New Item
• Ctrl+D → Duplicate Item
• Alt+C → Manage Coupons
• F1 → Full Help Guide
• F2 → Check Customer
• F3 → Add Item

ITEM TABLE:
• Enter → Move between fields
• Tab → Next field in row
• Shift+Tab → Previous field in row
• Ctrl+↑/↓ → Increase/Decrease quantity
• Delete → Remove item
• Insert → Add new item

PHONE FIELDS:
• Enter → Validate & move to next
• Numbers only (0-9)
• Auto-validates 10 digits

QUICK FIELDS (Alt+Number):
• Alt+1 → Phone field
• Alt+2 → Name field
• Alt+3 → Birthday person
• Alt+4 → Birthday phone
• Alt+5 → Add item
• Alt+6 → Coupon field
• Alt+7 → Submit bill
  `;

          alert(guide);
        }

        function initializeEnhancedKeyboardSystem() {
          console.log("Initializing enhanced keyboard system...");

          // Collect all focusable elements
          formFields = Array.from(
            document.querySelectorAll(
              'input:not([type="hidden"]), button, select, textarea, [tabindex]:not([tabindex="-1"])'
            )
          ).filter((el) => {
            // Filter out hidden or disabled elements
            return (
              !el.disabled &&
              el.offsetParent !== null &&
              el.style.display !== "none" &&
              el.style.visibility !== "hidden"
            );
          });

          // Add event listeners
          document.addEventListener("keydown", handleGlobalKeyboard);

          // Make all buttons keyboard accessible
          document.querySelectorAll("button").forEach((btn) => {
            btn.setAttribute("tabindex", "0");
            btn.addEventListener("keydown", function (e) {
              if (e.key === "Enter" || e.key === " ") {
                e.preventDefault();
                this.click();
              }
            });
          });

          // Special handling for Enter in form
          document
            .getElementById("billingForm")
            .addEventListener("keydown", function (e) {
              if (e.key === "Enter" && !e.target.type === "button") {
                e.preventDefault();
                moveToNextField();
              }
            });

          console.log(
            `Keyboard system initialized with ${formFields.length} focusable elements`
          );
        }

        // Refresh coupons function
        async function refreshCoupons() {
          showNotification("Refreshing coupons...", "info");
          await loadCoupons();
          updateCouponsDisplay();
        }

        // Update coupons display in sidebar
        function updateCouponsDisplay() {
          const quickCouponsDiv = document.getElementById(
            "quickCouponsSidebar"
          );
          const couponsCountSpan = document.getElementById("couponsCount");

          if (!quickCouponsDiv || !couponsCountSpan) return;

          // Get active coupons
          const activeCoupons = currentCoupons.filter((coupon) => {
            const now = new Date();
            const valid =
              (!coupon.start_date || new Date(coupon.start_date) <= now) &&
              (!coupon.end_date || new Date(coupon.end_date) >= now) &&
              (!coupon.usage_limit || coupon.used_count < coupon.usage_limit);
            return valid;
          });

          // Update count
          couponsCountSpan.textContent = activeCoupons.length;

          // Clear existing
          quickCouponsDiv.innerHTML = "";

          if (activeCoupons.length === 0) {
            quickCouponsDiv.innerHTML = `
      <div style="text-align: center; padding: 20px; color: #666;">
        <i class="fas fa-tags" style="font-size: 32px; margin-bottom: 10px; color: #ddd;"></i>
        <p>No active coupons</p>
        <button onclick="document.getElementById('manageCouponsBtn').click()" style="
          margin-top: 10px;
          padding: 8px 15px;
          background-color: var(--primary);
          color: white;
          border: none;
          border-radius: 8px;
          cursor: pointer;
          font-size: 12px;
        ">
          <i class="fas fa-plus"></i> Create First Coupon
        </button>
      </div>
    `;
            return;
          }

          // Display first 3 active coupons
          const displayCoupons = activeCoupons.slice(0, 3);

          displayCoupons.forEach((coupon) => {
            const couponDiv = document.createElement("div");
            couponDiv.className = "active-coupon-item";

            // Check if coupon is expiring soon (within 3 days)
            const now = new Date();
            if (coupon.end_date) {
              const expiryDate = new Date(coupon.end_date);
              const daysUntilExpiry = Math.ceil(
                (expiryDate - now) / (1000 * 60 * 60 * 24)
              );
              if (daysUntilExpiry <= 3) {
                couponDiv.classList.add("expiring");
              }
              if (daysUntilExpiry < 0) {
                couponDiv.classList.add("expired");
              }
            }

            couponDiv.innerHTML = `
      <div class="coupon-details">
        <div class="coupon-code">${coupon.code}</div>
        <div class="coupon-discount">${getDiscountText(coupon)}</div>
        ${
          coupon.end_date
            ? `
          <div class="coupon-expiry">
            <i class="fas fa-calendar"></i> 
            Exp: ${new Date(coupon.end_date).toLocaleDateString()}
          </div>
        `
            : ""
        }
      </div>
      <div class="coupon-actions">
        <button onclick="applyCoupon('${coupon.code}')" style="
          background: none;
          border: none;
          color: var(--success);
          cursor: pointer;
          padding: 5px;
          border-radius: 4px;
          transition: all 0.3s;
        " title="Apply Coupon">
          <i class="fas fa-check"></i>
        </button>
      </div>
    `;

            quickCouponsDiv.appendChild(couponDiv);
          });

          // Show "View All" link if there are more coupons
          if (activeCoupons.length > 3) {
            const viewAllDiv = document.createElement("div");
            viewAllDiv.style.textAlign = "center";
            viewAllDiv.style.marginTop = "10px";
            viewAllDiv.innerHTML = `
      <button onclick="document.getElementById('manageCouponsBtn').click()" style="
        background: none;
        border: none;
        color: var(--primary);
        cursor: pointer;
        font-size: 12px;
        text-decoration: underline;
      ">
        <i class="fas fa-ellipsis-h"></i> View all ${activeCoupons.length} coupons
      </button>
    `;
            quickCouponsDiv.appendChild(viewAllDiv);
          }
        }

        function setupFormSubmission() {
          const form = document.getElementById("billingForm");
          const submitBtn = document.getElementById("submitBill");

          // Remove any existing listeners first
          const newForm = form.cloneNode(true);
          form.parentNode.replaceChild(newForm, form);

          // Get the new form reference
          const updatedForm = document.getElementById("billingForm");

          // Add ONE listener with the WhatsApp auto-send logic
          updatedForm.addEventListener("submit", async function (e) {
            e.preventDefault(); // This is the key fix!

            // Validate form
            if (!validateFormBeforeSubmission()) {
              return;
            }

            // Check if there are items
            const itemRows = document.querySelectorAll(".item-row");
            if (itemRows.length === 0) {
              showNotification(
                "Please add at least one item to the bill",
                "error"
              );
              return;
            }

            // Call the WhatsApp flow function (which has the blocker)
            await saveBillWithWhatsAppFlow();
          });

          console.log("Form submission handler set up with WhatsApp auto-send");
        }

        // Add this function to prevent browser's Save Page dialog
        function preventBrowserSaveShortcut() {
          document.addEventListener(
            "keydown",
            function (e) {
              // Check for Ctrl+S or Cmd+S
              if ((e.ctrlKey || e.metaKey) && e.key === "s") {
                e.preventDefault(); // Prevent browser save dialog
                e.stopPropagation(); // Stop event from bubbling up

                // Focus out of any input field first
                if (
                  document.activeElement &&
                  (document.activeElement.tagName === "INPUT" ||
                    document.activeElement.tagName === "TEXTAREA")
                ) {
                  document.activeElement.blur();
                }

                // Trigger your save function
                setTimeout(() => {
                  document.getElementById("submitBill")?.click();
                }, 50);

                return false;
              }
            },
            true
          ); // Use capture phase to catch it early
        }

        // Add this function to your code
        async function checkAndUpdateStockDisplay(productCode, quantity, row) {
          if (!productCode || !row) return;

          try {
            const stockCheck = await checkStockAvailability(
              productCode,
              quantity
            );
            const stockBadge = row.querySelector(".stock-badge");
            const stockMessage = row.querySelector(".stock-info-message");
            const rowTd = row.querySelector("td:first-child");

            // Remove previous styling
            if (rowTd) {
              rowTd.style.borderLeft = "";
              rowTd.style.backgroundColor = "";
            }

            // Update stock badge
            if (stockCheck.available === false && stockCheck.stock > 0) {
              // Partially available
              if (stockBadge) {
                stockBadge.className = "stock-badge low-stock";
                stockBadge.textContent = "LOW";
                stockBadge.title = `Only ${stockCheck.stock} units available`;
              }

              if (stockMessage) {
                stockMessage.textContent = `Stock: ${stockCheck.stock} units (Insufficient)`;
                stockMessage.style.color = "#ff9800";
              }

              if (rowTd) {
                rowTd.style.borderLeft = "3px solid #ff9800";
                rowTd.style.backgroundColor = "rgba(255, 152, 0, 0.05)";
              }
            } else if (stockCheck.stock === 0) {
              // Out of stock
              if (stockBadge) {
                stockBadge.className = "stock-badge out-of-stock";
                stockBadge.textContent = "OUT";
                stockBadge.title = "Out of stock";
              }

              if (stockMessage) {
                stockMessage.textContent = "Stock: 0 units (Out of stock)";
                stockMessage.style.color = "#f44336";
              }

              if (rowTd) {
                rowTd.style.borderLeft = "3px solid #f44336";
                rowTd.style.backgroundColor = "rgba(244, 67, 54, 0.05)";
              }
            } else {
              // Sufficient stock
              if (stockBadge) {
                if (stockCheck.stock <= 3) {
                  stockBadge.className = "stock-badge low-stock";
                  stockBadge.textContent = "LOW";
                } else if (stockCheck.stock <= 10) {
                  stockBadge.className = "stock-badge medium-stock";
                  stockBadge.textContent = "MED";
                } else {
                  stockBadge.className = "stock-badge in-stock";
                  stockBadge.textContent = "IN";
                }
                stockBadge.title = `${stockCheck.stock} units available`;
              }

              if (stockMessage) {
                stockMessage.textContent = `Stock: ${stockCheck.stock} units`;
                stockMessage.style.color =
                  stockCheck.stock <= 10 ? "#ff9800" : "#4caf50";
              }

              if (rowTd && stockCheck.stock <= 10) {
                rowTd.style.borderLeft = "3px solid #ff9800";
                rowTd.style.backgroundColor = "rgba(255, 152, 0, 0.05)";
              }
            }
          } catch (error) {
            console.error("Error checking stock display:", error);
          }
        }

        async function applyCouponFromAnySource(code) {
          if (!code || code.trim() === "") {
            showNotification("Please enter a coupon code", "error");
            return;
          }

          // Trim and uppercase the code
          const cleanCode = code.trim().toUpperCase();

          // Find the coupon
          const coupon = currentCoupons.find(
            (c) => c.code.toUpperCase() === cleanCode
          );

          if (!coupon) {
            showNotification(`Coupon "${code}" not found`, "error");
            return;
          }

          // Validate coupon
          const validation = validateCoupon(coupon);
          if (!validation.valid) {
            showNotification(validation.message, "error");
            return;
          }

          // Set applied coupon
          appliedCoupon = coupon;

          // Update the coupon code input field
          document.getElementById("couponCode").value = coupon.code;

          // Update display
          updateAppliedCouponDisplay();

          // Update order summary with discount
          updateOrderSummary();

          // Show success notification
          showNotification(
            `Coupon "${coupon.code}" applied successfully!`,
            "success"
          );
        }

        // Initialize when page loads
        document.addEventListener("DOMContentLoaded", async function () {
          // Initialize Supabase
          await initSupabase();

          // Initialize coupons system
          await initCouponsSystem();

          // Initialize form submission handler - ADD THIS LINE
          setupFormSubmission();

          // Update coupons display after initialization
          setTimeout(() => {
            updateCouponsDisplay();
          }, 1000);

          // Set today's date as default for birthday
          const today = new Date().toISOString().split("T")[0];
          document.getElementById("birthdayPersonBirthdate").value = today;

          // Add global datalists to HTML
          if (!document.getElementById("globalProductNames")) {
            const nameDatalist = document.createElement("datalist");
            nameDatalist.id = "globalProductNames";
            document.body.appendChild(nameDatalist);

            const codeDatalist = document.createElement("datalist");
            codeDatalist.id = "globalProductCodes";
            document.body.appendChild(codeDatalist);
          }

          // Add inventory management CSS
          const inventoryCSS = `
        /* Inventory Management CSS */
        .stock-badge {
          display: inline-block;
          padding: 2px 6px;
          border-radius: 4px;
          font-size: 10px;
          font-weight: bold;
          text-transform: uppercase;
          letter-spacing: 0.5px;
        }

        .stock-badge.in-stock {
          background-color: #4caf50;
          color: white;
        }

        .stock-badge.medium-stock {
          background-color: #ffc107;
          color: #333;
        }

        .stock-badge.low-stock {
          background-color: #ff9800;
          color: white;
        }

        .stock-badge.out-of-stock {
          background-color: #f44336;
          color: white;
        }

        /* Quantity buttons */
        .qty-btn {
          width: 24px;
          height: 24px;
          display: flex;
          align-items: center;
          justify-content: center;
          border: 1px solid #ddd;
          background-color: #f8f9fa;
          border-radius: 4px;
          cursor: pointer;
          transition: all 0.2s;
          font-size: 12px;
        }

        .qty-btn:hover {
          background-color: #e9ecef;
          border-color: #999;
        }

        .qty-btn:active {
          transform: scale(0.95);
        }

        .qty-btn.decrease {
          color: #f44336;
        }

        .qty-btn.increase {
          color: #4caf50;
        }

        /* Stock warning styles */
        .stock-warning {
          animation: pulseWarning 2s infinite;
        }

        @keyframes pulseWarning {
          0% { opacity: 1; }
          50% { opacity: 0.7; }
          100% { opacity: 1; }
        }

        /* Inventory alert */
        .inventory-alert {
          position: fixed;
          top: 80px;
          right: 20px;
          background: linear-gradient(45deg, #ff9800, #ff5722);
          color: white;
          padding: 10px 20px;
          border-radius: 10px;
          z-index: 100;
          display: flex;
          align-items: center;
          gap: 10px;
          box-shadow: 0 5px 15px rgba(255, 152, 0, 0.3);
          animation: slideInRight 0.3s ease;
        }

        @keyframes slideInRight {
          from { transform: translateX(100%); opacity: 0; }
          to { transform: translateX(0); opacity: 1; }
        }
        `;

          const style = document.createElement("style");
          style.textContent = inventoryCSS;
          document.head.appendChild(style);

          const bogoCSS = `
/* BOGO Coupon Indicator */
.bogo-coupon {
  position: relative;
}

.bogo-coupon::after {
  content: "BOGO";
  position: absolute;
  top: -8px;
  right: -8px;
  background: linear-gradient(45deg, #ff4081, #f50057);
  color: white;
  font-size: 10px;
  font-weight: bold;
  padding: 2px 6px;
  border-radius: 10px;
  animation: pulse 2s infinite;
}

@keyframes pulse {
  0% { transform: scale(1); }
  50% { transform: scale(1.05); }
  100% { transform: scale(1); }
}

/* BOGO Applied Message */
.bogo-message {
  background: linear-gradient(45deg, #e8f5e9, #c8e6c9);
  border-left: 4px solid #4caf50;
  padding: 10px;
  border-radius: 8px;
  margin-top: 5px;
  font-size: 12px;
  color: #2e7d32;
}

/* BOGO badge in coupons table */
.bogo-badge {
  background: #f50057;
  color: white;
  font-size: 9px;
  padding: 1px 4px;
  border-radius: 4px;
  margin-left: 5px;
}
`;

          const bogoStyle = document.createElement("style");
          bogoStyle.textContent = bogoCSS;
          document.head.appendChild(bogoStyle);

          // Initialize enhanced keyboard system
          setTimeout(() => {
            initializeEnhancedKeyboardSystem();

            // Auto-focus on first field
            setTimeout(() => {
              focusField("purchaserPhone");
              showNotification(
                "Press Enter to navigate between fields. Ctrl+S to save bill.",
                "info"
              );
            }, 500);
          }, 100);

          // Setup page focus refresh
          setupPageFocusRefresh();

          // Add item button
          const addItemBtn = document.getElementById("addItemBtn");
          if (addItemBtn) {
            addItemBtn.addEventListener("click", function () {
              addItemRow();
            });

            // Make button keyboard accessible
            addItemBtn.addEventListener("keydown", function (e) {
              if (e.key === "Enter" || e.key === " ") {
                e.preventDefault();
                addItemRow();
              }
            });
          }

          // Check customer button
          const checkCustomerBtn = document.getElementById("checkCustomerBtn");
          if (checkCustomerBtn) {
            checkCustomerBtn.addEventListener("click", function (e) {
              e.preventDefault();
              e.stopPropagation();
              manualCheckCustomer();
            });

            checkCustomerBtn.addEventListener("keydown", function (e) {
              if (e.key === "Enter" || e.key === " ") {
                e.preventDefault();
                manualCheckCustomer();
              }
            });
          }

          // Make submit button more keyboard-friendly
          const submitBillBtn = document.getElementById("submitBill");
          if (submitBillBtn) {
            // Add tabindex for keyboard focus
            submitBillBtn.setAttribute("tabindex", "0");

            submitBillBtn.addEventListener("keydown", function (e) {
              if (e.key === "Enter" || e.key === " ") {
                e.preventDefault();
                this.click();
              }
            });
          }

          // Reset form
          const resetFormBtn = document.getElementById("resetForm");
          if (resetFormBtn) {
            resetFormBtn.addEventListener("click", function () {
              {
                document.getElementById("billingForm").reset();
                document.getElementById("itemsTableBody").innerHTML = "";
                document.getElementById("couponDisplaySection").style.display =
                  "none";
                appliedCoupon = null;
                updateOrderSummary();
                document.getElementById("birthdayPersonBirthdate").value =
                  today;

                const customerInfoDiv = document.getElementById("customerInfo");
                if (customerInfoDiv) {
                  customerInfoDiv.style.display = "none";
                }

                updateItemRows();
                currentItemRow = null;
                currentItemField = 0;

                setTimeout(() => {
                  focusField("purchaserPhone");
                }, 100);

                showNotification("Form reset", "info");
              }
            });

            resetFormBtn.addEventListener("keydown", function (e) {
              if (e.key === "Enter" || e.key === " ") {
                e.preventDefault();
                this.click();
              }
            });
          }

          // Add WhatsApp share button to the button group
          const buttonGroup = document.querySelector(".button-group");
          if (buttonGroup && !document.getElementById("whatsappShareBtn")) {
            const whatsappBtn = document.createElement("button");
            whatsappBtn.type = "button";
            whatsappBtn.id = "whatsappShareBtn";
            whatsappBtn.className = "btn btn-success";
            whatsappBtn.innerHTML =
              '<i class="fab fa-whatsapp"></i> Send via WhatsApp';
            whatsappBtn.style.display = "none"; // Hidden by default

            buttonGroup.appendChild(whatsappBtn);

            // WhatsApp button click handler
            whatsappBtn.addEventListener("click", function () {
              if (!window.lastSavedBill || !window.lastPdfUrl) {
                showNotification("Please save a bill first", "warning");
                return;
              }

              openWhatsAppWithBill(window.lastSavedBill, window.lastPdfUrl);
            });

            // Show WhatsApp button when a bill is saved
            window.addEventListener("billSaved", function (e) {
              if (e.detail && e.detail.bill && e.detail.pdfUrl) {
                window.lastSavedBill = e.detail.bill;
                window.lastPdfUrl = e.detail.pdfUrl;
                whatsappBtn.style.display = "flex";
              }
            });
          }

          // Database setup
          const setupDbBtn = document.getElementById("setupDbBtn");
          if (setupDbBtn) {
            setupDbBtn.addEventListener("click", function () {
              const dbInfoModal = document.getElementById("dbInfoModal");
              if (dbInfoModal) {
                dbInfoModal.style.display = "flex";
                document.getElementById("sbUrlInput").value =
                  config.supabaseUrl;
                document.getElementById("sbKeyInput").value =
                  config.supabaseKey;

                // Focus on first input in modal
                setTimeout(() => {
                  document.getElementById("sbUrlInput")?.focus();
                }, 100);
              }
            });
          }

          const closeDbModal = document.getElementById("closeDbModal");
          if (closeDbModal) {
            closeDbModal.addEventListener("click", function () {
              const dbInfoModal = document.getElementById("dbInfoModal");
              if (dbInfoModal) {
                dbInfoModal.style.display = "none";
                focusField("purchaserPhone");
              }
            });

            closeDbModal.addEventListener("keydown", function (e) {
              if (e.key === "Enter" || e.key === " ") {
                e.preventDefault();
                this.click();
              }
            });
          }

          const saveDbConfig = document.getElementById("saveDbConfig");
          if (saveDbConfig) {
            saveDbConfig.addEventListener("click", function () {
              const url = document.getElementById("sbUrlInput").value;
              const key = document.getElementById("sbKeyInput").value;

              if (url && key) {
                config.supabaseUrl = url;
                config.supabaseKey = key;
                localStorage.setItem("cakeBlissConfig", JSON.stringify(config));

                if (initSupabase()) {
                  showNotification(
                    "Database configuration saved successfully!",
                    "success"
                  );
                  const dbInfoModal = document.getElementById("dbInfoModal");
                  if (dbInfoModal) {
                    dbInfoModal.style.display = "none";
                    focusField("purchaserPhone");
                  }
                }
              } else {
                showNotification("Please enter both URL and Key", "error");
              }
            });

            saveDbConfig.addEventListener("keydown", function (e) {
              if (e.key === "Enter" || e.key === " ") {
                e.preventDefault();
                this.click();
              }
            });
          }

          // Add help button to footer
          const footerLinks = document.querySelector(".footer-links");
          if (footerLinks) {
            const helpLink = document.createElement("a");
            helpLink.href = "#";
            helpLink.innerHTML =
              '<i class="fas fa-keyboard"></i> Keyboard Help (F1)';
            helpLink.addEventListener("click", function (e) {
              e.preventDefault();
              showKeyboardHelp();
            });

            helpLink.addEventListener("keydown", function (e) {
              if (e.key === "Enter" || e.key === " ") {
                e.preventDefault();
                showKeyboardHelp();
              }
            });

            footerLinks.appendChild(helpLink);
          }

          // Show welcome message with keyboard tips
          setTimeout(() => {
            showNotification(
              "Press F1 for keyboard shortcuts. Use Tab to navigate.",
              "info"
            );
          }, 1500);

          setTimeout(() => {
            ensureCatalogLoaded();
          }, 3000);
        });
        // WhatsApp button click handler
        const whatsappBtn = document.getElementById("whatsappShareBtn");
        if (whatsappBtn) {
          whatsappBtn.addEventListener("click", function () {
            if (!window.lastSavedBill || !window.lastPdfUrl) {
              showNotification("Please save a bill first", "warning");
              return;
            }

            openWhatsAppWithBill(window.lastSavedBill, window.lastPdfUrl);
          });

          // WhatsApp keyboard shortcut (Ctrl+W)
          document.addEventListener("keydown", function (e) {
            if ((e.ctrlKey || e.metaKey) && e.key.toLowerCase() === "w") {
              e.preventDefault();
              if (window.lastSavedBill && window.lastPdfUrl) {
                whatsappBtn.click();
              } else {
                showNotification("Save a bill first (Ctrl+S)", "info");
              }
            }
          });
        }
      })();
    </script>
  </body>
</html>
