<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Cake Bliss | Billing & Customer Management</title>
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    />
    <!-- Include Supabase JS -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
      }

      :root {
        --primary: #ff7bac;
        --secondary: #ffb347;
        --accent: #9d4edd;
        --light: #fff9fb;
        --dark: #333333;
        --success: #4caf50;
        --warning: #ff9800;
        --danger: #f44336;
      }

      body {
        background: linear-gradient(135deg, #ffecd2 0%, #fcb69f 100%);
        color: var(--dark);
        min-height: 100vh;
        padding: 20px;
      }

      .container {
        max-width: 1200px;
        margin: 0 auto;
      }

      /* Header Styles */
      header {
        background-color: white;
        border-radius: 20px;
        padding: 25px 40px;
        margin-bottom: 30px;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.08);
        display: flex;
        justify-content: space-between;
        align-items: center;
        flex-wrap: wrap;
      }

      .logo-container {
        display: flex;
        align-items: center;
        gap: 15px;
      }

      .logo {
        width: 60px;
        height: 60px;
        background: linear-gradient(45deg, var(--primary), var(--secondary));
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-size: 28px;
      }

      .logo-text h1 {
        color: var(--primary);
        font-size: 28px;
        font-weight: 800;
        letter-spacing: 1px;
      }

      .logo-text p {
        color: var(--dark);
        font-size: 14px;
        opacity: 0.8;
      }

      nav ul {
        display: flex;
        list-style: none;
        gap: 25px;
      }

      nav a {
        text-decoration: none;
        color: var(--dark);
        font-weight: 600;
        font-size: 16px;
        padding: 8px 15px;
        border-radius: 50px;
        transition: all 0.3s ease;
      }

      nav a:hover,
      nav a.active {
        background-color: var(--primary);
        color: white;
      }

      /* Main Content */
      .main-content {
        display: flex;
        gap: 30px;
        flex-wrap: wrap;
      }

      /* Billing Form */
      .billing-card {
        background-color: white;
        border-radius: 20px;
        padding: 35px;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.08);
        flex: 2;
        min-width: 300px;
      }

      .billing-card h2 {
        color: var(--primary);
        margin-bottom: 10px;
        font-size: 26px;
        display: flex;
        align-items: center;
        gap: 10px;
      }

      .billing-card h2 i {
        color: var(--secondary);
      }

      .form-subtitle {
        color: #666;
        margin-bottom: 30px;
        font-size: 15px;
      }

      .form-row {
        display: flex;
        flex-wrap: wrap;
        gap: 20px;
        margin-bottom: 25px;
      }

      .form-group {
        flex: 1;
        min-width: 250px;
      }

      .form-group label {
        display: block;
        margin-bottom: 8px;
        font-weight: 600;
        color: var(--dark);
      }

      .form-group input,
      .form-group select {
        width: 100%;
        padding: 14px 18px;
        border: 2px solid #eee;
        border-radius: 12px;
        font-size: 16px;
        transition: all 0.3s;
      }

      .form-group input:focus,
      .form-group select:focus {
        border-color: var(--primary);
        outline: none;
        box-shadow: 0 0 0 3px rgba(255, 123, 172, 0.2);
      }

      .date-group {
        display: flex;
        gap: 15px;
      }

      .date-group .form-group {
        flex: 1;
      }

      .cake-price-row {
        background-color: #fff9fb;
        padding: 20px;
        border-radius: 12px;
        margin-top: 10px;
      }

      .price-display {
        font-size: 28px;
        font-weight: 800;
        color: var(--accent);
        text-align: center;
        margin-top: 10px;
      }

      .button-group {
        display: flex;
        gap: 15px;
        margin-top: 30px;
        flex-wrap: wrap;
      }

      .btn {
        padding: 16px 30px;
        border-radius: 12px;
        border: none;
        font-size: 16px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s;
        flex: 1;
        min-width: 150px;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 10px;
      }

      .btn-primary {
        background-color: var(--primary);
        color: white;
      }

      .btn-primary:hover {
        background-color: #ff5a9c;
        transform: translateY(-3px);
        box-shadow: 0 5px 15px rgba(255, 123, 172, 0.4);
      }

      .btn-secondary {
        background-color: var(--secondary);
        color: white;
      }

      .btn-secondary:hover {
        background-color: #ff9e1f;
        transform: translateY(-3px);
        box-shadow: 0 5px 15px rgba(255, 179, 71, 0.4);
      }

      .btn-success {
        background-color: var(--success);
        color: white;
      }

      .btn-success:hover {
        background-color: #3d8b40;
        transform: translateY(-3px);
        box-shadow: 0 5px 15px rgba(76, 175, 80, 0.4);
      }

      /* Cake Gallery Sidebar */
      .cake-gallery {
        flex: 1;
        min-width: 300px;
      }

      .gallery-card {
        background-color: white;
        border-radius: 20px;
        padding: 25px;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.08);
        margin-bottom: 30px;
      }

      .gallery-card h3 {
        color: var(--primary);
        margin-bottom: 20px;
        font-size: 22px;
        display: flex;
        align-items: center;
        gap: 10px;
      }

      .cake-item {
        display: flex;
        align-items: center;
        padding: 15px;
        border-radius: 12px;
        margin-bottom: 15px;
        cursor: pointer;
        transition: all 0.3s;
        border: 2px solid transparent;
      }

      .cake-item:hover {
        background-color: #fff9fb;
        transform: translateX(5px);
      }

      .cake-item.selected {
        border-color: var(--primary);
        background-color: rgba(255, 123, 172, 0.05);
      }

      .cake-icon {
        width: 50px;
        height: 50px;
        background: linear-gradient(45deg, var(--secondary), var(--primary));
        border-radius: 10px;
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-size: 22px;
        margin-right: 15px;
      }

      .cake-details h4 {
        color: var(--dark);
        margin-bottom: 5px;
      }

      .cake-details p {
        color: var(--accent);
        font-weight: 700;
        font-size: 18px;
      }

      /* Recent Orders */
      .recent-orders {
        background-color: white;
        border-radius: 20px;
        padding: 25px;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.08);
      }

      .orders-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
      }

      .orders-header h3 {
        color: var(--primary);
        font-size: 22px;
        display: flex;
        align-items: center;
        gap: 10px;
      }

      .order-count {
        background-color: var(--primary);
        color: white;
        padding: 5px 15px;
        border-radius: 50px;
        font-weight: 600;
      }

      .order-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 15px;
        border-bottom: 1px solid #eee;
      }

      .order-item:last-child {
        border-bottom: none;
      }

      .order-cake {
        font-weight: 600;
        color: var(--dark);
      }

      .order-price {
        color: var(--accent);
        font-weight: 700;
      }

      /* Footer */
      footer {
        text-align: center;
        margin-top: 40px;
        padding: 20px;
        color: #666;
        font-size: 14px;
      }

      .footer-links {
        display: flex;
        justify-content: center;
        gap: 20px;
        margin-top: 10px;
      }

      .footer-links a {
        color: var(--primary);
        text-decoration: none;
      }

      /* Notification */
      .notification {
        position: fixed;
        top: 20px;
        right: 20px;
        padding: 15px 25px;
        border-radius: 12px;
        color: white;
        font-weight: 600;
        z-index: 1000;
        display: flex;
        align-items: center;
        gap: 10px;
        transform: translateX(150%);
        transition: transform 0.3s ease;
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
      }

      .notification.show {
        transform: translateX(0);
      }

      .notification.success {
        background-color: var(--success);
      }

      .notification.error {
        background-color: var(--danger);
      }

      .notification.info {
        background-color: var(--accent);
      }

      /* Database Status */
      .db-status {
        display: inline-flex;
        align-items: center;
        gap: 8px;
        padding: 5px 12px;
        border-radius: 50px;
        font-size: 14px;
        font-weight: 600;
        margin-top: 10px;
      }

      .db-status.connected {
        background-color: rgba(76, 175, 80, 0.1);
        color: var(--success);
      }

      .db-status.disconnected {
        background-color: rgba(244, 67, 54, 0.1);
        color: var(--danger);
      }

      .status-dot {
        width: 10px;
        height: 10px;
        border-radius: 50%;
      }

      .status-dot.connected {
        background-color: var(--success);
        animation: pulse 2s infinite;
      }

      .status-dot.disconnected {
        background-color: var(--danger);
      }

      @keyframes pulse {
        0% {
          opacity: 1;
        }
        50% {
          opacity: 0.5;
        }
        100% {
          opacity: 1;
        }
      }

      /* Responsive Design */
      @media (max-width: 992px) {
        .main-content {
          flex-direction: column;
        }

        nav ul {
          margin-top: 20px;
          width: 100%;
          justify-content: center;
        }
      }

      @media (max-width: 576px) {
        .form-row {
          flex-direction: column;
        }

        .date-group {
          flex-direction: column;
        }

        .button-group {
          flex-direction: column;
        }

        header {
          padding: 20px;
        }

        .billing-card {
          padding: 25px;
        }
      }

      /* Cake-themed decorative elements */
      .cake-decoration {
        position: fixed;
        width: 100px;
        height: 100px;
        opacity: 0.05;
        z-index: -1;
        pointer-events: none;
      }

      .cake-1 {
        top: 10%;
        left: 5%;
        font-size: 100px;
        color: var(--primary);
      }

      .cake-2 {
        bottom: 10%;
        right: 5%;
        font-size: 80px;
        color: var(--secondary);
      }

      .cake-3 {
        top: 50%;
        right: 10%;
        font-size: 60px;
        color: var(--accent);
      }
      /* Add this to the existing CSS */
      .returning-customer-badge {
        display: inline-flex;
        align-items: center;
        gap: 5px;
        background-color: rgba(76, 175, 80, 0.1);
        color: var(--success);
        padding: 3px 10px;
        border-radius: 50px;
        font-size: 12px;
        font-weight: 600;
        margin-left: 10px;
        cursor: pointer;
        transition: all 0.3s;
      }

      .returning-customer-badge:hover {
        background-color: rgba(76, 175, 80, 0.2);
        transform: scale(1.05);
      }

      .form-group .customer-info {
        display: flex;
        align-items: center;
        gap: 10px;
        flex-wrap: wrap;
      }
      /* Add to existing CSS */
      .keyboard-hint {
        font-size: 11px;
        color: #666;
        margin-left: 5px;
        font-weight: normal;
      }

      .form-group input:focus,
      .form-group select:focus,
      .btn:focus {
        outline: 3px solid var(--accent);
        outline-offset: 2px;
        box-shadow: 0 0 0 5px rgba(157, 78, 221, 0.2);
      }

      .quick-select-btn {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        width: 30px;
        height: 30px;
        background-color: #f0f0f0;
        border: 1px solid #ddd;
        border-radius: 4px;
        margin-left: 5px;
        cursor: pointer;
        font-weight: bold;
        font-size: 12px;
      }

      .quick-select-btn:hover {
        background-color: var(--primary);
        color: white;
        border-color: var(--primary);
      }

      .cake-quick-select {
        display: flex;
        gap: 5px;
        margin-top: 5px;
        flex-wrap: wrap;
      }

      .current-field-indicator {
        position: absolute;
        top: -10px;
        right: 10px;
        background-color: var(--accent);
        color: white;
        padding: 2px 8px;
        border-radius: 10px;
        font-size: 10px;
        font-weight: bold;
      }

      .form-group {
        position: relative;
      }
      /* Add to existing CSS */
      select:focus {
        border-color: var(--primary) !important;
        box-shadow: 0 0 0 3px rgba(255, 123, 172, 0.3) !important;
      }

      select option {
        padding: 10px;
        font-size: 14px;
      }

      select option:checked {
        background-color: var(--primary);
        color: white;
      }

      select option:hover {
        background-color: #fff9fb;
      }

      /* Enhanced dropdown when focused */
      select[multiple],
      select[size] {
        border-radius: 12px;
        border: 2px solid var(--primary);
        background-color: white;
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
      }

      .dropdown-active {
        position: relative;
      }

      .dropdown-active::after {
        content: "▼";
        position: absolute;
        right: 15px;
        top: 50%;
        transform: translateY(-50%);
        color: var(--primary);
        pointer-events: none;
      }
    </style>
  </head>
  <body>
    <!-- Decorative cake icons in background -->
    <div class="cake-decoration cake-1">
      <i class="fas fa-birthday-cake"></i>
    </div>
    <div class="cake-decoration cake-2">
      <i class="fas fa-cookie-bite"></i>
    </div>
    <div class="cake-decoration cake-3">
      <i class="fas fa-cupcake"></i>
    </div>

    <!-- Notification Area -->
    <div id="notification" class="notification">
      <i class="fas fa-check-circle"></i>
      <span>Notification message</span>
    </div>

    <div class="container">
      <!-- Header -->
      <header>
        <div class="logo-container">
          <div class="logo">
            <i class="fas fa-birthday-cake"></i>
          </div>
          <div class="logo-text">
            <h1>Cake Bliss</h1>
            <p>Billing & Customer Management System</p>
            <div id="dbStatus" class="db-status disconnected">
              <div class="status-dot disconnected"></div>
              <span>Supabase: Disconnected</span>
            </div>
          </div>
        </div>
        <nav>
          <ul>
            <li>
              <a href="#" class="active"
                ><i class="fas fa-receipt"></i> Billing</a
              >
            </li>
            <li>
              <a href="#" id="viewCustomersBtn"
                ><i class="fas fa-users"></i> Customers</a
              >
            </li>
            <li>
              <a href="reports.html"
                ><i class="fas fa-chart-bar"></i> Reports</a
              >
            </li>
            <li>
              <a href="#"><i class="fas fa-cog"></i> Settings</a>
            </li>
          </ul>
        </nav>
      </header>

      <div class="main-content">
        <!-- Billing Form -->
        <div class="billing-card">
          <h2><i class="fas fa-cash-register"></i> Create New Bill</h2>
          <p class="form-subtitle">
            Fill in customer details and cake information to generate a bill
          </p>

          <form id="billingForm">
            <div class="form-row">
              <div class="form-group">
                <label for="purchaserPhone"
                  ><i class="fas fa-phone"></i> Purchaser Phone *</label
                >
                <div class="customer-info">
                  <input
                    type="tel"
                    id="purchaserPhone"
                    placeholder="1234567890"
                    required
                    tabindex="1"
                    style="flex: 1"
                  />
                  <button
                    type="button"
                    id="checkCustomerBtn"
                    class="btn"
                    style="
                      padding: 10px 15px;
                      background-color: #f0f0f0;
                      min-width: auto;
                    "
                    tabindex="2"
                  >
                    <i class="fas fa-search"></i> Check (F2)
                  </button>
                </div>
                <div
                  id="customerInfo"
                  style="margin-top: 10px; display: none"
                ></div>
              </div>
              <div class="form-group">
                <label for="birthdayPersonPhone"
                  ><i class="fas fa-mobile-alt"></i> Birthday Person
                  Phone</label
                >
                <input
                  type="tel"
                  id="birthdayPersonPhone"
                  placeholder="Optional"
                  tabindex="3"
                />
              </div>
            </div>

            <div class="form-row">
              <div class="form-group">
                <label for="purchaserName"
                  ><i class="fas fa-user"></i> Purchaser Name *</label
                >
                <input
                  type="text"
                  id="purchaserName"
                  placeholder="Enter full name"
                  required
                  tabindex="4"
                />
              </div>
              <div class="form-group">
                <label for="birthdayPersonName"
                  ><i class="fas fa-birthday-cake"></i> Birthday Person Name
                  *</label
                >
                <input
                  type="text"
                  id="birthdayPersonName"
                  placeholder="Name of person celebrating"
                  required
                  tabindex="5"
                />
              </div>
            </div>

            <div class="form-row">
              <div class="form-group">
                <label for="purchaserBirthdate"
                  ><i class="fas fa-calendar-day"></i> Purchaser
                  Birthdate</label
                >
                <input type="date" id="purchaserBirthdate" tabindex="6" />
              </div>
              <div class="form-group">
                <label for="birthdayPersonBirthdate"
                  ><i class="fas fa-calendar-check"></i> Birthday Person
                  Birthdate *</label
                >
                <input
                  type="date"
                  id="birthdayPersonBirthdate"
                  required
                  tabindex="7"
                />
              </div>
            </div>

            <div class="form-row">
              <div class="form-group">
                <label for="cakeName"
                  ><i class="fas fa-utensils"></i> Select Cake *</label
                >
                <select id="cakeName" required tabindex="8">
                  <option value="">
                    Choose a cake (Press F3 then use ↑↓ keys)
                  </option>
                  <option value="Chocolate Fudge Delight">
                    Chocolate Fudge Delight
                  </option>
                  <option value="Vanilla Dream">Vanilla Dream</option>
                  <option value="Red Velvet Supreme">Red Velvet Supreme</option>
                  <option value="Strawberry Heaven">Strawberry Heaven</option>
                  <option value="Caramel Crunch">Caramel Crunch</option>
                  <option value="Rainbow Sprinkles">Rainbow Sprinkles</option>
                </select>
                <div class="keyboard-hint">Use ↑↓ keys to select cake</div>
              </div>
              <div class="form-group">
                <label for="couponCode"
                  ><i class="fas fa-tag"></i> Coupon Code</label
                >
                <input
                  type="text"
                  id="couponCode"
                  placeholder="Enter coupon code if any"
                  tabindex="9"
                />
              </div>
            </div>

            <div class="cake-price-row">
              <div class="form-group">
                <label for="cakePrice"
                  ><i class="fas fa-dollar-sign"></i> Cake Price *</label
                >
                <input
                  type="number"
                  id="cakePrice"
                  placeholder="0.00"
                  min="0"
                  step="0.01"
                  required
                  tabindex="10"
                />
              </div>
              <div class="price-display">
                Total: $<span id="totalPrice">0.00</span>
              </div>
            </div>

            <div class="button-group">
              <button
                type="submit"
                class="btn btn-primary"
                id="submitBill"
                tabindex="11"
              >
                <i class="fas fa-file-invoice-dollar"></i> Generate & Save Bill
                (Ctrl+Enter)
              </button>
              <button
                type="button"
                class="btn"
                id="resetForm"
                style="background-color: #f0f0f0"
                tabindex="12"
              >
                <i class="fas fa-redo"></i> Reset Form (Ctrl+R)
              </button>
            </div>
          </form>
        </div>

        <!-- Cake Gallery Sidebar -->
        <div class="cake-gallery">
          <div class="gallery-card">
            <h3><i class="fas fa-store"></i> Popular Cakes</h3>

            <div
              class="cake-item selected"
              data-cake="Chocolate Fudge Delight"
              data-price="45.99"
            >
              <div class="cake-icon">
                <i class="fas fa-cookie"></i>
              </div>
              <div class="cake-details">
                <h4>Chocolate Fudge Delight</h4>
                <p>$45.99</p>
              </div>
            </div>

            <div
              class="cake-item"
              data-cake="Red Velvet Supreme"
              data-price="52.50"
            >
              <div class="cake-icon">
                <i class="fas fa-birthday-cake"></i>
              </div>
              <div class="cake-details">
                <h4>Red Velvet Supreme</h4>
                <p>$52.50</p>
              </div>
            </div>

            <div
              class="cake-item"
              data-cake="Rainbow Sprinkles"
              data-price="38.75"
            >
              <div class="cake-icon">
                <i class="fas fa-ice-cream"></i>
              </div>
              <div class="cake-details">
                <h4>Rainbow Sprinkles</h4>
                <p>$38.75</p>
              </div>
            </div>

            <div
              class="cake-item"
              data-cake="Strawberry Heaven"
              data-price="42.25"
            >
              <div class="cake-icon">
                <i class="fas fa-stroopwafel"></i>
              </div>
              <div class="cake-details">
                <h4>Strawberry Heaven</h4>
                <p>$42.25</p>
              </div>
            </div>
          </div>

          <!-- Recent Orders -->
          <div class="recent-orders">
            <div class="orders-header">
              <h3><i class="fas fa-history"></i> Recent Bills</h3>
              <div class="order-count" id="recentBillsCount">0</div>
            </div>
            <div id="recentBillsList">
              <!-- Bills will be loaded here from Supabase -->
              <div class="order-item">
                <div class="order-cake">Loading...</div>
                <div class="order-price">$0.00</div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Database Info Modal (Hidden by default) -->
      <div
        id="dbInfoModal"
        style="
          display: none;
          position: fixed;
          top: 0;
          left: 0;
          width: 100%;
          height: 100%;
          background: rgba(0, 0, 0, 0.5);
          z-index: 1001;
          align-items: center;
          justify-content: center;
        "
      >
        <div
          style="
            background: white;
            padding: 30px;
            border-radius: 20px;
            max-width: 500px;
            width: 90%;
          "
        >
          <h3 style="color: var(--primary); margin-bottom: 20px">
            <i class="fas fa-database"></i> Database Setup Required
          </h3>
          <p style="margin-bottom: 15px">
            To connect to Supabase, you need to:
          </p>
          <!-- In your dbInfoModal, update the instructions -->
          <ol style="margin-bottom: 20px; padding-left: 20px">
            <li style="margin-bottom: 10px">
              Create a free account at
              <a href="https://supabase.com" target="_blank">supabase.com</a>
            </li>
            <li style="margin-bottom: 10px">Create a new project</li>
            <li style="margin-bottom: 10px">
              Create ONE table named "cake_bills" with these columns:
              <ul style="margin-top: 5px; padding-left: 15px">
                <li>id (uuid, primary key)</li>
                <li>bill_number (text, unique)</li>
                <li>purchaser_name (text)</li>
                <li>birthday_person_name (text)</li>
                <li>purchaser_birthdate (date)</li>
                <li>birthday_person_birthdate (date)</li>
                <li>purchaser_phone (text)</li>
                <li>birthday_person_phone (text)</li>
                <li>cake_name (text)</li>
                <li>cake_price (numeric)</li>
                <li>total_price (numeric)</li>
                <li>coupon_code (text)</li>
                <li>created_at (timestamp)</li>
              </ul>
            </li>
            <li>Update the Supabase URL and Key below</li>
          </ol>
          <div style="margin-bottom: 20px">
            <label style="display: block; margin-bottom: 5px; font-weight: 600"
              >Supabase URL:</label
            >
            <input
              type="text"
              id="sbUrlInput"
              style="
                width: 100%;
                padding: 10px;
                border: 2px solid #eee;
                border-radius: 8px;
                margin-bottom: 15px;
              "
              placeholder="https://your-project.supabase.co"
            />

            <label style="display: block; margin-bottom: 5px; font-weight: 600"
              >Supabase Anon Key:</label
            >
            <input
              type="text"
              id="sbKeyInput"
              style="
                width: 100%;
                padding: 10px;
                border: 2px solid #eee;
                border-radius: 8px;
              "
              placeholder="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9..."
            />
          </div>
          <div style="display: flex; gap: 10px">
            <button id="saveDbConfig" class="btn btn-primary" style="flex: 1">
              Save Configuration
            </button>
            <button
              id="closeDbModal"
              class="btn"
              style="flex: 1; background-color: #f0f0f0"
            >
              Close
            </button>
          </div>
        </div>
      </div>

      <footer>
        <p>&copy; 2023 Cake Bliss Billing System. All rights reserved.</p>
        <div class="footer-links">
          <a href="#" id="setupDbBtn"
            ><i class="fas fa-database"></i> Setup DB</a
          >
          <a href="#"><i class="fas fa-question-circle"></i> Help</a>
          <a href="#"><i class="fas fa-shield-alt"></i> Privacy</a>
          <a href="#"><i class="fas fa-file-contract"></i> Terms</a>
        </div>
      </footer>
    </div>
    <!-- Keyboard Shortcut Help -->
    <div
      id="keyboardHelp"
      style="position: fixed; bottom: 20px; right: 20px; z-index: 999"
    >
      <button
        id="toggleHelp"
        class="btn"
        style="
          padding: 8px 15px;
          background-color: var(--accent);
          color: white;
          border-radius: 50px;
        "
      >
        <i class="fas fa-keyboard"></i> Shortcuts (F1)
      </button>

      <div
        id="helpModal"
        style="
          display: none;
          position: absolute;
          bottom: 50px;
          right: 0;
          width: 300px;
          background: white;
          border-radius: 10px;
          padding: 20px;
          box-shadow: 0 5px 20px rgba(0, 0, 0, 0.2);
        "
      >
        <h4 style="color: var(--primary); margin-bottom: 15px">
          <i class="fas fa-keyboard"></i> Keyboard Shortcuts
        </h4>
        <table style="width: 100%; font-size: 13px">
          <tr>
            <td><kbd>Enter</kbd></td>
            <td>Next field</td>
          </tr>
          <tr>
            <td><kbd>Esc</kbd></td>
            <td>Clear field / Close dropdown</td>
          </tr>
          <tr>
            <td><kbd>F2</kbd></td>
            <td>Check customer</td>
          </tr>
          <tr>
            <td><kbd>F3</kbd></td>
            <td>Open cake dropdown</td>
          </tr>
          <tr>
            <td><kbd>F4</kbd></td>
            <td>Edit price</td>
          </tr>
          <tr>
            <td><kbd>F5</kbd></td>
            <td>Today's date</td>
          </tr>
          <tr>
            <td><kbd>F8</kbd></td>
            <td>Repeat last customer</td>
          </tr>
          <tr>
            <td><kbd>↑↓</kbd> in dropdown</td>
            <td>Select cake</td>
          </tr>
          <tr>
            <td><kbd>Enter</kbd> in dropdown</td>
            <td>Confirm selection</td>
          </tr>
          <tr>
            <td><kbd>Ctrl+Enter</kbd></td>
            <td>Generate & Save Bill</td>
          </tr>
          <tr>
            <td><kbd>Ctrl+R</kbd></td>
            <td>Reset form</td>
          </tr>
          <tr>
            <td><kbd>T/Y</kbd> in date</td>
            <td>Today/Yesterday</td>
          </tr>
        </table>
      </div>
    </div>
    <script>
  // Supabase Configuration
  let supabase = null;
  let isConnected = false;

  // Default configuration
  const DEFAULT_CONFIG = {
    supabaseUrl: "https://vdbwzmutxjonnpfwfpbn.supabase.co",
    supabaseKey: "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZkYnd6bXV0eGpvbm5wZndmcGJuIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQ5OTcwMjQsImV4cCI6MjA4MDU3MzAyNH0.n0ERxgLgYU1Tvw5QONihv1C3A7o7rcxrcn5MjZ5UnEM",
  };

  // Load configuration from localStorage
  let config = JSON.parse(localStorage.getItem("cakeBlissConfig")) || DEFAULT_CONFIG;

  // Track last customer for quick repeat
  let lastCustomerData = null;

  // Initialize Supabase if credentials exist
  function initSupabase() {
    if (config.supabaseUrl && config.supabaseKey) {
      try {
        supabase = window.supabase.createClient(config.supabaseUrl, config.supabaseKey);
        updateDbStatus(true);
        loadRecentBills();
        console.log("Supabase connected successfully");
        showNotification("Connected to Supabase database!", "success");
        return true;
      } catch (error) {
        console.error("Error initializing Supabase:", error);
        updateDbStatus(false);
        showNotification("Failed to connect to Supabase", "error");
        return false;
      }
    } else {
      updateDbStatus(false);
      return false;
    }
  }

  // Update database connection status
  function updateDbStatus(connected) {
    isConnected = connected;
    const dbStatus = document.getElementById("dbStatus");
    const statusDot = dbStatus.querySelector(".status-dot");
    const statusText = dbStatus.querySelector("span");

    if (connected) {
      dbStatus.className = "db-status connected";
      statusDot.className = "status-dot connected";
      statusText.textContent = "Supabase: Connected";
    } else {
      dbStatus.className = "db-status disconnected";
      statusDot.className = "status-dot disconnected";
      statusText.textContent = "Supabase: Disconnected";
    }
  }

  // Show notification
  function showNotification(message, type = "success") {
    const notification = document.getElementById("notification");
    const icon = notification.querySelector("i");
    const text = notification.querySelector("span");

    notification.className = `notification ${type}`;
    text.textContent = message;

    // Set icon based on type
    if (type === "success") {
      icon.className = "fas fa-check-circle";
    } else if (type === "error") {
      icon.className = "fas fa-exclamation-circle";
    } else {
      icon.className = "fas fa-info-circle";
    }

    notification.classList.add("show");

    // Auto hide after 5 seconds
    setTimeout(() => {
      notification.classList.remove("show");
    }, 5000);
  }

  // Save bill to Supabase
  async function saveBillToDatabase(billData) {
    if (!isConnected || !supabase) {
      showNotification("Not connected to database. Please setup Supabase first.", "error");
      return null;
    }

    // Generate a unique bill number
    const billNumber = "BILL-" + Date.now() + "-" + Math.floor(Math.random() * 1000);

    try {
      const { data, error } = await supabase
        .from("cake_bills")
        .insert([
          {
            bill_number: billNumber,
            purchaser_name: billData.purchaserName,
            birthday_person_name: billData.birthdayPersonName,
            purchaser_birthdate: billData.purchaserBirthdate || null,
            birthday_person_birthdate: billData.birthdayPersonBirthdate,
            purchaser_phone: billData.purchaserPhone,
            birthday_person_phone: billData.birthdayPersonPhone || null,
            cake_name: billData.cakeName,
            cake_price: parseFloat(billData.cakePrice),
            total_price: parseFloat(billData.totalPrice),
            coupon_code: billData.couponCode || null,
            created_at: new Date().toISOString(),
          },
        ])
        .select();

      if (error) {
        console.error("Error saving bill:", error);
        showNotification("Failed to save bill: " + error.message, "error");
        return null;
      }

      showNotification("Bill saved successfully! Bill #: " + billNumber, "success");
      loadRecentBills(); // Refresh recent bills
      return data[0];
    } catch (error) {
      console.error("Error saving bill:", error);
      showNotification("Failed to save bill", "error");
      return null;
    }
  }

  // Load recent bills from Supabase
  async function loadRecentBills() {
    if (!isConnected || !supabase) {
      console.log("Cannot load bills: Supabase not connected");
      return;
    }

    try {
      const { data, error } = await supabase
        .from("cake_bills")
        .select("cake_name, total_price, created_at, purchaser_name")
        .order("created_at", { ascending: false })
        .limit(5);

      if (error) {
        console.error("Error loading bills:", error);
        return;
      }

      const billsList = document.getElementById("recentBillsList");
      const billsCount = document.getElementById("recentBillsCount");

      if (data && data.length > 0) {
        billsList.innerHTML = "";
        data.forEach((bill) => {
          const billDate = new Date(bill.created_at).toLocaleDateString();
          const shortCakeName = bill.cake_name.length > 15
            ? bill.cake_name.substring(0, 15) + "..."
            : bill.cake_name;

          const billItem = document.createElement("div");
          billItem.className = "order-item";
          billItem.innerHTML = `
            <div class="order-cake" title="${bill.cake_name} (${bill.purchaser_name})">${shortCakeName}</div>
            <div class="order-price">$${parseFloat(bill.total_price).toFixed(2)}</div>
          `;
          billsList.appendChild(billItem);
        });

        billsCount.textContent = data.length;
      } else {
        billsList.innerHTML = '<div class="order-item"><div class="order-cake">No bills yet</div><div class="order-price">$0.00</div></div>';
        billsCount.textContent = "0";
      }
    } catch (error) {
      console.error("Error loading bills:", error);
    }
  }

  // Check if customer exists
  async function checkReturningCustomer(phoneNumber) {
    console.log("checkReturningCustomer called with:", phoneNumber);
    
    if (!isConnected || !supabase) {
      console.log("Supabase not connected");
      showNotification("Database not connected", "error");
      return null;
    }

    if (!phoneNumber || phoneNumber.trim().length < 5) {
      console.log("Phone number too short:", phoneNumber);
      return null;
    }

    try {
      console.log("Querying Supabase for phone:", phoneNumber.trim());
      const { data, error } = await supabase
        .from("cake_bills")
        .select("*")
        .eq("purchaser_phone", phoneNumber.trim())
        .order("created_at", { ascending: false })
        .limit(1);

      if (error) {
        console.error("Error checking customer:", error);
        showNotification("Database error: " + error.message, "error");
        return null;
      }

      console.log("Query result:", data);
      
      if (data && data.length > 0) {
        console.log("Found customer:", data[0]);
        return data[0]; // Return the most recent bill record
      }

      console.log("No customer found");
      return null;
    } catch (error) {
      console.error("Error checking customer:", error);
      showNotification("Error checking customer", "error");
      return null;
    }
  }

  // Autofill form with customer data
  function autofillCustomerForm(customerData) {
    console.log("Autofilling with:", customerData);
    
    document.getElementById("purchaserName").value = customerData.purchaser_name || "";
    document.getElementById("birthdayPersonName").value = customerData.birthday_person_name || "";

    if (customerData.purchaser_birthdate) {
      document.getElementById("purchaserBirthdate").value = customerData.purchaser_birthdate;
    }

    if (customerData.birthday_person_birthdate) {
      document.getElementById("birthdayPersonBirthdate").value = customerData.birthday_person_birthdate;
    }

    document.getElementById("birthdayPersonPhone").value = customerData.birthday_person_phone || "";

    // Set cake name if it exists in our options
    if (customerData.cake_name) {
      const cakeSelect = document.getElementById("cakeName");
      const options = Array.from(cakeSelect.options);
      const matchingOption = options.find(
        (option) => option.value.toLowerCase() === customerData.cake_name.toLowerCase()
      );
      if (matchingOption) {
        cakeSelect.value = matchingOption.value;

        // Trigger price update
        const cakePrices = {
          "Chocolate Fudge Delight": "45.99",
          "Vanilla Dream": "39.50",
          "Red Velvet Supreme": "52.50",
          "Strawberry Heaven": "42.25",
          "Caramel Crunch": "48.75",
          "Rainbow Sprinkles": "38.75",
        };

        if (cakePrices[customerData.cake_name]) {
          document.getElementById("cakePrice").value = cakePrices[customerData.cake_name];
          updateTotalPrice();
        }
      }
    }

    if (customerData.coupon_code) {
      document.getElementById("couponCode").value = customerData.coupon_code || "";
    }

    showNotification("Welcome back! Your details have been auto-filled.", "success");
  }

  // Clear customer info display
  function clearCustomerInfo() {
    const customerInfoDiv = document.getElementById("customerInfo");
    if (customerInfoDiv) {
      customerInfoDiv.style.display = "none";
      customerInfoDiv.innerHTML = "";
    }

    const returningCustomerLabel = document.getElementById("returningCustomerLabel");
    if (returningCustomerLabel) {
      returningCustomerLabel.remove();
    }
  }

  // Helper functions
  function updateTotalPrice() {
    const cakePrice = parseFloat(document.getElementById("cakePrice").value) || 0;
    document.getElementById("totalPrice").textContent = cakePrice.toFixed(2);
  }

  function validateForm() {
    const requiredFields = [
      "purchaserName",
      "birthdayPersonName",
      "purchaserPhone",
      "cakeName",
      "cakePrice",
    ];
    let isValid = true;

    requiredFields.forEach((fieldId) => {
      const field = document.getElementById(fieldId);
      if (!field.value) {
        field.style.borderColor = "red";
        isValid = false;
      } else {
        field.style.borderColor = "#eee";
      }
    });

    if (!isValid) {
      showNotification("Please fill in all required fields (marked with *)", "error");
    }

    return isValid;
  }

  function getFormData() {
    return {
      purchaserName: document.getElementById("purchaserName").value,
      birthdayPersonName: document.getElementById("birthdayPersonName").value,
      purchaserBirthdate: document.getElementById("purchaserBirthdate").value,
      birthdayPersonBirthdate: document.getElementById("birthdayPersonBirthdate").value,
      purchaserPhone: document.getElementById("purchaserPhone").value,
      birthdayPersonPhone: document.getElementById("birthdayPersonPhone").value,
      cakeName: document.getElementById("cakeName").value,
      cakePrice: document.getElementById("cakePrice").value,
      couponCode: document.getElementById("couponCode").value,
      totalPrice: document.getElementById("totalPrice").textContent,
    };
  }

  // SIMPLIFIED: Manual check for returning customers
  async function manualCheckCustomer() {
    console.log("manualCheckCustomer called");
    
    const phoneNumber = document.getElementById("purchaserPhone").value.trim();
    console.log("Phone number:", phoneNumber);

    if (!phoneNumber) {
      showNotification("Please enter a phone number first", "error");
      return;
    }

    const returningCustomer = await checkReturningCustomer(phoneNumber);

    if (returningCustomer) {
      const customerInfoDiv = document.getElementById("customerInfo");
      customerInfoDiv.innerHTML = `
        <div style="background-color: #f8f9fa; padding: 15px; border-radius: 10px; border-left: 4px solid var(--success);">
          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
            <strong style="color: var(--success);">
              <i class="fas fa-user-check"></i> Returning Customer Found
            </strong>
            <button id="autofillBtn" class="btn" style="padding: 5px 15px; background-color: var(--success); color: white; font-size: 12px;">
              <i class="fas fa-magic"></i> Auto-fill
            </button>
          </div>
          <div style="font-size: 14px;">
            <div><strong>Name:</strong> ${returningCustomer.purchaser_name}</div>
            <div><strong>Last Order:</strong> ${returningCustomer.cake_name} ($${returningCustomer.cake_price})</div>
            <div><strong>Last Order Date:</strong> ${new Date(returningCustomer.created_at).toLocaleDateString()}</div>
          </div>
        </div>
      `;
      customerInfoDiv.style.display = "block";

      document.getElementById("autofillBtn").addEventListener("click", function () {
        autofillCustomerForm(returningCustomer);
        customerInfoDiv.style.display = "none";
      });

      showNotification(`Found returning customer: ${returningCustomer.purchaser_name}`, "success");
    } else {
      const customerInfoDiv = document.getElementById("customerInfo");
      customerInfoDiv.innerHTML = `
        <div style="background-color: #fff3cd; padding: 15px; border-radius: 10px; border-left: 4px solid var(--warning); color: #856404;">
          <strong><i class="fas fa-user-plus"></i> New Customer</strong>
          <div style="font-size: 14px; margin-top: 5px;">No previous orders found with this phone number.</div>
        </div>
      `;
      customerInfoDiv.style.display = "block";
      showNotification("No previous customer found with this phone number", "info");
    }
  }

  // DOM Ready
  document.addEventListener("DOMContentLoaded", function () {
    console.log("DOM loaded, initializing...");
    
    // Initialize Supabase connection
    initSupabase();

    // Set today's date as default for birthday person's birthdate
    const today = new Date();
    const formattedDate = today.toISOString().split("T")[0];
    document.getElementById("birthdayPersonBirthdate").value = formattedDate;

    // Focus first field on page load
    setTimeout(() => {
      document.getElementById("purchaserPhone").focus();
      document.getElementById("purchaserPhone").select();
    }, 100);

    // Initialize total price
    updateTotalPrice();

    // ========== KEYBOARD SHORTCUTS ==========
    // Handle F1 for help
    document.addEventListener("keydown", function (e) {
      if (e.key === "F1") {
        e.preventDefault();
        const toggleHelp = document.getElementById("toggleHelp");
        if (toggleHelp) toggleHelp.click();
      }
    });

    // Handle F2 for customer check - FIXED VERSION
    document.addEventListener("keydown", function (e) {
      if (e.key === "F2") {
        console.log("F2 pressed");
        e.preventDefault();
        e.stopImmediatePropagation();
        
        // Call the manual check function directly
        manualCheckCustomer();
        return false;
      }
    }, true); // Use capture phase

    // Handle other shortcuts
    document.addEventListener("keydown", function (e) {
      // F3 - Open cake dropdown
      if (e.key === "F3") {
        e.preventDefault();
        const cakeSelect = document.getElementById("cakeName");
        if (cakeSelect) {
          cakeSelect.focus();
          cakeSelect.click();
        }
      }

      // F4 - Focus price field
      if (e.key === "F4") {
        e.preventDefault();
        const priceField = document.getElementById("cakePrice");
        if (priceField) {
          priceField.focus();
          priceField.select();
        }
      }

      // F5 - Auto-fill today's date in birthday field
      if (e.key === "F5") {
        e.preventDefault();
        const today = new Date().toISOString().split("T")[0];
        document.getElementById("birthdayPersonBirthdate").value = today;
        document.getElementById("purchaserPhone").focus();
      }

      // F8 - Repeat last customer
      if (e.key === "F8" && lastCustomerData) {
        e.preventDefault();
        if (confirm("Repeat last customer details?")) {
          autofillCustomerForm(lastCustomerData);
        }
      }

      // Ctrl+Enter - Generate bill
      if (e.ctrlKey && e.key === "Enter") {
        e.preventDefault();
        const submitBtn = document.getElementById("submitBill");
        if (submitBtn) submitBtn.click();
      }

      // Ctrl+R - Reset form
      if (e.ctrlKey && e.key === "r") {
        e.preventDefault();
        const resetBtn = document.getElementById("resetForm");
        if (resetBtn) resetBtn.click();
      }
    });

    // ========== EVENT LISTENERS ==========
    // Check customer button click
    document.getElementById("checkCustomerBtn").addEventListener("click", manualCheckCustomer);

    // Enter key navigation (simplified)
    const formInputs = document.querySelectorAll("#billingForm input, #billingForm select");
    formInputs.forEach((input) => {
      input.addEventListener("keydown", function (e) {
        // Enter key moves to next field
        if (e.key === "Enter" && !e.ctrlKey && !e.shiftKey) {
          e.preventDefault();
          
          // Skip for check button (handled separately)
          if (this.id === "checkCustomerBtn") return;
          
          // Find next field
          const currentTabIndex = parseInt(this.getAttribute("tabindex") || "0");
          const nextField = document.querySelector(`[tabindex="${currentTabIndex + 1}"]`);
          
          if (nextField) {
            nextField.focus();
            if (nextField.type !== "select-one") {
              nextField.select();
            }
          }
        }
      });
    });

    // Cake selection and price updates
    document.getElementById("cakeName").addEventListener("change", function () {
      const selectedCake = this.value;
      const cakePrices = {
        "Chocolate Fudge Delight": "45.99",
        "Vanilla Dream": "39.50",
        "Red Velvet Supreme": "52.50",
        "Strawberry Heaven": "42.25",
        "Caramel Crunch": "48.75",
        "Rainbow Sprinkles": "38.75",
      };

      if (cakePrices[selectedCake]) {
        document.getElementById("cakePrice").value = cakePrices[selectedCake];
        updateTotalPrice();
      }
    });

    document.getElementById("cakePrice").addEventListener("input", updateTotalPrice);

    // Cake gallery selection
    const cakeItems = document.querySelectorAll(".cake-item");
    cakeItems.forEach((item) => {
      item.addEventListener("click", function () {
        cakeItems.forEach((cake) => cake.classList.remove("selected"));
        this.classList.add("selected");

        const cakeName = this.getAttribute("data-cake");
        const cakePrice = this.getAttribute("data-price");

        document.getElementById("cakeName").value = cakeName;
        document.getElementById("cakePrice").value = cakePrice;
        updateTotalPrice();
      });
    });

    // Submit bill
    document.getElementById("submitBill").addEventListener("click", async function (e) {
      e.preventDefault();

      if (!validateForm()) return;

      const formData = getFormData();

      try {
        const savedBill = await saveBillToDatabase(formData);

        if (savedBill) {
          lastCustomerData = savedBill;

          const billDetails = `
╔══════════════════════════════════════╗
║         🎂 CAKE BLISS BILL 🎂         ║
╠══════════════════════════════════════╣
║ Bill Number: ${savedBill.bill_number}
║ Date: ${new Date().toLocaleDateString()}
╠══════════════════════════════════════╣
║ Customer: ${formData.purchaserName}
║ Birthday Person: ${formData.birthdayPersonName}
║ Cake: ${formData.cakeName}
║ Price: $${formData.cakePrice}
╠══════════════════════════════════════╣
║          TOTAL: $${formData.totalPrice}
╚══════════════════════════════════════╝
          `;

          alert(billDetails);

          if (confirm("Would you like to print the receipt?")) {
            // Add print functionality here if needed
            console.log("Print receipt:", savedBill);
          }

          setTimeout(() => {
            document.getElementById("resetForm").click();
            document.getElementById("purchaserPhone").focus();
          }, 500);
        }
      } catch (error) {
        console.error("Error processing bill:", error);
        showNotification("Failed to process bill. Please try again.", "error");
      }
    });

    // Reset form
    document.getElementById("resetForm").addEventListener("click", function () {
      if (confirm("Are you sure you want to reset the form?")) {
        document.getElementById("billingForm").reset();
        document.getElementById("totalPrice").textContent = "0.00";

        cakeItems.forEach((cake) => cake.classList.remove("selected"));
        cakeItems[0].classList.add("selected");

        document.getElementById("birthdayPersonBirthdate").value = formattedDate;
        clearCustomerInfo();
      }
    });

    // Database setup
    document.getElementById("setupDbBtn").addEventListener("click", function () {
      document.getElementById("dbInfoModal").style.display = "flex";
    });

    document.getElementById("closeDbModal").addEventListener("click", function () {
      document.getElementById("dbInfoModal").style.display = "none";
    });

    document.getElementById("saveDbConfig").addEventListener("click", function () {
      const url = document.getElementById("sbUrlInput").value;
      const key = document.getElementById("sbKeyInput").value;

      if (url && key) {
        config.supabaseUrl = url;
        config.supabaseKey = key;
        localStorage.setItem("cakeBlissConfig", JSON.stringify(config));

        if (initSupabase()) {
          showNotification("Database configuration saved successfully!", "success");
          document.getElementById("dbInfoModal").style.display = "none";
        }
      } else {
        showNotification("Please enter both URL and Key", "error");
      }
    });

    // Auto-check on phone blur
    document.getElementById("purchaserPhone").addEventListener("blur", async function () {
      const phoneNumber = this.value.trim();

      if (phoneNumber.length >= 5) {
        const returningCustomer = await checkReturningCustomer(phoneNumber);

        if (returningCustomer) {
          if (confirm(`Welcome back ${returningCustomer.purchaser_name}! Auto-fill details?`)) {
            autofillCustomerForm(returningCustomer);
          }
        }
      }
    });

    console.log("Initialization complete");
  });

  // Help modal functionality
  document.getElementById("toggleHelp").addEventListener("click", function () {
    const modal = document.getElementById("helpModal");
    modal.style.display = modal.style.display === "none" ? "block" : "none";
  });

  // Close help when clicking outside
  document.addEventListener("click", function (e) {
    const helpModal = document.getElementById("helpModal");
    const toggleButton = document.getElementById("toggleHelp");

    if (helpModal.style.display === "block" && !helpModal.contains(e.target) && !toggleButton.contains(e.target)) {
      helpModal.style.display = "none";
    }
  });
</script>
  </body>
</html>
