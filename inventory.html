<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Cake Bliss | Inventory Management System</title>
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    />
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
      }

      :root {
        --primary: #ff7bac;
        --secondary: #ffb347;
        --accent: #9d4edd;
        --light: #fff9fb;
        --dark: #333333;
        --success: #4caf50;
        --warning: #ff9800;
        --danger: #f44336;
        --info: #2196f3;
      }

      body {
        background: linear-gradient(135deg, #ffecd2 0%, #fcb69f 100%);
        color: var(--dark);
        min-height: 100vh;
        padding: 20px;
      }

      .container {
        max-width: 1400px;
        margin: 0 auto;
      }

      /* Header */
      header {
        background-color: white;
        border-radius: 20px;
        padding: 25px 40px;
        margin-bottom: 30px;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.08);
        display: flex;
        justify-content: space-between;
        align-items: center;
        flex-wrap: wrap;
      }

      .logo-container {
        display: flex;
        align-items: center;
        gap: 15px;
      }

      .logo {
        width: 60px;
        height: 60px;
        background: linear-gradient(45deg, var(--primary), var(--secondary));
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-size: 28px;
      }

      .logo-text h1 {
        color: var(--primary);
        font-size: 28px;
        font-weight: 800;
        letter-spacing: 1px;
      }

      .logo-text p {
        color: var(--dark);
        font-size: 14px;
        opacity: 0.8;
      }

      nav ul {
        display: flex;
        list-style: none;
        gap: 25px;
      }

      nav a {
        text-decoration: none;
        color: var(--dark);
        font-weight: 600;
        font-size: 16px;
        padding: 8px 15px;
        border-radius: 50px;
        transition: all 0.3s ease;
      }

      nav a:hover,
      nav a.active {
        background-color: var(--primary);
        color: white;
      }

      /* Dashboard Stats */
      .dashboard-stats {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 20px;
        margin-bottom: 30px;
      }

      .stat-card {
        background: white;
        border-radius: 15px;
        padding: 25px;
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.05);
        display: flex;
        align-items: center;
        gap: 20px;
        transition: transform 0.3s ease;
      }

      .stat-card:hover {
        transform: translateY(-5px);
      }

      .stat-icon {
        width: 60px;
        height: 60px;
        border-radius: 12px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 24px;
        color: white;
      }

      .stat-content h3 {
        font-size: 14px;
        color: #666;
        margin-bottom: 5px;
      }

      .stat-value {
        font-size: 28px;
        font-weight: 700;
        color: var(--dark);
      }

      .stat-trend {
        font-size: 12px;
        margin-top: 5px;
      }

      .stat-trend.positive {
        color: var(--success);
      }

      .stat-trend.negative {
        color: var(--danger);
      }

      /* Main Content */
      .main-content {
        display: flex;
        gap: 30px;
        flex-wrap: wrap;
      }

      /* Inventory Table */
      .inventory-card {
        background-color: white;
        border-radius: 20px;
        padding: 30px;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.08);
        flex: 2;
        min-width: 300px;
      }

      .inventory-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 25px;
      }

      .inventory-header h2 {
        color: var(--primary);
        font-size: 26px;
        display: flex;
        align-items: center;
        gap: 10px;
      }

      .header-actions {
        display: flex;
        gap: 10px;
      }

      .btn {
        padding: 12px 25px;
        border-radius: 10px;
        border: none;
        font-size: 14px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s;
        display: flex;
        align-items: center;
        gap: 8px;
      }

      .btn-primary {
        background-color: var(--primary);
        color: white;
      }

      .btn-primary:hover {
        background-color: #ff5a9c;
        transform: translateY(-2px);
      }

      .btn-success {
        background-color: var(--success);
        color: white;
      }

      .btn-success:hover {
        background-color: #3d8b40;
        transform: translateY(-2px);
      }

      .btn-warning {
        background-color: var(--warning);
        color: white;
      }

      .btn-warning:hover {
        background-color: #e68900;
        transform: translateY(-2px);
      }

      .btn-info {
        background-color: var(--info);
        color: white;
      }

      .btn-info:hover {
        background-color: #0b7dda;
        transform: translateY(-2px);
      }

      /* Table Styles */
      .table-container {
        overflow-x: auto;
        border-radius: 12px;
        border: 1px solid #eee;
      }

      .inventory-table {
        width: 100%;
        border-collapse: collapse;
        min-width: 800px;
      }

      .inventory-table th {
        background-color: #f8f9fa;
        padding: 15px;
        text-align: left;
        font-weight: 600;
        color: var(--dark);
        border-bottom: 2px solid #eee;
        position: sticky;
        top: 0;
      }

      .inventory-table td {
        padding: 15px;
        border-bottom: 1px solid #eee;
        vertical-align: middle;
      }

      .inventory-table tr:hover {
        background-color: #f9f9f9;
      }

      /* Status Badges */
      .status-badge {
        display: inline-flex;
        align-items: center;
        gap: 5px;
        padding: 5px 12px;
        border-radius: 20px;
        font-size: 12px;
        font-weight: 600;
      }

      .status-in-stock {
        background-color: rgba(76, 175, 80, 0.1);
        color: var(--success);
      }

      .status-low-stock {
        background-color: rgba(255, 152, 0, 0.1);
        color: var(--warning);
      }

      .status-critical {
        background-color: rgba(244, 67, 54, 0.1);
        color: var(--danger);
      }

      .status-expired {
        background-color: rgba(121, 121, 121, 0.1);
        color: #666;
        text-decoration: line-through;
      }

      /* Shelf Life Indicators */
      .shelf-life-indicator {
        display: flex;
        align-items: center;
        gap: 10px;
      }

      .shelf-life-bar {
        flex: 1;
        height: 8px;
        background-color: #eee;
        border-radius: 4px;
        overflow: hidden;
      }

      .shelf-life-fill {
        height: 100%;
        border-radius: 4px;
        transition: width 0.3s ease;
      }

      .shelf-life-fill.green {
        background-color: var(--success);
      }

      .shelf-life-fill.yellow {
        background-color: var(--warning);
      }

      .shelf-life-fill.orange {
        background-color: #ff9800;
      }

      .shelf-life-fill.red {
        background-color: var(--danger);
      }

      .shelf-life-text {
        font-size: 12px;
        font-weight: 600;
        min-width: 40px;
      }

      /* Quick Actions */
      .quick-actions {
        display: flex;
        gap: 5px;
      }

      .action-btn {
        width: 32px;
        height: 32px;
        border-radius: 6px;
        border: none;
        background: none;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.3s;
      }

      .action-btn:hover {
        background-color: rgba(0, 0, 0, 0.05);
      }

      .action-btn.edit {
        color: var(--info);
      }

      .action-btn.restock {
        color: var(--success);
      }

      .action-btn.view {
        color: var(--primary);
      }

      /* Batch Management */
      .batch-badge {
        display: inline-flex;
        align-items: center;
        gap: 3px;
        padding: 3px 8px;
        background-color: #f0f0f0;
        border-radius: 12px;
        font-size: 11px;
        margin-right: 5px;
        margin-bottom: 5px;
      }

      .batch-date {
        font-family: monospace;
      }

      .batch-qty {
        font-weight: 600;
        color: var(--accent);
      }

      /* Filters */
      .filters-section {
        background-color: white;
        border-radius: 20px;
        padding: 25px;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.08);
        margin-bottom: 30px;
      }

      .filters-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
      }

      .filter-row {
        display: flex;
        flex-wrap: wrap;
        gap: 15px;
        align-items: center;
      }

      .filter-group {
        display: flex;
        align-items: center;
        gap: 10px;
      }

      .filter-group label {
        font-weight: 600;
        font-size: 14px;
      }

      .filter-group select,
      .filter-group input {
        padding: 8px 12px;
        border: 2px solid #eee;
        border-radius: 8px;
        font-size: 14px;
      }

      .filter-group input[type="date"] {
        min-width: 150px;
      }

      /* Sidebar */
      .sidebar {
        flex: 1;
        min-width: 300px;
      }

      .sidebar-card {
        background-color: white;
        border-radius: 20px;
        padding: 25px;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.08);
        margin-bottom: 30px;
      }

      .sidebar-card h3 {
        color: var(--primary);
        margin-bottom: 20px;
        font-size: 20px;
        display: flex;
        align-items: center;
        gap: 10px;
      }

      /* Expiring Soon */
      .expiring-list {
        max-height: 300px;
        overflow-y: auto;
      }

      .expiring-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 12px 0;
        border-bottom: 1px solid #eee;
      }

      .expiring-item:last-child {
        border-bottom: none;
      }

      .expiring-item .product-name {
        font-weight: 600;
        font-size: 14px;
      }

      .expiring-item .expiry-date {
        font-size: 12px;
        color: #666;
      }

      .expiring-item .expiry-badge {
        padding: 3px 8px;
        border-radius: 4px;
        font-size: 11px;
        font-weight: 600;
      }

      /* Stock Alert */
      .stock-alert-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 12px 0;
        border-bottom: 1px solid #eee;
      }

      .stock-alert-item:last-child {
        border-bottom: none;
      }

      .stock-alert-item .stock-info {
        font-size: 14px;
      }

      .stock-alert-item .stock-qty {
        font-weight: 600;
        color: var(--danger);
      }

      /* Modal Styles */
      .modal {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.5);
        z-index: 2000;
        align-items: center;
        justify-content: center;
      }

      .modal-content {
        background: white;
        border-radius: 20px;
        padding: 30px;
        max-width: 500px;
        width: 90%;
        max-height: 90vh;
        overflow-y: auto;
        box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
      }

      .modal-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 25px;
      }

      .modal-header h3 {
        color: var(--primary);
        font-size: 22px;
        display: flex;
        align-items: center;
        gap: 10px;
      }

      .close-modal {
        background: none;
        border: none;
        font-size: 24px;
        color: #666;
        cursor: pointer;
        padding: 5px;
      }

      .form-group {
        margin-bottom: 20px;
      }

      .form-group label {
        display: block;
        margin-bottom: 8px;
        font-weight: 600;
        color: var(--dark);
        display: flex;
        align-items: center;
        gap: 5px;
      }

      .form-group input,
      .form-group select,
      .form-group textarea {
        width: 100%;
        padding: 12px;
        border: 2px solid #eee;
        border-radius: 10px;
        font-size: 14px;
        transition: all 0.3s;
      }

      .form-group input:focus,
      .form-group select:focus,
      .form-group textarea:focus {
        border-color: var(--primary);
        outline: none;
        box-shadow: 0 0 0 3px rgba(255, 123, 172, 0.2);
      }

      .form-row {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 15px;
      }

      .form-actions {
        display: flex;
        gap: 10px;
        margin-top: 30px;
      }

      /* Batch Modal */
      .batch-form {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 15px;
        margin-top: 20px;
        padding: 20px;
        background-color: #f8f9fa;
        border-radius: 10px;
      }

      /* Notification */
      .notification {
        position: fixed;
        top: 20px;
        right: 20px;
        padding: 15px 25px;
        border-radius: 12px;
        color: white;
        font-weight: 600;
        z-index: 1000;
        display: flex;
        align-items: center;
        gap: 10px;
        transform: translateX(150%);
        transition: transform 0.3s ease;
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
      }

      .notification.show {
        transform: translateX(0);
      }

      .notification.success {
        background-color: var(--success);
      }

      .notification.error {
        background-color: var(--danger);
      }

      .notification.warning {
        background-color: var(--warning);
      }

      .notification.info {
        background-color: var(--info);
      }

      /* Footer */
      footer {
        text-align: center;
        margin-top: 40px;
        padding: 20px;
        color: #666;
        font-size: 14px;
      }

      .footer-links {
        display: flex;
        justify-content: center;
        gap: 20px;
        margin-top: 10px;
      }

      .footer-links a {
        color: var(--primary);
        text-decoration: none;
      }

      /* Responsive */
      @media (max-width: 992px) {
        .main-content {
          flex-direction: column;
        }
      }

      @media (max-width: 768px) {
        .form-row {
          grid-template-columns: 1fr;
        }

        .filter-row {
          flex-direction: column;
          align-items: flex-start;
        }

        .header-actions {
          flex-wrap: wrap;
        }
      }

      /* Animation for critical items */
      @keyframes pulseCritical {
        0% {
          opacity: 1;
        }
        50% {
          opacity: 0.7;
        }
        100% {
          opacity: 1;
        }
      }

      .critical-item {
        animation: pulseCritical 2s infinite;
        background-color: rgba(244, 67, 54, 0.05);
      }

      /* Batch History */
      .batch-history {
        max-height: 200px;
        overflow-y: auto;
        margin-top: 10px;
        padding: 10px;
        background-color: #f8f9fa;
        border-radius: 8px;
      }

      .batch-history-item {
        display: flex;
        justify-content: space-between;
        padding: 8px;
        border-bottom: 1px solid #ddd;
        font-size: 12px;
      }

      .batch-history-item:last-child {
        border-bottom: none;
      }
      /* Add to your existing CSS */
      #useCurrentPrice {
        background-color: var(--accent);
        color: white;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        transition: all 0.3s;
      }

      #useCurrentPrice:hover {
        background-color: #8a2be2;
        transform: translateY(-1px);
      }

      #productInfo {
        border-left: 4px solid var(--primary);
        animation: slideIn 0.3s ease;
      }

      @keyframes slideIn {
        from {
          opacity: 0;
          transform: translateY(-10px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }
      /* Add to your existing CSS */
      #usePreviousShelfLife {
        background-color: var(--info);
        color: white;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        transition: all 0.3s;
      }

      #usePreviousShelfLife:hover {
        background-color: #0b7dda;
        transform: translateY(-1px);
      }

      #batchShelfLife:disabled {
        background-color: #f5f5f5;
        cursor: not-allowed;
      }

      #previousBatchesInfo {
        background-color: #f8f9fa;
        border: 1px solid #e0e0e0;
        border-radius: 8px;
        padding: 10px;
        animation: fadeIn 0.3s ease;
      }

      @keyframes fadeIn {
        from {
          opacity: 0;
        }
        to {
          opacity: 1;
        }
      }

      .batch-history-item:hover {
        background-color: #f0f0f0;
      }

      select#shelfLifeMode {
        width: 100%;
        padding: 8px;
        border: 2px solid #eee;
        border-radius: 6px;
        font-size: 14px;
      }

      select#shelfLifeMode:focus {
        border-color: var(--primary);
        outline: none;
      }
      /* Add these styles for the expiring items */
      .expiring-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 12px;
        border-bottom: 1px solid #eee;
        transition: all 0.3s;
      }

      .expiring-item:hover {
        background-color: #f9f9f9;
      }

      .expiring-item:last-child {
        border-bottom: none;
      }

      .expiring-item .product-name {
        font-weight: 600;
        font-size: 14px;
        margin-bottom: 3px;
      }

      .expiry-badge {
        padding: 4px 10px;
        border-radius: 12px;
        font-size: 11px;
        font-weight: 700;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        margin-left: 10px;
        white-space: nowrap;
      }

      .expiry-badge.status-critical {
        background-color: rgba(244, 67, 54, 0.1);
        color: var(--danger);
        animation: pulseWarning 2s infinite;
      }

      .expiry-badge.status-low-stock {
        background-color: rgba(255, 152, 0, 0.1);
        color: var(--warning);
      }

      @keyframes pulseWarning {
        0% {
          opacity: 1;
        }
        50% {
          opacity: 0.7;
        }
        100% {
          opacity: 1;
        }
      }

      /* Expiring Soon Section Styling - MOVE THIS BEFORE .sidebar-card styles */
      #expiring-soon {
        background: linear-gradient(135deg, #fff5f5 0%, #ffeaea 100%);
        border: 2px solid #ffcdd2;
        border-radius: 15px;
        padding: 20px;
        margin-bottom: 30px;
        box-shadow: 0 6px 20px rgba(255, 0, 0, 0.1);
        position: relative;
        overflow: hidden;
      }

      #expiring-soon::before {
        content: "";
        position: absolute;
        top: 0;
        left: 0;
        width: 8px;
        height: 100%;
        background: linear-gradient(to bottom, #ff4757, #ff6b81);
        border-radius: 15px 0 0 15px;
      }

      #expiring-soon h3 {
        color: #d32f2f;
        margin-top: 0;
        margin-bottom: 20px;
        font-size: 1.3rem;
        display: flex;
        align-items: center;
        gap: 10px;
        padding-bottom: 10px;
        border-bottom: 2px solid #ffebee;
      }

      #expiring-soon .expiring-list {
        max-height: 350px;
        overflow-y: auto;
        padding-right: 5px;
      }

      /* Custom scrollbar for expiring list */
      #expiring-soon .expiring-list::-webkit-scrollbar {
        width: 4px;
      }

      #expiring-soon .expiring-list::-webkit-scrollbar-track {
        background: #ffeaea;
        border-radius: 4px;
      }

      #expiring-soon .expiring-list::-webkit-scrollbar-thumb {
        background: #ff6b81;
        border-radius: 4px;
      }

      /* Expiring item styling */
      #expiring-soon .expiring-item {
        background: white;
        border-radius: 10px;
        padding: 15px;
        margin-bottom: 12px;
        border-left: 4px solid #ff4757;
        box-shadow: 0 3px 8px rgba(0, 0, 0, 0.05);
        transition: all 0.3s ease;
        display: flex;
        justify-content: space-between;
        align-items: center;
      }

      #expiring-soon .expiring-item:hover {
        transform: translateY(-3px);
        box-shadow: 0 6px 15px rgba(255, 71, 87, 0.15);
        border-left-color: #d32f2f;
      }

      #expiring-soon .expiring-item > div:first-child {
        flex: 1;
      }

      #expiring-soon .expiring-item .product-name {
        font-weight: 700;
        color: #333;
        font-size: 14px;
        margin-bottom: 8px;
        display: flex;
        align-items: center;
        gap: 8px;
      }

      #expiring-soon .expiring-item .expiry-info {
        display: flex;
        justify-content: space-between;
        align-items: center;
        font-size: 12px;
      }

      #expiring-soon .expiring-item .expiry-date {
        background: #ffebee;
        color: #d32f2f;
        padding: 4px 12px;
        border-radius: 20px;
        font-weight: 600;
        display: flex;
        align-items: center;
        gap: 5px;
      }

      #expiring-soon .expiring-item .quantity {
        color: var(--accent);
        font-weight: 700;
        display: flex;
        align-items: center;
        gap: 5px;
      }

      #expiring-soon .expiring-item .quantity::before {
        content: "ðŸ“¦";
        font-size: 11px;
      }

      /* Expiry badge styling */
      #expiring-soon .expiry-badge {
        padding: 6px 14px;
        border-radius: 20px;
        font-size: 12px;
        font-weight: 800;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        margin-left: 15px;
        white-space: nowrap;
        box-shadow: 0 3px 6px rgba(0, 0, 0, 0.1);
      }

      #expiring-soon .expiry-badge.status-critical {
        background: linear-gradient(45deg, #ff4757, #ff6b81);
        color: white;
        animation: pulseCritical 1.5s infinite;
      }

      #expiring-soon .expiry-badge.status-low-stock {
        background: linear-gradient(45deg, #ff9800, #ffb74d);
        color: white;
      }

      /* No items message */
      #expiring-soon .expiring-list > div[style*="text-align: center"] {
        background: white;
        border-radius: 10px;
        padding: 30px 20px;
        text-align: center;
        color: #999;
        font-style: italic;
        border: 2px dashed #ffcdd2;
      }
      /* Searchable Dropdown Styles */
      .searchable-dropdown {
        position: relative;
        width: 100%;
      }

      .searchable-dropdown-input {
        width: 100%;
        padding: 12px;
        border: 2px solid #eee;
        border-radius: 10px;
        font-size: 14px;
        transition: all 0.3s;
        padding-right: 40px;
      }

      .searchable-dropdown-input:focus {
        border-color: var(--primary);
        outline: none;
        box-shadow: 0 0 0 3px rgba(255, 123, 172, 0.2);
      }

      .searchable-dropdown-toggle {
        position: absolute;
        right: 10px;
        top: 50%;
        transform: translateY(-50%);
        background: none;
        border: none;
        color: #666;
        cursor: pointer;
        padding: 5px;
      }

      .searchable-dropdown-options {
        position: absolute;
        top: 100%;
        left: 0;
        right: 0;
        background: white;
        border: 2px solid #eee;
        border-radius: 10px;
        margin-top: 5px;
        max-height: 300px;
        overflow-y: auto;
        z-index: 1000;
        box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
        display: none;
      }

      .searchable-dropdown-options.active {
        display: block;
      }

      .searchable-dropdown-option {
        padding: 12px 15px;
        cursor: pointer;
        border-bottom: 1px solid #f0f0f0;
        transition: all 0.2s;
      }

      .searchable-dropdown-option:last-child {
        border-bottom: none;
      }

      .searchable-dropdown-option:hover {
        background-color: #f8f9fa;
      }

      .searchable-dropdown-option.selected {
        background-color: rgba(255, 123, 172, 0.1);
        color: var(--primary);
        font-weight: 600;
        border-left: 4px solid var(--primary);
      }

      .searchable-dropdown-option .product-code {
        font-weight: 600;
        color: var(--accent);
      }

      .searchable-dropdown-option .product-name {
        margin-left: 10px;
        color: var(--dark);
      }

      .searchable-dropdown-option .product-price {
        float: right;
        color: var(--success);
        font-weight: 600;
      }

      /* Search input inside dropdown */
      .searchable-dropdown-search {
        padding: 10px 15px;
        border-bottom: 1px solid #eee;
        background-color: #f8f9fa;
        display: none;
      }

      .searchable-dropdown-search input {
        width: 100%;
        padding: 8px 12px;
        border: 2px solid #ddd;
        border-radius: 6px;
        font-size: 14px;
      }

      .searchable-dropdown-search input:focus {
        outline: none;
        border-color: var(--primary);
      }
      /* Enhanced Searchable Dropdown Styles */
      .searchable-dropdown {
        position: relative;
        width: 100%;
      }

      .searchable-dropdown-input {
        width: 100%;
        padding: 12px 40px 12px 12px;
        border: 2px solid #eee;
        border-radius: 10px;
        font-size: 14px;
        transition: all 0.3s;
        cursor: pointer;
        background: white;
      }

      .searchable-dropdown-input:hover {
        border-color: #ddd;
      }

      .searchable-dropdown-input:focus {
        border-color: var(--primary);
        outline: none;
        box-shadow: 0 0 0 3px rgba(255, 123, 172, 0.2);
      }

      .searchable-dropdown-toggle {
        position: absolute;
        right: 12px;
        top: 50%;
        transform: translateY(-50%);
        background: none;
        border: none;
        color: #666;
        cursor: pointer;
        padding: 5px;
        transition: color 0.3s;
      }

      .searchable-dropdown-toggle:hover {
        color: var(--primary);
      }

      .searchable-dropdown-options {
        position: absolute;
        top: 100%;
        left: 0;
        right: 0;
        background: white;
        border: 2px solid var(--primary);
        border-radius: 10px;
        margin-top: 5px;
        max-height: 300px;
        overflow-y: auto;
        z-index: 1000;
        box-shadow: 0 10px 25px rgba(0, 0, 0, 0.15);
        display: none;
      }

      .searchable-dropdown-options.active {
        display: block;
        animation: fadeIn 0.2s ease;
      }

      @keyframes fadeIn {
        from {
          opacity: 0;
          transform: translateY(-5px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      .searchable-dropdown-search {
        padding: 10px;
        background-color: #f8f9fa;
        border-bottom: 1px solid #eee;
        position: sticky;
        top: 0;
        z-index: 1;
      }

      .searchable-dropdown-search input {
        width: 100%;
        padding: 8px 12px;
        border: 2px solid #ddd;
        border-radius: 6px;
        font-size: 14px;
        transition: all 0.3s;
      }

      .searchable-dropdown-search input:focus {
        outline: none;
        border-color: var(--primary);
        box-shadow: 0 0 0 2px rgba(255, 123, 172, 0.1);
      }

      .searchable-dropdown-option {
        padding: 12px 15px;
        cursor: pointer;
        border-bottom: 1px solid #f0f0f0;
        transition: all 0.2s;
        display: flex;
        justify-content: space-between;
        align-items: center;
      }

      .searchable-dropdown-option:last-child {
        border-bottom: none;
      }

      .searchable-dropdown-option:hover {
        background-color: #f5f5f5;
      }

      .searchable-dropdown-option.selected {
        background-color: rgba(255, 123, 172, 0.1);
        border-left: 4px solid var(--primary);
      }

      .searchable-dropdown-option .product-info {
        flex: 1;
      }

      .searchable-dropdown-option .product-code {
        font-weight: 600;
        color: var(--accent);
        font-size: 13px;
        display: block;
      }

      .searchable-dropdown-option .product-name {
        color: var(--dark);
        font-size: 14px;
        margin-top: 2px;
      }

      .searchable-dropdown-option .product-price {
        color: var(--success);
        font-weight: 700;
        font-size: 14px;
        white-space: nowrap;
      }

      .searchable-dropdown-option .product-stock {
        font-size: 11px;
        color: #666;
        margin-top: 2px;
      }

      .searchable-dropdown-option .no-results {
        color: #999;
        font-style: italic;
        cursor: default;
      }

      .searchable-dropdown-option .no-results:hover {
        background-color: transparent;
      }

      /* Custom scrollbar for dropdown */
      .searchable-dropdown-options::-webkit-scrollbar {
        width: 6px;
      }

      .searchable-dropdown-options::-webkit-scrollbar-track {
        background: #f1f1f1;
        border-radius: 4px;
      }

      .searchable-dropdown-options::-webkit-scrollbar-thumb {
        background: #ccc;
        border-radius: 4px;
      }

      .searchable-dropdown-options::-webkit-scrollbar-thumb:hover {
        background: #aaa;
      }
      .searchable-dropdown-input {
        cursor: text; /* Allow text selection */
        background: white;
        width: 100%;
      }

      .searchable-dropdown-input:focus {
        border-color: var(--primary);
        box-shadow: 0 0 0 3px rgba(255, 123, 172, 0.2);
      }
      /* Keyboard Navigation Styles */
      .keyboard-focus {
        outline: 3px solid var(--accent) !important;
        outline-offset: 2px !important;
        box-shadow: 0 0 0 3px rgba(157, 78, 221, 0.3) !important;
        position: relative;
        z-index: 10;
      }

      .keyboard-nav-table tr.keyboard-focus {
        background-color: rgba(157, 78, 221, 0.1) !important;
        border: 2px solid var(--accent) !important;
      }

      .keyboard-nav-table td.keyboard-focus {
        background-color: rgba(157, 78, 221, 0.2) !important;
      }

      .modal .keyboard-focus {
        outline: 3px solid var(--accent) !important;
        outline-offset: 2px !important;
      }

      /* Focus styles for buttons */
      .btn:focus,
      .action-btn:focus,
      .close-modal:focus {
        outline: 3px solid var(--accent) !important;
        outline-offset: 2px !important;
      }

      /* Focus styles for inputs */
      input:focus,
      select:focus,
      textarea:focus {
        outline: 3px solid var(--accent) !important;
        outline-offset: 2px !important;
        border-color: var(--primary) !important;
      }

      /* Sidebar keyboard navigation */
      .sidebar-card .expiring-item.keyboard-focus,
      .sidebar-card .stock-alert-item.keyboard-focus,
      .sidebar-card .batch-history-item.keyboard-focus {
        background-color: rgba(157, 78, 221, 0.1) !important;
        border: 2px solid var(--accent) !important;
        border-radius: 8px;
      }

      /* Dashboard stats keyboard navigation */
      .stat-card.keyboard-focus {
        transform: translateY(-5px);
        box-shadow: 0 10px 25px rgba(157, 78, 221, 0.3) !important;
        border: 2px solid var(--accent) !important;
      }

      /* Modal focus styles */
      .modal-content .form-group input:focus,
      .modal-content .form-group select:focus {
        border-color: var(--primary);
        outline: 3px solid var(--accent) !important;
        outline-offset: 2px !important;
      }

      /* Searchable dropdown focus */
      .searchable-dropdown-input.keyboard-focus {
        border-color: var(--primary);
        outline: 3px solid var(--accent) !important;
        outline-offset: 2px !important;
      }

      /* Table row hover with keyboard */
      .inventory-table tr:hover {
        background-color: rgba(157, 78, 221, 0.05);
      }

      /* Keyboard shortcut indicator */
      .keyboard-shortcut {
        display: inline-block;
        margin-left: 8px;
        font-size: 11px;
        color: #666;
        background: #f0f0f0;
        padding: 2px 6px;
        border-radius: 4px;
        font-family: monospace;
      }

      /* Tabindex indicator (for debugging) */
      [tabindex] {
        position: relative;
      }

      /* Skip to main content link (for accessibility) */
      .skip-to-content {
        position: absolute;
        top: -40px;
        left: 0;
        background: var(--primary);
        color: white;
        padding: 8px 16px;
        text-decoration: none;
        border-radius: 0 0 8px 0;
        z-index: 9999;
        transition: top 0.3s;
      }

      .skip-to-content:focus {
        top: 0;
      }

      /* Action button focus states */
      .action-btn:focus {
        background-color: rgba(0, 0, 0, 0.1);
        transform: scale(1.1);
      }

      /* Modal close button focus */
      .close-modal:focus {
        background-color: rgba(0, 0, 0, 0.1);
        border-radius: 50%;
      }

      /* Form button focus states */
      .form-actions .btn:focus {
        transform: translateY(-2px);
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
      }
      /* Add to your existing CSS */
      #productCode {
        font-weight: 600;
        color: var(--accent);
        font-family: monospace;
        letter-spacing: 1px;
      }

      #productCode:read-only {
        color: var(--success);
      }

      .form-group small {
        display: block;
        margin-top: 5px;
        color: #666;
        font-size: 11px;
      }

      .form-group small i {
        margin-right: 5px;
      }
      /* Add this to your existing CSS */
      #batchHistory .batch-history-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 12px 15px;
        border-bottom: 1px solid #eee;
        transition: all 0.3s;
        cursor: pointer;
      }

      #batchHistory .batch-history-item:hover {
        background-color: #f9f9f9;
      }

      #batchHistory .batch-history-item:last-child {
        border-bottom: none;
      }

      #batchHistory .batch-history-item > div:first-child {
        flex: 1;
      }

      #batchHistory .batch-history-item .batch-expiry {
        font-size: 12px;
        font-weight: 600;
        color: var(--accent);
      }

      #batchHistory .batch-history-item .batch-created {
        font-size: 10px;
        color: #999;
        margin-top: 2px;
      }

      /* If you want to add some styling for expired items */
      #batchHistory .batch-history-item.expired .batch-expiry {
        color: var(--danger);
        text-decoration: line-through;
      }
      /* Add to your existing CSS */
      #batchHistory i.fas {
        width: 12px;
        text-align: center;
        margin-right: 4px;
      }

      #batchHistory .batch-history-item .expired-text {
        color: var(--danger);
        font-weight: 600;
      }
      /* No Stock Section */
      #no-stock-section {
        background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
        border: 2px solid #dee2e6;
        border-radius: 15px;
        padding: 20px;
        margin-bottom: 30px;
        box-shadow: 0 6px 20px rgba(0, 0, 0, 0.05);
        position: relative;
        overflow: hidden;
      }

      #no-stock-section::before {
        content: "";
        position: absolute;
        top: 0;
        left: 0;
        width: 8px;
        height: 100%;
        background: linear-gradient(to bottom, #6c757d, #adb5bd);
        border-radius: 15px 0 0 15px;
      }

      #no-stock-section h3 {
        color: #6c757d;
        margin-top: 0;
        margin-bottom: 20px;
        font-size: 1.3rem;
        display: flex;
        align-items: center;
        gap: 10px;
        padding-bottom: 10px;
        border-bottom: 2px solid #dee2e6;
      }

      #no-stock-section .no-stock-item {
        background: white;
        border-radius: 10px;
        padding: 15px;
        margin-bottom: 12px;
        border-left: 4px solid #6c757d;
        box-shadow: 0 3px 8px rgba(0, 0, 0, 0.05);
        transition: all 0.3s ease;
        display: flex;
        justify-content: space-between;
        align-items: center;
        cursor: pointer;
      }

      #no-stock-section .no-stock-item:hover {
        transform: translateY(-3px);
        box-shadow: 0 6px 15px rgba(108, 117, 125, 0.15);
        border-left-color: #495057;
      }

      #no-stock-section .no-stock-item > div:first-child {
        flex: 1;
      }

      #no-stock-section .no-stock-item .product-name {
        font-weight: 700;
        color: #333;
        font-size: 14px;
        margin-bottom: 5px;
        display: flex;
        align-items: center;
        gap: 8px;
      }

      #no-stock-section .no-stock-item .product-name i {
        color: var(--danger);
      }

      #no-stock-section .no-stock-item .product-code {
        font-size: 11px;
        color: #666;
        font-family: monospace;
      }

      #no-stock-section .no-stock-item .out-of-stock-badge {
        background: linear-gradient(45deg, #6c757d, #adb5bd);
        color: white;
        padding: 6px 14px;
        border-radius: 20px;
        font-size: 12px;
        font-weight: 800;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        white-space: nowrap;
        box-shadow: 0 3px 6px rgba(0, 0, 0, 0.1);
      }

      /* Stock alert items styling */
      #noStockList .stock-alert-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 12px 0;
        border-bottom: 1px solid #eee;
        cursor: pointer;
      }

      #noStockList .stock-alert-item:last-child {
        border-bottom: none;
      }

      #noStockList .stock-alert-item:hover {
        background-color: #f9f9f9;
      }

      #noStockList .stock-alert-item .stock-info {
        font-size: 14px;
      }

      #noStockList .stock-alert-item .stock-qty {
        font-weight: 600;
        color: var(--danger);
      }
      /* Sidebar Section Styling */
      .sidebar-section {
        background: white;
        border-radius: 12px;
        padding: 20px;
        margin-bottom: 20px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.08);
        border: 1px solid #e9ecef;
      }

      .sidebar-section h3 {
        font-size: 16px;
        font-weight: 700;
        color: var(--dark);
        margin-bottom: 15px;
        padding-bottom: 10px;
        border-bottom: 2px solid var(--primary-light);
        display: flex;
        align-items: center;
        gap: 10px;
      }

      .sidebar-section h3 i {
        color: var(--primary);
      }

      /* Out of Stock Items Styling */
      .no-stock-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 12px 15px;
        margin-bottom: 8px;
        background: linear-gradient(135deg, #fff5f5 0%, #ffeaea 100%);
        border-radius: 8px;
        border-left: 4px solid var(--danger);
        cursor: pointer;
        transition: all 0.2s ease;
      }

      .no-stock-item:hover {
        transform: translateX(5px);
        background: linear-gradient(135deg, #ffeaea 0%, #ffdbdb 100%);
        box-shadow: 0 3px 8px rgba(220, 53, 69, 0.15);
      }

      .no-stock-item:focus {
        outline: 2px solid var(--danger);
        outline-offset: 2px;
      }

      .no-stock-item .stock-info {
        flex: 1;
      }

      .no-stock-item .product-name {
        font-weight: 600;
        color: var(--dark);
        margin-bottom: 3px;
      }

      .no-stock-item .product-code {
        font-family: "Monaco", "Consolas", monospace;
        font-size: 11px;
        color: var(--danger);
        background: rgba(220, 53, 69, 0.1);
        padding: 2px 6px;
        border-radius: 4px;
        display: inline-block;
      }

      .no-stock-item .stock-qty {
        font-size: 20px;
        font-weight: 800;
        color: var(--danger);
        min-width: 40px;
        text-align: center;
      }

      /* Expiring Soon Items Styling */
      .expiring-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 12px 15px;
        margin-bottom: 8px;
        background: linear-gradient(135deg, #fff9e6 0%, #fff4d1 100%);
        border-radius: 8px;
        border-left: 4px solid var(--warning);
        cursor: pointer;
        transition: all 0.2s ease;
      }

      .expiring-item:hover {
        transform: translateX(5px);
        background: linear-gradient(135deg, #fff4d1 0%, #ffecb3 100%);
        box-shadow: 0 3px 8px rgba(255, 193, 7, 0.15);
      }

      .expiring-item:focus {
        outline: 2px solid var(--warning);
        outline-offset: 2px;
      }

      .expiring-item .product-name {
        font-weight: 600;
        color: var(--dark);
        margin-bottom: 5px;
      }

      .expiring-badge {
        font-size: 11px;
        font-weight: 800;
        padding: 4px 8px;
        border-radius: 20px;
        min-width: 50px;
        text-align: center;
      }

      .expiring-badge.status-critical {
        background: var(--danger);
        color: white;
      }

      .expiring-badge.status-low-stock {
        background: var(--warning);
        color: var(--dark);
      }

      /* Empty state styling */
      .empty-state {
        text-align: center;
        padding: 30px 20px;
        color: #adb5bd;
      }

      .empty-state i {
        font-size: 40px;
        margin-bottom: 10px;
        opacity: 0.5;
      }

      .empty-state p {
        font-size: 14px;
        margin: 0;
        font-style: italic;
      }

      /* Keyboard focus styling for sidebar items */
      .keyboard-focus.no-stock-item,
      .keyboard-focus.expiring-item,
      .keyboard-focus.stock-alert-item {
        outline: 3px solid var(--primary);
        outline-offset: 2px;
        transform: scale(1.02);
        z-index: 1;
        position: relative;
      }

      /* Status counters */
      .status-counter {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        width: 24px;
        height: 24px;
        background: var(--primary);
        color: white;
        border-radius: 50%;
        font-size: 12px;
        font-weight: 700;
        margin-left: 8px;
      }

      /* Section headers with counts */
      .section-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        margin-bottom: 15px;
      }

      .section-title {
        display: flex;
        align-items: center;
        gap: 10px;
      }

      .section-count {
        font-size: 12px;
        padding: 2px 8px;
        border-radius: 12px;
        font-weight: 700;
      }

      .section-count.out-of-stock {
        background: rgba(220, 53, 69, 0.1);
        color: var(--danger);
      }

      .section-count.expiring {
        background: rgba(255, 193, 7, 0.1);
        color: var(--warning-dark);
      }
      /* Sidebar Section Styling */
      .sidebar-section {
        background: white;
        border-radius: 12px;
        padding: 20px;
        margin-bottom: 20px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.08);
        border: 1px solid #e9ecef;
      }

      .sidebar-section h3 {
        font-size: 16px;
        font-weight: 700;
        color: var(--dark);
        margin-bottom: 15px;
        padding-bottom: 10px;
        border-bottom: 2px solid var(--primary-light);
        display: flex;
        align-items: center;
        gap: 10px;
      }

      .sidebar-section h3 i {
        color: var(--primary);
      }

      /* Out of Stock Items Styling */
      .no-stock-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 12px 15px;
        margin-bottom: 8px;
        background: linear-gradient(135deg, #fff5f5 0%, #ffeaea 100%);
        border-radius: 8px;
        border-left: 4px solid var(--danger);
        cursor: pointer;
        transition: all 0.2s ease;
      }

      .no-stock-item:hover {
        transform: translateX(5px);
        background: linear-gradient(135deg, #ffeaea 0%, #ffdbdb 100%);
        box-shadow: 0 3px 8px rgba(220, 53, 69, 0.15);
      }

      .no-stock-item:focus {
        outline: 2px solid var(--danger);
        outline-offset: 2px;
      }

      .no-stock-item .stock-info {
        flex: 1;
      }

      .no-stock-item .product-name {
        font-weight: 600;
        color: var(--dark);
        margin-bottom: 3px;
      }

      .no-stock-item .product-code {
        font-family: "Monaco", "Consolas", monospace;
        font-size: 11px;
        color: var(--danger);
        background: rgba(220, 53, 69, 0.1);
        padding: 2px 6px;
        border-radius: 4px;
        display: inline-block;
      }

      .no-stock-item .stock-qty {
        font-size: 20px;
        font-weight: 800;
        color: var(--danger);
        min-width: 40px;
        text-align: center;
      }

      /* Expiring Soon Items Styling */
      .expiring-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 12px 15px;
        margin-bottom: 8px;
        background: linear-gradient(135deg, #fff9e6 0%, #fff4d1 100%);
        border-radius: 8px;
        border-left: 4px solid var(--warning);
        cursor: pointer;
        transition: all 0.2s ease;
      }

      .expiring-item:hover {
        transform: translateX(5px);
        background: linear-gradient(135deg, #fff4d1 0%, #ffecb3 100%);
        box-shadow: 0 3px 8px rgba(255, 193, 7, 0.15);
      }

      .expiring-item:focus {
        outline: 2px solid var(--warning);
        outline-offset: 2px;
      }

      .expiring-item .product-name {
        font-weight: 600;
        color: var(--dark);
        margin-bottom: 5px;
      }

      .expiring-badge {
        font-size: 11px;
        font-weight: 800;
        padding: 4px 8px;
        border-radius: 20px;
        min-width: 50px;
        text-align: center;
      }

      .expiring-badge.status-critical {
        background: var(--danger);
        color: white;
      }

      .expiring-badge.status-low-stock {
        background: var(--warning);
        color: var(--dark);
      }

      /* Empty state styling */
      .empty-state {
        text-align: center;
        padding: 30px 20px;
        color: #adb5bd;
      }

      .empty-state i {
        font-size: 40px;
        margin-bottom: 10px;
        opacity: 0.5;
      }

      .empty-state p {
        font-size: 14px;
        margin: 0;
        font-style: italic;
      }

      /* Keyboard focus styling for sidebar items */
      .keyboard-focus.no-stock-item,
      .keyboard-focus.expiring-item,
      .keyboard-focus.stock-alert-item {
        outline: 3px solid var(--primary);
        outline-offset: 2px;
        transform: scale(1.02);
        z-index: 1;
        position: relative;
      }

      /* Status counters */
      .status-counter {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        width: 24px;
        height: 24px;
        background: var(--primary);
        color: white;
        border-radius: 50%;
        font-size: 12px;
        font-weight: 700;
        margin-left: 8px;
      }

      /* Section headers with counts */
      .section-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        margin-bottom: 15px;
      }

      .section-title {
        display: flex;
        align-items: center;
        gap: 10px;
      }

      .section-count {
        font-size: 12px;
        padding: 2px 8px;
        border-radius: 12px;
        font-weight: 700;
      }

      .section-count.out-of-stock {
        background: rgba(220, 53, 69, 0.1);
        color: var(--danger);
      }

      .section-count.expiring {
        background: rgba(255, 193, 7, 0.1);
        color: var(--warning-dark);
      }
      /* Make stat cards clickable */
      .stat-card {
        cursor: pointer;
      }

      .stat-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 10px 25px rgba(0, 0, 0, 0.15);
      }

      /* Focus for keyboard navigation */
      .stat-card:focus {
        outline: 3px solid var(--accent);
        outline-offset: 2px;
      }
      /* Make no-stock section clickable */
      #no-stock-section {
        cursor: pointer;
        transition: all 0.3s ease;
      }

      #no-stock-section:hover {
        transform: translateY(-3px);
        box-shadow: 0 8px 25px rgba(0, 0, 0, 0.12);
      }

      #no-stock-section:hover h3 {
        color: var(--primary);
      }

      #no-stock-section .fa-external-link-alt {
        opacity: 0;
        transition: opacity 0.3s ease;
      }

      #no-stock-section:hover .fa-external-link-alt {
        opacity: 1;
      }
      /* Filters Section */
      .filters-section {
        background-color: #f8f9fa;
        border-radius: 12px;
        padding: 20px;
        margin-bottom: 20px;
        border: 1px solid #e9ecef;
      }

      .filters-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 15px;
      }

      .filters-header h3 {
        color: var(--primary);
        font-size: 16px;
        display: flex;
        align-items: center;
        gap: 8px;
        margin: 0;
      }

      .filter-row {
        display: flex;
        flex-wrap: wrap;
        gap: 15px;
        align-items: center;
      }

      .filter-group {
        display: flex;
        align-items: center;
        gap: 8px;
      }

      .filter-group label {
        font-weight: 600;
        font-size: 13px;
        color: #555;
        white-space: nowrap;
      }

      .filter-group select,
      .filter-group input {
        padding: 8px 12px;
        border: 2px solid #ddd;
        border-radius: 6px;
        font-size: 13px;
        min-width: 150px;
        transition: all 0.3s;
      }

      .filter-group select:focus,
      .filter-group input:focus {
        border-color: var(--primary);
        outline: none;
        box-shadow: 0 0 0 2px rgba(255, 123, 172, 0.2);
      }

      .filter-group input {
        min-width: 200px;
      }

      #applyFiltersBtn {
        padding: 8px 16px;
      }

      #clearFiltersBtn {
        padding: 8px 16px;
        font-size: 13px;
      }

      /* Active filter indicator */
      .active-filters {
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
        margin-top: 15px;
        padding-top: 15px;
        border-top: 1px solid #eee;
      }

      .filter-tag {
        background-color: var(--primary);
        color: white;
        padding: 4px 10px;
        border-radius: 15px;
        font-size: 12px;
        display: flex;
        align-items: center;
        gap: 5px;
      }

      .filter-tag .remove-filter {
        background: none;
        border: none;
        color: white;
        cursor: pointer;
        padding: 2px;
        font-size: 10px;
      }

      .filter-tag .remove-filter:hover {
        opacity: 0.8;
      }

      /* No results message */
      .no-results {
        text-align: center;
        padding: 40px 20px;
        color: #999;
      }

      .no-results i {
        font-size: 48px;
        margin-bottom: 15px;
        opacity: 0.5;
      }

      .no-results p {
        font-size: 16px;
        margin-bottom: 10px;
      }

      .no-results .suggestion {
        font-size: 14px;
        color: #666;
      }
      .active-filter {
        border: 2px solid var(--primary) !important;
        background-color: rgba(255, 123, 172, 0.1) !important;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <header>
        <div class="logo-container">
          <div class="logo">
            <i class="fas fa-birthday-cake"></i>
          </div>
          <div class="logo-text">
            <h1>Cake Bliss</h1>
            <p>Advanced Billing System with Multiple Items</p>
            <div id="dbStatus" class="db-status disconnected">
              <div class="status-dot disconnected"></div>
              <span>Supabase: Disconnected</span>
            </div>
          </div>
        </div>
        <nav>
          <ul>
            <li>
              <a href="billing.html"><i class="fas fa-receipt"></i> Billing</a>
            </li>
            <!-- Add this to your header navigation -->
            <li>
              <a href="inventory.html" class="active" id="inventoryBtn">
                <i class="fas fa-boxes"></i> Inventory
              </a>
            </li>
            <li>
              <a href="reports.html"
                ><i class="fas fa-chart-bar"></i> Reports</a
              >
            </li>
            <li>
              <a href="promotions.html"
                ><i class="fas fa-bullhorn"></i> Promotions</a
              >
            </li>
          </ul>
        </nav>
      </header>

      <!-- Dashboard Stats -->
      <div class="dashboard-stats">
        <div class="stat-card">
          <div
            class="stat-icon"
            style="
              background: linear-gradient(
                45deg,
                var(--primary),
                var(--secondary)
              );
            "
          >
            <i class="fas fa-box"></i>
          </div>
          <div class="stat-content">
            <h3>Total Products</h3>
            <div class="stat-value" id="totalProducts">0</div>
          </div>
        </div>
        <div class="stat-card">
          <div
            class="stat-icon"
            style="background: linear-gradient(45deg, var(--success), #66bb6a)"
          >
            <i class="fas fa-check-circle"></i>
          </div>
          <div class="stat-content">
            <h3>Available Stock</h3>
            <div class="stat-value" id="inStockCount">0</div>
          </div>
        </div>

        <div class="stat-card">
          <div
            class="stat-icon"
            style="background: linear-gradient(45deg, var(--warning), #ffb74d)"
          >
            <i class="fas fa-exclamation-triangle"></i>
          </div>
          <div class="stat-content">
            <h3>Low Stock</h3>
            <div class="stat-value" id="lowStockCount">0</div>
          </div>
        </div>
        <!-- Out of Stock Stat Card - ADD CLICK HANDLER -->
        <div class="stat-card" id="outOfStockCard">
          <div
            class="stat-icon"
            style="background: linear-gradient(45deg, #6c757d, #adb5bd)"
          >
            <i class="fas fa-times-circle"></i>
          </div>
          <div class="stat-content">
            <h3>Out of Stock</h3>
            <div class="stat-value" id="outOfStockCount">0</div>
          </div>
        </div>

        <!-- No Stock Sidebar Card (moved to sidebar area later) -->

        <div class="stat-card">
          <div
            class="stat-icon"
            style="background: linear-gradient(45deg, var(--danger), #ef5350)"
          >
            <i class="fas fa-calendar-times"></i>
          </div>
          <div class="stat-content">
            <h3>Expiring Soon</h3>
            <div class="stat-value" id="expiringCount">0</div>
          </div>
        </div>
      </div>

      <!-- Main Content -->
      <div class="main-content">
        <!-- Inventory Table -->
        <div class="inventory-card">
          <div class="inventory-header">
            <h2><i class="fas fa-boxes-stacked"></i> Product Inventory</h2>
            <div class="header-actions">
              <button type="button" class="btn btn-primary" id="addProductBtn">
                <i class="fas fa-plus"></i> Add Product
              </button>
              <button type="button" class="btn btn-success" id="addBatchBtn">
                <i class="fas fa-layer-group"></i> Add Batch
              </button>
              <button type="button" class="btn btn-warning" id="updateDatesBtn">
                <i class="fas fa-calendar-day"></i> Update Dates
              </button>
              <button type="button" class="btn btn-info" id="exportBtn">
                <i class="fas fa-file-export"></i> Export
              </button>
            </div>
          </div>
          <!-- Add this inside the inventory-card, after the inventory-header div -->
          <div class="filters-section">
            <div class="filters-header">
              <h3><i class="fas fa-filter"></i> Filter Products</h3>
              <button
                type="button"
                class="btn"
                id="clearFiltersBtn"
                style="background-color: #f0f0f0"
              >
                <i class="fas fa-times"></i> Clear Filters
              </button>
            </div>
            <div class="filter-row">
              <div class="filter-group">
                <label for="filterCategory">Category:</label>
                <select id="filterCategory">
                  <option value="">All Categories</option>
                  <option value="Cakes">Cakes</option>
                  <option value="Pastries">Pastries</option>
                  <option value="Decorations">Decorations</option>
                  <option value="Beverages">Beverages</option>
                </select>
              </div>

              <div class="filter-group">
                <label for="filterStockStatus">Stock Status:</label>
                <select id="filterStockStatus">
                  <option value="">All Status</option>
                  <option value="in_stock">Available</option>
                  <option value="low_stock">Low Stock</option>
                  <option value="out_of_stock">Out of Stock</option>
                  <option value="expiring_soon">Expiring Soon</option>
                </select>
              </div>

              <div class="filter-group">
                <label for="filterSearch">Search:</label>
                <input
                  type="text"
                  id="filterSearch"
                  placeholder="Product name or code..."
                />
              </div>

              <div class="filter-group">
                <button
                  type="button"
                  class="btn btn-primary"
                  id="applyFiltersBtn"
                >
                  <i class="fas fa-search"></i> Apply Filters
                </button>
              </div>
            </div>
          </div>
          <div class="table-container">
            <table class="inventory-table" id="inventoryTable">
              <thead>
                <tr>
                  <th>Product</th>
                  <th>Category</th>
                  <th>Stock</th>
                  <th>Price</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody id="inventoryTableBody">
                <!-- Will be populated by JavaScript -->
              </tbody>
            </table>
          </div>
        </div>

        <!-- Sidebar -->
        <div class="sidebar">
          <!-- Expiring Soon -->
          <div class="sidebar-card" id="expiring-soon">
            <h3><i class="fas fa-clock"></i> Expiring Soon (â‰¤ 3 days)</h3>
            <div class="expiring-list" id="expiringList">
              <!-- Will be populated -->
            </div>
          </div>

          <!-- Low Stock -->
          <div class="sidebar-card">
            <h3>
              <i class="fas fa-exclamation-triangle"></i> Low Stock (â‰¤ 5 units)
            </h3>
            <div id="lowStockList">
              <!-- Will be populated -->
            </div>
          </div>

          <!-- No Stock Sidebar Card -->
          <div
            class="sidebar-card"
            id="no-stock-section"
            onclick="showAllOutOfStock()"
          >
            <div
              style="
                display: flex;
                justify-content: space-between;
                align-items: center;
                margin-bottom: 15px;
              "
            >
              <h3 style="margin: 0">
                <i class="fas fa-times-circle"></i> Out of Stock
              </h3>
              <i
                class="fas fa-external-link-alt"
                style="color: var(--primary); cursor: pointer"
              ></i>
            </div>
            <div id="noStockList">
              <!-- Will be populated -->
            </div>
          </div>

          <!-- Batch History -->
          <div class="sidebar-card">
            <h3><i class="fas fa-history"></i> Recent Batches</h3>
            <div id="batchHistory">
              <!-- Will be populated -->
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Product Modal -->
    <div id="productModal" class="modal">
      <div class="modal-content">
        <div class="modal-header">
          <h3 id="productModalTitle"><i class="fas fa-box"></i> Add Product</h3>
          <button type="button" class="close-modal" id="closeProductModal">
            <i class="fas fa-times"></i>
          </button>
        </div>
        <form id="productForm">
          <div class="form-group">
            <label for="productName">Product Name *</label>
            <input
              type="text"
              id="productName"
              required
              placeholder="Chocolate Cake"
            />
          </div>

          <div class="form-group">
            <label for="productCode">Generated Product Code</label>
            <input
              type="text"
              id="productCode"
              readonly
              style="
                background-color: #f8f9fa;
                cursor: not-allowed;
                font-weight: 600;
                color: var(--accent);
                font-family: monospace;
              "
            />
            <small style="color: #666; font-size: 11px">
              <i class="fas fa-info-circle"></i> Code is auto-generated based on
              category
            </small>
          </div>
          <div class="form-row">
            <div class="form-group">
              <label for="productCategory">Category *</label>
              <select id="productCategory" required>
                <option value="">Select Category</option>
                <option value="Cakes">Cakes</option>
                <option value="Pastries">Pastries</option>
                <option value="Decorations">Decorations</option>
                <option value="Beverages">Beverages</option>
              </select>
            </div>
            <div class="form-group">
              <label for="productPrice">Unit Price (â‚¹) *</label>
              <input
                type="number"
                id="productPrice"
                required
                step="0.01"
                placeholder="45.99"
                min="0.01"
              />
            </div>
          </div>

          <div class="form-row">
            <div class="form-group">
              <label for="shelfLifeDays">Shelf Life (Days) *</label>
              <input
                type="number"
                id="shelfLifeDays"
                required
                min="1"
                placeholder="7"
                value="7"
              />
            </div>
            <div class="form-group">
              <label style="color: transparent">-</label>
              <div
                style="
                  background-color: #f8f9fa;
                  padding: 8px;
                  border-radius: 6px;
                  font-size: 12px;
                "
              >
                <i class="fas fa-info-circle"></i> Stock will be managed through
                batches
              </div>
            </div>
          </div>

          <div class="form-actions">
            <button type="submit" class="btn btn-primary">
              <i class="fas fa-save"></i> Save
            </button>
            <button type="button" class="btn" id="cancelProductBtn">
              Cancel
            </button>
          </div>
        </form>
      </div>
    </div>

    <!-- Batch Modal -->
    <div id="batchModal" class="modal">
      <div class="modal-content">
        <div class="modal-header">
          <h3><i class="fas fa-layer-group"></i> Add New Batch</h3>
          <button type="button" class="close-modal" id="closeBatchModal">
            <i class="fas fa-times"></i>
          </button>
        </div>
        <form id="batchForm">
          <div class="form-group">
            <label for="batchProduct">Product *</label>
            <div class="searchable-dropdown" id="batchProductDropdown">
              <input
                type="text"
                class="searchable-dropdown-input"
                id="batchProductInput"
                placeholder="Type product name or code..."
                required
                autocomplete="off"
              />
              <button
                type="button"
                class="searchable-dropdown-toggle"
                id="batchProductToggle"
              >
                <i class="fas fa-chevron-down"></i>
              </button>
              <div class="searchable-dropdown-options" id="batchProductOptions">
                <!-- Options will be populated dynamically -->
                <!-- No inner search box needed -->
              </div>
              <input
                type="hidden"
                id="batchProduct"
                name="batchProduct"
                required
              />
            </div>
          </div>

          <div class="form-row">
            <div class="form-group">
              <label for="batchQuantity">Quantity *</label>
              <input
                type="number"
                id="batchQuantity"
                required
                min="1"
                value="1"
              />
            </div>
            <div class="form-group">
              <label for="batchPrice">Cost per Unit (â‚¹) *</label>
              <input type="number" id="batchPrice" step="0.01" required />
              <small style="color: #666; font-size: 11px"
                >Auto-filled from product price</small
              >
            </div>
          </div>

          <div class="form-row">
            <div class="form-group">
              <label for="batchManufactureDate">Manufacture Date *</label>
              <input type="date" id="batchManufactureDate" required />
              <small style="color: #666; font-size: 11px"
                >Default: Today's date</small
              >
            </div>
            <div class="form-group">
              <label for="batchShelfLife">Shelf Life (Days) *</label>
              <input type="number" id="batchShelfLife" min="1" required />
              <small style="color: #666; font-size: 11px"
                >Default from product settings</small
              >
            </div>
          </div>
          <!-- Add this empty div to maintain spacing -->
          <div style="display: none">
            <!-- Hidden expiry date field for JavaScript calculations -->
            <input type="hidden" id="batchExpiryDate" />
          </div>

          <div class="form-actions">
            <button type="submit" class="btn btn-success">
              <i class="fas fa-check"></i> Add Batch
            </button>
            <button type="button" class="btn" id="cancelBatchBtn">
              Cancel
            </button>
          </div>
        </form>
      </div>
    </div>

    <!-- Update Dates Modal -->
    <div id="datesModal" class="modal">
      <div class="modal-content">
        <div class="modal-header">
          <h3><i class="fas fa-calendar-day"></i> Update Shelf Life</h3>
          <button type="button" class="close-modal" id="closeDatesModal">
            <i class="fas fa-times"></i>
          </button>
        </div>
        <div style="padding: 20px">
          <p>
            This will update shelf life calculations based on today's date:
            <strong id="currentDate"></strong>
          </p>
          <p>
            Products will be checked for expiration and remaining shelf life
            will be recalculated.
          </p>
          <div class="form-actions">
            <button
              type="button"
              class="btn btn-warning"
              id="confirmUpdateDates"
            >
              <i class="fas fa-sync"></i> Update Now
            </button>
            <button type="button" class="btn" id="cancelDatesBtn">
              Cancel
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Product Detail Modal -->
    <div id="detailModal" class="modal">
      <div class="modal-content" style="max-width: 700px">
        <div class="modal-header">
          <h3 id="detailTitle">Product Details</h3>
          <button type="button" class="close-modal" id="closeDetailModal">
            <i class="fas fa-times"></i>
          </button>
        </div>
        <div id="detailContent">
          <!-- Content loaded dynamically -->
        </div>
      </div>
    </div>
    <script>
      // Database Configuration
      const SUPABASE_URL = "https://vdbwzmutxjonnpfwfpbn.supabase.co";
      const SUPABASE_KEY =
        "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZkYnd6bXV0eGpvbm5wZndmcGJuIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQ5OTcwMjQsImV4cCI6MjA4MDU3MzAyNH0.n0ERxgLgYU1Tvw5QONihv1C3A7o7rcxrcn5MjZ5UnEM";

      let supabase = null;
      let products = [];
      let batches = [];
      let today = new Date();

      // Keyboard Navigation Variables
      let currentFocusIndex = 0;
      let focusableElements = [];
      let inTableMode = false;
      let currentTableRow = 0;
      let currentTableColumn = 0;
      let isModalOpen = false;
      let currentModalElements = [];

      // ==================== KEYBOARD NAVIGATION SYSTEM ====================

      function initializeKeyboardNavigation() {
        console.log("Initializing keyboard navigation...");

        // Collect all focusable elements
        updateFocusableElements();

        // Add global keyboard event listener
        document.addEventListener("keydown", handleGlobalKeyboard);

        // Set initial focus
        setTimeout(() => {
          if (focusableElements.length > 0) {
            setFocus(0);
          }
        }, 100);

        console.log(
          "Keyboard navigation initialized with",
          focusableElements.length,
          "focusable elements"
        );
      }

      // Filtering variables
      let currentFilters = {
        category: "",
        stockStatus: "",
        search: "",
      };
      let filteredProducts = [];

      // Initialize filters
      function initializeFilters() {
        // Apply Filters button
        document
          .getElementById("applyFiltersBtn")
          .addEventListener("click", applyFilters);

        // Clear Filters button
        document
          .getElementById("clearFiltersBtn")
          .addEventListener("click", clearFilters);

        // Search on Enter key
        document
          .getElementById("filterSearch")
          .addEventListener("keyup", function (e) {
            if (e.key === "Enter") {
              applyFilters();
            }
          });

        // Apply filters when dropdowns change (optional)
        document
          .getElementById("filterCategory")
          .addEventListener("change", applyFilters);
        document
          .getElementById("filterStockStatus")
          .addEventListener("change", applyFilters);
      }

      // Update after loading products
      function updateCategoryFilterOptions() {
        const categorySelect = document.getElementById("filterCategory");
        const categories = [...new Set(products.map((p) => p.category))];

        // Clear existing options (keep "All Categories")
        categorySelect.innerHTML = '<option value="">All Categories</option>';

        // Add each unique category
        categories.forEach((category) => {
          const option = document.createElement("option");
          option.value = category;
          option.textContent = category;
          categorySelect.appendChild(option);
        });
      }

      // Apply filters
      function applyFilters() {
        // Get filter values
        currentFilters = {
          category: document.getElementById("filterCategory").value,
          stockStatus: document.getElementById("filterStockStatus").value,
          search: document
            .getElementById("filterSearch")
            .value.toLowerCase()
            .trim(),
        };

        // Check if any filters are active
        const hasFiltersActive =
          currentFilters.category !== "" ||
          currentFilters.stockStatus !== "" ||
          currentFilters.search !== "";

        if (hasFiltersActive) {
          // Filter products
          filterProducts();

          // Update UI
          updateFilteredTable();
          updateActiveFiltersDisplay();

          // Show notification
          showNotification(
            `Showing ${filteredProducts.length} filtered products`,
            "info"
          );
        } else {
          // No filters active, show all products
          filteredProducts = [];
          updateFilteredTable();
          updateActiveFiltersDisplay();
        }
      }

      // Filter products based on current filters
      function filterProducts() {
        filteredProducts = products.filter((product) => {
          const status = calculateProductStatus(product);
          let matchesAllFilters = true;

          // Category filter
          if (
            currentFilters.category &&
            product.category !== currentFilters.category
          ) {
            matchesAllFilters = false;
          }

          if (currentFilters.stockStatus) {
            if (currentFilters.stockStatus === "available") {
              // Show products that are NOT out_of_stock
              if (status.status === "out_of_stock") {
                matchesAllFilters = false;
              }
            } else if (currentFilters.stockStatus === "expiring_soon") {
              // Show only products with expiring batches AND stock > 0
              if (
                status.status !== "expiring_soon" ||
                status.totalStock === 0
              ) {
                matchesAllFilters = false;
              }
            } else if (currentFilters.stockStatus === "low_stock") {
              // Show products with stock > 0
              if (status.status !== "low_stock") {
                matchesAllFilters = false;
              }
            } else if (currentFilters.stockStatus === "out_of_stock") {
              // Show products with no stock
              if (status.totalStock > 0) {
                matchesAllFilters = false;
              }
            }
          }

          // Search filter
          if (currentFilters.search) {
            const searchTerm = currentFilters.search;
            const matchesName = product.product_name
              .toLowerCase()
              .includes(searchTerm);
            const matchesCode = product.product_code
              .toLowerCase()
              .includes(searchTerm);
            if (!matchesName && !matchesCode) {
              matchesAllFilters = false;
            }
          }

          return matchesAllFilters;
        });
      }

      // Check if any filters are active
      function hasActiveFilters() {
        return (
          currentFilters.category !== "" ||
          currentFilters.stockStatus !== "" ||
          currentFilters.search !== ""
        );
      }

      // Update table with filtered products
      function updateFilteredTable() {
        const tbody = document.getElementById("inventoryTableBody");
        tbody.innerHTML = "";

        // Check if any filters are active
        const hasFiltersActive = hasActiveFilters();

        // Use filtered products if filters are active, otherwise use all products
        const displayProducts = hasFiltersActive ? filteredProducts : products;

        if (displayProducts.length === 0) {
          tbody.innerHTML = `
      <tr>
        <td colspan="5" class="no-results">
          <i class="fas fa-search"></i>
          <p>No products found</p>
          <div class="suggestion">Try adjusting your filters or search term</div>
          <button type="button" class="btn" onclick="clearFilters()" style="margin-top: 15px;">
            <i class="fas fa-times"></i> Clear Filters
          </button>
        </td>
      </tr>
    `;
          return;
        }

        // Month names array for formatting
        const monthNames = [
          "January",
          "February",
          "March",
          "April",
          "May",
          "June",
          "July",
          "August",
          "September",
          "October",
          "November",
          "December",
        ];

        displayProducts.forEach((product) => {
          const status = calculateProductStatus(product);
          const row = document.createElement("tr");

          // Determine row class based on status
          if (status.status === "expiring_soon")
            row.classList.add("critical-item");
          else if (status.status === "low_stock")
            row.classList.add("warning-item");
          else if (status.status === "out_of_stock")
            row.classList.add("out-of-stock");

          // Batch info
          let batchInfo = "";
          if (status.batches && status.batches.length > 0) {
            const activeBatches = status.batches.filter((b) => {
              if (!b.expiry_date) return true;
              return new Date(b.expiry_date) >= today;
            });
            batchInfo = `<div style="font-size: 11px; color: #666;">${activeBatches.length} active batch(es)</div>`;
          }

          row.innerHTML = `
      <td>
        <div style="font-weight: 600;">${product.product_name}</div>
        <div style="font-size: 12px; color: #666;">${product.product_code}</div>
        ${batchInfo}
      </td>
      <td>
        <span class="category-badge">${product.category}</span>
      </td>
      <td>
        <div style="font-weight: 700; font-size: 18px; color: ${
          status.totalStock <= 5 ? "var(--danger)" : "var(--success)"
        }">
          ${status.totalStock}
        </div>
        <div style="font-size: 11px; color: #666;">units</div>
      </td>
      <td>
        <div style="font-weight: 700; color: var(--accent);">
          â‚¹${parseFloat(product.unit_price).toFixed(2)}
        </div>
      </td>
      <td>
        <div class="quick-actions">
          <button class="action-btn view" onclick="viewProduct('${
            product.id
          }')" title="View Details" tabindex="0">
            <i class="fas fa-eye"></i>
          </button>
          <button class="action-btn edit" onclick="editProduct('${
            product.id
          }')" title="Edit" tabindex="0">
            <i class="fas fa-edit"></i>
          </button>
        </div>
      </td>
    `;

          tbody.appendChild(row);
        });
      }

      // Clear filters function
      function clearFilters() {
        document.getElementById("filterCategory").value = "";
        document.getElementById("filterStockStatus").value = "";
        document.getElementById("filterSearch").value = "";

        currentFilters = {
          category: "",
          stockStatus: "",
          search: "",
        };

        // Update table to show all products
        updateInventoryTable(); // Call the original table update function
        updateActiveFiltersDisplay();

        showNotification("Filters cleared", "info");
      }

      // Update active filters display
      function updateActiveFiltersDisplay() {
        const filtersContainer = document.querySelector(
          ".filters-section .active-filters"
        );
        if (!filtersContainer) {
          // Create active filters container if it doesn't exist
          const filterSection = document.querySelector(".filters-section");
          const activeFiltersDiv = document.createElement("div");
          activeFiltersDiv.className = "active-filters";
          filterSection.appendChild(activeFiltersDiv);
        }

        const activeFiltersDiv = document.querySelector(
          ".filters-section .active-filters"
        );
        activeFiltersDiv.innerHTML = "";

        const hasFilters = Object.values(currentFilters).some(
          (value) => value !== ""
        );

        if (!hasFilters) {
          activeFiltersDiv.style.display = "none";
          return;
        }

        activeFiltersDiv.style.display = "flex";

        // Add filter tags
        if (currentFilters.category) {
          const tag = document.createElement("div");
          tag.className = "filter-tag";
          tag.innerHTML = `
      <span>Category: ${currentFilters.category}</span>
      <button class="remove-filter" onclick="removeFilter('category')">
        <i class="fas fa-times"></i>
      </button>
    `;
          activeFiltersDiv.appendChild(tag);
        }

        if (currentFilters.stockStatus) {
          const statusLabels = {
            available: "Available",
            low_stock: "Low Stock",
            out_of_stock: "Out of Stock",
            expiring_soon: "Expiring Soon",
          };
          const tag = document.createElement("div");
          tag.className = "filter-tag";
          tag.innerHTML = `
      <span>Status: ${
        statusLabels[currentFilters.stockStatus] || currentFilters.stockStatus
      }</span>
      <button class="remove-filter" onclick="removeFilter('stockStatus')">
        <i class="fas fa-times"></i>
      </button>
    `;
          activeFiltersDiv.appendChild(tag);
        }

        if (currentFilters.search) {
          const tag = document.createElement("div");
          tag.className = "filter-tag";
          tag.innerHTML = `
      <span>Search: "${currentFilters.search}"</span>
      <button class="remove-filter" onclick="removeFilter('search')">
        <i class="fas fa-times"></i>
      </button>
    `;
          activeFiltersDiv.appendChild(tag);
        }
      }

      // Remove specific filter
      function removeFilter(filterType) {
        if (filterType === "category") {
          document.getElementById("filterCategory").value = "";
        } else if (filterType === "stockStatus") {
          document.getElementById("filterStockStatus").value = "";
        } else if (filterType === "search") {
          document.getElementById("filterSearch").value = "";
        }

        applyFilters();
      }

      function updateFocusableElements() {
        // Get all focusable elements
        focusableElements = Array.from(
          document.querySelectorAll(
            'a[href], button, input, select, textarea, [tabindex]:not([tabindex="-1"])'
          )
        ).filter((el) => {
          // Filter out hidden, disabled, or non-visible elements
          return (
            el.offsetParent !== null &&
            !el.disabled &&
            el.style.display !== "none" &&
            !el.classList.contains("modal") &&
            !el.closest(".modal")
          );
        });

        // Add tabindex to the no-stock section
        const noStockSection = document.getElementById("no-stock-section");
        if (noStockSection && !focusableElements.includes(noStockSection)) {
          noStockSection.setAttribute("tabindex", "0");
          focusableElements.push(noStockSection);
        }

        // Add tabindex to table rows for navigation
        const tableRows = document.querySelectorAll(
          ".inventory-table tbody tr"
        );
        tableRows.forEach((row, index) => {
          row.setAttribute("tabindex", "0");
          if (!focusableElements.includes(row)) {
            focusableElements.push(row);
          }
        });

        // Add tabindex to sidebar items
        const sidebarItems = document.querySelectorAll(
          ".expiring-item, .stock-alert-item, .batch-history-item, .no-stock-item"
        );
        sidebarItems.forEach((item, index) => {
          item.setAttribute("tabindex", "0");
          if (!focusableElements.includes(item)) {
            focusableElements.push(item);
          }
        });

        // Add tabindex to dashboard cards
        const statCards = document.querySelectorAll(".stat-card");
        statCards.forEach((card, index) => {
          card.setAttribute("tabindex", "0");
          if (!focusableElements.includes(card)) {
            focusableElements.push(card);
          }
        });
      }

      function handleGlobalKeyboard(e) {
        // Don't interfere with typing in inputs
        if (
          e.target.tagName === "INPUT" ||
          e.target.tagName === "TEXTAREA" ||
          e.target.tagName === "SELECT"
        ) {
          handleInputKeyboard(e);
          return;
        }

        // Global shortcuts (work everywhere)
        if (e.ctrlKey || e.metaKey) {
          handleControlShortcuts(e);
          return;
        }

        if (e.altKey) {
          handleAltShortcuts(e);
          return;
        }

        // Function keys
        if (e.key.startsWith("F")) {
          handleFunctionKeys(e);
          return;
        }

        // Navigation keys
        switch (e.key) {
          case "Tab":
            e.preventDefault();
            if (e.shiftKey) {
              moveToPreviousElement();
            } else {
              moveToNextElement();
            }
            break;

          case "ArrowDown":
            e.preventDefault();
            if (inTableMode) {
              navigateTable("down");
            } else {
              moveToNextElement();
            }
            break;

          case "ArrowUp":
            e.preventDefault();
            if (inTableMode) {
              navigateTable("up");
            } else {
              moveToPreviousElement();
            }
            break;

          case "ArrowRight":
            e.preventDefault();
            if (inTableMode) {
              navigateTable("right");
            }
            break;

          case "ArrowLeft":
            e.preventDefault();
            if (inTableMode) {
              navigateTable("left");
            }
            break;

          case "Enter":
          case " ":
            e.preventDefault();
            activateCurrentElement();
            break;

          case "Escape":
            e.preventDefault();
            if (isModalOpen) {
              closeActiveModal();
            } else {
              clearCurrentFocus();
            }
            break;

          case "Home":
            e.preventDefault();
            setFocus(0);
            break;

          case "End":
            e.preventDefault();
            setFocus(focusableElements.length - 1);
            break;
        }
      }

      function handleInputKeyboard(e) {
        switch (e.key) {
          case "Enter":
            e.preventDefault();
            if (e.target.type === "button" || e.target.type === "submit") {
              e.target.click();
            } else {
              moveToNextElement();
            }
            break;

          case "Tab":
            e.preventDefault();
            if (e.shiftKey) {
              moveToPreviousElement();
            } else {
              moveToNextElement();
            }
            break;

          case "Escape":
            e.preventDefault();
            e.target.blur();
            setFocus(currentFocusIndex);
            break;
        }
      }

      function handleControlShortcuts(e) {
        switch (e.key.toLowerCase()) {
          case "n": // New product
            e.preventDefault();
            addProductModal();
            break;

          case "b": // Add batch
            e.preventDefault();
            addBatchModal();
            break;

          case "e": // Export
            e.preventDefault();
            exportInventory();
            break;

          case "r": // Refresh
            e.preventDefault();
            loadInventoryData();
            showNotification("Refreshing inventory...", "info");
            break;

          case "f": // Focus search/filter
            e.preventDefault();
            const searchInput = document.querySelector(
              'input[type="search"], input[placeholder*="search"]'
            );
            if (searchInput) {
              setFocusOnElement(searchInput);
            }
            break;

          case "1": // Focus on first button
            e.preventDefault();
            const firstButton = document.querySelector(
              ".header-actions button, .btn"
            );
            if (firstButton) {
              setFocusOnElement(firstButton);
            }
            break;

          case "h": // Help
            e.preventDefault();
            showKeyboardHelp();
            break;
        }
      }

      function handleAltShortcuts(e) {
        switch (e.key.toLowerCase()) {
          case "1": // Add Product
            e.preventDefault();
            addProductModal();
            break;

          case "2": // Add Batch
            e.preventDefault();
            addBatchModal();
            break;

          case "3": // Update Dates
            e.preventDefault();
            updateDatesModal();
            break;

          case "4": // Export
            e.preventDefault();
            exportInventory();
            break;

          case "5": // View Products Table
            e.preventDefault();
            const table = document.querySelector(".inventory-table");
            if (table) {
              setFocusOnElement(table);
              inTableMode = true;
            }
            break;

          case "6": // Focus on Expiring Soon
            e.preventDefault();
            const expiringSection = document.getElementById("expiring-soon");
            if (expiringSection) {
              setFocusOnElement(expiringSection);
            }
            break;

          case "7": // Focus on Low Stock
            e.preventDefault();
            const lowStockSection = document.querySelector("#lowStockList");
            if (lowStockSection) {
              setFocusOnElement(lowStockSection);
            }
            break;

          case "8": // Focus on filter search
            e.preventDefault();
            document.getElementById("filterSearch")?.focus();
            document.getElementById("filterSearch")?.select();
            break;

          case "9": // Apply filters
            e.preventDefault();
            applyFilters();
            break;

          case "0": // Clear filters
            e.preventDefault();
            clearFilters();
            break;

          case "h": // Help
            e.preventDefault();
            showKeyboardHelp();
            break;
        }
      }

      function handleFunctionKeys(e) {
        e.preventDefault();
        switch (e.key) {
          case "F1": // Help
            showKeyboardHelp();
            break;

          case "F2": // Add Product
            addProductModal();
            break;

          case "F3": // Add Batch
            addBatchModal();
            break;

          case "F4": // Update Dates
            updateDatesModal();
            break;

          case "F5": // Refresh/Reload
            loadInventoryData();
            showNotification("Inventory refreshed", "success");
            break;

          case "F6": // Export
            exportInventory();
            break;

          case "F7": // View Products
            viewProduct(products[0]?.id);
            break;

          case "F8": // Focus on table
            const tableBody = document.querySelector(".inventory-table tbody");
            if (tableBody && tableBody.firstChild) {
              setFocusOnElement(tableBody.firstChild);
              inTableMode = true;
            }
            break;

          case "F9": // Quick save (if in modal)
            const saveBtn = document.querySelector(
              ".modal .btn-primary, .modal .btn-success"
            );
            if (saveBtn) {
              saveBtn.click();
            }
            break;

          case "F10": // Quick close (if in modal)
            if (isModalOpen) {
              closeActiveModal();
            }
            break;

          case "F11": // Toggle fullscreen
            toggleFullscreen();
            break;

          case "F12": // Developer tools (let default)
            return;
        }
      }

      function moveToNextElement() {
        clearFocusIndicators();
        currentFocusIndex = (currentFocusIndex + 1) % focusableElements.length;
        setFocus(currentFocusIndex);
      }

      function moveToPreviousElement() {
        clearFocusIndicators();
        currentFocusIndex =
          currentFocusIndex > 0
            ? currentFocusIndex - 1
            : focusableElements.length - 1;
        setFocus(currentFocusIndex);
      }

      function setFocus(index) {
        if (index >= 0 && index < focusableElements.length) {
          const element = focusableElements[index];

          // Check if element is a table row
          if (element.tagName === "TR") {
            inTableMode = true;
            const rows = Array.from(
              document.querySelectorAll(".inventory-table tbody tr")
            );
            currentTableRow = rows.indexOf(element);
            currentTableColumn = 0;

            // Find focusable cells in this row
            const cells = element.querySelectorAll("button, [tabindex]");
            if (cells.length > 0) {
              cells[0].focus();
              cells[0].classList.add("keyboard-focus");
            } else {
              element.focus();
              element.classList.add("keyboard-focus");
            }
          } else {
            inTableMode = false;
            element.focus();
            element.classList.add("keyboard-focus");
          }

          // Scroll into view
          element.scrollIntoView({ behavior: "smooth", block: "nearest" });
        }
      }

      function setFocusOnElement(element) {
        const index = focusableElements.indexOf(element);
        if (index !== -1) {
          currentFocusIndex = index;
          setFocus(currentFocusIndex);
        }
      }

      function clearFocusIndicators() {
        document.querySelectorAll(".keyboard-focus").forEach((el) => {
          el.classList.remove("keyboard-focus");
        });
      }

      function clearCurrentFocus() {
        const currentElement = focusableElements[currentFocusIndex];
        if (
          currentElement &&
          (currentElement.tagName === "INPUT" ||
            currentElement.tagName === "TEXTAREA")
        ) {
          currentElement.value = "";
          showNotification("Field cleared", "info");
        }
      }

      function activateCurrentElement() {
        const element = focusableElements[currentFocusIndex];
        if (element) {
          if (element.tagName === "BUTTON" || element.tagName === "A") {
            element.click();
          } else if (element.tagName === "TR") {
            // Table row - find and click the view button
            const viewBtn = element.querySelector(".action-btn.view");
            if (viewBtn) {
              viewBtn.click();
            }
          } else if (
            element.classList.contains("expiring-item") ||
            element.classList.contains("stock-alert-item") ||
            element.classList.contains("batch-history-item")
          ) {
            // Sidebar item - simulate click
            element.click();
          } else if (element.classList.contains("stat-card")) {
            // Dashboard card - refresh data
            loadInventoryData();
            showNotification("Refreshing inventory data...", "info");
          } else if (element.id === "no-stock-section") {
            // Click on the no-stock sidebar card
            showAllOutOfStock();
          }
        }
      }

      function navigateTable(direction) {
        const rows = Array.from(
          document.querySelectorAll(".inventory-table tbody tr")
        );
        if (rows.length === 0) return;

        switch (direction) {
          case "down":
            if (currentTableRow < rows.length - 1) {
              currentTableRow++;
            }
            break;

          case "up":
            if (currentTableRow > 0) {
              currentTableRow--;
            }
            break;

          case "right":
            const currentRow = rows[currentTableRow];
            const cells = currentRow.querySelectorAll("button, [tabindex]");
            if (cells.length > 0) {
              if (currentTableColumn < cells.length - 1) {
                currentTableColumn++;
              }
            }
            break;

          case "left":
            if (currentTableColumn > 0) {
              currentTableColumn--;
            }
            break;
        }

        // Update focus
        const targetRow = rows[currentTableRow];
        const rowCells = targetRow.querySelectorAll("button, [tabindex]");

        clearFocusIndicators();

        if (rowCells.length > 0 && currentTableColumn < rowCells.length) {
          rowCells[currentTableColumn].focus();
          rowCells[currentTableColumn].classList.add("keyboard-focus");
          targetRow.classList.add("keyboard-focus");
        } else {
          targetRow.focus();
          targetRow.classList.add("keyboard-focus");
        }

        targetRow.scrollIntoView({ behavior: "smooth", block: "nearest" });
      }

      function setupModalKeyboardNavigation(modalId) {
        const modal = document.getElementById(modalId);
        if (!modal) return;

        isModalOpen = true;

        // Get all focusable elements in modal
        currentModalElements = Array.from(
          modal.querySelectorAll(
            'button, input, select, textarea, [tabindex]:not([tabindex="-1"])'
          )
        ).filter((el) => el.offsetParent !== null && !el.disabled);

        // Set focus on first element
        if (currentModalElements.length > 0) {
          setTimeout(() => {
            currentModalElements[0].focus();
            currentModalElements[0].classList.add("keyboard-focus");
          }, 100);
        }

        // Add keyboard event listener for modal
        const modalKeyHandler = (e) => {
          if (e.key === "Escape") {
            e.preventDefault();
            closeActiveModal();
          } else if (e.key === "Tab") {
            e.preventDefault();
            const currentIndex = currentModalElements.indexOf(
              document.activeElement
            );
            if (e.shiftKey) {
              const prevIndex =
                currentIndex > 0
                  ? currentIndex - 1
                  : currentModalElements.length - 1;
              currentModalElements[prevIndex].focus();
            } else {
              const nextIndex =
                (currentIndex + 1) % currentModalElements.length;
              currentModalElements[nextIndex].focus();
            }
          } else if (e.key === "Enter" && e.target.type !== "textarea") {
            if (e.target.type === "submit" || e.target.tagName === "BUTTON") {
              return; // Let default behavior
            } else {
              e.preventDefault();
              const currentIndex = currentModalElements.indexOf(
                document.activeElement
              );
              const nextIndex =
                (currentIndex + 1) % currentModalElements.length;
              currentModalElements[nextIndex].focus();
            }
          }
        };

        modal.addEventListener("keydown", modalKeyHandler);

        // Store handler for cleanup
        modal.dataset.keyHandler = modalKeyHandler;
      }

      function closeActiveModal() {
        const activeModal = document.querySelector(
          '.modal[style*="display: flex"], .modal[style*="display:flex"]'
        );
        if (activeModal) {
          // Remove keyboard handler
          if (activeModal.dataset.keyHandler) {
            activeModal.removeEventListener(
              "keydown",
              activeModal.dataset.keyHandler
            );
          }

          // Close modal
          if (activeModal.id === "productModal") closeProductModal();
          else if (activeModal.id === "batchModal") closeBatchModal();
          else if (activeModal.id === "datesModal") closeDatesModal();
          else if (activeModal.id === "detailModal") closeDetailModal();
        }

        isModalOpen = false;
        updateFocusableElements();
        setFocus(0);
      }

      function toggleFullscreen() {
        if (!document.fullscreenElement) {
          document.documentElement.requestFullscreen();
        } else if (document.exitFullscreen) {
          document.exitFullscreen();
        }
      }

      function showKeyboardHelp() {
        const helpText = `
â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘                ðŸ“¦ INVENTORY - KEYBOARD SHORTCUTS ðŸ“¦         â•‘
â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£
â•‘ NAVIGATION:                                                  â•‘
â•‘   Tab / Shift+Tab  â†’ Next/Previous element                   â•‘
â•‘   Enter / Space    â†’ Activate current element                â•‘
â•‘   Esc              â†’ Clear field / Close modal               â•‘
â•‘   â†‘â†“â†â†’             â†’ Navigate table                          â•‘
â•‘   Home / End       â†’ First/Last element                      â•‘
â•‘                                                              â•‘  
â•‘ TABLE NAVIGATION:                                            â•‘
â•‘   Enter on row    â†’ View product details                     â•‘
â•‘   Arrow keys      â†’ Move between rows and action buttons     â•‘
â•‘                                                              â•‘  
â•‘ FUNCTION KEYS:                                               â•‘
â•‘   F1  â†’ This help                                            â•‘
â•‘   F2  â†’ Add new product                                      â•‘
â•‘   F3  â†’ Add new batch                                        â•‘
â•‘   F4  â†’ Update shelf life dates                              â•‘
â•‘   F5  â†’ Refresh inventory                                    â•‘
â•‘   F6  â†’ Export to CSV                                        â•‘
â•‘   F7  â†’ View first product                                   â•‘
â•‘   F8  â†’ Focus on products table                              â•‘
â•‘   F9  â†’ Quick save (in modal)                                â•‘
â•‘   F10 â†’ Quick close (in modal)                               â•‘
â•‘   F11 â†’ Toggle fullscreen                                    â•‘
â•‘                                                              â•‘  
â•‘ CONTROL SHORTCUTS (Ctrl+):                                   â•‘
â•‘   N  â†’ New product                                           â•‘
â•‘   B  â†’ Add batch                                             â•‘
â•‘   E  â†’ Export inventory                                      â•‘
â•‘   R  â†’ Refresh data                                          â•‘
â•‘   F  â†’ Focus search                                          â•‘
â•‘   H  â†’ Help                                                  â•‘
â•‘   1  â†’ First action button                                   â•‘
â•‘                                                              â•‘  
â•‘ ALT SHORTCUTS (Alt+):                                        â•‘
â•‘   1 â†’ Add Product                                            â•‘
â•‘   2 â†’ Add Batch                                              â•‘
â•‘   3 â†’ Update Dates                                           â•‘
â•‘   4 â†’ Export                                                 â•‘
â•‘   5 â†’ Products Table                                         â•‘
â•‘   6 â†’ Expiring Soon section                                  â•‘
â•‘   7 â†’ Low Stock section                                      â•‘
â•‘   H â†’ Help                                                   â•‘
â•‘                                                              â•‘  
â•‘ MODAL NAVIGATION:                                            â•‘
â•‘   Tab / Shift+Tab â†’ Navigate form fields                     â•‘
â•‘   Enter           â†’ Next field / Submit form                 â•‘
â•‘   Esc             â†’ Close modal                              â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    `;

        alert(helpText);
      }

      // ==================== INVENTORY MANAGEMENT FUNCTIONS ====================

      // Initialize Supabase
      async function initSupabase() {
        try {
          supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
          console.log("Supabase connected");
          await loadInventoryData();

          // Initialize keyboard navigation after data loads
          setTimeout(() => {
            initializeKeyboardNavigation();
          }, 500);

          return true;
        } catch (error) {
          console.error("Error connecting to Supabase:", error);
          showNotification("Database connection failed", "error");
          return false;
        }
      }

      function generateProductCode(category, productName) {
        // Category prefixes
        const categoryPrefixes = {
          Cakes: "CK",
          Pastries: "PS",
          Decorations: "DC",
          Beverages: "BV",
        };

        const prefix = categoryPrefixes[category] || "PR";

        // Get existing product codes for this category
        const existingCodes = products
          .filter((p) => p.category === category)
          .map((p) => p.product_code)
          .filter((code) => code.startsWith(prefix));

        // Find the highest number used
        let maxNumber = 0;
        existingCodes.forEach((code) => {
          const match = code.match(/\d+$/);
          if (match) {
            const num = parseInt(match[0]);
            if (num > maxNumber) maxNumber = num;
          }
        });

        // Generate next number
        const nextNumber = maxNumber + 1;

        // Format number with leading zeros (e.g., 001, 002, etc.)
        const formattedNumber = nextNumber.toString().padStart(3, "0");

        return `${prefix}-${formattedNumber}`;
      }

      function updateProductCode() {
        const productNameInput = document.getElementById("productName");
        const categorySelect = document.getElementById("productCategory");
        const productCodeInput = document.getElementById("productCode");

        if (!productNameInput || !categorySelect || !productCodeInput) {
          return;
        }

        const productName = productNameInput.value.trim();
        const category = categorySelect.value;

        if (productName && category) {
          const generatedCode = generateProductCode(category, productName);
          productCodeInput.value = generatedCode;

          // Add visual feedback
          productCodeInput.style.color = "var(--success)";
          productCodeInput.style.fontWeight = "600";
        } else {
          productCodeInput.value = "";
        }
      }

      // Update the loadInventoryData function
      async function loadInventoryData() {
        try {
          // Load products
          const { data: productsData, error: productsError } = await supabase
            .from("products")
            .select("*")
            .order("product_name");

          if (productsError) throw productsError;
          products = productsData || [];

          // Load batches
          const { data: batchesData, error: batchesError } = await supabase
            .from("product_batches")
            .select("*");

          if (
            batchesError &&
            !batchesError.message.includes("does not exist")
          ) {
            throw batchesError;
          }
          batches = batchesData || [];

          // Update UI
          updateDashboard();

          // Instead of calling applyFilters(), update the table directly
          updateFilteredTable(); // This will show all products initially (no filters applied)

          updateSidebar();

          // Update keyboard navigation elements
          updateFocusableElements();
        } catch (error) {
          console.error("Error loading inventory:", error);
          showNotification("Failed to load inventory", "error");
        }
      }

      // Calculate product status based on batches
      function calculateProductStatus(product) {
        const productBatches = batches.filter(
          (b) => b.product_code === product.product_code
        );

        if (productBatches.length === 0) {
          return {
            totalStock: 0,
            expiringBatches: 0,
            earliestExpiry: null,
            status: "out_of_stock",
          };
        }

        // Calculate total stock
        const totalStock = productBatches.reduce(
          (sum, batch) => sum + (batch.remaining_quantity || 0),
          0
        );

        // Find earliest expiry date
        const validBatches = productBatches.filter((b) => {
          if (!b.expiry_date) return false;
          const expiry = new Date(b.expiry_date);
          return expiry >= today;
        });

        let earliestExpiry = null;
        let expiringSoon = 0;

        if (validBatches.length > 0) {
          // Sort by expiry date
          validBatches.sort(
            (a, b) => new Date(a.expiry_date) - new Date(b.expiry_date)
          );
          earliestExpiry = new Date(validBatches[0].expiry_date);

          // Count batches expiring in 3 days or less
          expiringSoon = validBatches.filter((b) => {
            const expiry = new Date(b.expiry_date);
            const diffTime = expiry - today;
            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
            return diffDays <= 3;
          }).length;
        }

        // Determine status
        let status = "in_stock";
        if (totalStock === 0) status = "out_of_stock";
        else if (totalStock >= 1 && totalStock <= 5) status = "low_stock";
        else if (expiringSoon > 0) status = "expiring_soon";

        return {
          totalStock,
          expiringBatches: expiringSoon,
          earliestExpiry,
          status,
          batches: productBatches,
        };
      }

      function updateDashboard() {
        let availableStock = 0; // This will include in_stock + low_stock + expiring_soon
        let lowStock = 0;
        let expiringSoon = 0;
        let outOfStock = 0;

        products.forEach((product) => {
          const status = calculateProductStatus(product);

          if (status.status === "out_of_stock") {
            outOfStock++;
          } else {
            // All other statuses (in_stock, low_stock, expiring_soon) are considered "available"
            availableStock++;

            // Still track low_stock and expiring_soon separately for their individual counters
            if (status.status === "low_stock") lowStock++;
            if (status.status === "expiring_soon") expiringSoon++;
          }
        });

        document.getElementById("totalProducts").textContent = products.length;
        document.getElementById("inStockCount").textContent = availableStock; // Now shows total available products
        document.getElementById("lowStockCount").textContent = lowStock;
        document.getElementById("expiringCount").textContent = expiringSoon;
        document.getElementById("outOfStockCount").textContent = outOfStock;
      }

      // Update inventory table function
      function updateInventoryTable() {
        const tbody = document.getElementById("inventoryTableBody");
        tbody.innerHTML = "";

        // Month names array for formatting
        const monthNames = [
          "January",
          "February",
          "March",
          "April",
          "May",
          "June",
          "July",
          "August",
          "September",
          "October",
          "November",
          "December",
        ];

        products.forEach((product) => {
          const status = calculateProductStatus(product);
          const row = document.createElement("tr");

          // Determine row class based on status
          if (status.status === "expiring_soon")
            row.classList.add("critical-item");
          else if (status.status === "low_stock")
            row.classList.add("warning-item");
          else if (status.status === "out_of_stock")
            row.classList.add("out-of-stock");

          // Batch info
          let batchInfo = "";
          if (status.batches && status.batches.length > 0) {
            const activeBatches = status.batches.filter((b) => {
              if (!b.expiry_date) return true;
              return new Date(b.expiry_date) >= today;
            });
            batchInfo = `<div style="font-size: 11px; color: #666;">${activeBatches.length} active batch(es)</div>`;
          }

          row.innerHTML = `
      <td>
          <div style="font-weight: 600;">${product.product_name}</div>
          <div style="font-size: 12px; color: #666;">${
            product.product_code
          }</div>
          ${batchInfo}
      </td>
      <td>
          <span class="category-badge">${product.category}</span>
      </td>
      <td>
          <div style="font-weight: 700; font-size: 18px; color: ${
            status.totalStock <= 5 ? "var(--danger)" : "var(--success)"
          }">
              ${status.totalStock}
          </div>
          <div style="font-size: 11px; color: #666;">units</div>
      </td>
      
      <td>
          <div style="font-weight: 700; color: var(--accent);">
              â‚¹${parseFloat(product.unit_price).toFixed(2)}
          </div>
      </td>
      <td>
          <div class="quick-actions">
              <button class="action-btn view" onclick="viewProduct('${
                product.id
              }')" title="View Details" tabindex="0">
                  <i class="fas fa-eye"></i>
              </button>
              <button class="action-btn edit" onclick="editProduct('${
                product.id
              }')" title="Edit" tabindex="0">
                  <i class="fas fa-edit"></i>
              </button>
          </div>
      </td>
  `;

          tbody.appendChild(row);
        });
      }

      // Update sidebar information
      function updateSidebar() {
        updateExpiringList();
        updateLowStockList();
        updateNoStockList();
        updateBatchHistory();
      }

      // Update expiring soon list
      function updateExpiringList() {
        const expiringList = document.getElementById("expiringList");
        expiringList.innerHTML = "";

        // Month names array
        const monthNames = [
          "January",
          "February",
          "March",
          "April",
          "May",
          "June",
          "July",
          "August",
          "September",
          "October",
          "November",
          "December",
        ];

        // Collect all expiring batches from all products
        let expiringBatches = [];

        products.forEach((product) => {
          const productBatches = batches.filter(
            (b) => b.product_code === product.product_code
          );

          productBatches.forEach((batch) => {
            if (batch.expiry_date) {
              const expiryDate = new Date(batch.expiry_date);
              const diffTime = expiryDate - today;
              const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));

              // Check if batch has remaining quantity and is expiring soon
              const remainingQuantity = batch.remaining_quantity || 0;

              // Show batches expiring in 3 days or less (including today)
              // AND only if there's actually quantity remaining
              if (diffDays <= 3 && diffDays >= 0 && remainingQuantity > 0) {
                expiringBatches.push({
                  product: product,
                  batch: batch,
                  expiryDate: expiryDate,
                  daysLeft: diffDays,
                  quantity: remainingQuantity, // Use the actual remaining quantity
                });
              }
            }
          });
        });

        // Sort by days left (soonest first)
        expiringBatches.sort((a, b) => a.daysLeft - b.daysLeft);

        // Rest of the function remains the same...
        expiringBatches.forEach((item) => {
          // Format expiry date as DD MonthName
          const day = item.expiryDate.getDate();
          const month = monthNames[item.expiryDate.getMonth()];
          const formattedExpiry = `${day} ${month}`;

          // Determine badge color based on days left
          let badgeClass = "expiry-badge";
          if (item.daysLeft === 0) {
            badgeClass += " status-critical";
          } else if (item.daysLeft === 1) {
            badgeClass += " status-critical";
          } else if (item.daysLeft <= 3) {
            badgeClass += " status-low-stock";
          }

          const itemElement = document.createElement("div");
          itemElement.className = "expiring-item";
          itemElement.tabIndex = 0;
          itemElement.setAttribute("role", "button");
          itemElement.setAttribute(
            "aria-label",
            `View ${item.product.product_name} expiring in ${item.daysLeft} days`
          );

          itemElement.innerHTML = `
            <div style="flex: 1;">
                <div class="product-name">${item.product.product_name}</div>
                <div style="display: flex; justify-content: space-between; margin-top: 5px;">
                    <div class="expiry-date" style="font-size: 11px; color: #666;">
                        <i class="fas fa-calendar-day"></i> ${formattedExpiry}
                    </div>
                    <div style="font-size: 11px; color: var(--accent); font-weight: 600;">
                        <i class="fas fa-box"></i> ${item.quantity} units
                    </div>
                </div>
            </div>
            <div class="${badgeClass}">
                ${item.daysLeft === 0 ? "TODAY" : `${item.daysLeft}d`}
            </div>
        `;

          // Add click event
          itemElement.addEventListener("click", () => {
            viewProduct(item.product.id);
          });

          // Add keyboard event
          itemElement.addEventListener("keydown", (e) => {
            if (e.key === "Enter" || e.key === " ") {
              e.preventDefault();
              viewProduct(item.product.id);
            }
          });

          expiringList.appendChild(itemElement);
        });

        if (expiringBatches.length === 0) {
          expiringList.innerHTML =
            '<div style="text-align: center; padding: 20px; color: #999;">No items expiring soon</div>';
        }
      }

      // Update low stock list
      function updateLowStockList() {
        const lowStockList = document.getElementById("lowStockList");
        lowStockList.innerHTML = "";

        // Add month names array
        const monthNames = [
          "January",
          "February",
          "March",
          "April",
          "May",
          "June",
          "July",
          "August",
          "September",
          "October",
          "November",
          "December",
        ];

        const lowStockProducts = products
          .filter((product) => {
            const status = calculateProductStatus(product);
            return status.status === "low_stock";
          })
          .slice(0, 5);

        lowStockProducts.forEach((product) => {
          const status = calculateProductStatus(product);

          // Format the earliest expiry date as DD-month name
          let formattedExpiry = "";
          if (status.earliestExpiry) {
            const day = status.earliestExpiry.getDate();
            const month = monthNames[status.earliestExpiry.getMonth()];
            formattedExpiry = `${day} ${month}`;
          }

          const item = document.createElement("div");
          item.className = "stock-alert-item";
          item.tabIndex = 0;
          item.setAttribute("role", "button");
          item.setAttribute(
            "aria-label",
            `View ${product.product_name} with low stock`
          );

          item.innerHTML = `
          <div class="stock-info">
              <div>${product.product_name}</div>
              <div style="font-size: 11px; color: #666;">${product.product_code}</div>
          </div>
          <div class="stock-qty">${status.totalStock}</div>
      `;

          // Add click event
          item.addEventListener("click", () => {
            viewProduct(product.id);
          });

          // Add keyboard event
          item.addEventListener("keydown", (e) => {
            if (e.key === "Enter" || e.key === " ") {
              e.preventDefault();
              viewProduct(product.id);
            }
          });

          lowStockList.appendChild(item);
        });

        if (lowStockProducts.length === 0) {
          lowStockList.innerHTML =
            '<div style="text-align: center; padding: 20px; color: #999;">Stock levels are good</div>';
        }
      }

      // Update no stock list
      function updateNoStockList() {
        const noStockList = document.getElementById("noStockList");
        if (!noStockList) return;

        noStockList.innerHTML = "";

        const noStockProducts = products
          .filter((product) => {
            const status = calculateProductStatus(product);
            return status.status === "out_of_stock";
          })
          .slice(0, 5);

        noStockProducts.forEach((product) => {
          const status = calculateProductStatus(product);

          const item = document.createElement("div");
          item.className = "stock-alert-item";
          item.tabIndex = 0;
          item.setAttribute("role", "button");
          item.setAttribute(
            "aria-label",
            `View ${product.product_name} which is out of stock`
          );

          item.innerHTML = `
      <div class="stock-info">
          <div style="display: flex; align-items: center; gap: 8px;">
              <i class="fas fa-times-circle" style="color: var(--danger);"></i>
              <div>
                  <div style="font-weight: 600;">${product.product_name}</div>
                  <div style="font-size: 11px; color: #666; font-family: monospace;">${product.product_code}</div>
              </div>
          </div>
      </div>
      <div class="stock-qty">${status.totalStock}</div>
    `;

          item.addEventListener("click", () => {
            viewProduct(product.id);
          });

          item.addEventListener("keydown", (e) => {
            if (e.key === "Enter" || e.key === " ") {
              e.preventDefault();
              viewProduct(product.id);
            }
          });

          noStockList.appendChild(item);
        });

        if (noStockProducts.length === 0) {
          noStockList.innerHTML =
            '<div style="text-align: center; padding: 20px; color: #999; font-style: italic;">All products are in stock</div>';
        }
      }

      // Update batch history
      function updateBatchHistory() {
        const batchHistory = document.getElementById("batchHistory");
        batchHistory.innerHTML = "";

        // Month names array for formatting
        const monthNames = [
          "January",
          "February",
          "March",
          "April",
          "May",
          "June",
          "July",
          "August",
          "September",
          "October",
          "November",
          "December",
        ];

        // Get recent batches (last 5)
        const recentBatches = [...batches]
          .sort((a, b) => new Date(b.created_at) - new Date(a.created_at))
          .slice(0, 5);

        recentBatches.forEach((batch) => {
          const product = products.find(
            (p) => p.product_code === batch.product_code
          );
          if (!product) return;

          const item = document.createElement("div");
          item.className = "batch-history-item";
          item.tabIndex = 0;
          item.setAttribute("role", "button");
          item.setAttribute(
            "aria-label",
            `View ${product.product_name} batch details`
          );

          const expiryDate = batch.expiry_date
            ? new Date(batch.expiry_date)
            : null;
          const isExpired = expiryDate && expiryDate < today;

          // Format expiry date as "DD-month name"
          let formattedExpiry = "No expiry";
          let expiryDisplay = "";
          if (expiryDate) {
            const day = expiryDate.getDate();
            const month = monthNames[expiryDate.getMonth()];
            formattedExpiry = `${day} ${month}`;
            expiryDisplay = `
        <div style="font-size: 11px; color: ${
          isExpired ? "var(--danger)" : "#666"
        }; margin-top: 3px;">
          <i class="fas fa-calendar-times" style="margin-right: 5px;"></i>
          Expires: ${formattedExpiry}
        </div>
      `;
          }

          // Format created/manufacture date as "DD-month name"
          const createdDate = new Date(batch.created_at);
          const createdDay = createdDate.getDate();
          const createdMonth = monthNames[createdDate.getMonth()]; // CORRECT
          const formattedCreatedDate = `${createdDay} ${createdMonth}`;

          item.innerHTML = `
      <div>
          <div style="font-weight: 600; font-size: 14px;">${product.product_name}</div>
          <div style="font-size: 11px; color: #666;">
            ${batch.quantity} units
          </div>
      </div>
      <div style="text-align: right;">
          <div style="font-size: 11px; color: #666; margin-top: 3px;">
              <i class="fas fa-calendar-plus" style="margin-right: 5px;"></i>
              Made: ${formattedCreatedDate}
          </div>
          ${expiryDisplay}
      </div>
    `;

          // Add click event
          item.addEventListener("click", () => {
            const product = products.find(
              (p) => p.product_code === batch.product_code
            );
            if (product) {
              viewProduct(product.id);
            }
          });

          // Add keyboard event
          item.addEventListener("keydown", (e) => {
            if (e.key === "Enter" || e.key === " ") {
              e.preventDefault();
              const product = products.find(
                (p) => p.product_code === batch.product_code
              );
              if (product) {
                viewProduct(product.id);
              }
            }
          });

          batchHistory.appendChild(item);
        });

        if (recentBatches.length === 0) {
          batchHistory.innerHTML =
            '<div style="text-align: center; padding: 20px; color: #999;">No batches yet</div>';
        }
      }

      async function viewProduct(productId) {
        const product = products.find((p) => p.id === productId);
        if (!product) return;

        const productBatches = batches.filter(
          (b) => b.product_code === product.product_code
        );
        const status = calculateProductStatus(product);

        // Month names array
        const monthNames = [
          "January",
          "February",
          "March",
          "April",
          "May",
          "June",
          "July",
          "August",
          "September",
          "October",
          "November",
          "December",
        ];

        // Format expiry date in detail view
        let formattedEarliestExpiry = "";
        if (status.earliestExpiry) {
          const day = status.earliestExpiry.getDate();
          const month = monthNames[status.earliestExpiry.getMonth()];
          const year = status.earliestExpiry.getFullYear();
          formattedEarliestExpiry = `${day}-${month}-${year}`;
        }

        let batchesHTML = "";
        if (productBatches.length > 0) {
          batchesHTML = `
      <h4 style="color: var(--primary); margin: 20px 0 10px 0;">
          <i class="fas fa-layer-group"></i> Batches (${productBatches.length})
      </h4>
      <div style="max-height: 300px; overflow-y: auto;">
          <table style="width: 100%; border-collapse: collapse;">
              <thead>
                  <tr style="background-color: #f8f9fa;">
                      <th style="padding: 8px; text-align: left;">Batch ID</th>
                      <th style="padding: 8px; text-align: left;">Quantity</th>
                      <th style="padding: 8px; text-align: left;">Expiry</th>
                      <th style="padding: 8px; text-align: left;">Status</th>
                  </tr>
              </thead>
              <tbody>
                  ${productBatches
                    .map((batch) => {
                      const expiryDate = batch.expiry_date
                        ? new Date(batch.expiry_date)
                        : null;
                      const isExpired = expiryDate && expiryDate < today;
                      const diffDays = expiryDate
                        ? Math.ceil(
                            (expiryDate - today) / (1000 * 60 * 60 * 24)
                          )
                        : null;

                      let statusText = "Active";
                      let statusColor = "var(--success)";
                      if (isExpired) {
                        statusText = "Expired";
                        statusColor = "var(--danger)";
                      } else if (diffDays && diffDays <= 3) {
                        statusText = `${diffDays}d left`;
                        statusColor = "var(--warning)";
                      }

                      // Format batch expiry date
                      let formattedBatchExpiry = "N/A";
                      if (expiryDate) {
                        const day = expiryDate.getDate();
                        const month = monthNames[expiryDate.getMonth()];
                        const year = expiryDate.getFullYear();
                        formattedBatchExpiry = `${day}-${month}-${year}`;
                      }

                      return `
                          <tr style="border-bottom: 1px solid #eee;">
                              <td style="padding: 8px; font-family: monospace;">${batch.id.substring(
                                0,
                                8
                              )}</td>
                              <td style="padding: 8px;">${
                                batch.remaining_quantity || 0
                              }/${batch.quantity}</td>
                              <td style="padding: 8px;">${formattedBatchExpiry}</td>
                              <td style="padding: 8px; color: ${statusColor}; font-weight: 600;">${statusText}</td>
                          </tr>
                      `;
                    })
                    .join("")}
              </tbody>
          </table>
      </div>
  `;
        }

        document.getElementById(
          "detailTitle"
        ).innerHTML = `<i class="fas fa-info-circle"></i> ${product.product_name}`;
        document.getElementById("detailContent").innerHTML = `
  <div style="display: grid; gap: 15px;">
      <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
          <div>
              <label style="font-size: 12px; color: #666;">Product Code</label>
              <div style="font-weight: 600;">${product.product_code}</div>
          </div>
          <div>
              <label style="font-size: 12px; color: #666;">Category</label>
              <div style="font-weight: 600;">${product.category}</div>
          </div>
      </div>
      
      <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
          <div>
              <label style="font-size: 12px; color: #666;">Current Stock</label>
              <div style="font-weight: 700; font-size: 24px; color: ${
                status.totalStock <= 5 ? "var(--danger)" : "var(--success)"
              }">
                  ${status.totalStock} units
              </div>
          </div>
          <div>
              <label style="font-size: 12px; color: #666;">Unit Price</label>
              <div style="font-weight: 700; font-size: 24px; color: var(--accent);">
                  â‚¹${parseFloat(product.unit_price).toFixed(2)}
              </div>
          </div>
      </div>
      
      <div>
          <label style="font-size: 12px; color: #666;">Shelf Life</label>
          <div style="font-weight: 600;">${
            product.shelf_life_days || 7
          } days</div>
      </div>
      
      ${
        formattedEarliestExpiry
          ? `
          <div>
              <label style="font-size: 12px; color: #666;">Earliest Expiry</label>
              <div style="font-weight: 600; color: ${
                status.status === "expiring_soon"
                  ? "var(--warning)"
                  : "var(--success)"
              }">
                  ${formattedEarliestExpiry}
              </div>
          </div>
      `
          : ""
      }
      
      ${batchesHTML}
      
      <div style="margin-top: 20px; display: flex; gap: 10px;">
          <button type="button" class="btn btn-success" onclick="addBatchForProduct('${
            product.id
          }')" tabindex="0">
              <i class="fas fa-plus-circle"></i> Add Batch
          </button>
          <button type="button" class="btn" onclick="closeDetailModal()" style="background-color: #f0f0f0;" tabindex="0">
              Close
          </button>
      </div>
  </div>
`;

        document.getElementById("detailModal").style.display = "flex";
        setupModalKeyboardNavigation("detailModal");
      }

      // Add batch for specific product
      function addBatchForProduct(productId) {
        const product = products.find((p) => p.id === productId);
        if (!product) return;

        addBatchModal();

        // Auto-select the product
        setTimeout(() => {
          const dropdownInput = document.getElementById("batchProductInput");
          const hiddenInput = document.getElementById("batchProduct");
          const batchPriceInput = document.getElementById("batchPrice");
          const batchShelfLifeInput = document.getElementById("batchShelfLife");

          if (dropdownInput && hiddenInput) {
            dropdownInput.value = `${product.product_code} - ${product.product_name}`;
            hiddenInput.value = product.id;

            if (batchPriceInput) {
              batchPriceInput.value = parseFloat(product.unit_price).toFixed(2);
            }

            if (batchShelfLifeInput) {
              batchShelfLifeInput.value = product.shelf_life_days || 7;
            }

            // Focus on quantity field (NOT expiry date)
            document.getElementById("batchQuantity")?.focus();
          }
        }, 200);
      }

      function addProductModal() {
        document.getElementById("productModalTitle").innerHTML =
          '<i class="fas fa-plus"></i> Add New Product';
        document.getElementById("productForm").reset();
        document.getElementById("productModal").style.display = "flex";

        // Clear and disable product code field initially
        const productCodeInput = document.getElementById("productCode");
        productCodeInput.value = "";

        setupModalKeyboardNavigation("productModal");

        // Focus on product name field
        setTimeout(() => {
          const productNameInput = document.getElementById("productName");
          if (productNameInput) {
            productNameInput.focus();
            productNameInput.select();
          }
        }, 100);
      }

      function editProduct(productId) {
        const product = products.find((p) => p.id === productId);
        if (!product) return;

        document.getElementById("productModalTitle").innerHTML =
          '<i class="fas fa-edit"></i> Edit Product';
        document.getElementById("productCode").value = product.product_code;
        document.getElementById("productName").value = product.product_name;
        document.getElementById("productCategory").value = product.category;
        document.getElementById("productPrice").value = product.unit_price;
        document.getElementById("shelfLifeDays").value =
          product.shelf_life_days || 7;

        // Make code editable when editing
        const productCodeInput = document.getElementById("productCode");
        productCodeInput.readOnly = false;
        productCodeInput.style.backgroundColor = "white";
        productCodeInput.style.cursor = "text";
        productCodeInput.style.color = "var(--dark)";

        document.getElementById("productModal").style.display = "flex";
        setupModalKeyboardNavigation("productModal");
      }

      // Save product
      async function saveProduct(e) {
        e.preventDefault();

        const productData = {
          product_code: document.getElementById("productCode").value,
          product_name: document.getElementById("productName").value,
          category: document.getElementById("productCategory").value,
          unit_price: parseFloat(document.getElementById("productPrice").value),
          shelf_life_days: parseInt(
            document.getElementById("shelfLifeDays").value
          ),
          is_active: true,
          updated_at: new Date().toISOString(),
        };

        // Validate required fields
        if (
          !productData.product_name ||
          productData.product_name.trim() === ""
        ) {
          showNotification("Please enter a product name", "error");
          return;
        }

        if (
          !productData.product_code ||
          productData.product_code.trim() === ""
        ) {
          showNotification(
            "Please select a category to generate product code",
            "error"
          );
          return;
        }

        // Validate generated code
        if (!productData.product_code) {
          showNotification(
            "Please fill in product name and category to generate code",
            "error"
          );
          return;
        }

        try {
          // Check if product exists
          const existingProduct = products.find(
            (p) => p.product_code === productData.product_code
          );

          if (existingProduct) {
            // Update existing product
            const { error } = await supabase
              .from("products")
              .update(productData)
              .eq("id", existingProduct.id);

            if (error) throw error;
            showNotification("Product updated successfully", "success");
          } else {
            // Create new product
            productData.created_at = new Date().toISOString();

            const { error } = await supabase
              .from("products")
              .insert([productData]);

            if (error) throw error;
            showNotification("Product added successfully", "success");
          }

          // Close modal and reload
          closeProductModal();
          await loadInventoryData();
        } catch (error) {
          console.error("Error saving product:", error);
          showNotification("Failed to save product", "error");
        }
      }

      // Delete product
      async function deleteProduct(productId) {
        if (
          !confirm(
            "Are you sure you want to delete this product? This will also delete all associated batches."
          )
        ) {
          return;
        }

        try {
          // First delete batches
          const product = products.find((p) => p.id === productId);
          if (product) {
            await supabase
              .from("product_batches")
              .delete()
              .eq("product_code", product.product_code);
          }

          // Then delete product
          const { error } = await supabase
            .from("products")
            .delete()
            .eq("id", productId);

          if (error) throw error;

          showNotification("Product deleted successfully", "success");
          await loadInventoryData();
        } catch (error) {
          console.error("Error deleting product:", error);
          showNotification("Failed to delete product", "error");
        }
      }

      async function addBatchModal() {
        const dropdownOptions = document.getElementById("batchProductOptions");

        // Clear existing options
        dropdownOptions.innerHTML = "";

        // Add all products as options
        products.forEach((product) => {
          const status = calculateProductStatus(product);

          const option = document.createElement("div");
          option.className = "searchable-dropdown-option";
          option.dataset.value = product.id;
          option.dataset.price = product.unit_price;
          option.dataset.code = product.product_code;
          option.dataset.name = product.product_name;
          option.dataset.shelfLife = product.shelf_life_days || 7;

          option.innerHTML = `
      <div class="product-info">
          <span class="product-code">${product.product_code}</span>
          <span class="product-name">${product.product_name}</span>
          <span class="product-stock">Stock: ${status.totalStock} units</span>
      </div>
      <div class="product-price">â‚¹${parseFloat(product.unit_price).toFixed(
        2
      )}</div>
  `;

          dropdownOptions.appendChild(option);
        });

        // Reset all fields
        document.getElementById("batchQuantity").value = "1";
        document.getElementById("batchPrice").value = "";
        document.getElementById("batchShelfLife").value = "";
        document.getElementById("batchProductInput").value = "";
        document.getElementById("batchProduct").value = "";

        // Set today's date as manufacture date
        const todayStr = today.toISOString().split("T")[0];
        document.getElementById("batchManufactureDate").value = todayStr;

        document.getElementById("batchModal").style.display = "flex";
        setupModalKeyboardNavigation("batchModal");

        // Focus on the main input field
        setTimeout(() => {
          document.getElementById("batchProductInput").focus();
          document.getElementById("batchProductInput").select();
        }, 100);
      }

      // Calculate expiry date
      function calculateExpiryDate(manufactureDate, shelfLifeDays) {
        const date = new Date(manufactureDate);
        date.setDate(date.getDate() + parseInt(shelfLifeDays));
        return date.toISOString().split("T")[0];
      }

      function initSearchableDropdown() {
        const dropdown = document.getElementById("batchProductDropdown");
        const dropdownInput = document.getElementById("batchProductInput");
        const dropdownToggle = document.getElementById("batchProductToggle");
        const dropdownOptions = document.getElementById("batchProductOptions");
        const hiddenInput = document.getElementById("batchProduct");
        const batchPriceInput = document.getElementById("batchPrice");
        const batchShelfLifeInput = document.getElementById("batchShelfLife");
        const batchManufactureDateInput = document.getElementById(
          "batchManufactureDate"
        );

        let filteredOptions = [];
        let selectedIndex = -1;

        // Close dropdown when clicking outside
        document.addEventListener("click", function (event) {
          if (!dropdown.contains(event.target)) {
            closeDropdown();
          }
        });

        // Toggle dropdown
        dropdownToggle.addEventListener("click", function (e) {
          e.stopPropagation();
          if (dropdownOptions.classList.contains("active")) {
            closeDropdown();
          } else {
            openDropdown();
          }
        });

        // Show dropdown when clicking input
        dropdownInput.addEventListener("click", function (e) {
          e.stopPropagation();
          openDropdown();
        });

        // Filter options based on input
        dropdownInput.addEventListener("input", function () {
          const searchTerm = this.value.toLowerCase();
          const options = dropdownOptions.querySelectorAll(
            ".searchable-dropdown-option"
          );

          // Reset selected index
          selectedIndex = -1;

          // Filter options
          filteredOptions = [];
          options.forEach((option, index) => {
            const productCode = option.dataset.code?.toLowerCase() || "";
            const productName = option.dataset.name?.toLowerCase() || "";

            if (
              productCode.includes(searchTerm) ||
              productName.includes(searchTerm)
            ) {
              option.style.display = "flex";
              filteredOptions.push({ option, index });
            } else {
              option.style.display = "none";
            }
          });

          // Auto-select first option if there are results
          if (filteredOptions.length > 0) {
            selectedIndex = 0;
            clearSelection();
            filteredOptions[0].option.classList.add("selected");
          }
        });

        // Select option on click
        dropdownOptions.addEventListener("click", function (event) {
          const option = event.target.closest(".searchable-dropdown-option");
          if (!option || option.style.display === "none") return;

          selectOption(option);
        });

        // Keyboard navigation
        dropdownInput.addEventListener("keydown", function (event) {
          if (!dropdownOptions.classList.contains("active")) {
            if (event.key === "ArrowDown" || event.key === "Enter") {
              event.preventDefault();
              openDropdown();
            }
            return;
          }

          switch (event.key) {
            case "ArrowDown":
              event.preventDefault();
              if (filteredOptions.length > 0) {
                selectedIndex = (selectedIndex + 1) % filteredOptions.length;
                updateSelection();
              }
              break;

            case "ArrowUp":
              event.preventDefault();
              if (filteredOptions.length > 0) {
                selectedIndex =
                  selectedIndex <= 0
                    ? filteredOptions.length - 1
                    : selectedIndex - 1;
                updateSelection();
              }
              break;

            case "Enter":
              event.preventDefault();
              if (selectedIndex >= 0 && filteredOptions[selectedIndex]) {
                selectOption(filteredOptions[selectedIndex].option);
              } else if (filteredOptions.length === 1) {
                // If only one option matches, select it
                selectOption(filteredOptions[0].option);
              }
              break;

            case "Escape":
              event.preventDefault();
              closeDropdown();
              break;

            case "Tab":
              closeDropdown();
              break;
          }
        });

        // Helper functions
        function openDropdown() {
          dropdownOptions.classList.add("active");
          // Show all options initially
          const options = dropdownOptions.querySelectorAll(
            ".searchable-dropdown-option"
          );
          options.forEach((option) => (option.style.display = "flex"));
          filteredOptions = Array.from(options).map((option, index) => ({
            option,
            index,
          }));

          // Select first option if exists
          if (filteredOptions.length > 0) {
            selectedIndex = 0;
            clearSelection();
            filteredOptions[0].option.classList.add("selected");
          }
        }

        function closeDropdown() {
          dropdownOptions.classList.remove("active");
          selectedIndex = -1;
        }

        function clearSelection() {
          const selected = dropdownOptions.querySelector(
            ".searchable-dropdown-option.selected"
          );
          if (selected) {
            selected.classList.remove("selected");
          }
        }

        function updateSelection() {
          clearSelection();
          if (selectedIndex >= 0 && filteredOptions[selectedIndex]) {
            const option = filteredOptions[selectedIndex].option;
            option.classList.add("selected");
            option.scrollIntoView({ block: "nearest" });
          }
        }

        function selectOption(option) {
          const productId = option.dataset.value;
          const product = products.find((p) => p.id === productId);

          if (!product) return;

          // Update input field
          dropdownInput.value = `${product.product_code} - ${product.product_name}`;
          hiddenInput.value = productId;

          // Auto-fill price
          if (batchPriceInput) {
            batchPriceInput.value = parseFloat(product.unit_price).toFixed(2);
          }

          // Auto-fill shelf life
          if (batchShelfLifeInput) {
            batchShelfLifeInput.value = product.shelf_life_days || 7;
          }

          closeDropdown();

          // Focus on next field
          setTimeout(() => {
            document.getElementById("batchQuantity")?.focus();
            document.getElementById("batchQuantity")?.select();
          }, 50);
        }

        // Auto-calculate expiry when dates change
        [batchManufactureDateInput, batchShelfLifeInput].forEach((input) => {
          if (input) {
            input.addEventListener("change", function () {
              const productId = hiddenInput.value;
              const product = products.find((p) => p.id === productId);

              if (
                product &&
                batchManufactureDateInput.value &&
                batchShelfLifeInput.value
              ) {
                const expiryDate = calculateExpiryDate(
                  batchManufactureDateInput.value,
                  batchShelfLifeInput.value
                );

                if (batchExpiryDateInput) {
                  batchExpiryDateInput.value = expiryDate;
                }

                if (expiryInfo) {
                  expiryInfo.innerHTML = `
                      <i class="fas fa-calendar-check"></i> 
                      Expiry: ${new Date(expiryDate).toLocaleDateString()} 
                      (${batchShelfLifeInput.value} days from manufacture)
                  `;
                }
              }
            });
          }
        });
      }

      // Show all out of stock products in a modal
      function showAllOutOfStock() {
        const outOfStockProducts = products.filter((product) => {
          const status = calculateProductStatus(product);
          return status.status === "out_of_stock";
        });

        if (outOfStockProducts.length === 0) {
          showNotification("No out of stock products", "info");
          return;
        }

        // Month names for formatting
        const monthNames = [
          "January",
          "February",
          "March",
          "April",
          "May",
          "June",
          "July",
          "August",
          "September",
          "October",
          "November",
          "December",
        ];

        // Create modal content
        let modalContent = `
    <div class="modal-header">
      <h3><i class="fas fa-times-circle"></i> All Out of Stock Products (${outOfStockProducts.length})</h3>
      <button type="button" class="close-modal" onclick="closeOutOfStockModal()">
        <i class="fas fa-times"></i>
      </button>
    </div>
    <div style="max-height: 70vh; overflow-y: auto; padding: 10px;">
      <table style="width: 100%; border-collapse: collapse;">
        <thead>
          <tr style="background-color: #f8f9fa; position: sticky; top: 0;">
            <th style="padding: 12px; text-align: left; border-bottom: 2px solid #eee;">Product</th>
            <th style="padding: 12px; text-align: left; border-bottom: 2px solid #eee;">Category</th>
            <th style="padding: 12px; text-align: left; border-bottom: 2px solid #eee;">Code</th>
            <th style="padding: 12px; text-align: left; border-bottom: 2px solid #eee;">Price</th>
            <th style="padding: 12px; text-align: left; border-bottom: 2px solid #eee;">Stock</th>
            <th style="padding: 12px; text-align: left; border-bottom: 2px solid #eee;">Action</th>
          </tr>
        </thead>
        <tbody>
  `;

        outOfStockProducts.forEach((product) => {
          const status = calculateProductStatus(product);

          modalContent += `
      <tr style="border-bottom: 1px solid #eee; background-color: #fff5f5;">
        <td style="padding: 12px;">
          <div style="font-weight: 600;">${product.product_name}</div>
        </td>
        <td style="padding: 12px;">
          <span style="background-color: #f0f0f0; padding: 4px 8px; border-radius: 4px; font-size: 12px;">
            ${product.category}
          </span>
        </td>
        <td style="padding: 12px; font-family: monospace; color: var(--accent);">
          ${product.product_code}
        </td>
        <td style="padding: 12px; font-weight: 600; color: var(--accent);">
          â‚¹${parseFloat(product.unit_price).toFixed(2)}
        </td>
        <td style="padding: 12px;">
          <div style="font-weight: 800; color: var(--danger); font-size: 18px; text-align: center;">
            ${status.totalStock}
          </div>
        </td>
        <td style="padding: 12px;">
          <button class="btn btn-success" style="padding: 8px 12px; font-size: 12px;" 
                  onclick="addBatchForProduct('${
                    product.id
                  }'); closeOutOfStockModal();">
            <i class="fas fa-plus-circle"></i> Add Batch
          </button>
        </td>
      </tr>
    `;
        });

        modalContent += `
        </tbody>
      </table>
      
      <div style="margin-top: 20px; display: flex; gap: 10px; justify-content: center;">
        <button type="button" class="btn" onclick="closeOutOfStockModal()" style="background-color: #f0f0f0;">
          <i class="fas fa-times"></i> Close
        </button>
      </div>
    </div>
  `;

        // Create and show modal
        const modal = document.createElement("div");
        modal.className = "modal";
        modal.id = "outOfStockModal";
        modal.innerHTML = `
    <div class="modal-content" style="max-width: 900px;">
      ${modalContent}
    </div>
  `;

        document.body.appendChild(modal);
        modal.style.display = "flex";

        // Setup keyboard navigation for the modal
        setupModalKeyboardNavigation("outOfStockModal");
      }

      // Close the out of stock modal
      function closeOutOfStockModal() {
        const modal = document.getElementById("outOfStockModal");
        if (modal) {
          modal.style.display = "none";
          setTimeout(() => modal.remove(), 300);
          isModalOpen = false;
          updateFocusableElements();
          setFocus(0);
        }
      }
      // Save batch
      async function saveBatch(e) {
        e.preventDefault();

        const productId = document.getElementById("batchProduct").value;
        const product = products.find((p) => p.id === productId);
        if (!product) {
          showNotification("Please select a product", "error");
          return;
        }

        const quantity = parseInt(
          document.getElementById("batchQuantity").value
        );
        if (!quantity || quantity <= 0) {
          showNotification("Please enter a valid quantity", "error");
          return;
        }

        const unitCost = parseFloat(
          document.getElementById("batchPrice").value
        );
        if (!unitCost || unitCost <= 0) {
          showNotification("Please enter a valid cost per unit", "error");
          return;
        }

        const shelfLifeDays = parseInt(
          document.getElementById("batchShelfLife").value
        );
        if (!shelfLifeDays || shelfLifeDays <= 0) {
          showNotification("Please enter a valid shelf life", "error");
          return;
        }

        const manufactureDate = document.getElementById(
          "batchManufactureDate"
        ).value;
        if (!manufactureDate) {
          showNotification("Please select a manufacture date", "error");
          return;
        }

        // Calculate expiry date internally (not shown to user)
        const expiryDate = calculateExpiryDate(manufactureDate, shelfLifeDays);

        const batchData = {
          product_code: product.product_code,
          quantity: quantity,
          remaining_quantity: quantity,
          unit_cost: unitCost,
          manufacture_date: manufactureDate,
          expiry_date: expiryDate, // Now calculated internally
          shelf_life_days: shelfLifeDays,
          created_at: new Date().toISOString(),
        };

        // Validate dates (manufacture date should not be in future)
        const manufactureDateObj = new Date(batchData.manufacture_date);
        manufactureDateObj.setHours(0, 0, 0, 0); // Normalize manufacture date to start of day

        const todayDate = new Date();
        todayDate.setHours(0, 0, 0, 0); // Normalize today's date to start of day

        if (manufactureDateObj > todayDate) {
          showNotification("Manufacture date cannot be in the future", "error");
          return;
        }

        try {
          const { error } = await supabase
            .from("product_batches")
            .insert([batchData]);

          if (error) throw error;

          showNotification(
            `Batch added successfully! ${batchData.quantity} units of ${
              product.product_name
            } at â‚¹${unitCost.toFixed(2)} each`,
            "success"
          );

          // Close modal and reload data
          closeBatchModal();
          await loadInventoryData();
        } catch (error) {
          console.error("Error saving batch:", error);
          showNotification("Failed to add batch", "error");
        }
      }

      // Update dates (shelf life calculation)
      function updateDatesModal() {
        today = new Date();
        document.getElementById("currentDate").textContent =
          today.toLocaleDateString();
        document.getElementById("datesModal").style.display = "flex";
        setupModalKeyboardNavigation("datesModal");
      }

      // Confirm date update
      async function confirmUpdateDates() {
        showNotification("Shelf life updated for today", "success");
        await loadInventoryData();
        closeDatesModal();
      }

      // Export inventory
      async function exportInventory() {
        let csvContent = "data:text/csv;charset=utf-8,";
        csvContent +=
          "Product Code,Product Name,Category,Stock,Price,Shelf Life (Days),Status,Expiry Date\n";

        products.forEach((product) => {
          const status = calculateProductStatus(product);
          const expiryDate = status.earliestExpiry
            ? status.earliestExpiry.toLocaleDateString()
            : "";

          csvContent +=
            [
              product.product_code,
              `"${product.product_name}"`,
              product.category,
              status.totalStock,
              product.unit_price,
              product.shelf_life_days || 7,
              status.status,
              expiryDate,
            ].join(",") + "\n";
        });

        const encodedUri = encodeURI(csvContent);
        const link = document.createElement("a");
        link.setAttribute("href", encodedUri);
        link.setAttribute(
          "download",
          `inventory_${today.toISOString().split("T")[0]}.csv`
        );
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);

        showNotification("Inventory exported to CSV", "success");
      }

      // Close modals
      function closeProductModal() {
        document.getElementById("productModal").style.display = "none";
        isModalOpen = false;
        updateFocusableElements();
        setFocus(0);
      }

      function closeBatchModal() {
        document.getElementById("batchModal").style.display = "none";
        isModalOpen = false;
        updateFocusableElements();
        setFocus(0);
      }

      function closeDatesModal() {
        document.getElementById("datesModal").style.display = "none";
        isModalOpen = false;
        updateFocusableElements();
        setFocus(0);
      }

      function closeDetailModal() {
        document.getElementById("detailModal").style.display = "none";
        isModalOpen = false;
        updateFocusableElements();
        setFocus(0);
      }

      // Show notification
      function showNotification(message, type = "success") {
        const notification = document.createElement("div");
        notification.className = `notification ${type}`;
        notification.innerHTML = `
      <i class="fas fa-${
        type === "success"
          ? "check-circle"
          : type === "error"
          ? "exclamation-circle"
          : "info-circle"
      }"></i>
      <span>${message}</span>
  `;

        document.body.appendChild(notification);

        setTimeout(() => {
          notification.classList.add("show");
        }, 10);

        setTimeout(() => {
          notification.classList.remove("show");
          setTimeout(() => notification.remove(), 300);
        }, 3000);
      }

      // Add this to applyFilters function
      function highlightActiveFilters() {
        const filters = ["filterCategory", "filterStockStatus", "filterSearch"];

        filters.forEach((filterId) => {
          const element = document.getElementById(filterId);
          if (element.value) {
            element.classList.add("active-filter");
          } else {
            element.classList.remove("active-filter");
          }
        });
      }

      // Initialize the application
      document.addEventListener("DOMContentLoaded", async function () {
        await initSupabase();

        // Initialize searchable dropdown
        initSearchableDropdown();

        // Initialize filters
        initializeFilters();

        // Event listeners with keyboard accessibility
        document
          .getElementById("addProductBtn")
          .addEventListener("click", addProductModal);
        document
          .getElementById("addBatchBtn")
          .addEventListener("click", addBatchModal);
        document
          .getElementById("updateDatesBtn")
          .addEventListener("click", updateDatesModal);
        document
          .getElementById("exportBtn")
          .addEventListener("click", exportInventory);

        document
          .getElementById("productForm")
          .addEventListener("submit", saveProduct);
        document
          .getElementById("batchForm")
          .addEventListener("submit", saveBatch);

        document
          .getElementById("closeProductModal")
          .addEventListener("click", closeProductModal);
        document
          .getElementById("cancelProductBtn")
          .addEventListener("click", closeProductModal);

        document
          .getElementById("closeBatchModal")
          .addEventListener("click", closeBatchModal);
        document
          .getElementById("cancelBatchBtn")
          .addEventListener("click", closeBatchModal);

        document
          .getElementById("closeDatesModal")
          .addEventListener("click", closeDatesModal);
        document
          .getElementById("cancelDatesBtn")
          .addEventListener("click", closeDatesModal);
        document
          .getElementById("confirmUpdateDates")
          .addEventListener("click", confirmUpdateDates);

        document
          .getElementById("closeDetailModal")
          .addEventListener("click", closeDetailModal);
        // Add event listeners for auto-generating product code
        document
          .getElementById("productName")
          .addEventListener("input", updateProductCode);
        document
          .getElementById("productCategory")
          .addEventListener("change", updateProductCode);
        // Set today's date
        today = new Date();

        // Show welcome message with keyboard tips
        setTimeout(() => {
          showNotification(
            "Press F1 for keyboard shortcuts. Use Tab to navigate, Enter to activate.",
            "info"
          );
        }, 1500);

        // Call this when switching back to inventory page
        window.addEventListener("focus", async function () {
          await loadInventoryData();
        });
      });
    </script>
  </body>
</html>
