<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Cake Bliss | Inventory Management System</title>
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    />
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
      /* ==================== BASE STYLES ==================== */
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
      }

      :root {
        --primary: #ff7bac;
        --secondary: #ffb347;
        --accent: #9d4edd;
        --light: #fff9fb;
        --dark: #333333;
        --success: #4caf50;
        --warning: #ff9800;
        --danger: #f44336;
        --info: #2196f3;
        --gray: #6c757d;
        --gray-light: #e9ecef;
      }

      body {
        background: linear-gradient(135deg, #ffecd2 0%, #fcb69f 100%);
        color: var(--dark);
        min-height: 100vh;
        padding: 10px;
      }

      .container {
        max-width: 1400px;
        margin: 0 auto;
        width: 100%;
      }

      /* ==================== HEADER ==================== */
      header {
        background-color: white;
        border-radius: 15px;
        padding: 15px 20px;
        margin-bottom: 20px;
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.08);
        display: flex;
        flex-direction: column;
        gap: 15px;
      }

      @media (min-width: 768px) {
        header {
          flex-direction: row;
          justify-content: space-between;
          align-items: center;
          padding: 20px 30px;
          border-radius: 20px;
        }
      }

      .logo-container {
        display: flex;
        align-items: center;
        gap: 12px;
      }

      .logo {
        width: 50px;
        height: 50px;
        background: linear-gradient(45deg, var(--primary), var(--secondary));
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-size: 24px;
        flex-shrink: 0;
      }

      @media (min-width: 768px) {
        .logo {
          width: 60px;
          height: 60px;
          font-size: 28px;
        }
      }

      .logo-text h1 {
        color: var(--primary);
        font-size: 22px;
        font-weight: 800;
        line-height: 1.2;
      }

      @media (min-width: 768px) {
        .logo-text h1 {
          font-size: 28px;
        }
      }

      .logo-text p {
        color: var(--dark);
        font-size: 12px;
        opacity: 0.8;
        margin-top: 2px;
      }

      @media (min-width: 768px) {
        .logo-text p {
          font-size: 14px;
        }
      }

      /* Database Status */
      .db-status {
        display: inline-flex;
        align-items: center;
        gap: 6px;
        padding: 4px 10px;
        border-radius: 50px;
        font-size: 12px;
        font-weight: 600;
        margin-top: 8px;
      }

      @media (min-width: 768px) {
        .db-status {
          margin-top: 10px;
          font-size: 14px;
        }
      }

      .db-status.connected {
        background-color: rgba(76, 175, 80, 0.1);
        color: var(--success);
      }

      .db-status.disconnected {
        background-color: rgba(244, 67, 54, 0.1);
        color: var(--danger);
      }

      .status-dot {
        width: 8px;
        height: 8px;
        border-radius: 50%;
      }

      @media (min-width: 768px) {
        .status-dot {
          width: 10px;
          height: 10px;
        }
      }

      .status-dot.connected {
        background-color: var(--success);
        animation: pulse 2s infinite;
      }

      .status-dot.disconnected {
        background-color: var(--danger);
      }

      /* Navigation */
      nav {
        width: 100%;
      }

      nav ul {
        display: flex;
        list-style: none;
        gap: 10px;
        flex-wrap: wrap;
        justify-content: center;
      }

      @media (min-width: 768px) {
        nav ul {
          gap: 20px;
          justify-content: flex-end;
        }
      }

      nav a {
        text-decoration: none;
        color: var(--dark);
        font-weight: 600;
        font-size: 14px;
        padding: 8px 12px;
        border-radius: 50px;
        transition: all 0.3s ease;
        display: flex;
        align-items: center;
        gap: 5px;
        white-space: nowrap;
      }

      @media (min-width: 768px) {
        nav a {
          font-size: 16px;
          padding: 8px 15px;
        }
      }

      nav a:hover,
      nav a.active {
        background-color: var(--primary);
        color: white;
      }

      /* ==================== DASHBOARD STATS ==================== */
      .dashboard-stats {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 15px;
        margin-bottom: 20px;
      }

      @media (min-width: 640px) {
        .dashboard-stats {
          grid-template-columns: repeat(3, 1fr);
        }
      }

      @media (min-width: 1024px) {
        .dashboard-stats {
          grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
          gap: 20px;
          margin-bottom: 30px;
        }
      }

      .stat-card {
        background: white;
        border-radius: 12px;
        padding: 15px;
        box-shadow: 0 3px 10px rgba(0, 0, 0, 0.05);
        display: flex;
        align-items: center;
        gap: 15px;
        transition: all 0.3s ease;
        cursor: pointer;
        min-height: 90px;
      }

      @media (min-width: 768px) {
        .stat-card {
          padding: 20px;
          border-radius: 15px;
          min-height: 100px;
        }
      }

      .stat-card:hover {
        transform: translateY(-3px);
        box-shadow: 0 8px 20px rgba(0, 0, 0, 0.1);
      }

      .stat-icon {
        width: 45px;
        height: 45px;
        border-radius: 10px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 20px;
        color: white;
        flex-shrink: 0;
      }

      @media (min-width: 768px) {
        .stat-icon {
          width: 60px;
          height: 60px;
          font-size: 24px;
          border-radius: 12px;
        }
      }

      .stat-content h3 {
        font-size: 12px;
        color: #666;
        margin-bottom: 5px;
      }

      @media (min-width: 768px) {
        .stat-content h3 {
          font-size: 14px;
        }
      }

      .stat-value {
        font-size: 22px;
        font-weight: 700;
        color: var(--dark);
        line-height: 1;
      }

      @media (min-width: 768px) {
        .stat-value {
          font-size: 28px;
        }
      }

      /* ==================== MAIN CONTENT ==================== */
      .main-content {
        display: flex;
        flex-direction: column;
        gap: 20px;
      }

      @media (min-width: 1024px) {
        .main-content {
          flex-direction: row;
          gap: 30px;
        }
      }

      /* ==================== INVENTORY CARD ==================== */
      .inventory-card {
        background-color: white;
        border-radius: 15px;
        padding: 20px;
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.08);
        flex: 2;
        width: 100%;
      }

      @media (min-width: 1024px) {
        .inventory-card {
          border-radius: 20px;
          padding: 30px;
        }
      }

      .inventory-header {
        display: flex;
        flex-direction: column;
        gap: 15px;
        margin-bottom: 20px;
      }

      @media (min-width: 768px) {
        .inventory-header {
          flex-direction: row;
          justify-content: space-between;
          align-items: center;
          gap: 20px;
          margin-bottom: 25px;
        }
      }

      .inventory-header h2 {
        color: var(--primary);
        font-size: 20px;
        display: flex;
        align-items: center;
        gap: 10px;
      }

      @media (min-width: 768px) {
        .inventory-header h2 {
          font-size: 26px;
        }
      }

      .header-actions {
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
      }

      @media (min-width: 768px) {
        .header-actions {
          gap: 10px;
        }
      }

      /* ==================== FILTERS SECTION ==================== */
      .filters-section {
        background-color: #f8f9fa;
        border-radius: 12px;
        padding: 15px;
        margin-bottom: 20px;
        border: 1px solid #e9ecef;
      }

      @media (min-width: 768px) {
        .filters-section {
          padding: 20px;
        }
      }

      .filters-header {
        display: flex;
        flex-direction: column;
        gap: 10px;
        margin-bottom: 15px;
      }

      @media (min-width: 640px) {
        .filters-header {
          flex-direction: row;
          justify-content: space-between;
          align-items: center;
        }
      }

      .filters-header h3 {
        color: var(--primary);
        font-size: 16px;
        display: flex;
        align-items: center;
        gap: 8px;
        margin: 0;
      }

      .filter-row {
        display: flex;
        flex-direction: column;
        gap: 15px;
      }

      @media (min-width: 768px) {
        .filter-row {
          flex-direction: row;
          flex-wrap: wrap;
          align-items: center;
          gap: 15px;
        }
      }

      .filter-group {
        display: flex;
        flex-direction: column;
        gap: 8px;
        width: 100%;
      }

      @media (min-width: 768px) {
        .filter-group {
          flex-direction: row;
          align-items: center;
          width: auto;
        }
      }

      .filter-group label {
        font-weight: 600;
        font-size: 13px;
        color: #555;
        min-width: 100px;
      }

      .filter-group select,
      .filter-group input {
        padding: 10px 12px;
        border: 2px solid #ddd;
        border-radius: 8px;
        font-size: 14px;
        width: 100%;
      }

      @media (min-width: 768px) {
        .filter-group select {
          min-width: 150px;
        }
        
        .filter-group input {
          min-width: 200px;
        }
      }

      #applyFiltersBtn,
      #clearFiltersBtn {
        padding: 10px 16px;
        font-size: 14px;
        width: 100%;
        margin-top: 5px;
      }

      @media (min-width: 768px) {
        #applyFiltersBtn,
        #clearFiltersBtn {
          width: auto;
          margin-top: 0;
        }
      }

      /* ==================== TABLE STYLES ==================== */
      .table-container {
        overflow-x: auto;
        border-radius: 10px;
        border: 1px solid #eee;
        margin-top: 20px;
        -webkit-overflow-scrolling: touch;
      }

      .inventory-table {
        width: 100%;
        border-collapse: collapse;
        min-width: 700px;
      }

      .inventory-table th {
        background-color: #f8f9fa;
        padding: 12px 10px;
        text-align: left;
        font-weight: 600;
        color: var(--dark);
        border-bottom: 2px solid #eee;
        position: sticky;
        top: 0;
        font-size: 13px;
      }

      @media (min-width: 768px) {
        .inventory-table th {
          padding: 15px;
          font-size: 14px;
        }
      }

      .inventory-table td {
        padding: 12px 10px;
        border-bottom: 1px solid #eee;
        vertical-align: middle;
        font-size: 13px;
      }

      @media (min-width: 768px) {
        .inventory-table td {
          padding: 15px;
          font-size: 14px;
        }
      }

      .inventory-table tr:hover {
        background-color: #f9f9f9;
      }

      /* Status Badges */
      .status-badge {
        display: inline-flex;
        align-items: center;
        gap: 5px;
        padding: 4px 10px;
        border-radius: 15px;
        font-size: 11px;
        font-weight: 600;
      }

      @media (min-width: 768px) {
        .status-badge {
          padding: 5px 12px;
          font-size: 12px;
        }
      }

      /* Quick Actions */
      .quick-actions {
        display: flex;
        gap: 5px;
        flex-wrap: nowrap;
      }

      .action-btn {
        width: 32px;
        height: 32px;
        border-radius: 6px;
        border: none;
        background: none;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.3s;
        font-size: 14px;
        flex-shrink: 0;
      }

      /* ==================== SIDEBAR ==================== */
      .sidebar {
        width: 100%;
      }

      @media (min-width: 1024px) {
        .sidebar {
          flex: 1;
          min-width: 300px;
          max-width: 400px;
        }
      }

      /* Sidebar Cards */
      .sidebar-card {
        background-color: white;
        border-radius: 15px;
        padding: 20px;
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.08);
        margin-bottom: 20px;
      }

      @media (min-width: 1024px) {
        .sidebar-card {
          border-radius: 20px;
          padding: 25px;
          margin-bottom: 30px;
        }
      }

      .sidebar-card h3 {
        color: var(--primary);
        margin-bottom: 15px;
        font-size: 16px;
        display: flex;
        align-items: center;
        gap: 10px;
      }

      @media (min-width: 768px) {
        .sidebar-card h3 {
          font-size: 18px;
        }
      }

      @media (min-width: 1024px) {
        .sidebar-card h3 {
          font-size: 20px;
          margin-bottom: 20px;
        }
      }

      /* Expiring Soon Special Card */
      #expiring-soon {
        background: linear-gradient(135deg, #fff5f5 0%, #ffeaea 100%);
        border: 2px solid #ffcdd2;
        border-radius: 15px;
        position: relative;
        overflow: hidden;
      }

      #expiring-soon::before {
        content: "";
        position: absolute;
        top: 0;
        left: 0;
        width: 8px;
        height: 100%;
        background: linear-gradient(to bottom, #ff4757, #ff6b81);
        border-radius: 15px 0 0 15px;
      }

      /* Expiring List */
      .expiring-list {
        max-height: 300px;
        overflow-y: auto;
        -webkit-overflow-scrolling: touch;
      }

      .expiring-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 12px;
        margin-bottom: 8px;
        background: white;
        border-radius: 10px;
        border-left: 4px solid #ff4757;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
        transition: all 0.3s ease;
        cursor: pointer;
      }

      .expiring-item:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 10px rgba(255, 71, 87, 0.15);
      }

      .expiring-item > div:first-child {
        flex: 1;
        min-width: 0;
        margin-right: 10px;
      }

      .expiring-item .product-name {
        font-weight: 600;
        color: #333;
        font-size: 13px;
        margin-bottom: 5px;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
      }

      @media (min-width: 768px) {
        .expiring-item .product-name {
          font-size: 14px;
        }
      }

      .expiring-item .expiry-info {
        display: flex;
        justify-content: space-between;
        align-items: center;
        font-size: 11px;
      }

      @media (min-width: 768px) {
        .expiring-item .expiry-info {
          font-size: 12px;
        }
      }

      .expiring-item .expiry-date {
        background: #ffebee;
        color: #d32f2f;
        padding: 3px 10px;
        border-radius: 20px;
        font-weight: 600;
        display: flex;
        align-items: center;
        gap: 5px;
        white-space: nowrap;
      }

      .expiring-item .quantity {
        color: var(--accent);
        font-weight: 600;
        display: flex;
        align-items: center;
        gap: 5px;
        white-space: nowrap;
      }

      .expiry-badge {
        padding: 4px 10px;
        border-radius: 20px;
        font-size: 10px;
        font-weight: 800;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        white-space: nowrap;
        margin-left: 8px;
        flex-shrink: 0;
      }

      @media (min-width: 768px) {
        .expiry-badge {
          padding: 6px 14px;
          font-size: 11px;
          margin-left: 10px;
        }
      }

      /* Stock Alert Items */
      .stock-alert-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 12px 0;
        border-bottom: 1px solid #eee;
        cursor: pointer;
      }

      .stock-alert-item:last-child {
        border-bottom: none;
      }

      .stock-alert-item .stock-info {
        font-size: 13px;
        flex: 1;
        min-width: 0;
      }

      @media (min-width: 768px) {
        .stock-alert-item .stock-info {
          font-size: 14px;
        }
      }

      .stock-alert-item .stock-qty {
        font-weight: 600;
        color: var(--danger);
        font-size: 16px;
        margin-left: 10px;
        flex-shrink: 0;
      }

      @media (min-width: 768px) {
        .stock-alert-item .stock-qty {
          font-size: 18px;
        }
      }

      /* Batch History */
      #batchHistory .batch-history-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 12px 0;
        border-bottom: 1px solid #eee;
        cursor: pointer;
        font-size: 13px;
      }

      @media (min-width: 768px) {
        #batchHistory .batch-history-item {
          font-size: 14px;
        }
      }

      #batchHistory .batch-history-item:last-child {
        border-bottom: none;
      }

      #batchHistory .batch-history-item > div:first-child {
        flex: 1;
        min-width: 0;
        margin-right: 10px;
      }

      /* ==================== BUTTONS ==================== */
      .btn {
        padding: 10px 16px;
        border-radius: 8px;
        border: none;
        font-size: 14px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        gap: 6px;
        text-align: center;
        white-space: nowrap;
        min-height: 44px; /* Better touch target */
      }

      @media (min-width: 768px) {
        .btn {
          padding: 12px 20px;
          border-radius: 10px;
          font-size: 14px;
          min-height: 48px;
        }
      }

      .btn i {
        font-size: 14px;
      }

      .btn-primary {
        background-color: var(--primary);
        color: white;
      }

      .btn-primary:hover {
        background-color: #ff5a9c;
        transform: translateY(-2px);
      }

      .btn-success {
        background-color: var(--success);
        color: white;
      }

      .btn-warning {
        background-color: var(--warning);
        color: white;
      }

      .btn-info {
        background-color: var(--info);
        color: white;
      }

      /* ==================== MODALS ==================== */
      .modal {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.5);
        z-index: 2000;
        align-items: center;
        justify-content: center;
        padding: 15px;
        overflow-y: auto;
      }

      .modal-content {
        background: white;
        border-radius: 15px;
        padding: 20px;
        width: 100%;
        max-width: 500px;
        max-height: 90vh;
        overflow-y: auto;
        -webkit-overflow-scrolling: touch;
        box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
      }

      @media (min-width: 768px) {
        .modal-content {
          border-radius: 20px;
          padding: 30px;
          max-width: 600px;
        }
      }

      .modal-header {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        margin-bottom: 20px;
      }

      .modal-header h3 {
        color: var(--primary);
        font-size: 18px;
        display: flex;
        align-items: center;
        gap: 8px;
        margin-right: 10px;
      }

      @media (min-width: 768px) {
        .modal-header h3 {
          font-size: 22px;
        }
      }

      .close-modal {
        background: none;
        border: none;
        font-size: 20px;
        color: #666;
        cursor: pointer;
        padding: 5px;
        flex-shrink: 0;
      }

      /* Form Styles */
      .form-group {
        margin-bottom: 15px;
      }

      .form-group label {
        display: block;
        margin-bottom: 6px;
        font-weight: 600;
        color: var(--dark);
        font-size: 14px;
      }

      .form-group input,
      .form-group select,
      .form-group textarea {
        width: 100%;
        padding: 12px;
        border: 2px solid #eee;
        border-radius: 8px;
        font-size: 14px;
        transition: all 0.3s;
      }

      .form-row {
        display: grid;
        grid-template-columns: 1fr;
        gap: 15px;
        margin-bottom: 15px;
      }

      @media (min-width: 480px) {
        .form-row {
          grid-template-columns: repeat(2, 1fr);
        }
      }

      .form-actions {
        display: flex;
        flex-direction: column;
        gap: 10px;
        margin-top: 20px;
      }

      @media (min-width: 480px) {
        .form-actions {
          flex-direction: row;
          justify-content: flex-end;
        }
      }

      /* ==================== NOTIFICATIONS ==================== */
      .notification {
        position: fixed;
        top: 20px;
        right: 15px;
        left: 15px;
        padding: 12px 20px;
        border-radius: 10px;
        color: white;
        font-weight: 600;
        z-index: 1000;
        display: flex;
        align-items: center;
        gap: 10px;
        transform: translateX(150%);
        transition: transform 0.3s ease;
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        font-size: 14px;
      }

      @media (min-width: 768px) {
        .notification {
          left: auto;
          right: 20px;
          max-width: 400px;
        }
      }

      .notification.show {
        transform: translateX(0);
      }

      .notification.success {
        background-color: var(--success);
      }

      .notification.error {
        background-color: var(--danger);
      }

      .notification.warning {
        background-color: var(--warning);
      }

      .notification.info {
        background-color: var(--info);
      }

      /* ==================== SEARCHABLE DROPDOWN ==================== */
      .searchable-dropdown {
        position: relative;
        width: 100%;
      }

      .searchable-dropdown-input {
        width: 100%;
        padding: 12px 40px 12px 12px;
        border: 2px solid #eee;
        border-radius: 8px;
        font-size: 14px;
        cursor: pointer;
        background: white;
      }

      .searchable-dropdown-toggle {
        position: absolute;
        right: 10px;
        top: 50%;
        transform: translateY(-50%);
        background: none;
        border: none;
        color: #666;
        cursor: pointer;
        padding: 5px;
      }

      .searchable-dropdown-options {
        position: absolute;
        top: 100%;
        left: 0;
        right: 0;
        background: white;
        border: 2px solid var(--primary);
        border-radius: 8px;
        margin-top: 5px;
        max-height: 300px;
        overflow-y: auto;
        z-index: 1000;
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.15);
        display: none;
        -webkit-overflow-scrolling: touch;
      }

      @media (min-width: 768px) {
        .searchable-dropdown-options {
          max-height: 400px;
        }
      }

      .searchable-dropdown-options.active {
        display: block;
      }

      .searchable-dropdown-option {
        padding: 12px 15px;
        cursor: pointer;
        border-bottom: 1px solid #f0f0f0;
        transition: all 0.2s;
        display: flex;
        justify-content: space-between;
        align-items: center;
        font-size: 13px;
      }

      @media (min-width: 768px) {
        .searchable-dropdown-option {
          font-size: 14px;
        }
      }

      /* ==================== KEYBOARD NAVIGATION ==================== */
      .keyboard-focus {
        outline: 3px solid var(--accent) !important;
        outline-offset: 2px !important;
        box-shadow: 0 0 0 3px rgba(157, 78, 221, 0.3) !important;
        position: relative;
        z-index: 10;
      }

      /* ==================== ANIMATIONS ==================== */
      @keyframes pulse {
        0% {
          opacity: 1;
        }
        50% {
          opacity: 0.7;
        }
        100% {
          opacity: 1;
        }
      }

      @keyframes pulseCritical {
        0% {
          opacity: 1;
        }
        50% {
          opacity: 0.7;
        }
        100% {
          opacity: 1;
        }
      }

      @keyframes fadeIn {
        from {
          opacity: 0;
        }
        to {
          opacity: 1;
        }
      }

      /* ==================== EMPTY STATES ==================== */
      .empty-state {
        text-align: center;
        padding: 30px 20px;
        color: #adb5bd;
      }

      .empty-state i {
        font-size: 40px;
        margin-bottom: 10px;
        opacity: 0.5;
      }

      .empty-state p {
        font-size: 14px;
        margin: 0;
        font-style: italic;
      }

      /* ==================== UTILITY CLASSES ==================== */
      .critical-item {
        animation: pulseCritical 2s infinite;
        background-color: rgba(244, 67, 54, 0.05);
      }

      .active-filter {
        border: 2px solid var(--primary) !important;
        background-color: rgba(255, 123, 172, 0.1) !important;
      }

      /* ==================== ACTIVE FILTERS DISPLAY ==================== */
      .active-filters {
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
        margin-top: 15px;
        padding-top: 15px;
        border-top: 1px solid #eee;
      }

      .filter-tag {
        background-color: var(--primary);
        color: white;
        padding: 4px 10px;
        border-radius: 15px;
        font-size: 12px;
        display: flex;
        align-items: center;
        gap: 5px;
      }

      /* ==================== NO RESULTS STYLES ==================== */
      .no-results {
        text-align: center;
        padding: 40px 20px;
        color: #999;
      }

      .no-results i {
        font-size: 48px;
        margin-bottom: 15px;
        opacity: 0.5;
      }

      .no-results p {
        font-size: 16px;
        margin-bottom: 10px;
      }

      .no-results .suggestion {
        font-size: 14px;
        color: #666;
      }

      /* ==================== CUSTOM SCROLLBARS ==================== */
      @media (min-width: 768px) {
        ::-webkit-scrollbar {
          width: 6px;
          height: 6px;
        }

        ::-webkit-scrollbar-track {
          background: #f1f1f1;
          border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb {
          background: #ccc;
          border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
          background: #aaa;
        }
      }

      /* ==================== TOUCH DEVICE OPTIMIZATIONS ==================== */
      @media (hover: none) and (pointer: coarse) {
        .btn,
        .action-btn,
        .stat-card,
        .expiring-item,
        .stock-alert-item,
        .batch-history-item {
          min-height: 44px;
          padding: 12px;
        }
        
        .action-btn {
          width: 44px;
          height: 44px;
        }
        
        .table-container {
          -webkit-overflow-scrolling: touch;
          overflow-x: auto;
        }
      }

      /* ==================== PRINT STYLES ==================== */
      @media print {
        body {
          background: white;
          padding: 0;
        }
        
        .container {
          max-width: 100%;
          box-shadow: none;
        }
        
        header,
        .dashboard-stats,
        .filters-section,
        .sidebar,
        .header-actions,
        .quick-actions,
        .notification {
          display: none !important;
        }
        
        .inventory-card {
          box-shadow: none;
          padding: 0;
          margin: 0;
        }
        
        .table-container {
          overflow: visible;
          border: none;
        }
        
        .inventory-table {
          min-width: 100%;
          border: 1px solid #000;
        }
        
        .inventory-table th,
        .inventory-table td {
          border: 1px solid #000;
          padding: 8px;
        }
      }
    </style>
  </head>
  <body>
    <div class="container">
      <header>
        <div class="logo-container">
          <div class="logo">
            <i class="fas fa-birthday-cake"></i>
          </div>
          <div class="logo-text">
            <h1>Cake Bliss</h1>
            <p>Advanced Billing System with Multiple Items</p>
            <div id="dbStatus" class="db-status disconnected">
              <div class="status-dot disconnected"></div>
              <span>Database: Disconnected</span>
            </div>
          </div>
        </div>
        <nav>
          <ul>
            <li>
              <a href="billing.html"><i class="fas fa-receipt"></i> Billing</a>
            </li>
            <!-- Add this to your header navigation -->
            <li>
              <a href="inventory.html" class="active" id="inventoryBtn">
                <i class="fas fa-boxes"></i> Inventory
              </a>
            </li>
            <li>
              <a href="reports.html"
                ><i class="fas fa-chart-bar"></i> Reports</a
              >
            </li>
            <li>
              <a href="promotions.html"
                ><i class="fas fa-bullhorn"></i> Promotions</a
              >
            </li>
          </ul>
        </nav>
      </header>

      <!-- Dashboard Stats -->
      <div class="dashboard-stats">
        <div class="stat-card">
          <div
            class="stat-icon"
            style="
              background: linear-gradient(
                45deg,
                var(--primary),
                var(--secondary)
              );
            "
          >
            <i class="fas fa-box"></i>
          </div>
          <div class="stat-content">
            <h3>Total Products</h3>
            <div class="stat-value" id="totalProducts">0</div>
          </div>
        </div>
        <div class="stat-card">
          <div
            class="stat-icon"
            style="background: linear-gradient(45deg, var(--success), #66bb6a)"
          >
            <i class="fas fa-check-circle"></i>
          </div>
          <div class="stat-content">
            <h3>Available Stock</h3>
            <div class="stat-value" id="inStockCount">0</div>
          </div>
        </div>

        <div class="stat-card">
          <div
            class="stat-icon"
            style="background: linear-gradient(45deg, var(--warning), #ffb74d)"
          >
            <i class="fas fa-exclamation-triangle"></i>
          </div>
          <div class="stat-content">
            <h3>Low Stock</h3>
            <div class="stat-value" id="lowStockCount">0</div>
          </div>
        </div>
        <!-- Out of Stock Stat Card - ADD CLICK HANDLER -->
        <div class="stat-card" id="outOfStockCard">
          <div
            class="stat-icon"
            style="background: linear-gradient(45deg, #6c757d, #adb5bd)"
          >
            <i class="fas fa-times-circle"></i>
          </div>
          <div class="stat-content">
            <h3>Out of Stock</h3>
            <div class="stat-value" id="outOfStockCount">0</div>
          </div>
        </div>

        <!-- No Stock Sidebar Card (moved to sidebar area later) -->

        <div class="stat-card">
          <div
            class="stat-icon"
            style="background: linear-gradient(45deg, var(--danger), #ef5350)"
          >
            <i class="fas fa-calendar-times"></i>
          </div>
          <div class="stat-content">
            <h3>Expiring Soon</h3>
            <div class="stat-value" id="expiringCount">0</div>
          </div>
        </div>
      </div>

      <!-- Main Content -->
      <div class="main-content">
        <!-- Inventory Table -->
        <div class="inventory-card">
          <div class="inventory-header">
            <h2><i class="fas fa-boxes-stacked"></i> Product Inventory</h2>
            <div class="header-actions">
              <button type="button" class="btn btn-primary" id="addProductBtn">
                <i class="fas fa-plus"></i> Add Product
              </button>
              <button type="button" class="btn btn-success" id="addBatchBtn">
                <i class="fas fa-layer-group"></i> Add Batch
              </button>
              <button type="button" class="btn btn-warning" id="updateDatesBtn">
                <i class="fas fa-calendar-day"></i> Update Dates
              </button>
              <button type="button" class="btn btn-info" id="exportBtn">
                <i class="fas fa-file-export"></i> Export
              </button>
            </div>
          </div>
          <!-- Add this inside the inventory-card, after the inventory-header div -->
          <div class="filters-section">
            <div class="filters-header">
              <h3><i class="fas fa-filter"></i> Filter Products</h3>
              <button
                type="button"
                class="btn"
                id="clearFiltersBtn"
                style="background-color: #f0f0f0"
              >
                <i class="fas fa-times"></i> Clear Filters
              </button>
            </div>
            <div class="filter-row">
              <div class="filter-group">
                <label for="filterCategory">Category:</label>
                <select id="filterCategory">
                  <option value="">All Categories</option>
                  <option value="Cakes">Cakes</option>
                  <option value="Pastries">Pastries</option>
                  <option value="Decorations">Decorations</option>
                  <option value="Beverages">Beverages</option>
                </select>
              </div>

              <div class="filter-group">
                <label for="filterStockStatus">Stock Status:</label>
                <select id="filterStockStatus">
                  <option value="">All Status</option>
                  <option value="available">Available</option>
                  <option value="low_stock">Low Stock</option>
                  <option value="out_of_stock">Out of Stock</option>
                  <option value="expiring_soon">Expiring Soon</option>
                </select>
              </div>

              <div class="filter-group">
                <label for="filterSearch">Search:</label>
                <input
                  type="text"
                  id="filterSearch"
                  placeholder="Product name or code..."
                />
              </div>

              <div class="filter-group">
                <button
                  type="button"
                  class="btn btn-primary"
                  id="applyFiltersBtn"
                >
                  <i class="fas fa-search"></i> Apply Filters
                </button>
              </div>
            </div>
          </div>
          <div class="table-container">
            <table class="inventory-table" id="inventoryTable">
              <thead>
                <tr>
                  <th>Product</th>
                  <th>Category</th>
                  <th>Stock</th>
                  <th>Price</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody id="inventoryTableBody">
                <!-- Will be populated by JavaScript -->
              </tbody>
            </table>
          </div>
        </div>

        <!-- Sidebar -->
        <div class="sidebar">
          <!-- Expiring Soon -->
          <div class="sidebar-card" id="expiring-soon">
            <h3><i class="fas fa-clock"></i> Expiring Soon (≤ 3 days)</h3>
            <div class="expiring-list" id="expiringList">
              <!-- Will be populated -->
            </div>
          </div>

          <!-- Low Stock -->
          <div class="sidebar-card">
            <h3>
              <i class="fas fa-exclamation-triangle"></i> Low Stock (≤ 5 units)
            </h3>
            <div id="lowStockList">
              <!-- Will be populated -->
            </div>
          </div>

          <!-- No Stock Sidebar Card -->
          <div
            class="sidebar-card"
            id="no-stock-section"
            onclick="showAllOutOfStock()"
          >
            <div
              style="
                display: flex;
                justify-content: space-between;
                align-items: center;
                margin-bottom: 15px;
              "
            >
              <h3 style="margin: 0">
                <i class="fas fa-times-circle"></i> Out of Stock
              </h3>
              <i
                class="fas fa-external-link-alt"
                style="color: var(--primary); cursor: pointer"
              ></i>
            </div>
            <div id="noStockList">
              <!-- Will be populated -->
            </div>
          </div>

          <!-- Batch History -->
          <div class="sidebar-card">
            <h3><i class="fas fa-history"></i> Recent Batches</h3>
            <div id="batchHistory">
              <!-- Will be populated -->
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Product Modal -->
    <div id="productModal" class="modal">
      <div class="modal-content">
        <div class="modal-header">
          <h3 id="productModalTitle"><i class="fas fa-box"></i> Add Product</h3>
          <button type="button" class="close-modal" id="closeProductModal">
            <i class="fas fa-times"></i>
          </button>
        </div>
        <form id="productForm">
          <div class="form-group">
            <label for="productName">Product Name *</label>
            <input
              type="text"
              id="productName"
              required
              placeholder="Chocolate Cake"
            />
          </div>

          <div class="form-group">
            <label for="productCode">Generated Product Code</label>
            <input
              type="text"
              id="productCode"
              readonly
              style="
                background-color: #f8f9fa;
                cursor: not-allowed;
                font-weight: 600;
                color: var(--accent);
                font-family: monospace;
              "
            />
            <small style="color: #666; font-size: 11px">
              <i class="fas fa-info-circle"></i> Code is auto-generated based on
              category
            </small>
          </div>
          <div class="form-row">
            <div class="form-group">
              <label for="productCategory">Category *</label>
              <select id="productCategory" required>
                <option value="">Select Category</option>
                <option value="Cakes">Cakes</option>
                <option value="Pastries">Pastries</option>
                <option value="Decorations">Decorations</option>
                <option value="Beverages">Beverages</option>
              </select>
            </div>
            <div class="form-group">
              <label for="productPrice">Unit Price (₹) *</label>
              <input
                type="number"
                id="productPrice"
                required
                step="0.01"
                placeholder="45.99"
                min="0.01"
              />
            </div>
          </div>

          <div class="form-row">
            <div class="form-group">
              <label for="shelfLifeDays">Shelf Life (Days) *</label>
              <input
                type="number"
                id="shelfLifeDays"
                required
                min="1"
                placeholder="7"
                value="7"
              />
            </div>
            <div class="form-group">
              <label style="color: transparent">-</label>
              <div
                style="
                  background-color: #f8f9fa;
                  padding: 8px;
                  border-radius: 6px;
                  font-size: 12px;
                "
              >
                <i class="fas fa-info-circle"></i> Stock will be managed through
                batches
              </div>
            </div>
          </div>

          <div class="form-actions">
            <button type="submit" class="btn btn-primary">
              <i class="fas fa-save"></i> Save
            </button>
            <button type="button" class="btn" id="cancelProductBtn">
              Cancel
            </button>
          </div>
        </form>
      </div>
    </div>

    <!-- Batch Modal -->
    <div id="batchModal" class="modal">
      <div class="modal-content">
        <div class="modal-header">
          <h3><i class="fas fa-layer-group"></i> Add New Batch</h3>
          <button type="button" class="close-modal" id="closeBatchModal">
            <i class="fas fa-times"></i>
          </button>
        </div>
        <form id="batchForm">
          <div class="form-group">
            <label for="batchProduct">Product *</label>
            <div class="searchable-dropdown" id="batchProductDropdown">
              <input
                type="text"
                class="searchable-dropdown-input"
                id="batchProductInput"
                placeholder="Type product name or code..."
                required
                autocomplete="off"
              />
              <button
                type="button"
                class="searchable-dropdown-toggle"
                id="batchProductToggle"
              >
                <i class="fas fa-chevron-down"></i>
              </button>
              <div class="searchable-dropdown-options" id="batchProductOptions">
                <!-- Options will be populated dynamically -->
                <!-- No inner search box needed -->
              </div>
              <input
                type="hidden"
                id="batchProduct"
                name="batchProduct"
                required
              />
            </div>
          </div>

          <div class="form-row">
            <div class="form-group">
              <label for="batchQuantity">Quantity *</label>
              <input
                type="number"
                id="batchQuantity"
                required
                min="1"
                value="1"
              />
            </div>
            <div class="form-group">
              <label for="batchPrice">Cost per Unit (₹) *</label>
              <input type="number" id="batchPrice" step="0.01" required />
              <small style="color: #666; font-size: 11px"
                >Auto-filled from product price</small
              >
            </div>
          </div>

          <div class="form-row">
            <div class="form-group">
              <label for="batchManufactureDate">Manufacture Date *</label>
              <input type="date" id="batchManufactureDate" required />
              <small style="color: #666; font-size: 11px"
                >Default: Today's date</small
              >
            </div>
            <div class="form-group">
              <label for="batchShelfLife">Shelf Life (Days) *</label>
              <input type="number" id="batchShelfLife" min="1" required />
              <small style="color: #666; font-size: 11px"
                >Default from product settings</small
              >
            </div>
          </div>
          <!-- Add this empty div to maintain spacing -->
          <div style="display: none">
            <!-- Hidden expiry date field for JavaScript calculations -->
            <input type="hidden" id="batchExpiryDate" />
          </div>

          <div class="form-actions">
            <button type="submit" class="btn btn-success">
              <i class="fas fa-check"></i> Add Batch
            </button>
            <button type="button" class="btn" id="cancelBatchBtn">
              Cancel
            </button>
          </div>
        </form>
      </div>
    </div>

    <!-- Update Dates Modal -->
    <div id="datesModal" class="modal">
      <div class="modal-content">
        <div class="modal-header">
          <h3><i class="fas fa-calendar-day"></i> Update Shelf Life</h3>
          <button type="button" class="close-modal" id="closeDatesModal">
            <i class="fas fa-times"></i>
          </button>
        </div>
        <div style="padding: 20px">
          <p>
            This will update shelf life calculations based on today's date:
            <strong id="currentDate"></strong>
          </p>
          <p>
            Products will be checked for expiration and remaining shelf life
            will be recalculated.
          </p>
          <div class="form-actions">
            <button
              type="button"
              class="btn btn-warning"
              id="confirmUpdateDates"
            >
              <i class="fas fa-sync"></i> Update Now
            </button>
            <button type="button" class="btn" id="cancelDatesBtn">
              Cancel
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Product Detail Modal -->
    <div id="detailModal" class="modal">
      <div class="modal-content" style="max-width: 700px">
        <div class="modal-header">
          <h3 id="detailTitle">Product Details</h3>
          <button type="button" class="close-modal" id="closeDetailModal">
            <i class="fas fa-times"></i>
          </button>
        </div>
        <div id="detailContent">
          <!-- Content loaded dynamically -->
        </div>
      </div>
    </div>
    <script>
(function() {
  // Database Configuration
  const SUPABASE_URL = "https://vdbwzmutxjonnpfwfpbn.supabase.co";
  const SUPABASE_KEY =
    "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZkYnd6bXV0eGpvbm5wZndmcGJuIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQ5OTcwMjQsImV4cCI6MjA4MDU3MzAyNH0.n0ERxgLgYU1Tvw5QONihv1C3A7o7rcxrcn5MjZ5UnEM";

  let supabase = null;
  let products = [];
  let batches = [];
  let today = new Date();

  // Keyboard Navigation Variables
  let currentFocusIndex = 0;
  let focusableElements = [];
  let inTableMode = false;
  let currentTableRow = 0;
  let currentTableColumn = 0;
  let isModalOpen = false;
  let currentModalElements = [];

  // ==================== KEYBOARD NAVIGATION SYSTEM ====================

  function initializeKeyboardNavigation() {
    console.log("Initializing keyboard navigation...");

    // Collect all focusable elements
    updateFocusableElements();

    // Add global keyboard event listener
    document.addEventListener("keydown", handleGlobalKeyboard);

    // Set initial focus
    setTimeout(() => {
      if (focusableElements.length > 0) {
        setFocus(0);
      }
    }, 100);

    console.log(
      "Keyboard navigation initialized with",
      focusableElements.length,
      "focusable elements"
    );
  }

  // Filtering variables
  let currentFilters = {
    category: "",
    stockStatus: "",
    search: "",
  };
  let filteredProducts = [];

  // Initialize filters
  function initializeFilters() {
    // Apply Filters button
    document
      .getElementById("applyFiltersBtn")
      .addEventListener("click", applyFilters);

    // Clear Filters button
    document
      .getElementById("clearFiltersBtn")
      .addEventListener("click", clearFilters);

    // Search on Enter key
    document
      .getElementById("filterSearch")
      .addEventListener("keyup", function (e) {
        if (e.key === "Enter") {
          applyFilters();
        }
      });

    // Apply filters when dropdowns change (optional)
    document
      .getElementById("filterCategory")
      .addEventListener("change", applyFilters);
    document
      .getElementById("filterStockStatus")
      .addEventListener("change", applyFilters);
  }

  // Update after loading products
  function updateCategoryFilterOptions() {
    const categorySelect = document.getElementById("filterCategory");
    const categories = [...new Set(products.map((p) => p.category))];

    // Clear existing options (keep "All Categories")
    categorySelect.innerHTML = '<option value="">All Categories</option>';

    // Add each unique category
    categories.forEach((category) => {
      const option = document.createElement("option");
      option.value = category;
      option.textContent = category;
      categorySelect.appendChild(option);
    });
  }

  // Apply filters
  function applyFilters() {
    // Get filter values
    currentFilters = {
      category: document.getElementById("filterCategory").value,
      stockStatus: document.getElementById("filterStockStatus").value,
      search: document
        .getElementById("filterSearch")
        .value.toLowerCase()
        .trim(),
    };

    // Check if any filters are active
    const hasFiltersActive =
      currentFilters.category !== "" ||
      currentFilters.stockStatus !== "" ||
      currentFilters.search !== "";

    if (hasFiltersActive) {
      // Filter products
      filterProducts();

      // Update UI
      updateFilteredTable();
      updateActiveFiltersDisplay();

      // Show notification
      showNotification(
        `Showing ${filteredProducts.length} filtered products`,
        "info"
      );
    } else {
      // No filters active, show all products
      filteredProducts = [];
      updateFilteredTable();
      updateActiveFiltersDisplay();
    }
  }

  // Filter products based on current filters
  function filterProducts() {
    filteredProducts = products.filter((product) => {
      const status = calculateProductStatus(product);
      let matchesAllFilters = true;

      // Category filter
      if (
        currentFilters.category &&
        product.category !== currentFilters.category
      ) {
        matchesAllFilters = false;
      }

      // Stock status filter - KEEP AVAILABLE LOGIC AS IS
      if (currentFilters.stockStatus) {
        if (currentFilters.stockStatus === "available") {
          // Show products that are NOT out_of_stock
          if (status.status === "out_of_stock") {
            matchesAllFilters = false;
          }
        } else if (currentFilters.stockStatus === "expiring_soon") {
          // FIX: Show ALL products with batches expiring in ≤3 days (regardless of product status)
          const hasExpiringBatch =
            status.batches &&
            status.batches.some((batch) => {
              if (!batch.expiry_date) return false;

              const expiryDate = new Date(batch.expiry_date);
              const todayDate = new Date();

              // Calculate days difference
              const diffTime = expiryDate - todayDate;
              const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));

              // Batch is expiring soon if: 0-3 days left AND has remaining quantity
              return (
                diffDays >= 0 &&
                diffDays <= 3 &&
                (batch.remaining_quantity || 0) > 0
              );
            });

          if (!hasExpiringBatch) {
            matchesAllFilters = false;
          }
        } else if (currentFilters.stockStatus === "low_stock") {
          // Show products with low stock (1-5 units)
          if (status.status !== "low_stock") {
            matchesAllFilters = false;
          }
        } else if (currentFilters.stockStatus === "out_of_stock") {
          // Show products with no stock
          if (status.totalStock > 0) {
            matchesAllFilters = false;
          }
        }
      }

      // Search filter
      if (currentFilters.search) {
        const searchTerm = currentFilters.search;
        const matchesName = product.product_name
          .toLowerCase()
          .includes(searchTerm);
        const matchesCode = product.product_code
          .toLowerCase()
          .includes(searchTerm);
        if (!matchesName && !matchesCode) {
          matchesAllFilters = false;
        }
      }

      return matchesAllFilters;
    });
  }

  // Debug function to check expiring items
  function debugExpiringItems() {
    console.log("=== DEBUG: Expiring Items Analysis ===");

    products.forEach((product, index) => {
      const status = calculateProductStatus(product);

      // Check if this product has expiring batches
      const expiringBatches = status.batches.filter((b) => {
        if (!b.expiry_date || b.remaining_quantity === 0) return false;
        const expiry = new Date(b.expiry_date);
        const diffTime = expiry - today;
        const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
        return diffDays <= 3 && diffDays >= 0;
      });

      if (expiringBatches.length > 0) {
        console.log(`${index + 1}. ${product.product_name}`);
        console.log(`   Product Status: ${status.status}`);
        console.log(`   Total Stock: ${status.totalStock}`);
        console.log(`   Expiring Batches: ${expiringBatches.length}`);
        expiringBatches.forEach((batch, i) => {
          const expiry = new Date(batch.expiry_date);
          const diffTime = expiry - today;
          const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
          console.log(
            `   Batch ${i + 1}: ${
              batch.remaining_quantity
            } units, ${diffDays} days left`
          );
        });
        console.log(
          `   Should show in filter: ${
            expiringBatches.length > 0 && status.totalStock > 0
              ? "YES"
              : "NO"
          }`
        );
      }
    });

    console.log("=== END DEBUG ===");
  }

  // Check if any filters are active
  function hasActiveFilters() {
    return (
      currentFilters.category !== "" ||
      currentFilters.stockStatus !== "" ||
      currentFilters.search !== ""
    );
  }

  // Update table with filtered products
  function updateFilteredTable() {
    const tbody = document.getElementById("inventoryTableBody");
    tbody.innerHTML = "";

    // Check if any filters are active
    const hasFiltersActive = hasActiveFilters();

    // Use filtered products if filters are active, otherwise use all products
    const displayProducts = hasFiltersActive ? filteredProducts : products;

    if (displayProducts.length === 0) {
      tbody.innerHTML = `
      <tr>
        <td colspan="5" class="no-results">
          <i class="fas fa-search"></i>
          <p>No products found</p>
          <div class="suggestion">Try adjusting your filters or search term</div>
          <button type="button" class="btn" onclick="clearFilters()" style="margin-top: 15px;">
            <i class="fas fa-times"></i> Clear Filters
          </button>
        </td>
      </tr>
    `;
      return;
    }

    // Month names array for formatting
    const monthNames = [
      "January",
      "February",
      "March",
      "April",
      "May",
      "June",
      "July",
      "August",
      "September",
      "October",
      "November",
      "December",
    ];

    displayProducts.forEach((product) => {
      const status = calculateProductStatus(product);
      const row = document.createElement("tr");

      // Determine row class based on status
      if (status.status === "expiring_soon")
        row.classList.add("critical-item");
      else if (status.status === "low_stock")
        row.classList.add("warning-item");
      else if (status.status === "out_of_stock")
        row.classList.add("out-of-stock");

      // Batch info
      let batchInfo = "";
      if (status.batches && status.batches.length > 0) {
        const activeBatches = status.batches.filter((b) => {
          if (!b.expiry_date) return true;
          return new Date(b.expiry_date) >= today;
        });
        batchInfo = `<div style="font-size: 11px; color: #666;">${activeBatches.length} active batch(es)</div>`;
      }

      row.innerHTML = `
      <td>
        <div style="font-weight: 600;">${product.product_name}</div>
        <div style="font-size: 12px; color: #666;">${product.product_code}</div>
        ${batchInfo}
      </td>
      <td>
        <span class="category-badge">${product.category}</span>
      </td>
      <td>
        <div style="font-weight: 700; font-size: 18px; color: ${
          status.totalStock <= 5 ? "var(--danger)" : "var(--success)"
        }">
          ${status.totalStock}
        </div>
        <div style="font-size: 11px; color: #666;">units</div>
      </td>
      <td>
        <div style="font-weight: 700; color: var(--accent);">
          ₹${parseFloat(product.unit_price).toFixed(2)}
        </div>
      </td>
      <td>
        <div class="quick-actions">
          <button class="action-btn view" onclick="viewProduct('${
            product.id
          }')" title="View Details" tabindex="0">
            <i class="fas fa-eye"></i>
          </button>
          <button class="action-btn edit" onclick="editProduct('${
            product.id
          }')" title="Edit" tabindex="0">
            <i class="fas fa-edit"></i>
          </button>
        </div>
      </td>
    `;

      tbody.appendChild(row);
    });
  }

  // Clear filters function
  function clearFilters() {
    document.getElementById("filterCategory").value = "";
    document.getElementById("filterStockStatus").value = "";
    document.getElementById("filterSearch").value = "";

    currentFilters = {
      category: "",
      stockStatus: "",
      search: "",
    };

    // Update table to show all products
    updateInventoryTable(); // Call the original table update function
    updateActiveFiltersDisplay();

    showNotification("Filters cleared", "info");
  }

  // Update active filters display
  function updateActiveFiltersDisplay() {
    const filtersContainer = document.querySelector(
      ".filters-section .active-filters"
    );
    if (!filtersContainer) {
      // Create active filters container if it doesn't exist
      const filterSection = document.querySelector(".filters-section");
      const activeFiltersDiv = document.createElement("div");
      activeFiltersDiv.className = "active-filters";
      filterSection.appendChild(activeFiltersDiv);
    }

    const activeFiltersDiv = document.querySelector(
      ".filters-section .active-filters"
    );
    activeFiltersDiv.innerHTML = "";

    const hasFilters = Object.values(currentFilters).some(
      (value) => value !== ""
    );

    if (!hasFilters) {
      activeFiltersDiv.style.display = "none";
      return;
    }

    activeFiltersDiv.style.display = "flex";

    // Add filter tags
    if (currentFilters.category) {
      const tag = document.createElement("div");
      tag.className = "filter-tag";
      tag.innerHTML = `
      <span>Category: ${currentFilters.category}</span>
      <button class="remove-filter" onclick="removeFilter('category')">
        <i class="fas fa-times"></i>
      </button>
    `;
      activeFiltersDiv.appendChild(tag);
    }

    if (currentFilters.stockStatus) {
      const statusLabels = {
        available: "Available",
        low_stock: "Low Stock",
        out_of_stock: "Out of Stock",
        expiring_soon: "Expiring Soon",
      };
      const tag = document.createElement("div");
      tag.className = "filter-tag";
      tag.innerHTML = `
      <span>Status: ${
        statusLabels[currentFilters.stockStatus] || currentFilters.stockStatus
      }</span>
      <button class="remove-filter" onclick="removeFilter('stockStatus')">
        <i class="fas fa-times"></i>
      </button>
    `;
      activeFiltersDiv.appendChild(tag);
    }

    if (currentFilters.search) {
      const tag = document.createElement("div");
      tag.className = "filter-tag";
      tag.innerHTML = `
      <span>Search: "${currentFilters.search}"</span>
      <button class="remove-filter" onclick="removeFilter('search')">
        <i class="fas fa-times"></i>
      </button>
    `;
      activeFiltersDiv.appendChild(tag);
    }
  }

  // Remove specific filter
  function removeFilter(filterType) {
    if (filterType === "category") {
      document.getElementById("filterCategory").value = "";
    } else if (filterType === "stockStatus") {
      document.getElementById("filterStockStatus").value = "";
    } else if (filterType === "search") {
      document.getElementById("filterSearch").value = "";
    }

    applyFilters();
  }

  function updateFocusableElements() {
    // Get all focusable elements
    focusableElements = Array.from(
      document.querySelectorAll(
        'a[href], button, input, select, textarea, [tabindex]:not([tabindex="-1"])'
      )
    ).filter((el) => {
      // Filter out hidden, disabled, or non-visible elements
      return (
        el.offsetParent !== null &&
        !el.disabled &&
        el.style.display !== "none" &&
        !el.classList.contains("modal") &&
        !el.closest(".modal")
      );
    });

    // Add tabindex to the no-stock section
    const noStockSection = document.getElementById("no-stock-section");
    if (noStockSection && !focusableElements.includes(noStockSection)) {
      noStockSection.setAttribute("tabindex", "0");
      focusableElements.push(noStockSection);
    }

    // Add tabindex to table rows for navigation
    const tableRows = document.querySelectorAll(
      ".inventory-table tbody tr"
    );
    tableRows.forEach((row, index) => {
      row.setAttribute("tabindex", "0");
      if (!focusableElements.includes(row)) {
        focusableElements.push(row);
      }
    });

    // Add tabindex to sidebar items
    const sidebarItems = document.querySelectorAll(
      ".expiring-item, .stock-alert-item, .batch-history-item, .no-stock-item"
    );
    sidebarItems.forEach((item, index) => {
      item.setAttribute("tabindex", "0");
      if (!focusableElements.includes(item)) {
        focusableElements.push(item);
      }
    });

    // Add tabindex to dashboard cards
    const statCards = document.querySelectorAll(".stat-card");
    statCards.forEach((card, index) => {
      card.setAttribute("tabindex", "0");
      if (!focusableElements.includes(card)) {
        focusableElements.push(card);
      }
    });
  }

  function handleGlobalKeyboard(e) {
    // Don't interfere with typing in inputs
    if (
      e.target.tagName === "INPUT" ||
      e.target.tagName === "TEXTAREA" ||
      e.target.tagName === "SELECT"
    ) {
      handleInputKeyboard(e);
      return;
    }

    // Global shortcuts (work everywhere)
    if (e.ctrlKey || e.metaKey) {
      handleControlShortcuts(e);
      return;
    }

    if (e.altKey) {
      handleAltShortcuts(e);
      return;
    }

    // Function keys
    if (e.key.startsWith("F")) {
      handleFunctionKeys(e);
      return;
    }

    // Navigation keys
    switch (e.key) {
      case "Tab":
        e.preventDefault();
        if (e.shiftKey) {
          moveToPreviousElement();
        } else {
          moveToNextElement();
        }
        break;

      case "ArrowDown":
        e.preventDefault();
        if (inTableMode) {
          navigateTable("down");
        } else {
          moveToNextElement();
        }
        break;

      case "ArrowUp":
        e.preventDefault();
        if (inTableMode) {
          navigateTable("up");
        } else {
          moveToPreviousElement();
        }
        break;

      case "ArrowRight":
        e.preventDefault();
        if (inTableMode) {
          navigateTable("right");
        }
        break;

      case "ArrowLeft":
        e.preventDefault();
        if (inTableMode) {
          navigateTable("left");
        }
        break;

      case "Enter":
      case " ":
        e.preventDefault();
        activateCurrentElement();
        break;

      case "Escape":
        e.preventDefault();
        if (isModalOpen) {
          closeActiveModal();
        } else {
          clearCurrentFocus();
        }
        break;

      case "Home":
        e.preventDefault();
        setFocus(0);
        break;

      case "End":
        e.preventDefault();
        setFocus(focusableElements.length - 1);
        break;
    }
  }

  function handleInputKeyboard(e) {
    switch (e.key) {
      case "Enter":
        e.preventDefault();
        if (e.target.type === "button" || e.target.type === "submit") {
          e.target.click();
        } else {
          moveToNextElement();
        }
        break;

      case "Tab":
        e.preventDefault();
        if (e.shiftKey) {
          moveToPreviousElement();
        } else {
          moveToNextElement();
        }
        break;

      case "Escape":
        e.preventDefault();
        e.target.blur();
        setFocus(currentFocusIndex);
        break;
    }
  }

  function handleControlShortcuts(e) {
    switch (e.key.toLowerCase()) {
      case "n": // New product
        e.preventDefault();
        addProductModal();
        break;

      case "b": // Add batch
        e.preventDefault();
        addBatchModal();
        break;

      case "e": // Export
        e.preventDefault();
        exportInventory();
        break;

      case "r": // Refresh
        e.preventDefault();
        loadInventoryData();
        showNotification("Refreshing inventory...", "info");
        break;

      case "f": // Focus search/filter
        e.preventDefault();
        const searchInput = document.querySelector(
          'input[type="search"], input[placeholder*="search"]'
        );
        if (searchInput) {
          setFocusOnElement(searchInput);
        }
        break;

      case "1": // Focus on first button
        e.preventDefault();
        const firstButton = document.querySelector(
          ".header-actions button, .btn"
        );
        if (firstButton) {
          setFocusOnElement(firstButton);
        }
        break;

      case "h": // Help
        e.preventDefault();
        showKeyboardHelp();
        break;
    }
  }

  function handleAltShortcuts(e) {
    switch (e.key.toLowerCase()) {
      case "1": // Add Product
        e.preventDefault();
        addProductModal();
        break;

      case "2": // Add Batch
        e.preventDefault();
        addBatchModal();
        break;

      case "3": // Update Dates
        e.preventDefault();
        updateDatesModal();
        break;

      case "4": // Export
        e.preventDefault();
        exportInventory();
        break;

      case "5": // View Products Table
        e.preventDefault();
        const table = document.querySelector(".inventory-table");
        if (table) {
          setFocusOnElement(table);
          inTableMode = true;
        }
        break;

      case "6": // Focus on Expiring Soon
        e.preventDefault();
        const expiringSection = document.getElementById("expiring-soon");
        if (expiringSection) {
          setFocusOnElement(expiringSection);
        }
        break;

      case "7": // Focus on Low Stock
        e.preventDefault();
        const lowStockSection = document.querySelector("#lowStockList");
        if (lowStockSection) {
          setFocusOnElement(lowStockSection);
        }
        break;

      case "8": // Focus on filter search
        e.preventDefault();
        document.getElementById("filterSearch")?.focus();
        document.getElementById("filterSearch")?.select();
        break;

      case "9": // Apply filters
        e.preventDefault();
        applyFilters();
        break;

      case "0": // Clear filters
        e.preventDefault();
        clearFilters();
        break;

      case "h": // Help
        e.preventDefault();
        showKeyboardHelp();
        break;
    }
  }

  function handleFunctionKeys(e) {
    e.preventDefault();
    switch (e.key) {
      case "F1": // Help
        showKeyboardHelp();
        break;

      case "F2": // Add Product
        addProductModal();
        break;

      case "F3": // Add Batch
        addBatchModal();
        break;

      case "F4": // Update Dates
        updateDatesModal();
        break;

      case "F5": // Refresh/Reload
        loadInventoryData();
        showNotification("Inventory refreshed", "success");
        break;

      case "F6": // Export
        exportInventory();
        break;

      case "F7": // View Products
        viewProduct(products[0]?.id);
        break;

      case "F8": // Focus on table
        const tableBody = document.querySelector(".inventory-table tbody");
        if (tableBody && tableBody.firstChild) {
          setFocusOnElement(tableBody.firstChild);
          inTableMode = true;
        }
        break;

      case "F9": // Quick save (if in modal)
        const saveBtn = document.querySelector(
          ".modal .btn-primary, .modal .btn-success"
        );
        if (saveBtn) {
          saveBtn.click();
        }
        break;

      case "F10": // Quick close (if in modal)
        if (isModalOpen) {
          closeActiveModal();
        }
        break;

      case "F11": // Toggle fullscreen
        toggleFullscreen();
        break;

      case "F12": // Developer tools (let default)
        return;
    }
  }

  function moveToNextElement() {
    clearFocusIndicators();
    currentFocusIndex = (currentFocusIndex + 1) % focusableElements.length;
    setFocus(currentFocusIndex);
  }

  function moveToPreviousElement() {
    clearFocusIndicators();
    currentFocusIndex =
      currentFocusIndex > 0
        ? currentFocusIndex - 1
        : focusableElements.length - 1;
    setFocus(currentFocusIndex);
  }

  function setFocus(index) {
    if (index >= 0 && index < focusableElements.length) {
      const element = focusableElements[index];

      // Check if element is a table row
      if (element.tagName === "TR") {
        inTableMode = true;
        const rows = Array.from(
          document.querySelectorAll(".inventory-table tbody tr")
        );
        currentTableRow = rows.indexOf(element);
        currentTableColumn = 0;

        // Find focusable cells in this row
        const cells = element.querySelectorAll("button, [tabindex]");
        if (cells.length > 0) {
          cells[0].focus();
          cells[0].classList.add("keyboard-focus");
        } else {
          element.focus();
          element.classList.add("keyboard-focus");
        }
      } else {
        inTableMode = false;
        element.focus();
        element.classList.add("keyboard-focus");
      }

      // Scroll into view
      element.scrollIntoView({ behavior: "smooth", block: "nearest" });
    }
  }

  function setFocusOnElement(element) {
    const index = focusableElements.indexOf(element);
    if (index !== -1) {
      currentFocusIndex = index;
      setFocus(currentFocusIndex);
    }
  }

  function clearFocusIndicators() {
    document.querySelectorAll(".keyboard-focus").forEach((el) => {
      el.classList.remove("keyboard-focus");
    });
  }

  function clearCurrentFocus() {
    const currentElement = focusableElements[currentFocusIndex];
    if (
      currentElement &&
      (currentElement.tagName === "INPUT" ||
        currentElement.tagName === "TEXTAREA")
    ) {
      currentElement.value = "";
      showNotification("Field cleared", "info");
    }
  }

  function activateCurrentElement() {
    const element = focusableElements[currentFocusIndex];
    if (element) {
      if (element.tagName === "BUTTON" || element.tagName === "A") {
        element.click();
      } else if (element.tagName === "TR") {
        // Table row - find and click the view button
        const viewBtn = element.querySelector(".action-btn.view");
        if (viewBtn) {
          viewBtn.click();
        }
      } else if (
        element.classList.contains("expiring-item") ||
        element.classList.contains("stock-alert-item") ||
        element.classList.contains("batch-history-item")
      ) {
        // Sidebar item - simulate click
        element.click();
      } else if (element.classList.contains("stat-card")) {
        // Dashboard card - refresh data
        loadInventoryData();
        showNotification("Refreshing inventory data...", "info");
      } else if (element.id === "no-stock-section") {
        // Click on the no-stock sidebar card
        showAllOutOfStock();
      }
    }
  }

  function navigateTable(direction) {
    const rows = Array.from(
      document.querySelectorAll(".inventory-table tbody tr")
    );
    if (rows.length === 0) return;

    switch (direction) {
      case "down":
        if (currentTableRow < rows.length - 1) {
          currentTableRow++;
        }
        break;

      case "up":
        if (currentTableRow > 0) {
          currentTableRow--;
        }
        break;

      case "right":
        const currentRow = rows[currentTableRow];
        const cells = currentRow.querySelectorAll("button, [tabindex]");
        if (cells.length > 0) {
          if (currentTableColumn < cells.length - 1) {
            currentTableColumn++;
          }
        }
        break;

      case "left":
        if (currentTableColumn > 0) {
          currentTableColumn--;
        }
        break;
    }

    // Update focus
    const targetRow = rows[currentTableRow];
    const rowCells = targetRow.querySelectorAll("button, [tabindex]");

    clearFocusIndicators();

    if (rowCells.length > 0 && currentTableColumn < rowCells.length) {
      rowCells[currentTableColumn].focus();
      rowCells[currentTableColumn].classList.add("keyboard-focus");
      targetRow.classList.add("keyboard-focus");
    } else {
      targetRow.focus();
      targetRow.classList.add("keyboard-focus");
    }

    targetRow.scrollIntoView({ behavior: "smooth", block: "nearest" });
  }

  function setupModalKeyboardNavigation(modalId) {
    const modal = document.getElementById(modalId);
    if (!modal) return;

    isModalOpen = true;

    // Get all focusable elements in modal
    currentModalElements = Array.from(
      modal.querySelectorAll(
        'button, input, select, textarea, [tabindex]:not([tabindex="-1"])'
      )
    ).filter((el) => el.offsetParent !== null && !el.disabled);

    // Set focus on first element
    if (currentModalElements.length > 0) {
      setTimeout(() => {
        currentModalElements[0].focus();
        currentModalElements[0].classList.add("keyboard-focus");
      }, 100);
    }

    // Add keyboard event listener for modal
    const modalKeyHandler = (e) => {
      if (e.key === "Escape") {
        e.preventDefault();
        closeActiveModal();
      } else if (e.key === "Tab") {
        e.preventDefault();
        const currentIndex = currentModalElements.indexOf(
          document.activeElement
        );
        if (e.shiftKey) {
          const prevIndex =
            currentIndex > 0
              ? currentIndex - 1
              : currentModalElements.length - 1;
          currentModalElements[prevIndex].focus();
        } else {
          const nextIndex =
            (currentIndex + 1) % currentModalElements.length;
          currentModalElements[nextIndex].focus();
        }
      } else if (e.key === "Enter" && e.target.type !== "textarea") {
        if (e.target.type === "submit" || e.target.tagName === "BUTTON") {
          return; // Let default behavior
        } else {
          e.preventDefault();
          const currentIndex = currentModalElements.indexOf(
            document.activeElement
          );
          const nextIndex =
            (currentIndex + 1) % currentModalElements.length;
          currentModalElements[nextIndex].focus();
        }
      }
    };

    modal.addEventListener("keydown", modalKeyHandler);

    // Store handler for cleanup
    modal.dataset.keyHandler = modalKeyHandler;
  }

  function closeActiveModal() {
    const activeModal = document.querySelector(
      '.modal[style*="display: flex"], .modal[style*="display:flex"]'
    );
    if (activeModal) {
      // Remove keyboard handler
      if (activeModal.dataset.keyHandler) {
        activeModal.removeEventListener(
          "keydown",
          activeModal.dataset.keyHandler
        );
      }

      // Close modal
      if (activeModal.id === "productModal") closeProductModal();
      else if (activeModal.id === "batchModal") closeBatchModal();
      else if (activeModal.id === "datesModal") closeDatesModal();
      else if (activeModal.id === "detailModal") closeDetailModal();
    }

    isModalOpen = false;
    updateFocusableElements();
    setFocus(0);
  }

  function toggleFullscreen() {
    if (!document.fullscreenElement) {
      document.documentElement.requestFullscreen();
    } else if (document.exitFullscreen) {
      document.exitFullscreen();
    }
  }

  function showKeyboardHelp() {
    const helpText = `
╔══════════════════════════════════════════════════════════════╗
║                📦 INVENTORY - KEYBOARD SHORTCUTS 📦         ║
╠══════════════════════════════════════════════════════════════╣
║ NAVIGATION:                                                  ║
║   Tab / Shift+Tab  → Next/Previous element                   ║
║   Enter / Space    → Activate current element                ║
║   Esc              → Clear field / Close modal               ║
║   ↑↓←→             → Navigate table                          ║
║   Home / End       → First/Last element                      ║
║                                                              ║  
║ TABLE NAVIGATION:                                            ║
║   Enter on row    → View product details                     ║
║   Arrow keys      → Move between rows and action buttons     ║
║                                                              ║  
║ FUNCTION KEYS:                                               ║
║   F1  → This help                                            ║
║   F2  → Add new product                                      ║
║   F3  → Add new batch                                        ║
║   F4  → Update shelf life dates                              ║
║   F5  → Refresh inventory                                    ║
║   F6  → Export to CSV                                        ║
║   F7  → View first product                                   ║
║   F8  → Focus on products table                              ║
║   F9  → Quick save (in modal)                                ║
║   F10 → Quick close (in modal)                               ║
║   F11 → Toggle fullscreen                                    ║
║                                                              ║  
║ CONTROL SHORTCUTS (Ctrl+):                                   ║
║   N  → New product                                           ║
║   B  → Add batch                                             ║
║   E  → Export inventory                                      ║
║   R  → Refresh data                                          ║
║   F  → Focus search                                          ║
║   H  → Help                                                  ║
║   1  → First action button                                   ║
║                                                              ║  
║ ALT SHORTCUTS (Alt+):                                        ║
║   1 → Add Product                                            ║
║   2 → Add Batch                                              ║
║   3 → Update Dates                                           ║
║   4 → Export                                                 ║
║   5 → Products Table                                         ║
║   6 → Expiring Soon section                                  ║
║   7 → Low Stock section                                      ║
║   H → Help                                                   ║
║                                                              ║  
║ MODAL NAVIGATION:                                            ║
║   Tab / Shift+Tab → Navigate form fields                     ║
║   Enter           → Next field / Submit form                 ║
║   Esc             → Close modal                              ║
╚══════════════════════════════════════════════════════════════╝
    `;

    alert(helpText);
  }

  // ==================== INVENTORY MANAGEMENT FUNCTIONS ====================

  // Initialize Supabase
  async function initSupabase() {
    try {
      supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

      // Test the connection by making a simple query
      const { data, error } = await supabase
        .from("products")
        .select("count")
        .limit(1);

      if (error) throw error;

      console.log("Supabase connected successfully");
      updateConnectionStatus(true);
      await loadInventoryData();

      // Initialize keyboard navigation after data loads
      setTimeout(() => {
        initializeKeyboardNavigation();
      }, 500);

      return true;
    } catch (error) {
      console.error("Error connecting to Supabase:", error);
      updateConnectionStatus(false);
      showNotification("Database connection failed", "error");
      return false;
    }
  }

  // Function to update connection status display
  function updateConnectionStatus(isConnected) {
    const dbStatusElement = document.getElementById("dbStatus");
    const statusDot = dbStatusElement?.querySelector(".status-dot");
    const statusSpan = dbStatusElement?.querySelector("span");

    if (!dbStatusElement) return;

    if (isConnected) {
      dbStatusElement.classList.remove("disconnected");
      dbStatusElement.classList.add("connected");

      if (statusDot) {
        statusDot.classList.remove("disconnected");
        statusDot.classList.add("connected");
      }

      if (statusSpan) {
        statusSpan.textContent = "Supabase: Connected";
      }
    } else {
      dbStatusElement.classList.remove("connected");
      dbStatusElement.classList.add("disconnected");

      if (statusDot) {
        statusDot.classList.remove("connected");
        statusDot.classList.add("disconnected");
      }

      if (statusSpan) {
        statusSpan.textContent = "Supabase: Disconnected";
      }
    }
  }

  function generateProductCode(category, productName) {
    // Category prefixes
    const categoryPrefixes = {
      Cakes: "CK",
      Pastries: "PS",
      Decorations: "DC",
      Beverages: "BV",
    };

    const prefix = categoryPrefixes[category] || "PR";

    // Get existing product codes for this category
    const existingCodes = products
      .filter((p) => p.category === category)
      .map((p) => p.product_code)
      .filter((code) => code.startsWith(prefix));

    // Find the highest number used
    let maxNumber = 0;
    existingCodes.forEach((code) => {
      const match = code.match(/\d+$/);
      if (match) {
        const num = parseInt(match[0]);
        if (num > maxNumber) maxNumber = num;
      }
    });

    // Generate next number
    const nextNumber = maxNumber + 1;

    // Format number with leading zeros (e.g., 001, 002, etc.)
    const formattedNumber = nextNumber.toString().padStart(3, "0");

    return `${prefix}-${formattedNumber}`;
  }

  function updateProductCode() {
    const productNameInput = document.getElementById("productName");
    const categorySelect = document.getElementById("productCategory");
    const productCodeInput = document.getElementById("productCode");

    if (!productNameInput || !categorySelect || !productCodeInput) {
      return;
    }

    const productName = productNameInput.value.trim();
    const category = categorySelect.value;

    if (productName && category) {
      const generatedCode = generateProductCode(category, productName);
      productCodeInput.value = generatedCode;

      // Add visual feedback
      productCodeInput.style.color = "var(--success)";
      productCodeInput.style.fontWeight = "600";
    } else {
      productCodeInput.value = "";
    }
  }

  // Update the loadInventoryData function
  async function loadInventoryData() {
    try {
      // Load products
      const { data: productsData, error: productsError } = await supabase
        .from("products")
        .select("*")
        .order("product_name");

      if (productsError) throw productsError;
      products = productsData || [];

      // Load batches
      const { data: batchesData, error: batchesError } = await supabase
        .from("product_batches")
        .select("*");

      if (
        batchesError &&
        !batchesError.message.includes("does not exist")
      ) {
        throw batchesError;
      }
      batches = batchesData || [];

      // Update UI
      updateDashboard();

      // Instead of calling applyFilters(), update the table directly
      updateFilteredTable(); // This will show all products initially (no filters applied)

      updateSidebar();

      // Update keyboard navigation elements
      updateFocusableElements();
    } catch (error) {
      console.error("Error loading inventory:", error);
      showNotification("Failed to load inventory", "error");
    }
  }

  // Calculate product status based on batches
  function calculateProductStatus(product) {
    const productBatches = batches.filter(
      (b) => b.product_code === product.product_code
    );

    if (productBatches.length === 0) {
      return {
        totalStock: 0,
        expiringBatches: 0,
        earliestExpiry: null,
        status: "out_of_stock",
      };
    }

    // Calculate total stock
    const totalStock = productBatches.reduce(
      (sum, batch) => sum + (batch.remaining_quantity || 0),
      0
    );

    // Find earliest expiry date
    const validBatches = productBatches.filter((b) => {
      if (!b.expiry_date) return false;
      const expiry = new Date(b.expiry_date);
      return expiry >= today;
    });

    let earliestExpiry = null;
    let expiringSoon = 0;

    if (validBatches.length > 0) {
      // Sort by expiry date
      validBatches.sort(
        (a, b) => new Date(a.expiry_date) - new Date(b.expiry_date)
      );
      earliestExpiry = new Date(validBatches[0].expiry_date);

      // Count batches expiring in 3 days or less WITH remaining quantity
      expiringSoon = validBatches.filter((b) => {
        const expiry = new Date(b.expiry_date);
        const diffTime = expiry - today;
        const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
        const hasRemaining = (b.remaining_quantity || 0) > 0;
        return diffDays <= 3 && hasRemaining;
      }).length;
    }

    // Determine status - FIXED LOGIC
    let status = "in_stock";

    if (totalStock === 0) {
      status = "out_of_stock";
    } else if (totalStock >= 1 && totalStock <= 5) {
      status = "low_stock";
    } else if (expiringSoon > 0) {
      // IMPORTANT: A product is "expiring_soon" if it has ANY batch expiring soon
      // AND has stock > 0 (not out_of_stock)
      status = "expiring_soon";
    }

    return {
      totalStock,
      expiringBatches: expiringSoon,
      earliestExpiry,
      status,
      batches: productBatches,
    };
  }

  function updateDashboard() {
    let availableStock = 0; // This will include in_stock + low_stock + expiring_soon
    let lowStock = 0;
    let expiringSoon = 0;
    let outOfStock = 0;

    products.forEach((product) => {
      const status = calculateProductStatus(product);

      if (status.status === "out_of_stock") {
        outOfStock++;
      } else {
        // All other statuses (in_stock, low_stock, expiring_soon) are considered "available"
        availableStock++;

        // Still track low_stock and expiring_soon separately for their individual counters
        if (status.status === "low_stock") lowStock++;
        if (status.status === "expiring_soon") expiringSoon++;
      }
    });

    document.getElementById("totalProducts").textContent = products.length;
    document.getElementById("inStockCount").textContent = availableStock; // Now shows total available products
    document.getElementById("lowStockCount").textContent = lowStock;
    document.getElementById("expiringCount").textContent = expiringSoon;
    document.getElementById("outOfStockCount").textContent = outOfStock;
  }

  // Update inventory table function
  function updateInventoryTable() {
    const tbody = document.getElementById("inventoryTableBody");
    tbody.innerHTML = "";

    // Month names array for formatting
    const monthNames = [
      "January",
      "February",
      "March",
      "April",
      "May",
      "June",
      "July",
      "August",
      "September",
      "October",
      "November",
      "December",
    ];

    products.forEach((product) => {
      const status = calculateProductStatus(product);
      const row = document.createElement("tr");

      // Determine row class based on status
      if (status.status === "expiring_soon")
        row.classList.add("critical-item");
      else if (status.status === "low_stock")
        row.classList.add("warning-item");
      else if (status.status === "out_of_stock")
        row.classList.add("out-of-stock");

      // Batch info
      let batchInfo = "";
      if (status.batches && status.batches.length > 0) {
        const activeBatches = status.batches.filter((b) => {
          if (!b.expiry_date) return true;
          return new Date(b.expiry_date) >= today;
        });
        batchInfo = `<div style="font-size: 11px; color: #666;">${activeBatches.length} active batch(es)</div>`;
      }

      row.innerHTML = `
      <td>
          <div style="font-weight: 600;">${product.product_name}</div>
          <div style="font-size: 12px; color: #666;">${
            product.product_code
          }</div>
          ${batchInfo}
      </td>
      <td>
          <span class="category-badge">${product.category}</span>
      </td>
      <td>
          <div style="font-weight: 700; font-size: 18px; color: ${
            status.totalStock <= 5 ? "var(--danger)" : "var(--success)"
          }">
              ${status.totalStock}
          </div>
          <div style="font-size: 11px; color: #666;">units</div>
      </td>
      
      <td>
          <div style="font-weight: 700; color: var(--accent);">
              ₹${parseFloat(product.unit_price).toFixed(2)}
          </div>
      </td>
      <td>
          <div class="quick-actions">
              <button class="action-btn view" onclick="viewProduct('${
                product.id
              }')" title="View Details" tabindex="0">
                  <i class="fas fa-eye"></i>
              </button>
              <button class="action-btn edit" onclick="editProduct('${
                product.id
              }')" title="Edit" tabindex="0">
                  <i class="fas fa-edit"></i>
              </button>
          </div>
      </td>
  `;

      tbody.appendChild(row);
    });
  }

  // Update sidebar information
  function updateSidebar() {
    updateExpiringList();
    updateLowStockList();
    updateNoStockList();
    updateBatchHistory();
  }

  // Update expiring soon list
  function updateExpiringList() {
    const expiringList = document.getElementById("expiringList");
    expiringList.innerHTML = "";

    // Month names array
    const monthNames = [
      "January",
      "February",
      "March",
      "April",
      "May",
      "June",
      "July",
      "August",
      "September",
      "October",
      "November",
      "December",
    ];

    // Collect all expiring batches from all products
    let expiringBatches = [];

    products.forEach((product) => {
      const productBatches = batches.filter(
        (b) => b.product_code === product.product_code
      );

      productBatches.forEach((batch) => {
        if (batch.expiry_date) {
          const expiryDate = new Date(batch.expiry_date);
          const diffTime = expiryDate - today;
          const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));

          // Check if batch has remaining quantity and is expiring soon
          const remainingQuantity = batch.remaining_quantity || 0;

          // Show batches expiring in 3 days or less (including today)
          // AND only if there's actually quantity remaining
          if (diffDays <= 3 && diffDays >= 0 && remainingQuantity > 0) {
            expiringBatches.push({
              product: product,
              batch: batch,
              expiryDate: expiryDate,
              daysLeft: diffDays,
              quantity: remainingQuantity, // Use the actual remaining quantity
            });
          }
        }
      });
    });

    // Sort by days left (soonest first)
    expiringBatches.sort((a, b) => a.daysLeft - b.daysLeft);

    // Rest of the function remains the same...
    expiringBatches.forEach((item) => {
      // Format expiry date as DD MonthName
      const day = item.expiryDate.getDate();
      const month = monthNames[item.expiryDate.getMonth()];
      const formattedExpiry = `${day} ${month}`;

      // Determine badge color based on days left
      let badgeClass = "expiry-badge";
      if (item.daysLeft === 0) {
        badgeClass += " status-critical";
      } else if (item.daysLeft === 1) {
        badgeClass += " status-critical";
      } else if (item.daysLeft <= 3) {
        badgeClass += " status-low-stock";
      }

      const itemElement = document.createElement("div");
      itemElement.className = "expiring-item";
      itemElement.tabIndex = 0;
      itemElement.setAttribute("role", "button");
      itemElement.setAttribute(
        "aria-label",
        `View ${item.product.product_name} expiring in ${item.daysLeft} days`
      );

      itemElement.innerHTML = `
            <div style="flex: 1;">
                <div class="product-name">${item.product.product_name}</div>
                <div style="display: flex; justify-content: space-between; margin-top: 5px;">
                    <div class="expiry-date" style="font-size: 11px; color: #666;">
                        <i class="fas fa-calendar-day"></i> ${formattedExpiry}
                    </div>
                    <div style="font-size: 11px; color: var(--accent); font-weight: 600;">
                        <i class="fas fa-box"></i> ${item.quantity} units
                    </div>
                </div>
            </div>
            <div class="${badgeClass}">
                ${item.daysLeft === 0 ? "TODAY" : `${item.daysLeft}d`}
            </div>
        `;

      // Add click event
      itemElement.addEventListener("click", () => {
        viewProduct(item.product.id);
      });

      // Add keyboard event
      itemElement.addEventListener("keydown", (e) => {
        if (e.key === "Enter" || e.key === " ") {
          e.preventDefault();
          viewProduct(item.product.id);
        }
      });

      expiringList.appendChild(itemElement);
    });

    if (expiringBatches.length === 0) {
      expiringList.innerHTML =
        '<div style="text-align: center; padding: 20px; color: #999;">No items expiring soon</div>';
    }
  }

  // Update low stock list
  function updateLowStockList() {
    const lowStockList = document.getElementById("lowStockList");
    lowStockList.innerHTML = "";

    // Add month names array
    const monthNames = [
      "January",
      "February",
      "March",
      "April",
      "May",
      "June",
      "July",
      "August",
      "September",
      "October",
      "November",
      "December",
    ];

    const lowStockProducts = products
      .filter((product) => {
        const status = calculateProductStatus(product);
        return status.status === "low_stock";
      })
      .slice(0, 5);

    lowStockProducts.forEach((product) => {
      const status = calculateProductStatus(product);

      // Format the earliest expiry date as DD-month name
      let formattedExpiry = "";
      if (status.earliestExpiry) {
        const day = status.earliestExpiry.getDate();
        const month = monthNames[status.earliestExpiry.getMonth()];
        formattedExpiry = `${day} ${month}`;
      }

      const item = document.createElement("div");
      item.className = "stock-alert-item";
      item.tabIndex = 0;
      item.setAttribute("role", "button");
      item.setAttribute(
        "aria-label",
        `View ${product.product_name} with low stock`
      );

      item.innerHTML = `
          <div class="stock-info">
              <div>${product.product_name}</div>
              <div style="font-size: 11px; color: #666;">${product.product_code}</div>
          </div>
          <div class="stock-qty">${status.totalStock}</div>
      `;

      // Add click event
      item.addEventListener("click", () => {
        viewProduct(product.id);
      });

      // Add keyboard event
      item.addEventListener("keydown", (e) => {
        if (e.key === "Enter" || e.key === " ") {
          e.preventDefault();
          viewProduct(product.id);
        }
      });

      lowStockList.appendChild(item);
    });

    if (lowStockProducts.length === 0) {
      lowStockList.innerHTML =
        '<div style="text-align: center; padding: 20px; color: #999;">Stock levels are good</div>';
    }
  }

  // Update no stock list
  function updateNoStockList() {
    const noStockList = document.getElementById("noStockList");
    if (!noStockList) return;

    noStockList.innerHTML = "";

    const noStockProducts = products
      .filter((product) => {
        const status = calculateProductStatus(product);
        return status.status === "out_of_stock";
      })
      .slice(0, 5);

    noStockProducts.forEach((product) => {
      const status = calculateProductStatus(product);

      const item = document.createElement("div");
      item.className = "stock-alert-item";
      item.tabIndex = 0;
      item.setAttribute("role", "button");
      item.setAttribute(
        "aria-label",
        `View ${product.product_name} which is out of stock`
      );

      item.innerHTML = `
      <div class="stock-info">
          <div style="display: flex; align-items: center; gap: 8px;">
              <i class="fas fa-times-circle" style="color: var(--danger);"></i>
              <div>
                  <div style="font-weight: 600;">${product.product_name}</div>
                  <div style="font-size: 11px; color: #666; font-family: monospace;">${product.product_code}</div>
              </div>
          </div>
      </div>
      <div class="stock-qty">${status.totalStock}</div>
    `;

      item.addEventListener("click", () => {
        viewProduct(product.id);
      });

      item.addEventListener("keydown", (e) => {
        if (e.key === "Enter" || e.key === " ") {
          e.preventDefault();
          viewProduct(product.id);
        }
      });

      noStockList.appendChild(item);
    });

    if (noStockProducts.length === 0) {
      noStockList.innerHTML =
        '<div style="text-align: center; padding: 20px; color: #999; font-style: italic;">All products are in stock</div>';
    }
  }

  // Update batch history
  function updateBatchHistory() {
    const batchHistory = document.getElementById("batchHistory");
    batchHistory.innerHTML = "";

    // Month names array for formatting
    const monthNames = [
      "January",
      "February",
      "March",
      "April",
      "May",
      "June",
      "July",
      "August",
      "September",
      "October",
      "November",
      "December",
    ];

    // Get recent batches (last 5)
    const recentBatches = [...batches]
      .sort((a, b) => new Date(b.created_at) - new Date(a.created_at))
      .slice(0, 5);

    recentBatches.forEach((batch) => {
      const product = products.find(
        (p) => p.product_code === batch.product_code
      );
      if (!product) return;

      const item = document.createElement("div");
      item.className = "batch-history-item";
      item.tabIndex = 0;
      item.setAttribute("role", "button");
      item.setAttribute(
        "aria-label",
        `View ${product.product_name} batch details`
      );

      const expiryDate = batch.expiry_date
        ? new Date(batch.expiry_date)
        : null;
      const isExpired = expiryDate && expiryDate < today;

      // Format expiry date as "DD-month name"
      let formattedExpiry = "No expiry";
      let expiryDisplay = "";
      if (expiryDate) {
        const day = expiryDate.getDate();
        const month = monthNames[expiryDate.getMonth()];
        formattedExpiry = `${day} ${month}`;
        expiryDisplay = `
        <div style="font-size: 11px; color: ${
          isExpired ? "var(--danger)" : "#666"
        }; margin-top: 3px;">
          <i class="fas fa-calendar-times" style="margin-right: 5px;"></i>
          Expires: ${formattedExpiry}
        </div>
      `;
      }

      // Format created/manufacture date as "DD-month name"
      const createdDate = new Date(batch.created_at);
      const createdDay = createdDate.getDate();
      const createdMonth = monthNames[createdDate.getMonth()]; // CORRECT
      const formattedCreatedDate = `${createdDay} ${createdMonth}`;

      item.innerHTML = `
      <div>
          <div style="font-weight: 600; font-size: 14px;">${product.product_name}</div>
          <div style="font-size: 11px; color: #666;">
            ${batch.quantity} units
          </div>
      </div>
      <div style="text-align: right;">
          <div style="font-size: 11px; color: #666; margin-top: 3px;">
              <i class="fas fa-calendar-plus" style="margin-right: 5px;"></i>
              Made: ${formattedCreatedDate}
          </div>
          ${expiryDisplay}
      </div>
    `;

      // Add click event
      item.addEventListener("click", () => {
        const product = products.find(
          (p) => p.product_code === batch.product_code
        );
        if (product) {
          viewProduct(product.id);
        }
      });

      // Add keyboard event
      item.addEventListener("keydown", (e) => {
        if (e.key === "Enter" || e.key === " ") {
          e.preventDefault();
          const product = products.find(
            (p) => p.product_code === batch.product_code
          );
          if (product) {
            viewProduct(product.id);
          }
        }
      });

      batchHistory.appendChild(item);
    });

    if (recentBatches.length === 0) {
      batchHistory.innerHTML =
        '<div style="text-align: center; padding: 20px; color: #999;">No batches yet</div>';
    }
  }

  async function viewProduct(productId) {
    const product = products.find((p) => p.id === productId);
    if (!product) return;

    const productBatches = batches.filter(
      (b) => b.product_code === product.product_code
    );
    const status = calculateProductStatus(product);

    // Month names array
    const monthNames = [
      "January",
      "February",
      "March",
      "April",
      "May",
      "June",
      "July",
      "August",
      "September",
      "October",
      "November",
      "December",
    ];

    // Format expiry date in detail view
    let formattedEarliestExpiry = "";
    if (status.earliestExpiry) {
      const day = status.earliestExpiry.getDate();
      const month = monthNames[status.earliestExpiry.getMonth()];
      const year = status.earliestExpiry.getFullYear();
      formattedEarliestExpiry = `${day}-${month}-${year}`;
    }

    let batchesHTML = "";
    if (productBatches.length > 0) {
      batchesHTML = `
      <h4 style="color: var(--primary); margin: 20px 0 10px 0;">
          <i class="fas fa-layer-group"></i> Batches (${productBatches.length})
      </h4>
      <div style="max-height: 300px; overflow-y: auto;">
          <table style="width: 100%; border-collapse: collapse;">
              <thead>
                  <tr style="background-color: #f8f9fa;">
                      <th style="padding: 8px; text-align: left;">Batch ID</th>
                      <th style="padding: 8px; text-align: left;">Quantity</th>
                      <th style="padding: 8px; text-align: left;">Expiry</th>
                      <th style="padding: 8px; text-align: left;">Status</th>
                  </tr>
              </thead>
              <tbody>
                  ${productBatches
                    .map((batch) => {
                      const expiryDate = batch.expiry_date
                        ? new Date(batch.expiry_date)
                        : null;
                      const isExpired = expiryDate && expiryDate < today;
                      const diffDays = expiryDate
                        ? Math.ceil(
                            (expiryDate - today) / (1000 * 60 * 60 * 24)
                          )
                        : null;

                      let statusText = "Active";
                      let statusColor = "var(--success)";
                      if (isExpired) {
                        statusText = "Expired";
                        statusColor = "var(--danger)";
                      } else if (diffDays && diffDays <= 3) {
                        statusText = `${diffDays}d left`;
                        statusColor = "var(--warning)";
                      }

                      // Format batch expiry date
                      let formattedBatchExpiry = "N/A";
                      if (expiryDate) {
                        const day = expiryDate.getDate();
                        const month = monthNames[expiryDate.getMonth()];
                        const year = expiryDate.getFullYear();
                        formattedBatchExpiry = `${day}-${month}-${year}`;
                      }

                      return `
                          <tr style="border-bottom: 1px solid #eee;">
                              <td style="padding: 8px; font-family: monospace;">${batch.id.substring(
                                0,
                                8
                              )}</td>
                              <td style="padding: 8px;">${
                                batch.remaining_quantity || 0
                              }/${batch.quantity}</td>
                              <td style="padding: 8px;">${formattedBatchExpiry}</td>
                              <td style="padding: 8px; color: ${statusColor}; font-weight: 600;">${statusText}</td>
                          </tr>
                      `;
                    })
                    .join("")}
              </tbody>
          </table>
      </div>
  `;
    }

    document.getElementById(
      "detailTitle"
    ).innerHTML = `<i class="fas fa-info-circle"></i> ${product.product_name}`;
    document.getElementById("detailContent").innerHTML = `
  <div style="display: grid; gap: 15px;">
      <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
          <div>
              <label style="font-size: 12px; color: #666;">Product Code</label>
              <div style="font-weight: 600;">${product.product_code}</div>
          </div>
          <div>
              <label style="font-size: 12px; color: #666;">Category</label>
              <div style="font-weight: 600;">${product.category}</div>
          </div>
      </div>
      
      <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
          <div>
              <label style="font-size: 12px; color: #666;">Current Stock</label>
              <div style="font-weight: 700; font-size: 24px; color: ${
                status.totalStock <= 5 ? "var(--danger)" : "var(--success)"
              }">
                  ${status.totalStock} units
              </div>
          </div>
          <div>
              <label style="font-size: 12px; color: #666;">Unit Price</label>
              <div style="font-weight: 700; font-size: 24px; color: var(--accent);">
                  ₹${parseFloat(product.unit_price).toFixed(2)}
              </div>
          </div>
      </div>
      
      <div>
          <label style="font-size: 12px; color: #666;">Shelf Life</label>
          <div style="font-weight: 600;">${
            product.shelf_life_days || 7
          } days</div>
      </div>
      
      ${
        formattedEarliestExpiry
          ? `
          <div>
              <label style="font-size: 12px; color: #666;">Earliest Expiry</label>
              <div style="font-weight: 600; color: ${
                status.status === "expiring_soon"
                  ? "var(--warning)"
                  : "var(--success)"
              }">
                  ${formattedEarliestExpiry}
              </div>
          </div>
      `
          : ""
      }
      
      ${batchesHTML}
      
      <div style="margin-top: 20px; display: flex; gap: 10px;">
          <button type="button" class="btn btn-success" onclick="addBatchForProduct('${
            product.id
          }')" tabindex="0">
              <i class="fas fa-plus-circle"></i> Add Batch
          </button>
          <button type="button" class="btn" onclick="closeDetailModal()" style="background-color: #f0f0f0;" tabindex="0">
              Close
          </button>
      </div>
  </div>
`;

    document.getElementById("detailModal").style.display = "flex";
    setupModalKeyboardNavigation("detailModal");
  }

  // Add batch for specific product
  function addBatchForProduct(productId) {
    const product = products.find((p) => p.id === productId);
    if (!product) return;

    addBatchModal();

    // Auto-select the product
    setTimeout(() => {
      const dropdownInput = document.getElementById("batchProductInput");
      const hiddenInput = document.getElementById("batchProduct");
      const batchPriceInput = document.getElementById("batchPrice");
      const batchShelfLifeInput = document.getElementById("batchShelfLife");

      if (dropdownInput && hiddenInput) {
        dropdownInput.value = `${product.product_code} - ${product.product_name}`;
        hiddenInput.value = product.id;

        if (batchPriceInput) {
          batchPriceInput.value = parseFloat(product.unit_price).toFixed(2);
        }

        if (batchShelfLifeInput) {
          batchShelfLifeInput.value = product.shelf_life_days || 7;
        }

        // Focus on quantity field (NOT expiry date)
        document.getElementById("batchQuantity")?.focus();
      }
    }, 200);
  }

  function addProductModal() {
    document.getElementById("productModalTitle").innerHTML =
      '<i class="fas fa-plus"></i> Add New Product';
    document.getElementById("productForm").reset();
    document.getElementById("productModal").style.display = "flex";

    // Clear and disable product code field initially
    const productCodeInput = document.getElementById("productCode");
    productCodeInput.value = "";

    setupModalKeyboardNavigation("productModal");

    // Focus on product name field
    setTimeout(() => {
      const productNameInput = document.getElementById("productName");
      if (productNameInput) {
        productNameInput.focus();
        productNameInput.select();
      }
    }, 100);
  }

  function editProduct(productId) {
    const product = products.find((p) => p.id === productId);
    if (!product) return;

    document.getElementById("productModalTitle").innerHTML =
      '<i class="fas fa-edit"></i> Edit Product';
    document.getElementById("productCode").value = product.product_code;
    document.getElementById("productName").value = product.product_name;
    document.getElementById("productCategory").value = product.category;
    document.getElementById("productPrice").value = product.unit_price;
    document.getElementById("shelfLifeDays").value =
      product.shelf_life_days || 7;

    // Make code editable when editing
    const productCodeInput = document.getElementById("productCode");
    productCodeInput.readOnly = false;
    productCodeInput.style.backgroundColor = "white";
    productCodeInput.style.cursor = "text";
    productCodeInput.style.color = "var(--dark)";

    document.getElementById("productModal").style.display = "flex";
    setupModalKeyboardNavigation("productModal");
  }

  // Save product
  async function saveProduct(e) {
    e.preventDefault();

    const productData = {
      product_code: document.getElementById("productCode").value,
      product_name: document.getElementById("productName").value,
      category: document.getElementById("productCategory").value,
      unit_price: parseFloat(document.getElementById("productPrice").value),
      shelf_life_days: parseInt(
        document.getElementById("shelfLifeDays").value
      ),
      is_active: true,
      updated_at: new Date().toISOString(),
    };

    // Validate required fields
    if (
      !productData.product_name ||
      productData.product_name.trim() === ""
    ) {
      showNotification("Please enter a product name", "error");
      return;
    }

    if (
      !productData.product_code ||
      productData.product_code.trim() === ""
    ) {
      showNotification(
        "Please select a category to generate product code",
        "error"
      );
      return;
    }

    // Validate generated code
    if (!productData.product_code) {
      showNotification(
        "Please fill in product name and category to generate code",
        "error"
      );
      return;
    }

    try {
      // Check if product exists
      const existingProduct = products.find(
        (p) => p.product_code === productData.product_code
      );

      if (existingProduct) {
        // Update existing product
        const { error } = await supabase
          .from("products")
          .update(productData)
          .eq("id", existingProduct.id);

        if (error) throw error;
        showNotification("Product updated successfully", "success");
      } else {
        // Create new product
        productData.created_at = new Date().toISOString();

        const { error } = await supabase
          .from("products")
          .insert([productData]);

        if (error) throw error;
        showNotification("Product added successfully", "success");
      }

      // Close modal and reload
      closeProductModal();
      await loadInventoryData();
    } catch (error) {
      console.error("Error saving product:", error);
      showNotification("Failed to save product", "error");
    }
  }

  // Delete product
  async function deleteProduct(productId) {
    if (
      !confirm(
        "Are you sure you want to delete this product? This will also delete all associated batches."
      )
    ) {
      return;
    }

    try {
      // First delete batches
      const product = products.find((p) => p.id === productId);
      if (product) {
        await supabase
          .from("product_batches")
          .delete()
          .eq("product_code", product.product_code);
      }

      // Then delete product
      const { error } = await supabase
        .from("products")
        .delete()
        .eq("id", productId);

      if (error) throw error;

      showNotification("Product deleted successfully", "success");
      await loadInventoryData();
    } catch (error) {
      console.error("Error deleting product:", error);
      showNotification("Failed to delete product", "error");
    }
  }

  async function addBatchModal() {
    const dropdownOptions = document.getElementById("batchProductOptions");

    // Clear existing options
    dropdownOptions.innerHTML = "";

    // Add all products as options
    products.forEach((product) => {
      const status = calculateProductStatus(product);

      const option = document.createElement("div");
      option.className = "searchable-dropdown-option";
      option.dataset.value = product.id;
      option.dataset.price = product.unit_price;
      option.dataset.code = product.product_code;
      option.dataset.name = product.product_name;
      option.dataset.shelfLife = product.shelf_life_days || 7;

      option.innerHTML = `
      <div class="product-info">
          <span class="product-code">${product.product_code}</span>
          <span class="product-name">${product.product_name}</span>
          <span class="product-stock">Stock: ${status.totalStock} units</span>
      </div>
      <div class="product-price">₹${parseFloat(product.unit_price).toFixed(
        2
      )}</div>
  `;

      dropdownOptions.appendChild(option);
    });

    // Reset all fields
    document.getElementById("batchQuantity").value = "1";
    document.getElementById("batchPrice").value = "";
    document.getElementById("batchShelfLife").value = "";
    document.getElementById("batchProductInput").value = "";
    document.getElementById("batchProduct").value = "";

    // Set today's date as manufacture date
    const todayStr = today.toISOString().split("T")[0];
    document.getElementById("batchManufactureDate").value = todayStr;

    document.getElementById("batchModal").style.display = "flex";
    setupModalKeyboardNavigation("batchModal");

    // Focus on the main input field
    setTimeout(() => {
      document.getElementById("batchProductInput").focus();
      document.getElementById("batchProductInput").select();
    }, 100);
  }

  // Calculate expiry date
  function calculateExpiryDate(manufactureDate, shelfLifeDays) {
    const date = new Date(manufactureDate);
    date.setDate(date.getDate() + parseInt(shelfLifeDays));
    return date.toISOString().split("T")[0];
  }

  function initSearchableDropdown() {
    const dropdown = document.getElementById("batchProductDropdown");
    const dropdownInput = document.getElementById("batchProductInput");
    const dropdownToggle = document.getElementById("batchProductToggle");
    const dropdownOptions = document.getElementById("batchProductOptions");
    const hiddenInput = document.getElementById("batchProduct");
    const batchPriceInput = document.getElementById("batchPrice");
    const batchShelfLifeInput = document.getElementById("batchShelfLife");
    const batchManufactureDateInput = document.getElementById(
      "batchManufactureDate"
    );

    let filteredOptions = [];
    let selectedIndex = -1;

    // Close dropdown when clicking outside
    document.addEventListener("click", function (event) {
      if (!dropdown.contains(event.target)) {
        closeDropdown();
      }
    });

    // Toggle dropdown
    dropdownToggle.addEventListener("click", function (e) {
      e.stopPropagation();
      if (dropdownOptions.classList.contains("active")) {
        closeDropdown();
      } else {
        openDropdown();
      }
    });

    // Show dropdown when clicking input
    dropdownInput.addEventListener("click", function (e) {
      e.stopPropagation();
      openDropdown();
    });

    // Filter options based on input
    dropdownInput.addEventListener("input", function () {
      const searchTerm = this.value.toLowerCase();
      const options = dropdownOptions.querySelectorAll(
        ".searchable-dropdown-option"
      );

      // Reset selected index
      selectedIndex = -1;

      // Filter options
      filteredOptions = [];
      options.forEach((option, index) => {
        const productCode = option.dataset.code?.toLowerCase() || "";
        const productName = option.dataset.name?.toLowerCase() || "";

        if (
          productCode.includes(searchTerm) ||
          productName.includes(searchTerm)
        ) {
          option.style.display = "flex";
          filteredOptions.push({ option, index });
        } else {
          option.style.display = "none";
        }
      });

      // Auto-select first option if there are results
      if (filteredOptions.length > 0) {
        selectedIndex = 0;
        clearSelection();
        filteredOptions[0].option.classList.add("selected");
      }
    });

    // Select option on click
    dropdownOptions.addEventListener("click", function (event) {
      const option = event.target.closest(".searchable-dropdown-option");
      if (!option || option.style.display === "none") return;

      selectOption(option);
    });

    // Keyboard navigation
    dropdownInput.addEventListener("keydown", function (event) {
      if (!dropdownOptions.classList.contains("active")) {
        if (event.key === "ArrowDown" || event.key === "Enter") {
          event.preventDefault();
          openDropdown();
        }
        return;
      }

      switch (event.key) {
        case "ArrowDown":
          event.preventDefault();
          if (filteredOptions.length > 0) {
            selectedIndex = (selectedIndex + 1) % filteredOptions.length;
            updateSelection();
          }
          break;

        case "ArrowUp":
          event.preventDefault();
          if (filteredOptions.length > 0) {
            selectedIndex =
              selectedIndex <= 0
                ? filteredOptions.length - 1
                : selectedIndex - 1;
            updateSelection();
          }
          break;

        case "Enter":
          event.preventDefault();
          if (selectedIndex >= 0 && filteredOptions[selectedIndex]) {
            selectOption(filteredOptions[selectedIndex].option);
          } else if (filteredOptions.length === 1) {
            // If only one option matches, select it
            selectOption(filteredOptions[0].option);
          }
          break;

        case "Escape":
          event.preventDefault();
          closeDropdown();
          break;

        case "Tab":
          closeDropdown();
          break;
      }
    });

    // Helper functions
    function openDropdown() {
      dropdownOptions.classList.add("active");
      // Show all options initially
      const options = dropdownOptions.querySelectorAll(
        ".searchable-dropdown-option"
      );
      options.forEach((option) => (option.style.display = "flex"));
      filteredOptions = Array.from(options).map((option, index) => ({
        option,
        index,
      }));

      // Select first option if exists
      if (filteredOptions.length > 0) {
        selectedIndex = 0;
        clearSelection();
        filteredOptions[0].option.classList.add("selected");
      }
    }

    function closeDropdown() {
      dropdownOptions.classList.remove("active");
      selectedIndex = -1;
    }

    function clearSelection() {
      const selected = dropdownOptions.querySelector(
        ".searchable-dropdown-option.selected"
      );
      if (selected) {
        selected.classList.remove("selected");
      }
    }

    function updateSelection() {
      clearSelection();
      if (selectedIndex >= 0 && filteredOptions[selectedIndex]) {
        const option = filteredOptions[selectedIndex].option;
        option.classList.add("selected");
        option.scrollIntoView({ block: "nearest" });
      }
    }

    function selectOption(option) {
      const productId = option.dataset.value;
      const product = products.find((p) => p.id === productId);

      if (!product) return;

      // Update input field
      dropdownInput.value = `${product.product_code} - ${product.product_name}`;
      hiddenInput.value = productId;

      // Auto-fill price
      if (batchPriceInput) {
        batchPriceInput.value = parseFloat(product.unit_price).toFixed(2);
      }

      // Auto-fill shelf life
      if (batchShelfLifeInput) {
        batchShelfLifeInput.value = product.shelf_life_days || 7;
      }

      closeDropdown();

      // Focus on next field
      setTimeout(() => {
        document.getElementById("batchQuantity")?.focus();
        document.getElementById("batchQuantity")?.select();
      }, 50);
    }

    // Auto-calculate expiry when dates change
    [batchManufactureDateInput, batchShelfLifeInput].forEach((input) => {
      if (input) {
        input.addEventListener("change", function () {
          const productId = hiddenInput.value;
          const product = products.find((p) => p.id === productId);

          if (
            product &&
            batchManufactureDateInput.value &&
            batchShelfLifeInput.value
          ) {
            const expiryDate = calculateExpiryDate(
              batchManufactureDateInput.value,
              batchShelfLifeInput.value
            );

            if (batchExpiryDateInput) {
              batchExpiryDateInput.value = expiryDate;
            }

            if (expiryInfo) {
              expiryInfo.innerHTML = `
                      <i class="fas fa-calendar-check"></i> 
                      Expiry: ${new Date(expiryDate).toLocaleDateString()} 
                      (${batchShelfLifeInput.value} days from manufacture)
                  `;
            }
          }
        });
      }
    });
  }

  // Show all out of stock products in a modal
  function showAllOutOfStock() {
    const outOfStockProducts = products.filter((product) => {
      const status = calculateProductStatus(product);
      return status.status === "out_of_stock";
    });

    if (outOfStockProducts.length === 0) {
      showNotification("No out of stock products", "info");
      return;
    }

    // Month names for formatting
    const monthNames = [
      "January",
      "February",
      "March",
      "April",
      "May",
      "June",
      "July",
      "August",
      "September",
      "October",
      "November",
      "December",
    ];

    // Create modal content
    let modalContent = `
    <div class="modal-header">
      <h3><i class="fas fa-times-circle"></i> All Out of Stock Products (${outOfStockProducts.length})</h3>
      <button type="button" class="close-modal" onclick="closeOutOfStockModal()">
        <i class="fas fa-times"></i>
      </button>
    </div>
    <div style="max-height: 70vh; overflow-y: auto; padding: 10px;">
      <table style="width: 100%; border-collapse: collapse;">
        <thead>
          <tr style="background-color: #f8f9fa; position: sticky; top: 0;">
            <th style="padding: 12px; text-align: left; border-bottom: 2px solid #eee;">Product</th>
            <th style="padding: 12px; text-align: left; border-bottom: 2px solid #eee;">Category</th>
            <th style="padding: 12px; text-align: left; border-bottom: 2px solid #eee;">Code</th>
            <th style="padding: 12px; text-align: left; border-bottom: 2px solid #eee;">Price</th>
            <th style="padding: 12px; text-align: left; border-bottom: 2px solid #eee;">Stock</th>
            <th style="padding: 12px; text-align: left; border-bottom: 2px solid #eee;">Action</th>
          </tr>
        </thead>
        <tbody>
  `;

    outOfStockProducts.forEach((product) => {
      const status = calculateProductStatus(product);

      modalContent += `
      <tr style="border-bottom: 1px solid #eee; background-color: #fff5f5;">
        <td style="padding: 12px;">
          <div style="font-weight: 600;">${product.product_name}</div>
        </td>
        <td style="padding: 12px;">
          <span style="background-color: #f0f0f0; padding: 4px 8px; border-radius: 4px; font-size: 12px;">
            ${product.category}
          </span>
        </td>
        <td style="padding: 12px; font-family: monospace; color: var(--accent);">
          ${product.product_code}
        </td>
        <td style="padding: 12px; font-weight: 600; color: var(--accent);">
          ₹${parseFloat(product.unit_price).toFixed(2)}
        </td>
        <td style="padding: 12px;">
          <div style="font-weight: 800; color: var(--danger); font-size: 18px; text-align: center;">
            ${status.totalStock}
          </div>
        </td>
        <td style="padding: 12px;">
          <button class="btn btn-success" style="padding: 8px 12px; font-size: 12px;" 
                  onclick="addBatchForProduct('${
                    product.id
                  }'); closeOutOfStockModal();">
            <i class="fas fa-plus-circle"></i> Add Batch
          </button>
        </td>
      </tr>
    `;
    });

    modalContent += `
        </tbody>
      </table>
      
      <div style="margin-top: 20px; display: flex; gap: 10px; justify-content: center;">
        <button type="button" class="btn" onclick="closeOutOfStockModal()" style="background-color: #f0f0f0;">
          <i class="fas fa-times"></i> Close
        </button>
      </div>
    </div>
  `;

    // Create and show modal
    const modal = document.createElement("div");
    modal.className = "modal";
    modal.id = "outOfStockModal";
    modal.innerHTML = `
    <div class="modal-content" style="max-width: 900px;">
      ${modalContent}
    </div>
  `;

    document.body.appendChild(modal);
    modal.style.display = "flex";

    // Setup keyboard navigation for the modal
    setupModalKeyboardNavigation("outOfStockModal");
  }

  // Close the out of stock modal
  function closeOutOfStockModal() {
    const modal = document.getElementById("outOfStockModal");
    if (modal) {
      modal.style.display = "none";
      setTimeout(() => modal.remove(), 300);
      isModalOpen = false;
      updateFocusableElements();
      setFocus(0);
    }
  }
  
  // Save batch
  async function saveBatch(e) {
    e.preventDefault();

    const productId = document.getElementById("batchProduct").value;
    const product = products.find((p) => p.id === productId);
    if (!product) {
      showNotification("Please select a product", "error");
      return;
    }

    const quantity = parseInt(
      document.getElementById("batchQuantity").value
    );
    if (!quantity || quantity <= 0) {
      showNotification("Please enter a valid quantity", "error");
      return;
    }

    const unitCost = parseFloat(
      document.getElementById("batchPrice").value
    );
    if (!unitCost || unitCost <= 0) {
      showNotification("Please enter a valid cost per unit", "error");
      return;
    }

    const shelfLifeDays = parseInt(
      document.getElementById("batchShelfLife").value
    );
    if (!shelfLifeDays || shelfLifeDays <= 0) {
      showNotification("Please enter a valid shelf life", "error");
      return;
    }

    const manufactureDate = document.getElementById(
      "batchManufactureDate"
    ).value;
    if (!manufactureDate) {
      showNotification("Please select a manufacture date", "error");
      return;
    }

    // Calculate expiry date internally (not shown to user)
    const expiryDate = calculateExpiryDate(manufactureDate, shelfLifeDays);

    const batchData = {
      product_code: product.product_code,
      quantity: quantity,
      remaining_quantity: quantity,
      unit_cost: unitCost,
      manufacture_date: manufactureDate,
      expiry_date: expiryDate, // Now calculated internally
      shelf_life_days: shelfLifeDays,
      created_at: new Date().toISOString(),
    };

    // Validate dates (manufacture date should not be in future)
    const manufactureDateObj = new Date(batchData.manufacture_date);
    manufactureDateObj.setHours(0, 0, 0, 0); // Normalize manufacture date to start of day

    const todayDate = new Date();
    todayDate.setHours(0, 0, 0, 0); // Normalize today's date to start of day

    if (manufactureDateObj > todayDate) {
      showNotification("Manufacture date cannot be in the future", "error");
      return;
    }

    try {
      const { error } = await supabase
        .from("product_batches")
        .insert([batchData]);

      if (error) throw error;

      showNotification(
        `Batch added successfully! ${batchData.quantity} units of ${
          product.product_name
        } at ₹${unitCost.toFixed(2)} each`,
        "success"
      );

      // Close modal and reload data
      closeBatchModal();
      await loadInventoryData();
    } catch (error) {
      console.error("Error saving batch:", error);
      showNotification("Failed to add batch", "error");
    }
  }

  // Update dates (shelf life calculation)
  function updateDatesModal() {
    today = new Date();
    document.getElementById("currentDate").textContent =
      today.toLocaleDateString();
    document.getElementById("datesModal").style.display = "flex";
    setupModalKeyboardNavigation("datesModal");
  }

  // Confirm date update
  async function confirmUpdateDates() {
    showNotification("Shelf life updated for today", "success");
    await loadInventoryData();
    closeDatesModal();
  }

  // Export inventory
  async function exportInventory() {
    let csvContent = "data:text/csv;charset=utf-8,";
    csvContent +=
      "Product Code,Product Name,Category,Stock,Price,Shelf Life (Days),Status,Expiry Date\n";

    products.forEach((product) => {
      const status = calculateProductStatus(product);
      const expiryDate = status.earliestExpiry
        ? status.earliestExpiry.toLocaleDateString()
        : "";

      csvContent +=
        [
          product.product_code,
          `"${product.product_name}"`,
          product.category,
          status.totalStock,
          product.unit_price,
          product.shelf_life_days || 7,
          status.status,
          expiryDate,
        ].join(",") + "\n";
    });

    const encodedUri = encodeURI(csvContent);
    const link = document.createElement("a");
    link.setAttribute("href", encodedUri);
    link.setAttribute(
      "download",
      `inventory_${today.toISOString().split("T")[0]}.csv`
    );
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);

    showNotification("Inventory exported to CSV", "success");
  }

  // Close modals
  function closeProductModal() {
    document.getElementById("productModal").style.display = "none";
    isModalOpen = false;
    updateFocusableElements();
    setFocus(0);
  }

  function closeBatchModal() {
    document.getElementById("batchModal").style.display = "none";
    isModalOpen = false;
    updateFocusableElements();
    setFocus(0);
  }

  function closeDatesModal() {
    document.getElementById("datesModal").style.display = "none";
    isModalOpen = false;
    updateFocusableElements();
    setFocus(0);
  }

  function closeDetailModal() {
    document.getElementById("detailModal").style.display = "none";
    isModalOpen = false;
    updateFocusableElements();
    setFocus(0);
  }

  // Show notification
  function showNotification(message, type = "success") {
    const notification = document.createElement("div");
    notification.className = `notification ${type}`;
    notification.innerHTML = `
      <i class="fas fa-${
        type === "success"
          ? "check-circle"
          : type === "error"
          ? "exclamation-circle"
          : "info-circle"
      }"></i>
      <span>${message}</span>
  `;

    document.body.appendChild(notification);

    setTimeout(() => {
      notification.classList.add("show");
    }, 10);

    setTimeout(() => {
      notification.classList.remove("show");
      setTimeout(() => notification.remove(), 300);
    }, 3000);
  }

  // Add this to applyFilters function
  function highlightActiveFilters() {
    const filters = ["filterCategory", "filterStockStatus", "filterSearch"];

    filters.forEach((filterId) => {
      const element = document.getElementById(filterId);
      if (element.value) {
        element.classList.add("active-filter");
      } else {
        element.classList.remove("active-filter");
      }
    });
  }

  // Initialize the application
  document.addEventListener("DOMContentLoaded", async function () {
    await initSupabase();

    // Initialize searchable dropdown
    initSearchableDropdown();

    // Initialize filters
    initializeFilters();

    // Event listeners with keyboard accessibility
    document
      .getElementById("addProductBtn")
      .addEventListener("click", addProductModal);
    document
      .getElementById("addBatchBtn")
      .addEventListener("click", addBatchModal);
    document
      .getElementById("updateDatesBtn")
      .addEventListener("click", updateDatesModal);
    document
      .getElementById("exportBtn")
      .addEventListener("click", exportInventory);

    document
      .getElementById("productForm")
      .addEventListener("submit", saveProduct);
    document
      .getElementById("batchForm")
      .addEventListener("submit", saveBatch);

    document
      .getElementById("closeProductModal")
      .addEventListener("click", closeProductModal);
    document
      .getElementById("cancelProductBtn")
      .addEventListener("click", closeProductModal);

    document
      .getElementById("closeBatchModal")
      .addEventListener("click", closeBatchModal);
    document
      .getElementById("cancelBatchBtn")
      .addEventListener("click", closeBatchModal);

    document
      .getElementById("closeDatesModal")
      .addEventListener("click", closeDatesModal);
    document
      .getElementById("cancelDatesBtn")
      .addEventListener("click", closeDatesModal);
    document
      .getElementById("confirmUpdateDates")
      .addEventListener("click", confirmUpdateDates);

    document
      .getElementById("closeDetailModal")
      .addEventListener("click", closeDetailModal);
    
    // Add event listeners for auto-generating product code
    document
      .getElementById("productName")
      .addEventListener("input", updateProductCode);
    document
      .getElementById("productCategory")
      .addEventListener("change", updateProductCode);
    
    // Set today's date
    today = new Date();

    // Show welcome message with keyboard tips
    setTimeout(() => {
      showNotification(
        "Press F1 for keyboard shortcuts. Use Tab to navigate, Enter to activate.",
        "info"
      );
    }, 1500);

    // Call this when switching back to inventory page
    window.addEventListener("focus", async function () {
      await loadInventoryData();
    });
  });
})();
</script>
  </body>
</html>
