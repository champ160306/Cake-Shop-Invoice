<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Cake Bliss | WhatsApp Promotions Manager</title>
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    />
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
      }

      :root {
        --primary: #ff7bac;
        --secondary: #ffb347;
        --accent: #9d4edd;
        --light: #fff9fb;
        --dark: #333333;
        --success: #4caf50;
        --warning: #ff9800;
        --danger: #f44336;
        --info: #2196f3;
      }

      body {
        background: linear-gradient(135deg, #ffecd2 0%, #fcb69f 100%);
        color: var(--dark);
        min-height: 100vh;
        padding: 20px;
      }

      .container {
        max-width: 1400px;
        margin: 0 auto;
      }

      /* Header */
      header {
        background-color: white;
        border-radius: 20px;
        padding: 25px 40px;
        margin-bottom: 30px;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.08);
        display: flex;
        justify-content: space-between;
        align-items: center;
        flex-wrap: wrap;
      }

      .logo-container {
        display: flex;
        align-items: center;
        gap: 15px;
      }

      .logo {
        width: 60px;
        height: 60px;
        background: linear-gradient(45deg, var(--primary), var(--secondary));
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-size: 28px;
      }

      .logo-text h1 {
        color: var(--primary);
        font-size: 28px;
        font-weight: 800;
        letter-spacing: 1px;
      }

      .logo-text p {
        color: var(--dark);
        font-size: 14px;
        opacity: 0.8;
      }

      .header-stats {
        display: flex;
        gap: 20px;
        margin-top: 10px;
      }

      .stat-item {
        background: var(--light);
        padding: 8px 15px;
        border-radius: 10px;
        font-size: 13px;
        font-weight: 600;
      }

      .stat-item i {
        margin-right: 5px;
        color: var(--accent);
      }

      nav ul {
        display: flex;
        list-style: none;
        gap: 25px;
      }

      nav a {
        text-decoration: none;
        color: var(--dark);
        font-weight: 600;
        font-size: 16px;
        padding: 8px 15px;
        border-radius: 50px;
        transition: all 0.3s ease;
      }

      nav a:hover,
      nav a.active {
        background-color: var(--primary);
        color: white;
      }

      /* Main Content */
      .main-content {
        display: grid;
        grid-template-columns: 1fr;
        gap: 30px;
      }

      /* Campaign Cards */
      .campaign-card {
        background-color: white;
        border-radius: 20px;
        padding: 30px;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.08);
        margin-bottom: 30px;
      }

      .campaign-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 25px;
        padding-bottom: 15px;
        border-bottom: 2px solid var(--light);
      }

      .campaign-title {
        display: flex;
        align-items: center;
        gap: 15px;
      }

      .campaign-icon {
        width: 50px;
        height: 50px;
        background: linear-gradient(45deg, var(--primary), var(--secondary));
        border-radius: 12px;
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-size: 24px;
      }

      .campaign-title h2 {
        color: var(--primary);
        font-size: 24px;
      }

      .campaign-title p {
        color: #666;
        font-size: 14px;
        margin-top: 5px;
      }

      .campaign-stats {
        display: flex;
        gap: 15px;
      }

      .stat-badge {
        background: var(--light);
        padding: 8px 15px;
        border-radius: 10px;
        font-weight: 600;
        font-size: 14px;
        display: flex;
        align-items: center;
        gap: 8px;
      }

      .stat-badge i {
        color: var(--accent);
      }

      /* Customer List */
      .customer-list {
        max-height: 500px;
        overflow-y: auto;
        margin-top: 20px;
      }

      .customer-item {
        display: grid;
        grid-template-columns: 2fr 1fr 1fr 1fr auto;
        gap: 15px;
        align-items: center;
        padding: 20px;
        border-bottom: 1px solid #eee;
        transition: all 0.3s ease;
      }

      .customer-item:hover {
        background-color: var(--light);
      }

      .customer-info h4 {
        color: var(--dark);
        font-size: 16px;
        margin-bottom: 5px;
      }

      .customer-info .customer-phone {
        font-size: 13px;
        color: #666;
        background: #f5f5f5;
        padding: 3px 8px;
        border-radius: 4px;
        display: inline-block;
        margin-top: 5px;
      }

      .customer-type {
        display: flex;
        align-items: center;
        gap: 8px;
      }

      .type-badge {
        padding: 4px 10px;
        border-radius: 20px;
        font-size: 12px;
        font-weight: 600;
        text-transform: uppercase;
      }

      .type-badge.purchaser {
        background-color: rgba(var(--primary-rgb), 0.1);
        color: var(--primary);
      }

      .type-badge.birthday-person {
        background-color: rgba(var(--accent-rgb), 0.1);
        color: var(--accent);
      }

      .customer-date {
        font-size: 14px;
        color: #666;
      }

      .customer-date i {
        color: var(--primary);
        margin-right: 5px;
      }

      .customer-amount {
        font-size: 18px;
        font-weight: 700;
        color: var(--accent);
        text-align: center;
      }

      .action-buttons {
        display: flex;
        gap: 10px;
      }

      .btn-whatsapp {
        background-color: #25d366;
        color: white;
        border: none;
        padding: 10px 20px;
        border-radius: 10px;
        cursor: pointer;
        font-weight: 600;
        display: flex;
        align-items: center;
        gap: 8px;
        transition: all 0.3s;
        white-space: nowrap;
      }

      .btn-whatsapp:hover {
        background-color: #1da851;
        transform: translateY(-2px);
        box-shadow: 0 5px 15px rgba(37, 211, 102, 0.3);
      }

      .btn-whatsapp:disabled {
        background-color: #cccccc;
        cursor: not-allowed;
        transform: none;
        box-shadow: none;
      }

      .btn-whatsapp.sending {
        background-color: var(--warning);
      }

      /* Message Preview */
      .message-preview {
        background: var(--light);
        border-radius: 15px;
        padding: 20px;
        margin-top: 20px;
        border-left: 4px solid var(--accent);
        display: none;
      }

      .message-preview.show {
        display: block;
        animation: slideDown 0.3s ease;
      }

      @keyframes slideDown {
        from {
          opacity: 0;
          transform: translateY(-10px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      .preview-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 15px;
      }

      .preview-header h4 {
        color: var(--primary);
        display: flex;
        align-items: center;
        gap: 10px;
      }

      .message-content {
        background: white;
        padding: 15px;
        border-radius: 10px;
        font-size: 14px;
        line-height: 1.5;
        white-space: pre-wrap;
        max-height: 200px;
        overflow-y: auto;
        font-family: "Segoe UI", Arial, sans-serif;
      }

      /* Notification */
      .notification {
        position: fixed;
        top: 20px;
        right: 20px;
        padding: 15px 25px;
        border-radius: 12px;
        color: white;
        font-weight: 600;
        z-index: 1000;
        display: flex;
        align-items: center;
        gap: 10px;
        transform: translateX(150%);
        transition: transform 0.3s ease;
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
      }

      .notification.show {
        transform: translateX(0);
      }

      .notification.success {
        background-color: var(--success);
      }

      .notification.info {
        background-color: var(--info);
      }

      .notification.warning {
        background-color: var(--warning);
      }

      .notification.error {
        background-color: var(--danger);
      }

      /* Loading State */
      .loading {
        text-align: center;
        padding: 40px;
        color: #666;
      }

      .loading i {
        margin-right: 10px;
        animation: spin 1s linear infinite;
      }

      @keyframes spin {
        0% {
          transform: rotate(0deg);
        }
        100% {
          transform: rotate(360deg);
        }
      }

      /* Empty State */
      .empty-state {
        text-align: center;
        padding: 40px;
        color: #666;
      }

      .empty-state i {
        font-size: 48px;
        color: #ddd;
        margin-bottom: 15px;
      }

      /* Dashboard Summary */
      .dashboard-summary {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 20px;
        margin-bottom: 30px;
      }

      .summary-card {
        background: white;
        border-radius: 15px;
        padding: 25px;
        box-shadow: 0 5px 20px rgba(0, 0, 0, 0.05);
        display: flex;
        align-items: center;
        gap: 20px;
        transition: transform 0.3s ease;
      }

      .summary-card:hover {
        transform: translateY(-5px);
      }

      .summary-icon {
        width: 60px;
        height: 60px;
        border-radius: 12px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 24px;
        color: white;
      }

      .summary-icon.birthdays {
        background: linear-gradient(45deg, #ff7bac, #ff4081);
      }

      .summary-icon.high-ticket {
        background: linear-gradient(45deg, #ffb347, #ff9800);
      }

      .summary-icon.gifting {
        background: linear-gradient(45deg, #9d4edd, #7b1fa2);
      }

      .summary-content h3 {
        font-size: 14px;
        color: #666;
        margin-bottom: 5px;
      }

      .summary-content .count {
        font-size: 32px;
        font-weight: 800;
        color: var(--dark);
        line-height: 1;
      }

      .summary-content .subtext {
        font-size: 12px;
        color: #999;
        margin-top: 5px;
      }

      /* Responsive Design */
      @media (max-width: 992px) {
        .customer-item {
          grid-template-columns: 1fr;
          gap: 10px;
        }

        .campaign-header {
          flex-direction: column;
          align-items: flex-start;
          gap: 15px;
        }

        .campaign-stats {
          width: 100%;
          justify-content: space-between;
        }
      }

      @media (max-width: 768px) {
        header {
          flex-direction: column;
          gap: 20px;
        }

        nav ul {
          flex-wrap: wrap;
          justify-content: center;
        }

        .dashboard-summary {
          grid-template-columns: 1fr;
        }
      }

      /* Filter Controls */
      .filter-controls {
        background: var(--light);
        border-radius: 15px;
        padding: 20px;
        margin-bottom: 20px;
        display: flex;
        flex-wrap: wrap;
        gap: 15px;
        align-items: center;
      }

      .filter-group {
        display: flex;
        align-items: center;
        gap: 10px;
      }

      .filter-group label {
        font-weight: 600;
        font-size: 14px;
        color: var(--dark);
      }

      .filter-group select,
      .filter-group input {
        padding: 8px 12px;
        border: 2px solid #eee;
        border-radius: 8px;
        font-size: 14px;
        min-width: 150px;
      }

      .refresh-btn {
        background: var(--accent);
        color: white;
        border: none;
        padding: 10px 20px;
        border-radius: 8px;
        cursor: pointer;
        font-weight: 600;
        display: flex;
        align-items: center;
        gap: 8px;
        margin-left: auto;
      }

      .refresh-btn:hover {
        background: #8a2be2;
        transform: translateY(-2px);
      }

      /* Connection Status */
      .connection-status {
        display: inline-flex;
        align-items: center;
        gap: 8px;
        padding: 5px 12px;
        border-radius: 50px;
        font-size: 14px;
        font-weight: 600;
        margin-top: 10px;
      }

      .connection-status.connected {
        background-color: rgba(76, 175, 80, 0.1);
        color: var(--success);
      }

      .connection-status.disconnected {
        background-color: rgba(244, 67, 54, 0.1);
        color: var(--danger);
      }

      .status-dot {
        width: 10px;
        height: 10px;
        border-radius: 50%;
      }

      .status-dot.connected {
        background-color: var(--success);
        animation: pulse 2s infinite;
      }

      .status-dot.disconnected {
        background-color: var(--danger);
      }

      @keyframes pulse {
        0% {
          opacity: 1;
        }
        50% {
          opacity: 0.5;
        }
        100% {
          opacity: 1;
        }
      }
    </style>
  </head>
  <body>
    <div class="container">
      <!-- Header -->
      <header>
        <div class="logo-container">
          <div class="logo">
            <i class="fas fa-birthday-cake"></i>
          </div>
          <div class="logo-text">
            <h1>Cake Bliss</h1>
            <p>WhatsApp Promotions Manager</p>
            <div id="dbStatus" class="connection-status disconnected">
              <div class="status-dot disconnected"></div>
              <span>Database: Disconnected</span>
            </div>
            <div class="header-stats">
              <div class="stat-item">
                <i class="fas fa-users"></i>
                <span id="totalCustomers">0</span> customers
              </div>
              <div class="stat-item">
                <i class="fas fa-paper-plane"></i>
                <span id="totalSent">0</span> sent today
              </div>
            </div>
          </div>
        </div>
        <nav>
          <ul>
            <li>
              <a href="billing.html"><i class="fas fa-receipt"></i> Billing</a>
            </li>
            <li>
              <a href="#" class="active"
                ><i class="fas fa-bullhorn"></i> Promotions</a
              >
            </li>
            <li>
              <a href="inventory.html"
                ><i class="fas fa-boxes"></i> Inventory</a
              >
            </li>
          </ul>
        </nav>
      </header>

      <!-- Dashboard Summary -->
      <div class="dashboard-summary">
        <div class="summary-card">
          <div class="summary-icon birthdays">
            <i class="fas fa-birthday-cake"></i>
          </div>
          <div class="summary-content">
            <h3>Upcoming Birthdays</h3>
            <div class="count" id="birthdayCount">0</div>
            <div class="subtext">Next 3 days</div>
          </div>
        </div>
        <div class="summary-card">
          <div class="summary-icon high-ticket">
            <i class="fas fa-crown"></i>
          </div>
          <div class="summary-content">
            <h3>High Ticket Customers</h3>
            <div class="count" id="highTicketCount">0</div>
            <div class="subtext">Last 30 days</div>
          </div>
        </div>
        <div class="summary-card">
          <div class="summary-icon gifting">
            <i class="fas fa-gift"></i>
          </div>
          <div class="summary-content">
            <h3>Gifting Opportunities</h3>
            <div class="count" id="giftingCount">0</div>
            <div class="subtext">Reciprocity reminders</div>
          </div>
        </div>
      </div>

      <!-- Filter Controls -->
      <div class="filter-controls">
        <div class="filter-group">
          <label for="daysFilter"
            ><i class="fas fa-calendar"></i> Birthday Range:</label
          >
          <select id="daysFilter">
            <option value="3">Next 3 days</option>
            <option value="7">Next 7 days</option>
            <option value="30">Next 30 days</option>
          </select>
        </div>
        <div class="filter-group">
          <label for="amountFilter"
            ><i class="fas fa-rupee-sign"></i> Min Amount:</label
          >
          <select id="amountFilter">
            <option value="1000">‚Çπ1,000+</option>
            <option value="2000">‚Çπ2,000+</option>
            <option value="5000">‚Çπ5,000+</option>
          </select>
        </div>
        <button id="refreshBtn" class="refresh-btn">
          <i class="fas fa-sync-alt"></i> Refresh Data
        </button>
      </div>

      <!-- Campaign 1: Upcoming Birthdays -->
      <div class="campaign-card">
        <div class="campaign-header">
          <div class="campaign-title">
            <div class="campaign-icon">
              <i class="fas fa-birthday-cake"></i>
            </div>
            <div>
              <h2>üéÇ Upcoming Birthdays</h2>
              <p>Send birthday offers to customers with upcoming birthdays</p>
            </div>
          </div>
          <div class="campaign-stats">
            <div class="stat-badge">
              <i class="fas fa-user"></i>
              <span id="birthdayStats">0 customers</span>
            </div>
          </div>
        </div>

        <div class="customer-list" id="birthdayList">
          <div class="loading">
            <i class="fas fa-spinner fa-spin"></i> Loading upcoming birthdays...
          </div>
        </div>
      </div>

      <!-- Campaign 2: High Ticket Customers -->
      <div class="campaign-card">
        <div class="campaign-header">
          <div class="campaign-title">
            <div class="campaign-icon">
              <i class="fas fa-crown"></i>
            </div>
            <div>
              <h2>üëë High Ticket Customers</h2>
              <p>Reward your highest spending customers from last month</p>
            </div>
          </div>
          <div class="campaign-stats">
            <div class="stat-badge">
              <i class="fas fa-rupee-sign"></i>
              <span id="highTicketStats">0 customers</span>
            </div>
          </div>
        </div>

        <div class="customer-list" id="highTicketList">
          <div class="loading">
            <i class="fas fa-spinner fa-spin"></i> Loading high ticket
            customers...
          </div>
        </div>
      </div>

      <!-- Campaign 3: Gifting Reciprocity -->
      <div class="campaign-card">
        <div class="campaign-header">
          <div class="campaign-title">
            <div class="campaign-icon">
              <i class="fas fa-gift"></i>
            </div>
            <div>
              <h2>üéÅ Gifting Reciprocity</h2>
              <p>
                Remind customers who received cakes that their gifter's birthday
                is coming up
              </p>
            </div>
          </div>
          <div class="campaign-stats">
            <div class="stat-badge">
              <i class="fas fa-exchange-alt"></i>
              <span id="giftingStats">0 opportunities</span>
            </div>
          </div>
        </div>

        <div class="customer-list" id="giftingList">
          <div class="loading">
            <i class="fas fa-spinner fa-spin"></i> Loading gifting
            opportunities...
          </div>
        </div>
      </div>

      <!-- Message Preview -->
      <div id="messagePreview" class="message-preview">
        <div class="preview-header">
          <h4><i class="fab fa-whatsapp"></i> WhatsApp Message Preview</h4>
          <button
            onclick="closePreview()"
            style="background: none; border: none; color: #666; cursor: pointer"
          >
            <i class="fas fa-times"></i>
          </button>
        </div>
        <div id="previewContent" class="message-content">
          Message will appear here...
        </div>
      </div>

      <!-- Notification -->
      <div id="notification" class="notification">
        <i class="fas fa-check-circle"></i>
        <span>Notification message</span>
      </div>
    </div>

    <script>
      // Configuration
      const DEFAULT_CONFIG = {
        supabaseUrl: "https://vdbwzmutxjonnpfwfpbn.supabase.co",
        supabaseKey:
          "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZkYnd6bXV0eGpvbm5wZndmcGJuIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQ5OTcwMjQsImV4cCI6MjA4MDU3MzAyNH0.n0ERxgLgYU1Tvw5QONihv1C3A7o7rcxrcn5MjZ5UnEM",
      };

      let supabase = null;
      let isConnected = false;
      let config = DEFAULT_CONFIG;
      let dailySendCount = 0;
      const MAX_DAILY_SENDS = 50; // Safe limit to avoid WhatsApp bans

      // Initialize when page loads
      document.addEventListener("DOMContentLoaded", async function () {
        await initSupabase();
        loadDailyCount();
        loadAllCampaigns();
        setupEventListeners();
      });

      // Initialize Supabase
      async function initSupabase() {
        try {
          config = DEFAULT_CONFIG;
          supabase = window.supabase.createClient(
            config.supabaseUrl,
            config.supabaseKey
          );

          // Test connection
          const { data, error } = await supabase
            .from("cake_bills")
            .select("id")
            .limit(1);

          if (error) throw error;

          updateDbStatus(true);
          showNotification("Connected to database", "success");
          return true;
        } catch (error) {
          console.error("Failed to connect to Supabase:", error);
          updateDbStatus(false);
          showNotification("Database connection failed", "error");
          return false;
        }
      }

      function updateDbStatus(connected) {
        isConnected = connected;
        const dbStatus = document.getElementById("dbStatus");
        const statusDot = dbStatus.querySelector(".status-dot");
        const statusText = dbStatus.querySelector("span");

        if (connected) {
          dbStatus.className = "connection-status connected";
          statusDot.className = "status-dot connected";
          statusText.textContent = "Database: Connected";
        } else {
          dbStatus.className = "connection-status disconnected";
          statusDot.className = "status-dot disconnected";
          statusText.textContent = "Database: Disconnected";
        }
      }

      // Load all campaigns
      async function loadAllCampaigns() {
        if (!isConnected) {
          showNotification("Please connect to database first", "error");
          return;
        }

        const days = parseInt(document.getElementById("daysFilter").value);
        const minAmount = parseInt(
          document.getElementById("amountFilter").value
        );

        await Promise.all([
          loadUpcomingBirthdays(days),
          loadHighTicketCustomers(minAmount),
          loadGiftingOpportunities(days),
        ]);
      }

      // 1. Upcoming Birthdays Campaign
      async function loadUpcomingBirthdays(days = 3) {
        const container = document.getElementById("birthdayList");
        container.innerHTML =
          '<div class="loading"><i class="fas fa-spinner fa-spin"></i> Loading upcoming birthdays...</div>';

        try {
          const today = new Date();
          const futureDate = new Date();
          futureDate.setDate(today.getDate() + days);

          // Format dates for query
          const todayStr = today.toISOString().split("T")[0];
          const futureStr = futureDate.toISOString().split("T")[0];

          // Query for upcoming birthdays from both purchaser and birthday person
          const { data: bills, error } = await supabase
            .from("cake_bills")
            .select("*")
            .order("created_at", { ascending: false });

          if (error) throw error;

          // Process and filter for upcoming birthdays
          const birthdayCustomers = [];
          const seenPhones = new Set();

          bills.forEach((bill) => {
            // Check purchaser birthday
            if (bill.purchaser_birthdate) {
              const purchaserBirthday = new Date(bill.purchaser_birthdate);
              const thisYearBirthday = new Date(
                today.getFullYear(),
                purchaserBirthday.getMonth(),
                purchaserBirthday.getDate()
              );

              if (thisYearBirthday >= today && thisYearBirthday <= futureDate) {
                if (!seenPhones.has(bill.purchaser_phone)) {
                  birthdayCustomers.push({
                    name: bill.purchaser_name,
                    phone: bill.purchaser_phone,
                    birthday: bill.purchaser_birthdate,
                    type: "purchaser",
                    lastPurchase: bill.created_at,
                    totalSpent: parseFloat(bill.total_price) || 0,
                  });
                  seenPhones.add(bill.purchaser_phone);
                }
              }
            }

            // Check birthday person's birthday
            if (bill.birthday_person_birthdate) {
              const birthdayPersonBirthday = new Date(
                bill.birthday_person_birthdate
              );
              const thisYearBirthday = new Date(
                today.getFullYear(),
                birthdayPersonBirthday.getMonth(),
                birthdayPersonBirthday.getDate()
              );

              if (thisYearBirthday >= today && thisYearBirthday <= futureDate) {
                if (
                  !seenPhones.has(
                    bill.birthday_person_phone || bill.purchaser_phone
                  )
                ) {
                  birthdayCustomers.push({
                    name: bill.birthday_person_name,
                    phone: bill.birthday_person_phone || bill.purchaser_phone,
                    birthday: bill.birthday_person_birthdate,
                    type: "birthday_person",
                    lastPurchase: bill.created_at,
                    totalSpent: parseFloat(bill.total_price) || 0,
                  });
                  if (bill.birthday_person_phone)
                    seenPhones.add(bill.birthday_person_phone);
                }
              }
            }
          });

          // Update stats
          document.getElementById("birthdayCount").textContent =
            birthdayCustomers.length;
          document.getElementById(
            "birthdayStats"
          ).textContent = `${birthdayCustomers.length} customers`;
          updateTotalStats();

          // Display customers
          if (birthdayCustomers.length === 0) {
            container.innerHTML =
              '<div class="empty-state"><i class="fas fa-birthday-cake"></i><p>No upcoming birthdays in selected range</p></div>';
            return;
          }

          container.innerHTML = "";
          birthdayCustomers.forEach((customer) => {
            const customerElement = createCustomerElement(customer, "birthday");
            container.appendChild(customerElement);
          });
        } catch (error) {
          console.error("Error loading birthdays:", error);
          container.innerHTML =
            '<div class="empty-state"><i class="fas fa-exclamation-triangle"></i><p>Failed to load birthdays</p></div>';
        }
      }

      // 2. High Ticket Customers Campaign
      async function loadHighTicketCustomers(minAmount = 1000) {
        const container = document.getElementById("highTicketList");
        container.innerHTML =
          '<div class="loading"><i class="fas fa-spinner fa-spin"></i> Loading high ticket customers...</div>';

        try {
          // Calculate date 30 days ago
          const thirtyDaysAgo = new Date();
          thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30);

          // Get bills from last 30 days
          const { data: bills, error } = await supabase
            .from("cake_bills")
            .select("*")
            .gte("created_at", thirtyDaysAgo.toISOString())
            .order("total_price", { ascending: false });

          if (error) throw error;

          // Aggregate by customer and filter by amount
          const customerMap = new Map();

          bills.forEach((bill) => {
            const phone = bill.purchaser_phone;
            const amount = parseFloat(bill.total_price) || 0;

            if (customerMap.has(phone)) {
              const existing = customerMap.get(phone);
              existing.totalSpent += amount;
              existing.lastPurchase =
                bill.created_at > existing.lastPurchase
                  ? bill.created_at
                  : existing.lastPurchase;
            } else {
              customerMap.set(phone, {
                name: bill.purchaser_name,
                phone: phone,
                totalSpent: amount,
                lastPurchase: bill.created_at,
                billCount: 1,
              });
            }
          });

          // Filter by minimum amount and convert to array
          const highTicketCustomers = Array.from(customerMap.values())
            .filter((customer) => customer.totalSpent >= minAmount)
            .sort((a, b) => b.totalSpent - a.totalSpent);

          // Update stats
          document.getElementById("highTicketCount").textContent =
            highTicketCustomers.length;
          document.getElementById(
            "highTicketStats"
          ).textContent = `${highTicketCustomers.length} customers`;
          updateTotalStats();

          // Display customers
          if (highTicketCustomers.length === 0) {
            container.innerHTML =
              '<div class="empty-state"><i class="fas fa-crown"></i><p>No high ticket customers found</p></div>';
            return;
          }

          container.innerHTML = "";
          highTicketCustomers.forEach((customer) => {
            const customerElement = createCustomerElement(
              customer,
              "highTicket"
            );
            container.appendChild(customerElement);
          });
        } catch (error) {
          console.error("Error loading high ticket customers:", error);
          container.innerHTML =
            '<div class="empty-state"><i class="fas fa-exclamation-triangle"></i><p>Failed to load high ticket customers</p></div>';
        }
      }

      // 3. Gifting Reciprocity Campaign
      async function loadGiftingOpportunities(days = 3) {
        const container = document.getElementById("giftingList");
        container.innerHTML =
          '<div class="loading"><i class="fas fa-spinner fa-spin"></i> Loading gifting opportunities...</div>';

        try {
          // Get all bills
          const { data: allBills, error } = await supabase
            .from("cake_bills")
            .select("*")
            .order("created_at", { ascending: false });

          if (error) throw error;

          // Find gifting relationships
          const giftingMap = new Map(); // birthday_person_phone -> [{gifter: purchaser, date: birthday}]
          const upcomingBirthdays = new Map(); // phone -> birthday date

          // First pass: Build gifting relationships
          allBills.forEach((bill) => {
            if (
              bill.birthday_person_phone &&
              bill.birthday_person_name !== bill.purchaser_name
            ) {
              const recipientPhone = bill.birthday_person_phone;
              if (!giftingMap.has(recipientPhone)) {
                giftingMap.set(recipientPhone, []);
              }
              giftingMap.get(recipientPhone).push({
                gifterName: bill.purchaser_name,
                gifterPhone: bill.purchaser_phone,
                gifterBirthday: bill.purchaser_birthdate,
                giftDate: bill.created_at,
              });
            }
          });

          // Second pass: Find gifter birthdays coming up
          const today = new Date();
          const futureDate = new Date();
          futureDate.setDate(today.getDate() + days);

          const opportunities = [];

          giftingMap.forEach((gifters, recipientPhone) => {
            gifters.forEach((gifter) => {
              if (gifter.gifterBirthday) {
                const gifterBirthday = new Date(gifter.gifterBirthday);
                const thisYearBirthday = new Date(
                  today.getFullYear(),
                  gifterBirthday.getMonth(),
                  gifterBirthday.getDate()
                );

                if (
                  thisYearBirthday >= today &&
                  thisYearBirthday <= futureDate
                ) {
                  // Find recipient info
                  const recipientBill = allBills.find(
                    (bill) =>
                      bill.birthday_person_phone === recipientPhone ||
                      (bill.purchaser_phone === recipientPhone &&
                        bill.birthday_person_phone)
                  );

                  if (recipientBill) {
                    opportunities.push({
                      recipientName:
                        recipientBill.birthday_person_name ||
                        recipientBill.purchaser_name,
                      recipientPhone: recipientPhone,
                      gifterName: gifter.gifterName,
                      gifterPhone: gifter.gifterPhone,
                      gifterBirthday: gifter.gifterBirthday,
                      lastGiftDate: gifter.giftDate,
                      lastGiftAmount:
                        parseFloat(recipientBill.total_price) || 0,
                    });
                  }
                }
              }
            });
          });

          // Update stats
          document.getElementById("giftingCount").textContent =
            opportunities.length;
          document.getElementById(
            "giftingStats"
          ).textContent = `${opportunities.length} opportunities`;
          updateTotalStats();

          // Display opportunities
          if (opportunities.length === 0) {
            container.innerHTML =
              '<div class="empty-state"><i class="fas fa-gift"></i><p>No gifting opportunities found</p></div>';
            return;
          }

          container.innerHTML = "";
          opportunities.forEach((opportunity) => {
            const opportunityElement = createGiftingElement(opportunity);
            container.appendChild(opportunityElement);
          });
        } catch (error) {
          console.error("Error loading gifting opportunities:", error);
          container.innerHTML =
            '<div class="empty-state"><i class="fas fa-exclamation-triangle"></i><p>Failed to load gifting opportunities</p></div>';
        }
      }

      // Create customer element for display
      function createCustomerElement(customer, type) {
        const div = document.createElement("div");
        div.className = "customer-item";

        const formattedDate = customer.birthday
          ? new Date(customer.birthday).toLocaleDateString("en-IN", {
              day: "numeric",
              month: "long",
            })
          : "N/A";

        const lastPurchaseDate = customer.lastPurchase
          ? new Date(customer.lastPurchase).toLocaleDateString("en-IN")
          : "Never";

        let typeBadge = "";
        if (customer.type === "purchaser") {
          typeBadge = '<span class="type-badge purchaser">Purchaser</span>';
        } else if (customer.type === "birthday_person") {
          typeBadge =
            '<span class="type-badge birthday-person">Birthday Person</span>';
        }

        div.innerHTML = `
                <div class="customer-info">
                    <h4>${customer.name}</h4>
                    <div class="customer-phone">${customer.phone}</div>
                    <div class="customer-type">${typeBadge}</div>
                </div>
                <div class="customer-date">
                    <i class="fas fa-calendar-alt"></i>
                    ${
                      type === "birthday"
                        ? "Birthday: " + formattedDate
                        : "Last Purchase: " + lastPurchaseDate
                    }
                </div>
                <div class="customer-amount">
                    ${
                      type === "highTicket"
                        ? "‚Çπ" + customer.totalSpent.toFixed(0)
                        : ""
                    }
                </div>
                <div class="action-buttons">
                    <button class="btn-whatsapp" onclick="sendBirthdayOffer('${
                      customer.phone
                    }', '${customer.name}', '${formattedDate}', '${type}')">
                        <i class="fab fa-whatsapp"></i> Send Offer
                    </button>
                </div>
            `;

        return div;
      }

      // Create gifting opportunity element
      function createGiftingElement(opportunity) {
        const div = document.createElement("div");
        div.className = "customer-item";

        const gifterBirthday = new Date(
          opportunity.gifterBirthday
        ).toLocaleDateString("en-IN", {
          day: "numeric",
          month: "long",
          year: "numeric",
        });

        const lastGiftDate = new Date(
          opportunity.lastGiftDate
        ).toLocaleDateString("en-IN");

        div.innerHTML = `
                <div class="customer-info">
                    <h4>${opportunity.recipientName}</h4>
                    <div class="customer-phone">${
                      opportunity.recipientPhone
                    }</div>
                    <div class="customer-type">
                        <span class="type-badge purchaser">Received Gift</span>
                    </div>
                </div>
                <div class="customer-date">
                    <i class="fas fa-user-friends"></i>
                    From: ${opportunity.gifterName}
                </div>
                <div class="customer-date">
                    <i class="fas fa-calendar-star"></i>
                    Their birthday: ${gifterBirthday}
                </div>
                <div class="customer-amount">
                    ‚Çπ${opportunity.lastGiftAmount.toFixed(0)}
                </div>
                <div class="action-buttons">
                    <button class="btn-whatsapp" onclick="sendGiftingReminder('${
                      opportunity.recipientPhone
                    }', '${opportunity.recipientName}', '${
          opportunity.gifterName
        }', '${gifterBirthday}')">
                        <i class="fab fa-whatsapp"></i> Send Reminder
                    </button>
                </div>
            `;

        return div;
      }

      // Send birthday offer via WhatsApp
      function sendBirthdayOffer(phone, name, birthday, type) {
        if (dailySendCount >= MAX_DAILY_SENDS) {
          showNotification(
            `Daily limit reached (${MAX_DAILY_SENDS} messages). Try again tomorrow.`,
            "warning"
          );
          return;
        }

        // Format phone number (remove non-digits, add 91 if not present)
        const cleanPhone = phone.replace(/\D/g, "");
        const phoneWithCountryCode = cleanPhone.startsWith("91")
          ? cleanPhone
          : "91" + cleanPhone;

        // Create personalized message
        let message = "";
        if (type === "birthday") {
          message = `üéÇ *Happy Birthday ${name}!* üéÇ

We noticed your birthday is coming up on *${birthday}*!

To make your celebration sweeter, here's a special offer just for you:

*üéÅ 20% OFF on any cake*
*üéâ Free personalized message*
*üöÄ Priority delivery*

Use code: BDAY20

Valid until: ${new Date(
            new Date().setDate(new Date().getDate() + 7)
          ).toLocaleDateString("en-IN")}

Visit us or call to place your order!

With love,
Cake Bliss Team üç∞

_To unsubscribe from birthday offers, reply STOP_`;
        } else if (type === "highTicket") {
          message = `üëë *Exclusive Offer for Our Valued Customer!* üëë

Hello ${name}! 

As one of our most valued customers, we want to thank you for your continued support with this exclusive offer:

*üéÅ 25% OFF your next order*
*‚ú® Free cake upgrade*
*‚≠ê Priority booking*

Use code: VIP25

This offer is specially curated for our premium customers like you!

Valid for 30 days.

Thank you for choosing Cake Bliss! üéÇ

Best regards,
Cake Bliss Team

_To unsubscribe, reply STOP_`;
        }

        // Show preview first
        showMessagePreview(message, name);

        // Store data for sending
        window.pendingMessage = {
          phone: phoneWithCountryCode,
          message: message,
          name: name,
          type: type,
        };
      }

      // Send gifting reminder
      function sendGiftingReminder(
        phone,
        recipientName,
        gifterName,
        gifterBirthday
      ) {
        if (dailySendCount >= MAX_DAILY_SENDS) {
          showNotification(
            `Daily limit reached (${MAX_DAILY_SENDS} messages). Try again tomorrow.`,
            "warning"
          );
          return;
        }

        // Format phone number
        const cleanPhone = phone.replace(/\D/g, "");
        const phoneWithCountryCode = cleanPhone.startsWith("91")
          ? cleanPhone
          : "91" + cleanPhone;

        // Create gifting reminder message
        const message = `üéÅ *Gifting Reminder* üéÅ

Hello ${recipientName}! 

We noticed that *${gifterName}* gifted you a cake on your special day! ‚ù§Ô∏è

Now it's your chance to return the love! ü•∞

*${gifterName}'s birthday is on ${gifterBirthday}*

Make their day special with a delicious cake from Cake Bliss!

*Special Return Gift Offer:*
üéÇ 15% OFF any cake for ${gifterName}
üéâ Free "Happy Birthday" message card
üöÄ Same-day delivery available

Use code: RETURNLOVE15

Valid until: ${gifterBirthday}

Spread the love! üíï

Cake Bliss Team üç∞

_This is a one-time gifting reminder_`;

        // Show preview first
        showMessagePreview(message, recipientName);

        // Store data for sending
        window.pendingMessage = {
          phone: phoneWithCountryCode,
          message: message,
          name: recipientName,
          type: "gifting",
        };
      }

      // Confirm and send message
      function confirmAndSend() {
        if (!window.pendingMessage) return;

        const { phone, message, name, type } = window.pendingMessage;

        // Encode message for URL
        const encodedMessage = encodeURIComponent(message);

        // Create WhatsApp URL
        const whatsappUrl = `https://wa.me/${phone}?text=${encodedMessage}`;

        // Open WhatsApp in new tab
        const newWindow = window.open(
          whatsappUrl,
          "_blank",
          "noopener,noreferrer"
        );

        if (newWindow) {
          newWindow.focus();

          // Update send count
          dailySendCount++;
          updateDailyCount();

          // Show success notification
          let campaignType = "";
          switch (type) {
            case "birthday":
              campaignType = "birthday offer";
              break;
            case "highTicket":
              campaignType = "VIP offer";
              break;
            case "gifting":
              campaignType = "gifting reminder";
              break;
          }

          showNotification(`${campaignType} sent to ${name}`, "success");

          // Update stats
          document.getElementById("totalSent").textContent = dailySendCount;

          // Close preview
          closePreview();

          // Clear pending message
          window.pendingMessage = null;

          // Disable button temporarily to prevent rapid clicking
          const button = document.querySelector(".btn-whatsapp.sending");
          if (button) {
            button.disabled = true;
            button.innerHTML = '<i class="fas fa-check"></i> Sent';
            setTimeout(() => {
              button.disabled = false;
              button.innerHTML = '<i class="fab fa-whatsapp"></i> Send Offer';
              button.classList.remove("sending");
            }, 3000);
          }
        } else {
          showNotification(
            "Popup blocked. Please allow popups for this site.",
            "error"
          );
        }
      }

      // Show message preview
      function showMessagePreview(message, recipientName) {
        const preview = document.getElementById("messagePreview");
        const content = document.getElementById("previewContent");

        content.textContent = message;
        preview.classList.add("show");

        // Add confirm button if not already present
        if (!document.getElementById("confirmSendBtn")) {
          const confirmBtn = document.createElement("button");
          confirmBtn.id = "confirmSendBtn";
          confirmBtn.className = "btn-whatsapp sending";
          confirmBtn.innerHTML =
            '<i class="fab fa-whatsapp"></i> Confirm & Send to ' +
            recipientName;
          confirmBtn.style.marginTop = "15px";
          confirmBtn.onclick = confirmAndSend;

          preview.appendChild(confirmBtn);
        }
      }

      function closePreview() {
        document.getElementById("messagePreview").classList.remove("show");
        window.pendingMessage = null;
      }

      // Update total statistics
      function updateTotalStats() {
        const birthdayCount =
          parseInt(document.getElementById("birthdayCount").textContent) || 0;
        const highTicketCount =
          parseInt(document.getElementById("highTicketCount").textContent) || 0;
        const giftingCount =
          parseInt(document.getElementById("giftingCount").textContent) || 0;

        const totalCustomers = birthdayCount + highTicketCount + giftingCount;
        document.getElementById("totalCustomers").textContent = totalCustomers;
      }

      // Load daily send count from localStorage
      function loadDailyCount() {
        const today = new Date().toDateString();
        const storedData = localStorage.getItem("cakeBlissWhatsAppStats");

        if (storedData) {
          const data = JSON.parse(storedData);
          if (data.date === today) {
            dailySendCount = data.count || 0;
          } else {
            dailySendCount = 0; // Reset for new day
          }
        }

        document.getElementById("totalSent").textContent = dailySendCount;
      }

      // Update daily count in localStorage
      function updateDailyCount() {
        const today = new Date().toDateString();
        const data = {
          date: today,
          count: dailySendCount,
        };
        localStorage.setItem("cakeBlissWhatsAppStats", JSON.stringify(data));
      }

      // Setup event listeners
      function setupEventListeners() {
        // Filter change listeners
        document
          .getElementById("daysFilter")
          .addEventListener("change", function () {
            const days = parseInt(this.value);
            loadUpcomingBirthdays(days);
            loadGiftingOpportunities(days);
          });

        document
          .getElementById("amountFilter")
          .addEventListener("change", function () {
            const minAmount = parseInt(this.value);
            loadHighTicketCustomers(minAmount);
          });

        // Refresh button
        document
          .getElementById("refreshBtn")
          .addEventListener("click", function () {
            this.innerHTML =
              '<i class="fas fa-spinner fa-spin"></i> Refreshing...';
            this.disabled = true;

            loadAllCampaigns().finally(() => {
              this.innerHTML = '<i class="fas fa-sync-alt"></i> Refresh Data';
              this.disabled = false;
              showNotification("Data refreshed successfully", "success");
            });
          });

        // Keyboard shortcuts
        document.addEventListener("keydown", function (e) {
          if (e.key === "Escape") {
            closePreview();
          }
          if (e.ctrlKey && e.key === "r") {
            e.preventDefault();
            document.getElementById("refreshBtn").click();
          }
        });
      }

      // Show notification
      function showNotification(message, type = "success") {
        const notification = document.getElementById("notification");
        const icon = notification.querySelector("i");
        const text = notification.querySelector("span");

        notification.className = `notification ${type}`;
        text.textContent = message;

        switch (type) {
          case "success":
            icon.className = "fas fa-check-circle";
            break;
          case "error":
            icon.className = "fas fa-exclamation-circle";
            break;
          case "warning":
            icon.className = "fas fa-exclamation-triangle";
            break;
          case "info":
            icon.className = "fas fa-info-circle";
            break;
        }

        notification.classList.add("show");

        setTimeout(() => {
          notification.classList.remove("show");
        }, 3000);
      }

      // Add CSS for type badge colors
      const style = document.createElement("style");
      style.textContent = `
            :root {
                --primary-rgb: 255, 123, 172;
                --accent-rgb: 157, 78, 221;
            }
        `;
      document.head.appendChild(style);
    </script>
  </body>
</html>
