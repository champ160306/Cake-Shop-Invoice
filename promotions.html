<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Cake Bliss | WhatsApp Promotions Manager</title>
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    />
    <!-- Cake-themed favicon -->
    <link
      rel="icon"
      href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üéÇ</text></svg>"
    />
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
      }

      :root {
        --primary: #ff7bac;
        --secondary: #ffb347;
        --accent: #9d4edd;
        --light: #fff9fb;
        --dark: #333333;
        --success: #4caf50;
        --warning: #ff9800;
        --danger: #f44336;
        --info: #2196f3;
      }

      body {
        background: linear-gradient(135deg, #ffecd2 0%, #fcb69f 100%);
        color: var(--dark);
        min-height: 100vh;
        padding: 20px;
      }

      .container {
        max-width: 1400px;
        margin: 0 auto;
      }

      /* Header */
      header {
        background-color: white;
        border-radius: 20px;
        padding: 25px 40px;
        margin-bottom: 30px;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.08);
        display: flex;
        justify-content: space-between;
        align-items: center;
        flex-wrap: wrap;
      }

      .logo-container {
        display: flex;
        align-items: center;
        gap: 15px;
      }

      .logo {
        width: 60px;
        height: 60px;
        background: linear-gradient(45deg, var(--primary), var(--secondary));
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-size: 28px;
      }

      .logo-text h1 {
        color: var(--primary);
        font-size: 28px;
        font-weight: 800;
        letter-spacing: 1px;
      }

      .logo-text p {
        color: var(--dark);
        font-size: 14px;
        opacity: 0.8;
      }

      .header-stats {
        display: flex;
        gap: 20px;
        margin-top: 10px;
      }

      .stat-item {
        background: var(--light);
        padding: 8px 15px;
        border-radius: 10px;
        font-size: 13px;
        font-weight: 600;
      }

      .stat-item i {
        margin-right: 5px;
        color: var(--accent);
      }

      nav ul {
        display: flex;
        list-style: none;
        gap: 25px;
      }

      nav a {
        text-decoration: none;
        color: var(--dark);
        font-weight: 600;
        font-size: 16px;
        padding: 8px 15px;
        border-radius: 50px;
        transition: all 0.3s ease;
      }

      nav a:hover,
      nav a.active {
        background-color: var(--primary);
        color: white;
      }

      /* Main Content */
      .main-content {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 30px;
      }
      /* All campaigns should be side by side (2 per row) */
      .main-content .campaign-card {
        grid-column: span 1;
      }
      @media (max-width: 992px) {
        .main-content {
          grid-template-columns: 1fr;
        }
      }

      .modal {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.5);
        z-index: 2000;
        display: flex;
        align-items: center;
        justify-content: center;
      }

      .modal-content {
        background: white;
        border-radius: 20px;
        padding: 30px;
        width: 90%;
        box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
      }

      .close-modal {
        background: none;
        border: none;
        font-size: 24px;
        color: #666;
        cursor: pointer;
        padding: 5px;
      }

      .close-modal:hover {
        color: var(--danger);
      }

      /* Campaign Cards */
      .campaign-card {
        background-color: white;
        border-radius: 20px;
        padding: 30px;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.08);
        margin-bottom: 30px;
      }

      .campaign-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 25px;
        padding-bottom: 15px;
        border-bottom: 2px solid var(--light);
      }

      .campaign-title {
        display: flex;
        align-items: center;
        gap: 15px;
      }

      .campaign-icon {
        width: 50px;
        height: 50px;
        background: linear-gradient(45deg, var(--primary), var(--secondary));
        border-radius: 12px;
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-size: 24px;
      }

      .campaign-title h2 {
        color: var(--primary);
        font-size: 24px;
      }

      .campaign-title p {
        color: #666;
        font-size: 14px;
        margin-top: 5px;
      }

      .campaign-stats {
        display: flex;
        gap: 15px;
      }

      .stat-badge {
        background: var(--light);
        padding: 8px 15px;
        border-radius: 10px;
        font-weight: 600;
        font-size: 14px;
        display: flex;
        align-items: center;
        gap: 8px;
      }

      .stat-badge i {
        color: var(--accent);
      }

      /* Customer List */
      .customer-list {
        max-height: 500px;
        overflow-y: auto;
        margin-top: 20px;
      }

      .customer-item {
        display: grid;
        grid-template-columns: 2fr 1fr 1fr 1fr auto;
        gap: 15px;
        align-items: center;
        padding: 20px;
        border-bottom: 1px solid #eee;
        transition: all 0.3s ease;
      }

      .customer-item:hover {
        background-color: var(--light);
      }

      .customer-info h4 {
        color: var(--dark);
        font-size: 16px;
        margin-bottom: 5px;
      }

      .customer-info .customer-phone {
        font-size: 13px;
        color: #666;
        background: #f5f5f5;
        padding: 3px 8px;
        border-radius: 4px;
        display: inline-block;
        margin-top: 5px;
      }

      .customer-type {
        display: flex;
        align-items: center;
        gap: 8px;
      }

      .type-badge {
        padding: 4px 10px;
        border-radius: 20px;
        font-size: 12px;
        font-weight: 600;
        text-transform: uppercase;
      }

      .type-badge.purchaser {
        background-color: rgba(var(--primary-rgb), 0.1);
        color: var(--primary);
      }

      .type-badge.birthday-person {
        background-color: rgba(var(--accent-rgb), 0.1);
        color: var(--accent);
      }

      .customer-date {
        font-size: 14px;
        color: #666;
      }

      .customer-date i {
        color: var(--primary);
        margin-right: 5px;
      }

      .customer-amount {
        font-size: 18px;
        font-weight: 700;
        color: var(--accent);
        text-align: center;
      }

      .action-buttons {
        display: flex;
        gap: 10px;
      }

      .btn-whatsapp {
        background-color: #25d366;
        color: white;
        border: none;
        padding: 10px 20px;
        border-radius: 10px;
        cursor: pointer;
        font-weight: 600;
        display: flex;
        align-items: center;
        gap: 8px;
        transition: all 0.3s;
        white-space: nowrap;
      }

      .btn-whatsapp:hover {
        background-color: #1da851;
        transform: translateY(-2px);
        box-shadow: 0 5px 15px rgba(37, 211, 102, 0.3);
      }

      .btn-whatsapp:disabled {
        background-color: #cccccc;
        cursor: not-allowed;
        transform: none;
        box-shadow: none;
      }

      .btn-whatsapp.sending {
        background-color: var(--warning);
      }

      /* Notification */
      .notification {
        position: fixed;
        top: 20px;
        right: 20px;
        padding: 15px 25px;
        border-radius: 12px;
        color: white;
        font-weight: 600;
        z-index: 1000;
        display: flex;
        align-items: center;
        gap: 10px;
        transform: translateX(150%);
        transition: transform 0.3s ease;
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
      }

      .notification.show {
        transform: translateX(0);
      }

      .notification.success {
        background-color: var(--success);
      }

      .notification.info {
        background-color: var(--info);
      }

      .notification.warning {
        background-color: var(--warning);
      }

      .notification.error {
        background-color: var(--danger);
      }

      /* Loading State */
      .loading {
        text-align: center;
        padding: 40px;
        color: #666;
      }

      .loading i {
        margin-right: 10px;
        animation: spin 1s linear infinite;
      }

      @keyframes spin {
        0% {
          transform: rotate(0deg);
        }
        100% {
          transform: rotate(360deg);
        }
      }

      /* Empty State */
      .empty-state {
        text-align: center;
        padding: 40px;
        color: #666;
      }

      .empty-state i {
        font-size: 48px;
        color: #ddd;
        margin-bottom: 15px;
      }

      /* Dashboard Summary */
      .dashboard-summary {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 20px;
        margin-bottom: 30px;
      }

      .summary-card {
        background: white;
        border-radius: 15px;
        padding: 25px;
        box-shadow: 0 5px 20px rgba(0, 0, 0, 0.05);
        display: flex;
        align-items: center;
        gap: 20px;
        transition: transform 0.3s ease;
      }

      .summary-card:hover {
        transform: translateY(-5px);
      }

      .summary-icon {
        width: 60px;
        height: 60px;
        border-radius: 12px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 24px;
        color: white;
      }

      .summary-icon.birthdays {
        background: linear-gradient(45deg, #ff7bac, #ff4081);
      }

      .summary-icon.high-ticket {
        background: linear-gradient(45deg, #ffb347, #ff9800);
      }

      .summary-icon.gifting {
        background: linear-gradient(45deg, #9d4edd, #7b1fa2);
      }

      .summary-content h3 {
        font-size: 14px;
        color: #666;
        margin-bottom: 5px;
      }

      .summary-content .count {
        font-size: 32px;
        font-weight: 800;
        color: var(--dark);
        line-height: 1;
      }

      .summary-content .subtext {
        font-size: 12px;
        color: #999;
        margin-top: 5px;
      }

      /* Responsive Design */
      @media (max-width: 992px) {
        .customer-item {
          grid-template-columns: 1fr;
          gap: 10px;
        }

        .campaign-header {
          flex-direction: column;
          align-items: flex-start;
          gap: 15px;
        }

        .campaign-stats {
          width: 100%;
          justify-content: space-between;
        }
      }

      @media (max-width: 768px) {
        header {
          flex-direction: column;
          gap: 20px;
        }

        nav ul {
          flex-wrap: wrap;
          justify-content: center;
        }

        .dashboard-summary {
          grid-template-columns: 1fr;
        }
      }

      /* Filter Controls */
      .filter-controls {
        background: var(--light);
        border-radius: 15px;
        padding: 20px;
        margin-bottom: 20px;
        display: flex;
        flex-wrap: wrap;
        gap: 15px;
        align-items: center;
      }

      .filter-group {
        display: flex;
        align-items: center;
        gap: 10px;
      }

      .filter-group label {
        font-weight: 600;
        font-size: 14px;
        color: var(--dark);
      }

      .filter-group select,
      .filter-group input {
        padding: 8px 12px;
        border: 2px solid #eee;
        border-radius: 8px;
        font-size: 14px;
        min-width: 150px;
      }

      .refresh-btn {
        background: var(--accent);
        color: white;
        border: none;
        padding: 10px 20px;
        border-radius: 8px;
        cursor: pointer;
        font-weight: 600;
        display: flex;
        align-items: center;
        gap: 8px;
        margin-left: auto;
      }

      .refresh-btn:hover {
        background: #8a2be2;
        transform: translateY(-2px);
      }

      /* Connection Status */
      .connection-status {
        display: inline-flex;
        align-items: center;
        gap: 8px;
        padding: 5px 12px;
        border-radius: 50px;
        font-size: 14px;
        font-weight: 600;
        margin-top: 10px;
      }

      .connection-status.connected {
        background-color: rgba(76, 175, 80, 0.1);
        color: var(--success);
      }

      .connection-status.disconnected {
        background-color: rgba(244, 67, 54, 0.1);
        color: var(--danger);
      }

      .status-dot {
        width: 10px;
        height: 10px;
        border-radius: 50%;
      }

      .status-dot.connected {
        background-color: var(--success);
        animation: pulse 2s infinite;
      }

      .status-dot.disconnected {
        background-color: var(--danger);
      }

      @keyframes pulse {
        0% {
          opacity: 1;
        }
        50% {
          opacity: 0.5;
        }
        100% {
          opacity: 1;
        }
      }
      .btn-whatsapp.sent {
        background-color: var(--success);
      }

      .btn-whatsapp.sent:hover {
        background-color: var(--success);
        transform: none;
        box-shadow: none;
        cursor: default;
      }
      /* Add to your CSS */
      .btn-whatsapp:disabled {
        background-color: #cccccc;
        cursor: not-allowed;
        transform: none;
        box-shadow: none;
        opacity: 0.7;
      }

      .btn-whatsapp:disabled:hover {
        background-color: #cccccc;
        transform: none;
        box-shadow: none;
      }

      .customer-phone.no-phone {
        background-color: #ffebee;
        color: #c62828;
        font-style: italic;
      }

      .customer-phone.no-phone i {
        margin-right: 5px;
      }
      /* Mobile Responsive Styles */
      @media (max-width: 576px) {
        body {
          padding: 10px;
        }

        header {
          padding: 20px;
          flex-direction: column;
          text-align: center;
          gap: 20px;
        }

        .logo-container {
          flex-direction: column;
          text-align: center;
        }

        .logo {
          margin: 0 auto;
        }

        .header-stats {
          flex-wrap: wrap;
          justify-content: center;
        }

        nav ul {
          flex-wrap: wrap;
          justify-content: center;
          gap: 10px;
        }

        nav a {
          padding: 8px 12px;
          font-size: 14px;
        }

        .dashboard-summary {
          grid-template-columns: 1fr;
          gap: 10px;
        }

        .summary-card {
          padding: 15px;
        }

        .summary-icon {
          width: 50px;
          height: 50px;
          font-size: 20px;
        }

        .filter-controls {
          flex-direction: column;
          align-items: stretch;
        }

        .filter-group {
          flex-direction: column;
          align-items: flex-start;
          width: 100%;
        }

        .filter-group select,
        .filter-group input {
          width: 100%;
          min-width: unset;
        }

        .refresh-btn {
          margin-left: 0;
          margin-top: 10px;
          width: 100%;
        }

        .main-content {
          grid-template-columns: 1fr;
          gap: 20px;
        }

        .campaign-card {
          padding: 20px;
          margin-bottom: 20px;
        }

        .campaign-header {
          flex-direction: column;
          align-items: flex-start;
          gap: 15px;
        }

        .campaign-title {
          flex-direction: column;
          text-align: center;
          width: 100%;
        }

        .campaign-icon {
          margin: 0 auto;
        }

        .campaign-stats {
          width: 100%;
          justify-content: center;
        }

        .customer-item {
          grid-template-columns: 1fr;
          gap: 10px;
          padding: 15px;
          text-align: center;
        }

        .customer-info,
        .customer-date,
        .customer-amount {
          text-align: center;
        }

        .customer-type {
          justify-content: center;
        }

        .action-buttons {
          justify-content: center;
        }

        .btn-whatsapp {
          padding: 12px 15px;
          font-size: 14px;
          width: 100%;
          justify-content: center;
        }

        /* Modal for mobile */
        .modal-content {
          width: 95%;
          padding: 20px;
          margin: 10px;
        }

        .notification {
          left: 10px;
          right: 10px;
          text-align: center;
        }
      }

      /* Tablet Responsive */
      @media (min-width: 577px) and (max-width: 768px) {
        .main-content {
          grid-template-columns: 1fr;
        }

        .customer-item {
          grid-template-columns: 1fr 1fr;
        }
      }

      /* Touch-friendly improvements */
      .btn-whatsapp,
      .refresh-btn,
      .filter-group select {
        min-height: 44px; /* Minimum touch target size */
        touch-action: manipulation; /* Prevent double-tap zoom */
      }

      /* Prevent text zoom on mobile */
      html {
        -webkit-text-size-adjust: 100%;
      }

      /* Better scrolling on mobile */
      .customer-list {
        -webkit-overflow-scrolling: touch;
        overscroll-behavior: contain;
      }

      /* Mobile-specific font sizes */
      @media (max-width: 576px) {
        h1 {
          font-size: 24px;
        }
        h2 {
          font-size: 20px;
        }
        h3 {
          font-size: 16px;
        }
        p,
        label,
        .stat-badge {
          font-size: 14px;
        }

        .logo-text h1 {
          font-size: 24px;
        }

        .campaign-title h2 {
          font-size: 20px;
        }
      }
      
      /* Better touch targets */
      .btn-whatsapp,
      .refresh-btn,
      .filter-group select,
      .filter-group input,
      .customer-item {
        cursor: pointer;
        -webkit-tap-highlight-color: rgba(0, 0, 0, 0.1);
        tap-highlight-color: rgba(0, 0, 0, 0.1);
      }

      /* Prevent text selection on buttons */
      .btn-whatsapp,
      .refresh-btn {
        user-select: none;
        -webkit-user-select: none;
      }

      /* Better scrolling */
      body {
        overflow-x: hidden;
      }

      .customer-list {
        scrollbar-width: thin;
        scrollbar-color: var(--primary) #f0f0f0;
      }

      .customer-list::-webkit-scrollbar {
        width: 6px;
      }

      .customer-list::-webkit-scrollbar-track {
        background: #f0f0f0;
        border-radius: 10px;
      }

      .customer-list::-webkit-scrollbar-thumb {
        background: var(--primary);
        border-radius: 10px;
      }
      /* Enhanced Navigation */
      nav {
        position: relative;
      }

      nav ul {
        display: flex;
        list-style: none;
        gap: 15px;
        margin: 0;
        padding: 0;
      }

      nav li {
        position: relative;
      }

      nav a {
        text-decoration: none;
        color: var(--dark);
        font-weight: 600;
        font-size: 16px;
        padding: 12px 20px;
        border-radius: 50px;
        transition: all 0.3s ease;
        display: flex;
        align-items: center;
        gap: 8px;
        position: relative;
        overflow: hidden;
      }

      nav a::before {
        content: "";
        position: absolute;
        top: 0;
        left: -100%;
        width: 100%;
        height: 100%;
        background: linear-gradient(
          90deg,
          transparent,
          rgba(255, 255, 255, 0.3),
          transparent
        );
        transition: left 0.5s ease;
      }

      nav a:hover::before {
        left: 100%;
      }

      nav a:hover {
        background-color: var(--primary);
        color: white;
        transform: translateY(-2px);
        box-shadow: 0 5px 15px rgba(255, 123, 172, 0.3);
      }

      nav a.active {
        background-color: var(--primary);
        color: white;
        box-shadow: 0 4px 12px rgba(255, 123, 172, 0.4);
      }

      nav a i {
        font-size: 18px;
        transition: transform 0.3s ease;
      }

      nav a:hover i {
        transform: scale(1.2);
      }

      /* Active page indicator */
      nav a.active::after {
        content: "";
        position: absolute;
        bottom: -5px;
        left: 50%;
        transform: translateX(-50%);
        width: 6px;
        height: 6px;
        background-color: var(--secondary);
        border-radius: 50%;
        animation: pulse 2s infinite;
      }

      /* Mobile Navigation Enhancements */
      .mobile-menu-toggle {
        display: none;
        background: var(--primary);
        color: white;
        border: none;
        padding: 12px 16px;
        border-radius: 10px;
        font-size: 20px;
        cursor: pointer;
        transition: all 0.3s ease;
        position: relative;
        z-index: 1001;
        box-shadow: 0 4px 12px rgba(255, 123, 172, 0.3);
      }

      .mobile-menu-toggle:hover {
        background: var(--secondary);
        transform: translateY(-2px);
        box-shadow: 0 6px 18px rgba(255, 179, 71, 0.4);
      }

      .mobile-menu-toggle:active {
        transform: translateY(0);
      }

      @media (max-width: 768px) {
        .mobile-menu-toggle {
          display: flex;
          align-items: center;
          justify-content: center;
          margin: 0;
          order: 2;
        }

        header {
          position: relative;
          padding: 20px;
        }

        nav {
          position: absolute;
          top: 100%;
          left: 0;
          right: 0;
          background: white;
          border-radius: 15px;
          margin-top: 15px;
          padding: 15px;
          box-shadow: 0 10px 30px rgba(0, 0, 0, 0.15);
          z-index: 1000;
          display: none;
          animation: slideDown 0.3s ease;
        }

        nav.show {
          display: block;
        }

        nav ul {
          flex-direction: column;
          gap: 8px;
        }

        nav li {
          width: 100%;
        }

        nav a {
          padding: 15px 20px;
          border-radius: 10px;
          justify-content: flex-start;
          font-size: 16px;
          border: 1px solid #f0f0f0;
        }

        nav a:hover {
          background-color: var(--primary);
          transform: translateX(5px);
        }

        nav a.active {
          border-left: 4px solid var(--primary);
          background-color: rgba(255, 123, 172, 0.1);
        }

        nav a.active::after {
          display: none;
        }

        /* Close button for mobile menu */
        .mobile-close-btn {
          position: absolute;
          top: 15px;
          right: 15px;
          background: none;
          border: none;
          font-size: 20px;
          color: var(--dark);
          cursor: pointer;
          padding: 5px;
        }
      }

      @keyframes slideDown {
        from {
          opacity: 0;
          transform: translateY(-10px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      /* Desktop specific enhancements */
      @media (min-width: 769px) {
        .logo-container {
          flex: 1;
        }

        nav {
          flex: 2;
          display: flex;
          justify-content: flex-end;
        }

        nav ul {
          justify-content: flex-end;
        }

        /* Add subtle background animation for desktop */
        nav a {
          background: linear-gradient(
            to right,
            transparent 50%,
            var(--primary) 50%
          );
          background-size: 200% 100%;
          background-position: right bottom;
          transition: all 0.4s ease;
        }

        nav a:hover {
          background-position: left bottom;
          color: white;
        }
      }

      /* Badge for notification counts (optional) */
      .nav-badge {
        position: absolute;
        top: -8px;
        right: -8px;
        background-color: var(--danger);
        color: white;
        font-size: 10px;
        font-weight: bold;
        padding: 2px 6px;
        border-radius: 10px;
        min-width: 18px;
        text-align: center;
      }

      /* Navbar shadow effect */
      header {
        position: relative;
      }

      header::after {
        content: "";
        position: absolute;
        bottom: -10px;
        left: 5%;
        width: 90%;
        height: 10px;
        background: rgba(0, 0, 0, 0.05);
        border-radius: 50%;
        filter: blur(5px);
        z-index: -1;
      }

      /* Floating animation for active menu item */
      @keyframes float {
        0%,
        100% {
          transform: translateY(0);
        }
        50% {
          transform: translateY(-5px);
        }
      }

      nav a.active {
        animation: float 3s ease-in-out infinite;
      }
      /* Smooth scrolling */
      html {
        scroll-behavior: smooth;
      }

      /* Better focus styles for accessibility */
      nav a:focus,
      .btn-whatsapp:focus,
      .refresh-btn:focus {
        outline: 2px solid var(--primary);
        outline-offset: 2px;
      }

      /* Reduce motion for users who prefer it */
      @media (prefers-reduced-motion: reduce) {
        * {
          animation-duration: 0.01ms !important;
          animation-iteration-count: 1 !important;
          transition-duration: 0.01ms !important;
        }

        nav a.active {
          animation: none;
        }
      }
      /* Navbar loading indicator */
      .nav-loading {
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 3px;
        background: linear-gradient(
          90deg,
          var(--primary),
          var(--secondary),
          var(--accent)
        );
        background-size: 200% 100%;
        animation: loading 2s linear infinite;
        display: none;
      }

      .nav-loading.active {
        display: block;
      }

      @keyframes loading {
        0% {
          background-position: 200% 0;
        }
        100% {
          background-position: -200% 0;
        }
      }
       .birthday-expiring-combo {
        background: linear-gradient(135deg, #ff6b6b 0%, #ffd93d 100%);
        border-left: 5px solid #ff6b6b;
        animation: pulse-glow 2s ease-in-out infinite;
      }

      @keyframes pulse-glow {
        0%, 100% {
          box-shadow: 0 0 10px rgba(255, 107, 107, 0.5);
        }
        50% {
          box-shadow: 0 0 20px rgba(255, 107, 107, 0.8);
        }
      }

      .combo-badge {
        background: linear-gradient(45deg, #ff6b6b, #ff8e53) !important;
        color: white !important;
        font-weight: bold !important;
        padding: 6px 12px !important;
        border-radius: 20px !important;
      }

      .double-offer-btn {
        background: linear-gradient(45deg, #ff6b6b, #ff8e53) !important;
        color: white !important;
        border: none !important;
        font-weight: bold !important;
      }

      .double-offer-btn:hover {
        background: linear-gradient(45deg, #ff5252, #ff7b00) !important;
        transform: translateY(-2px) scale(1.05) !important;
        box-shadow: 0 8px 20px rgba(255, 107, 107, 0.4) !important;
      }

      .customer-item.combo-highlight {
        animation: highlight-combo 0.5s ease;
        position: relative;
      }

      @keyframes highlight-combo {
        0% {
          transform: scale(0.98);
          background-color: rgba(255, 107, 107, 0.1);
        }
        100% {
          transform: scale(1);
          background-color: inherit;
        }
      }

      .combo-tag {
        position: absolute;
        top: 10px;
        right: 10px;
        background: linear-gradient(45deg, #ff6b6b, #ff8e53);
        color: white;
        padding: 3px 8px;
        border-radius: 10px;
        font-size: 10px;
        font-weight: bold;
        z-index: 1;
      }
/* Mobile Navigation Enhancements - FIXED */
.mobile-menu-toggle {
  display: none;
  background: var(--primary);
  color: white;
  border: none;
  padding: 12px 16px;
  border-radius: 10px;
  font-size: 20px;
  cursor: pointer;
  transition: all 0.3s ease;
  z-index: 1002;
  box-shadow: 0 4px 12px rgba(255, 123, 172, 0.3);
  margin-left: auto; /* Push to the right */
}

.mobile-menu-toggle:hover {
  background: var(--secondary);
  transform: translateY(-2px);
  box-shadow: 0 6px 18px rgba(255, 179, 71, 0.4);
}

.mobile-menu-toggle:active {
  transform: translateY(0);
}

@media (max-width: 768px) {
  .mobile-menu-toggle {
    display: flex;
    align-items: center;
    justify-content: center;
    position: absolute; /* Position absolutely */
    right: 20px; /* Align to right edge */
    top: 20px; /* Align to top */
  }

  header {
    flex-wrap: wrap;
    padding: 20px;
    position: relative; /* Needed for absolute positioning */
    min-height: 100px; /* Ensure enough height */
  }

  /* Make logo container take full width */
  .logo-container {
    width: 100%;
    padding-right: 60px; /* Leave space for hamburger */
    margin-bottom: 10px;
  }

  /* Hide the header stats on mobile to save space */
  .header-stats {
    display: none;
  }

  /* Connection status on mobile */
  .connection-status {
    font-size: 12px;
    padding: 4px 10px;
  }

  nav {
    display: none;
    position: absolute;
    top: 100%;
    left: 20px;
    right: 20px;
    background: white;
    border-radius: 15px;
    margin-top: 15px;
    padding: 15px;
    box-shadow: 0 10px 30px rgba(0, 0, 0, 0.15);
    z-index: 1001;
    animation: slideDown 0.3s ease;
  }

  /* Show when toggled */
  nav.show {
    display: block !important;
  }

  /* Reset desktop positioning */
  nav ul {
    flex-direction: column;
    gap: 8px;
  }

  nav li {
    width: 100%;
  }

  nav a {
    padding: 15px 20px;
    border-radius: 10px;
    justify-content: flex-start;
    font-size: 16px;
    border: 1px solid #f0f0f0;
    background: white;
    color: var(--dark);
  }

  nav a:hover,
  nav a:focus {
    background-color: var(--primary);
    color: white;
    transform: translateX(5px);
  }

  nav a.active {
    background-color: var(--primary);
    color: white;
    border-left: 4px solid var(--secondary);
  }

  nav a.active::after {
    display: none;
  }
}

/* Desktop specific - keep nav visible */
@media (min-width: 769px) {
  .mobile-menu-toggle {
    display: none; /* Hide hamburger on desktop */
  }
  
  nav {
    display: flex !important; /* Ensure nav is visible on desktop */
  }
  
  .header-stats {
    display: flex; /* Show stats on desktop */
  }
}

/* Desktop specific */
@media (min-width: 769px) {
  .mobile-menu-toggle {
    display: none;
  }
  
  header {
    justify-content: space-between; /* Reset for desktop */
  }
  
  .logo-container {
    flex: 1; /* Take available space on desktop */
  }
}

/* Add this animation */
@keyframes slideDown {
  from {
    opacity: 0;
    transform: translateY(-10px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}
    </style>
  </head>
  <body>
    <div class="container">
      <header>
        <div class="logo-container">
          <div class="logo">
            <i class="fas fa-birthday-cake"></i>
          </div>
          <div class="logo-text">
            <h1>Cake Bliss</h1>
            <p>WhatsApp Promotions Manager</p>
            <div id="dbStatus" class="connection-status disconnected">
              <div class="status-dot disconnected"></div>
              <span>Database: Disconnected</span>
            </div>
            <div class="header-stats">
              <div class="stat-item">
                <i class="fas fa-users"></i>
                <span id="totalCustomers">0</span> customers
              </div>
              <div class="stat-item">
                <i class="fas fa-paper-plane"></i>
                <span id="totalSent">0</span> sent today
              </div>
            </div>
          </div>
        </div>

        <!-- Mobile Menu Toggle -->
        <button class="mobile-menu-toggle" onclick="toggleMobileMenu()">
          <i class="fas fa-bars"></i>
        </button>

        <nav id="mobileNav">
          <ul>
            <li>
              <a href="billing.html">
                <i class="fas fa-receipt"></i>
                <span>Billing</span>
              </a>
            </li>
            <li>
              <a href="inventory.html">
                <i class="fas fa-boxes"></i>
                <span>Inventory</span>
              </a>
            </li>
            <li>
              <a href="reports.html">
                <i class="fas fa-chart-bar"></i>
                <span>Reports</span>
              </a>
            </li>
            <li>
              <a href="promotions.html" class="active">
                <i class="fas fa-bullhorn"></i>
                <span>Promotions</span>
              </a>
            </li>
          </ul>
        </nav>
      </header>

      <!-- Dashboard Summary -->
      <div class="dashboard-summary">
        <div class="summary-card">
          <div class="summary-icon birthdays">
            <i class="fas fa-birthday-cake"></i>
          </div>
          <div class="summary-content">
            <h3>Upcoming Birthdays</h3>
            <div class="count" id="birthdayCount">0</div>
            <div class="subtext">Next 3 days</div>
          </div>
        </div>
        <div class="summary-card">
          <div class="summary-icon high-ticket">
            <i class="fas fa-crown"></i>
          </div>
          <div class="summary-content">
            <h3>High Ticket Customers</h3>
            <div class="count" id="highTicketCount">0</div>
            <div class="subtext">Last 30 days</div>
          </div>
        </div>
        <div class="summary-card">
          <div class="summary-icon gifting">
            <i class="fas fa-gift"></i>
          </div>
          <div class="summary-content">
            <h3>Gifting Opportunities</h3>
            <div class="count" id="giftingCount">0</div>
            <div class="subtext">Reciprocity reminders</div>
          </div>
        </div>
      </div>

      <!-- Filter Controls -->
      <div class="filter-controls">
        <div class="filter-group">
          <label for="daysFilter"
            ><i class="fas fa-calendar"></i> Birthday Range:</label
          >
          <select id="daysFilter">
            <option value="3">Next 3 days</option>
            <option value="7">Next 7 days</option>
            <option value="30">Next 30 days</option>
          </select>
        </div>
        <div class="filter-group">
          <label for="amountFilter"
            ><i class="fas fa-rupee-sign"></i> Min Amount:</label
          >
          <select id="amountFilter">
            <option value="1000">‚Çπ1,000+</option>
            <option value="2000">‚Çπ2,000+</option>
            <option value="5000">‚Çπ5,000+</option>
          </select>
        </div>
        <button id="refreshBtn" class="refresh-btn">
          <i class="fas fa-sync-alt"></i> Refresh Data
        </button>
      </div>
      <div class="main-content">
        <!-- Campaign 1: Upcoming Birthdays -->
        <div class="campaign-card">
          <div class="campaign-header">
            <div class="campaign-title">
              <div class="campaign-icon">
                <i class="fas fa-birthday-cake"></i>
              </div>
              <div>
                <h2>üéÇ Upcoming Birthdays</h2>
                <p>Send birthday offers to customers with upcoming birthdays</p>
              </div>
            </div>
            <div class="campaign-stats">
              <div class="stat-badge">
                <i class="fas fa-user"></i>
                <span id="birthdayStats">0 customers</span>
              </div>
            </div>
          </div>

          <div class="customer-list" id="birthdayList">
            <div class="loading">
              <i class="fas fa-spinner fa-spin"></i> Loading upcoming
              birthdays...
            </div>
          </div>
        </div>

        <!-- Campaign 2: High Ticket Customers -->
        <div class="campaign-card">
          <div class="campaign-header">
            <div class="campaign-title">
              <div class="campaign-icon">
                <i class="fas fa-crown"></i>
              </div>
              <div>
                <h2>üëë High Ticket Customers</h2>
                <p>Reward your highest spending customers</p>
              </div>
            </div>
            <div class="campaign-stats">
              <div class="stat-badge">
                <i class="fas fa-user"></i>
                <span id="highTicketStats">0 customers</span>
              </div>
            </div>
          </div>

          <div class="customer-list" id="highTicketList">
            <div class="loading">
              <i class="fas fa-spinner fa-spin"></i> Loading high ticket
              customers...
            </div>
          </div>
        </div>

        <!-- Campaign 3: Gifting Reciprocity -->
        <div class="campaign-card">
          <div class="campaign-header">
            <div class="campaign-title">
              <div class="campaign-icon">
                <i class="fas fa-gift"></i>
              </div>
              <div>
                <h2>üéÅ Gifting Reciprocity</h2>
                <p>
                  Remind customers who received cakes that their gifter's
                  birthday is coming up
                </p>
              </div>
            </div>
            <div class="campaign-stats">
              <div class="stat-badge">
                <i class="fas fa-user"></i>
                <span id="giftingStats">0 opportunities</span>
              </div>
            </div>
          </div>

          <div class="customer-list" id="giftingList">
            <div class="loading">
              <i class="fas fa-spinner fa-spin"></i> Loading gifting
              opportunities...
            </div>
          </div>
        </div>

        <!-- Campaign 4: Expiring Products Offers -->
        <div class="campaign-card">
          <div class="campaign-header">
            <div class="campaign-title">
              <div
                class="campaign-icon"
                style="
                  background: linear-gradient(45deg, var(--warning), #ff9800);
                "
              >
                <i class="fas fa-hourglass-end"></i>
              </div>
              <div>
                <h2>‚è∞ Expiring Products Offers</h2>
                <p>
                  Send special offers for products expiring soon to previous
                  buyers
                </p>
              </div>
            </div>
            <div class="campaign-stats">
              <div class="stat-badge">
                <i class="fas fa-box"></i>
                <span id="expiringStats">0 products</span>
              </div>
            </div>
          </div>

          <div class="customer-list" id="expiringList">
            <div class="loading">
              <i class="fas fa-spinner fa-spin"></i> Loading expiring
              products...
            </div>
          </div>
        </div>

        <!-- New Campaign: Birthday + Expiring Products Combo -->
      <div class="campaign-card">
        <div class="campaign-header">
          <div class="campaign-title">
            <div
              class="campaign-icon"
              style="background: linear-gradient(45deg, #ff6b6b, #ff8e53)"
            >
              <i class="fas fa-birthday-cake"></i>
              <i class="fas fa-fire" style="font-size: 14px; position: absolute; top: 5px; right: 5px;"></i>
            </div>
            <div>
              <h2>üéÇüî• Birthday & Expiring Products Combo</h2>
              <p>Special birthday offers with expiring products for maximum impact!</p>
            </div>
          </div>
          <div class="campaign-stats">
            <div class="stat-badge combo-badge">
              <i class="fas fa-star"></i>
              <span id="comboStats">0 matches</span>
            </div>
          </div>
        </div>

        <div class="customer-list" id="comboList">
          <div class="loading">
            <i class="fas fa-spinner fa-spin"></i> Loading birthday-expiring matches...
          </div>
        </div>
      </div>
      </div>
      <!-- Notification -->
      <div id="notification" class="notification">
        <i class="fas fa-check-circle"></i>
        <span>Notification message</span>
      </div>
    </div>

    <!-- Expiring Products Modal -->
    <div id="expiringModal" class="modal" style="display: none">
      <div class="modal-content" style="max-width: 900px; max-height: 90vh">
        <div class="campaign-header">
          <div class="campaign-title">
            <div
              class="campaign-icon"
              style="
                background: linear-gradient(45deg, var(--warning), #ff9800);
              "
            >
              <i class="fas fa-box"></i>
            </div>
            <div>
              <h2 id="expiringModalTitle">Expiring Product</h2>
              <p id="expiringModalSubtitle">
                Previous customers who purchased this product
              </p>
            </div>
          </div>
          <button
            type="button"
            class="close-modal"
            onclick="closeExpiringModal()"
          >
            <i class="fas fa-times"></i>
          </button>
        </div>

        <div
          class="customer-list"
          id="expiringCustomersList"
          style="max-height: 60vh"
        >
          <!-- Customers will be loaded here -->
        </div>

        <div
          style="
            padding: 20px;
            border-top: 1px solid #eee;
            display: flex;
            justify-content: space-between;
            align-items: center;
          "
        >
          <div>
            <strong id="expiringProductInfo"></strong>
          </div>
          <div>
            <button
              type="button"
              class="btn"
              onclick="closeExpiringModal()"
              style="background-color: #f0f0f0"
            >
              <i class="fas fa-times"></i> Close
            </button>
          </div>
        </div>
      </div>
    </div>
    <script>
      // Configuration
      const DEFAULT_CONFIG = {
        supabaseUrl: "https://vdbwzmutxjonnpfwfpbn.supabase.co",
        supabaseKey:
          "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZkYnd6bXV0eGpvbm5wZndmcGJuIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQ5OTcwMjQsImV4cCI6MjA4MDU3MzAyNH0.n0ERxgLgYU1Tvw5QONihv1C3A7o7rcxrcn5MjZ5UnEM",
      };
      // === GLOBAL VARIABLES ===
      const supabaseClient = window.supabase.createClient(
        DEFAULT_CONFIG.supabaseUrl,
        DEFAULT_CONFIG.supabaseKey
      );
      let isConnected = false;
      let dailySendCount = 0;
      const MAX_DAILY_SENDS = 50;

      // === INITIALIZATION ===
      document.addEventListener("DOMContentLoaded", async function () {
        await initSupabase();
        loadDailyCount();
        loadAllCampaigns();
        setupEventListeners();
      });

      // === DATABASE FUNCTIONS ===
      async function initSupabase() {
        try {
          const config = DEFAULT_CONFIG;
          supabase = window.supabase.createClient(
            config.supabaseUrl,
            config.supabaseKey
          );

          const { data, error } = await supabaseClient
            .from("cake_bills")
            .select("id")
            .limit(1);

          if (error) throw error;

          updateDbStatus(true);
          showNotification("Connected to database", "success");
          return true;
        } catch (error) {
          console.error("Failed to connect to Supabase:", error);
          updateDbStatus(false);
          showNotification("Database connection failed", "error");
          return false;
        }
      }

      function updateDbStatus(connected) {
        isConnected = connected;
        const dbStatus = document.getElementById("dbStatus");
        const statusDot = dbStatus.querySelector(".status-dot");
        const statusText = dbStatus.querySelector("span");

        if (connected) {
          dbStatus.className = "connection-status connected";
          statusDot.className = "status-dot connected";
          statusText.textContent = "Database: Connected";
        } else {
          dbStatus.className = "connection-status disconnected";
          statusDot.className = "status-dot disconnected";
          statusText.textContent = "Database: Disconnected";
        }
      }

      // === CAMPAIGN LOADING FUNCTIONS ===
      async function loadAllCampaigns() {
        if (!isConnected) {
          showNotification("Please connect to database first", "error");
          return;
        }

        const days = parseInt(document.getElementById("daysFilter").value);
        const minAmount = parseInt(
          document.getElementById("amountFilter").value
        );

        showNavLoading();

        try {
          await Promise.all([
            loadUpcomingBirthdays(days),
            loadHighTicketCustomers(minAmount),
            loadGiftingOpportunities(days),
            loadExpiringProducts(),
            loadBirthdayExpiringCombo(days),
          ]);
        } finally {
          hideNavLoading();
        }
      }
// Mobile menu toggle function
function toggleMobileMenu() {
  const mobileNav = document.getElementById("mobileNav");
  const menuIcon = document.querySelector(".mobile-menu-toggle i");
  
  if (!mobileNav) return;
  
  // Toggle the show class
  mobileNav.classList.toggle("show");
  
  // Change icon
  if (mobileNav.classList.contains("show")) {
    menuIcon.className = "fas fa-times";
    document.body.style.overflow = "hidden"; // Prevent scrolling when menu is open
  } else {
    menuIcon.className = "fas fa-bars";
    document.body.style.overflow = ""; // Restore scrolling
  }
}
      // Show navbar loading indicator
      function showNavLoading() {
        const loadingBar = document.createElement("div");
        loadingBar.className = "nav-loading active";
        document.querySelector("header").appendChild(loadingBar);
      }

      // Hide navbar loading indicator
      function hideNavLoading() {
        const loadingBar = document.querySelector(".nav-loading");
        if (loadingBar) {
          loadingBar.remove();
        }
      }

      async function loadUpcomingBirthdays(days = 3) {
        const container = document.getElementById("birthdayList");
        container.innerHTML =
          '<div class="loading"><i class="fas fa-spinner fa-spin"></i> Loading upcoming birthdays...</div>';

        try {
          const today = new Date();
          const futureDate = new Date();
          futureDate.setDate(today.getDate() + days);

          const { data: bills, error } = await supabaseClient
            .from("cake_bills")
            .select("*")
            .order("created_at", { ascending: false });

          if (error) throw error;

          const birthdayCustomers = [];
          const seenPhones = new Set();

          bills.forEach((bill) => {
            // Check purchaser birthday
            if (bill.purchaser_birthdate) {
              const purchaserBirthday = new Date(bill.purchaser_birthdate);
              const thisYearBirthday = new Date(
                today.getFullYear(),
                purchaserBirthday.getMonth(),
                purchaserBirthday.getDate()
              );

              if (thisYearBirthday >= today && thisYearBirthday <= futureDate) {
                const phone = bill.purchaser_phone;
                const hasPhone = phone && phone.trim() !== "";

                if (!seenPhones.has(phone)) {
                  birthdayCustomers.push({
                    name: bill.purchaser_name,
                    phone: phone,
                    birthday: bill.purchaser_birthdate,
                    type: "purchaser",
                    lastPurchase: bill.created_at,
                    totalSpent: parseFloat(bill.total_price) || 0,
                    hasPhone: hasPhone,
                    billData: bill
                  });
                  seenPhones.add(phone);
                }
              }
            }

            // Check birthday person's birthday
            if (bill.birthday_person_birthdate) {
              const birthdayPersonBirthday = new Date(
                bill.birthday_person_birthdate
              );
              const thisYearBirthday = new Date(
                today.getFullYear(),
                birthdayPersonBirthday.getMonth(),
                birthdayPersonBirthday.getDate()
              );

              if (thisYearBirthday >= today && thisYearBirthday <= futureDate) {
                const phone =
                  bill.birthday_person_phone || bill.purchaser_phone;
                const hasPhone = phone && phone.trim() !== "";

                if (hasPhone && !seenPhones.has(phone)) {
                  birthdayCustomers.push({
                    name: bill.birthday_person_name,
                    phone: phone,
                    birthday: bill.birthday_person_birthdate,
                    type: "birthday_person",
                    lastPurchase: bill.created_at,
                    totalSpent: parseFloat(bill.total_price) || 0,
                    hasPhone: hasPhone,
                    billData: bill
                  });
                  seenPhones.add(phone);
                }
              }
            }
          });

          const customersWithPhone = birthdayCustomers.filter(
            (c) => c.hasPhone
          );
          document.getElementById("birthdayCount").textContent =
            customersWithPhone.length;
          document.getElementById(
            "birthdayStats"
          ).textContent = `${customersWithPhone.length} customers`;
          updateTotalStats();

          if (birthdayCustomers.length === 0) {
            container.innerHTML =
              '<div class="empty-state"><i class="fas fa-birthday-cake"></i><p>No upcoming birthdays in selected range</p></div>';
            return;
          }

          container.innerHTML = "";
          birthdayCustomers.forEach((customer) => {
            const customerElement = createCustomerElement(customer, "birthday");
            container.appendChild(customerElement);
          });
        } catch (error) {
          console.error("Error loading birthdays:", error);
          container.innerHTML =
            '<div class="empty-state"><i class="fas fa-exclamation-triangle"></i><p>Failed to load birthdays</p></div>';
        }
      }

      async function loadHighTicketCustomers(minAmount = 1000) {
        const container = document.getElementById("highTicketList");
        container.innerHTML =
          '<div class="loading"><i class="fas fa-spinner fa-spin"></i> Loading high ticket customers...</div>';

        try {
          const thirtyDaysAgo = new Date();
          thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30);

          const { data: bills, error } = await supabaseClient
            .from("cake_bills")
            .select("*")
            .gte("created_at", thirtyDaysAgo.toISOString())
            .order("total_price", { ascending: false });

          if (error) throw error;

          const customerMap = new Map();

          bills.forEach((bill) => {
            const phone = bill.purchaser_phone;
            const amount = parseFloat(bill.total_price) || 0;

            if (customerMap.has(phone)) {
              const existing = customerMap.get(phone);
              existing.totalSpent += amount;
              existing.lastPurchase =
                bill.created_at > existing.lastPurchase
                  ? bill.created_at
                  : existing.lastPurchase;
            } else {
              customerMap.set(phone, {
                name: bill.purchaser_name,
                phone: phone,
                totalSpent: amount,
                lastPurchase: bill.created_at,
                billCount: 1,
              });
            }
          });

          const highTicketCustomers = Array.from(customerMap.values())
            .filter((customer) => customer.totalSpent >= minAmount)
            .sort((a, b) => b.totalSpent - a.totalSpent);

          document.getElementById("highTicketCount").textContent =
            highTicketCustomers.length;
          document.getElementById(
            "highTicketStats"
          ).textContent = `${highTicketCustomers.length} customers`;
          updateTotalStats();

          if (highTicketCustomers.length === 0) {
            container.innerHTML =
              '<div class="empty-state"><i class="fas fa-crown"></i><p>No high ticket customers found</p></div>';
            return;
          }

          container.innerHTML = "";
          highTicketCustomers.forEach((customer) => {
            const customerElement = createCustomerElement(
              customer,
              "highTicket"
            );
            container.appendChild(customerElement);
          });
        } catch (error) {
          console.error("Error loading high ticket customers:", error);
          container.innerHTML =
            '<div class="empty-state"><i class="fas fa-exclamation-triangle"></i><p>Failed to load high ticket customers</p></div>';
        }
      }

      async function loadGiftingOpportunities(days = 3) {
        const container = document.getElementById("giftingList");
        container.innerHTML =
          '<div class="loading"><i class="fas fa-spinner fa-spin"></i> Loading gifting opportunities...</div>';

        try {
          const { data: allBills, error } = await supabaseClient
            .from("cake_bills")
            .select("*")
            .order("created_at", { ascending: false });

          if (error) throw error;

          const giftingMap = new Map();
          const today = new Date();
          const futureDate = new Date();
          futureDate.setDate(today.getDate() + days);

          allBills.forEach((bill) => {
            if (
              bill.birthday_person_phone &&
              bill.birthday_person_name !== bill.purchaser_name
            ) {
              const recipientPhone = bill.birthday_person_phone;
              if (!giftingMap.has(recipientPhone)) {
                giftingMap.set(recipientPhone, []);
              }
              giftingMap.get(recipientPhone).push({
                gifterName: bill.purchaser_name,
                gifterPhone: bill.purchaser_phone,
                gifterBirthday: bill.purchaser_birthdate,
                giftDate: bill.created_at,
              });
            }
          });

          const opportunities = [];
          const seenRecipients = new Set();

          giftingMap.forEach((gifters, recipientPhone) => {
            gifters.forEach((gifter) => {
              if (gifter.gifterBirthday) {
                const gifterBirthday = new Date(gifter.gifterBirthday);
                const thisYearBirthday = new Date(
                  today.getFullYear(),
                  gifterBirthday.getMonth(),
                  gifterBirthday.getDate()
                );

                if (
                  thisYearBirthday >= today &&
                  thisYearBirthday <= futureDate
                ) {
                  if (seenRecipients.has(recipientPhone)) return;

                  const recipientBill = allBills.find(
                    (bill) =>
                      bill.birthday_person_phone === recipientPhone ||
                      (bill.purchaser_phone === recipientPhone &&
                        bill.birthday_person_phone)
                  );

                  if (recipientBill) {
                    opportunities.push({
                      recipientName:
                        recipientBill.birthday_person_name ||
                        recipientBill.purchaser_name,
                      recipientPhone: recipientPhone,
                      gifterName: gifter.gifterName,
                      gifterPhone: gifter.gifterPhone,
                      gifterBirthday: gifter.gifterBirthday,
                      lastGiftDate: gifter.giftDate,
                      lastGiftAmount:
                        parseFloat(recipientBill.total_price) || 0,
                    });

                    seenRecipients.add(recipientPhone);
                  }
                }
              }
            });
          });

          document.getElementById("giftingCount").textContent =
            opportunities.length;
          document.getElementById(
            "giftingStats"
          ).textContent = `${opportunities.length} opportunities`;
          updateTotalStats();

          if (opportunities.length === 0) {
            container.innerHTML =
              '<div class="empty-state"><i class="fas fa-gift"></i><p>No gifting opportunities found</p></div>';
            return;
          }

          container.innerHTML = "";
          opportunities.forEach((opportunity) => {
            const opportunityElement = createGiftingElement(opportunity);
            container.appendChild(opportunityElement);
          });
        } catch (error) {
          console.error("Error loading gifting opportunities:", error);
          container.innerHTML =
            '<div class="empty-state"><i class="fas fa-exclamation-triangle"></i><p>Failed to load gifting opportunities</p></div>';
        }
      }

      async function loadExpiringProducts() {
        const container = document.getElementById("expiringList");
        container.innerHTML =
          '<div class="loading"><i class="fas fa-spinner fa-spin"></i> Loading expiring products...</div>';

        try {
          const { data: inventoryData, error: inventoryError } =
            await supabaseClient
              .from("products")
              .select("*")
              .order("product_name");
          if (inventoryError) throw inventoryError;

          const { data: batchesData, error: batchesError } =
            await supabaseClient.from("product_batches").select("*");
          if (
            batchesError &&
            !batchesError.message.includes("does not exist")
          ) {
            throw batchesError;
          }

          const today = new Date();
          today.setHours(0, 0, 0, 0);
          const expiringProducts = [];

          inventoryData.forEach((product) => {
            const productBatches = batchesData.filter(
              (b) => b.product_code === product.product_code
            );
            if (productBatches.length === 0) return;

            let totalStock = 0;
            let earliestExpiry = null;
            let expiringSoon = false;

            productBatches.forEach((batch) => {
              if (batch.expiry_date) {
                const expiryDate = new Date(batch.expiry_date);
                expiryDate.setHours(0, 0, 0, 0);

                const diffTime = expiryDate - today;
                const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));

                const remainingQty = batch.remaining_quantity || 0;
                if (diffDays >= 0 && diffDays <= 3 && remainingQty > 0) {
                  expiringSoon = true;
                  if (!earliestExpiry || expiryDate < earliestExpiry) {
                    earliestExpiry = expiryDate;
                  }
                }

                if (expiryDate >= today) {
                  totalStock += remainingQty;
                }
              }
            });

            if (expiringSoon && totalStock > 0) {
              expiringProducts.push({
                id: product.id,
                name: product.product_name,
                code: product.product_code,
                price: parseFloat(product.unit_price) || 0,
                stock: totalStock,
                expiryDate: earliestExpiry,
                category: product.category,
                shelfLife: product.shelf_life_days || 7,
              });
            }
          });

          expiringProducts.sort((a, b) => a.expiryDate - b.expiryDate);
          document.getElementById(
            "expiringStats"
          ).textContent = `${expiringProducts.length} products`;

          if (expiringProducts.length === 0) {
            container.innerHTML =
              '<div class="empty-state"><i class="fas fa-box-open"></i><p>No products expiring soon</p></div>';
            return;
          }

          container.innerHTML = "";
          expiringProducts.forEach((product) => {
            const productElement = createExpiringProductElement(product);
            container.appendChild(productElement);
          });
        } catch (error) {
          console.error("Error loading expiring products:", error);
          container.innerHTML =
            '<div class="empty-state"><i class="fas fa-exclamation-triangle"></i><p>Failed to load expiring products</p></div>';
        }
      }

      // === NEW FUNCTION: LOAD BIRTHDAY + EXPIRING COMBO ===
      async function loadBirthdayExpiringCombo(days = 3) {
        const container = document.getElementById("comboList");
        if (!container) return;
        
        container.innerHTML =
          '<div class="loading"><i class="fas fa-spinner fa-spin"></i> Finding birthday-expiring matches...</div>';

        try {
          // Get upcoming birthdays
          const today = new Date();
          const futureDate = new Date();
          futureDate.setDate(today.getDate() + days);

          const { data: bills, error: billsError } = await supabaseClient
            .from("cake_bills")
            .select("*")
            .order("created_at", { ascending: false });

          if (billsError) throw billsError;

          // Get expiring products
          const { data: inventoryData, error: inventoryError } =
            await supabaseClient
              .from("products")
              .select("*")
              .order("product_name");
          if (inventoryError) throw inventoryError;

          const { data: batchesData, error: batchesError } =
            await supabaseClient.from("product_batches").select("*");
          if (
            batchesError &&
            !batchesError.message.includes("does not exist")
          ) {
            throw batchesError;
          }

          // Find expiring products
          const todayDate = new Date();
          todayDate.setHours(0, 0, 0, 0);
          const expiringProducts = [];

          inventoryData.forEach((product) => {
            const productBatches = batchesData.filter(
              (b) => b.product_code === product.product_code
            );
            if (productBatches.length === 0) return;

            let totalStock = 0;
            let earliestExpiry = null;
            let expiringSoon = false;

            productBatches.forEach((batch) => {
              if (batch.expiry_date) {
                const expiryDate = new Date(batch.expiry_date);
                expiryDate.setHours(0, 0, 0, 0);

                const diffTime = expiryDate - todayDate;
                const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));

                const remainingQty = batch.remaining_quantity || 0;
                if (diffDays >= 0 && diffDays <= 3 && remainingQty > 0) {
                  expiringSoon = true;
                  if (!earliestExpiry || expiryDate < earliestExpiry) {
                    earliestExpiry = expiryDate;
                  }
                }

                if (expiryDate >= todayDate) {
                  totalStock += remainingQty;
                }
              }
            });

            if (expiringSoon && totalStock > 0) {
              expiringProducts.push({
                id: product.id,
                name: product.product_name,
                code: product.product_code,
                price: parseFloat(product.unit_price) || 0,
                stock: totalStock,
                expiryDate: earliestExpiry,
                category: product.category,
                shelfLife: product.shelf_life_days || 7,
              });
            }
          });

          // Find birthday customers and match with expiring products
          const birthdayExpiringMatches = [];
          const seenPhones = new Set();

          // First pass: Collect all birthday customers
          const birthdayCustomers = [];
          bills.forEach((bill) => {
            // Check purchaser birthday
            if (bill.purchaser_birthdate) {
              const purchaserBirthday = new Date(bill.purchaser_birthdate);
              const thisYearBirthday = new Date(
                today.getFullYear(),
                purchaserBirthday.getMonth(),
                purchaserBirthday.getDate()
              );

              if (thisYearBirthday >= today && thisYearBirthday <= futureDate) {
                const phone = bill.purchaser_phone;
                const hasPhone = phone && phone.trim() !== "";

                if (!seenPhones.has(phone) && hasPhone) {
                  birthdayCustomers.push({
                    name: bill.purchaser_name,
                    phone: phone,
                    birthday: bill.purchaser_birthdate,
                    type: "purchaser",
                    lastPurchase: bill.created_at,
                    totalSpent: parseFloat(bill.total_price) || 0,
                    hasPhone: hasPhone,
                    billData: bill
                  });
                  seenPhones.add(phone);
                }
              }
            }

            // Check birthday person's birthday
            if (bill.birthday_person_birthdate) {
              const birthdayPersonBirthday = new Date(
                bill.birthday_person_birthdate
              );
              const thisYearBirthday = new Date(
                today.getFullYear(),
                birthdayPersonBirthday.getMonth(),
                birthdayPersonBirthday.getDate()
              );

              if (thisYearBirthday >= today && thisYearBirthday <= futureDate) {
                const phone =
                  bill.birthday_person_phone || bill.purchaser_phone;
                const hasPhone = phone && phone.trim() !== "";

                if (hasPhone && !seenPhones.has(phone)) {
                  birthdayCustomers.push({
                    name: bill.birthday_person_name,
                    phone: phone,
                    birthday: bill.birthday_person_birthdate,
                    type: "birthday_person",
                    lastPurchase: bill.created_at,
                    totalSpent: parseFloat(bill.total_price) || 0,
                    hasPhone: hasPhone,
                    billData: bill
                  });
                  seenPhones.add(phone);
                }
              }
            }
          });

          // Second pass: Match birthday customers with their purchased expiring products
          birthdayCustomers.forEach((customer) => {
            // Find products this customer has purchased that are now expiring
            const customerBill = customer.billData;
            const customerExpiringProducts = [];

            if (customerBill) {
              expiringProducts.forEach((expiringProduct) => {
                // Check if this customer purchased this product
                let purchasedThisProduct = false;
                
                // Check product name in various possible fields
                const productName = expiringProduct.name.toLowerCase();
                const billString = JSON.stringify(customerBill).toLowerCase();
                
                // Simple matching logic
                if (billString.includes(productName) || 
                    (productName.includes("cake") && billString.includes("cake")) ||
                    (expiringProduct.category && expiringProduct.category.toLowerCase() === "cakes" && 
                     (billString.includes("cake") || billString.includes("pastry")))) {
                  purchasedThisProduct = true;
                }

                // Also check by product code if available
                if (customerBill.product_code === expiringProduct.code) {
                  purchasedThisProduct = true;
                }

                // Check items array if it exists
                const possibleItemFields = ["items", "products", "products_list", "order_items"];
                possibleItemFields.forEach((field) => {
                  if (customerBill[field]) {
                    try {
                      let items = [];
                      if (typeof customerBill[field] === "string") {
                        items = JSON.parse(customerBill[field]);
                      } else if (Array.isArray(customerBill[field])) {
                        items = customerBill[field];
                      }
                      
                      if (Array.isArray(items)) {
                        items.forEach((item) => {
                          if (!item) return;
                          const itemName = (
                            item.name ||
                            item.product_name ||
                            item.productName ||
                            item.description ||
                            ""
                          ).toLowerCase();
                          const itemCode = (
                            item.productCode ||
                            item.code ||
                            item.product_code ||
                            item.id ||
                            ""
                          ).toString().toLowerCase();
                          
                          if (itemName.includes(productName) || 
                              itemCode === expiringProduct.code.toLowerCase() ||
                              (expiringProduct.category && expiringProduct.category.toLowerCase() === "cakes" && 
                               (itemName.includes("cake") || itemName.includes("pastry")))) {
                            purchasedThisProduct = true;
                          }
                        });
                      }
                    } catch (e) {
                      // Silent catch for JSON parsing errors
                    }
                  }
                });

                if (purchasedThisProduct) {
                  customerExpiringProducts.push(expiringProduct);
                }
              });

              if (customerExpiringProducts.length > 0) {
                // Sort by closest expiry date
                customerExpiringProducts.sort((a, b) => a.expiryDate - b.expiryDate);
                
                birthdayExpiringMatches.push({
                  customer: customer,
                  expiringProducts: customerExpiringProducts,
                  matchScore: customerExpiringProducts.length * 10 + 
                             (30 - Math.ceil((customerExpiringProducts[0].expiryDate - today) / (1000 * 60 * 60 * 24))) // Days until expiry
                });
              }
            }
          });

          // Sort by match score (highest first)
          birthdayExpiringMatches.sort((a, b) => b.matchScore - a.matchScore);

          const comboStats = document.getElementById("comboStats");
          if (comboStats) {
            comboStats.textContent = `${birthdayExpiringMatches.length} matches`;
          }

          if (birthdayExpiringMatches.length === 0) {
            container.innerHTML =
              '<div class="empty-state"><i class="fas fa-search"></i><p>No birthday-expiring product matches found</p></div>';
            return;
          }

          container.innerHTML = "";
          birthdayExpiringMatches.forEach((match, index) => {
            const matchElement = createBirthdayExpiringElement(match, index);
            container.appendChild(matchElement);
          });
        } catch (error) {
          console.error("Error loading birthday-expiring combo:", error);
          container.innerHTML =
            '<div class="empty-state"><i class="fas fa-exclamation-triangle"></i><p>Failed to load birthday-expiring matches</p></div>';
        }
      }

      // === UI ELEMENT CREATION ===
      function createCustomerElement(customer, type) {
        const div = document.createElement("div");
        div.className = "customer-item";

        const formattedDate = customer.birthday
          ? new Date(customer.birthday).toLocaleDateString("en-IN", {
              day: "numeric",
              month: "long",
            })
          : "N/A";

        const lastPurchaseDate = customer.lastPurchase
          ? new Date(customer.lastPurchase).toLocaleDateString("en-IN")
          : "Never";

        let typeBadge = "";
        if (customer.type === "purchaser") {
          typeBadge = '<span class="type-badge purchaser">Purchaser</span>';
        } else if (customer.type === "birthday_person") {
          typeBadge =
            '<span class="type-badge birthday-person">Birthday Person</span>';
        }

        const hasPhone = customer.phone && customer.phone.trim() !== "";
        const escapedName = customer.name.replace(/'/g, "\\'");
        const escapedPhone = customer.phone
          ? customer.phone.replace(/'/g, "\\'")
          : "";

        div.innerHTML = `
      <div class="customer-info">
          <h4>${customer.name}</h4>
          <div class="customer-phone ${!hasPhone ? "no-phone" : ""}">
              ${
                hasPhone
                  ? customer.phone
                  : '<i class="fas fa-phone-slash"></i> No phone number'
              }
          </div>
          <div class="customer-type">${typeBadge}</div>
      </div>
      <div class="customer-date">
          <i class="fas fa-calendar-alt"></i>
          ${
            type === "birthday"
              ? "Birthday: " + formattedDate
              : "Last Purchase: " + lastPurchaseDate
          }
      </div>
      <div class="customer-amount">
          ${type === "highTicket" ? "‚Çπ" + customer.totalSpent.toFixed(0) : ""}
      </div>
      <div class="action-buttons">
          ${
            hasPhone
              ? `<button class="btn-whatsapp" onclick="sendBirthdayOffer('${escapedPhone}', '${escapedName}', '${formattedDate}', '${type}')">
                    <i class="fab fa-whatsapp"></i> Send Offer
                 </button>`
              : `<button class="btn-whatsapp" disabled title="No phone number available">
                    <i class="fas fa-ban"></i> No Phone
                 </button>`
          }
      </div>
    `;

        return div;
      }

      function createGiftingElement(opportunity) {
        const div = document.createElement("div");
        div.className = "customer-item";

        const gifterBirthday = new Date(
          opportunity.gifterBirthday
        ).toLocaleDateString("en-IN", {
          day: "2-digit",
          month: "long",
        });

        const lastGiftDate = new Date(
          opportunity.lastGiftDate
        ).toLocaleDateString("en-IN");
        const hasPhone =
          opportunity.recipientPhone &&
          opportunity.recipientPhone.trim() !== "";

        const escapedRecipientName = opportunity.recipientName.replace(
          /'/g,
          "\\'"
        );
        const escapedRecipientPhone = opportunity.recipientPhone
          ? opportunity.recipientPhone.replace(/'/g, "\\'")
          : "";
        const escapedGifterName = opportunity.gifterName.replace(/'/g, "\\'");
        const escapedGifterBirthday = gifterBirthday.replace(/'/g, "\\'");

        div.innerHTML = `
      <div class="customer-info">
          <h4>${opportunity.recipientName}</h4>
          <div class="customer-phone ${!hasPhone ? "no-phone" : ""}">
              ${
                hasPhone
                  ? opportunity.recipientPhone
                  : '<i class="fas fa-phone-slash"></i> No phone number'
              }
          </div>
          <div class="customer-type">
              <span class="type-badge purchaser">Received Gift</span>
          </div>
      </div>
      <div class="customer-date">
          <i class="fas fa-user-friends"></i>
          From: ${opportunity.gifterName}
      </div>
      <div class="customer-date">
          <i class="fas fa-calendar-star"></i>
          Their birthday: ${gifterBirthday}
      </div>
      <div class="customer-amount">
          ‚Çπ${opportunity.lastGiftAmount.toFixed(0)}
      </div>
      <div class="action-buttons">
          ${
            hasPhone
              ? `<button class="btn-whatsapp" onclick="sendGiftingReminder('${escapedRecipientPhone}', '${escapedRecipientName}', '${escapedGifterName}', '${escapedGifterBirthday}')">
                    <i class="fab fa-whatsapp"></i> Send Reminder
                 </button>`
              : `<button class="btn-whatsapp" disabled title="No phone number available">
                    <i class="fas fa-ban"></i> No Phone
                 </button>`
          }
      </div>
    `;

        return div;
      }

      function createExpiringProductElement(product) {
        const div = document.createElement("div");
        div.className = "customer-item";

        const expiryDateStr = product.expiryDate.toLocaleDateString("en-IN", {
          day: "numeric",
          month: "long",
          year: "numeric",
        });

        const today = new Date();
        const diffTime = product.expiryDate - today;
        const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));

        let expiryBadge = "";
        if (diffDays === 0) {
          expiryBadge =
            '<span class="type-badge" style="background-color: rgba(244, 67, 54, 0.1); color: var(--danger);">EXPIRES TODAY</span>';
        } else if (diffDays === 1) {
          expiryBadge =
            '<span class="type-badge" style="background-color: rgba(255, 152, 0, 0.1); color: var(--warning);">1 DAY LEFT</span>';
        } else {
          expiryBadge = `<span class="type-badge" style="background-color: rgba(255, 152, 0, 0.1); color: var(--warning);">${diffDays} DAYS LEFT</span>`;
        }

        const escapedProductName = product.name.replace(/'/g, "\\'");
        const escapedExpiryDate = expiryDateStr.replace(/'/g, "\\'");

        div.innerHTML = `
      <div class="customer-info">
        <h4>${product.name}</h4>
        <div style="font-size: 13px; color: #666; margin-top: 5px;">
          <i class="fas fa-barcode"></i> ${product.code}
        </div>
        <div style="font-size: 13px; color: #666; margin-top: 3px;">
          <i class="fas fa-tag"></i> ${product.category}
        </div>
      </div>
      <div class="customer-date">
        <i class="fas fa-calendar-times"></i>
        Expires: ${expiryDateStr}
      </div>
      <div class="customer-amount" style="display: flex; flex-direction: column; align-items: center;">
        <div style="font-size: 18px; font-weight: 700; color: var(--accent);">
          ‚Çπ${product.price.toFixed(2)}
        </div>
        <div style="font-size: 12px; color: #666; margin-top: 5px;">
          <i class="fas fa-box"></i> ${product.stock} in stock
        </div>
      </div>
      <div class="action-buttons">
        <button class="btn-whatsapp" onclick="viewProductCustomers('${
          product.id
        }', '${escapedProductName}', ${product.stock}, '${escapedExpiryDate}')">
          <i class="fas fa-users"></i> View Buyers
        </button>
      </div>
    `;

        return div;
      }

      // === CREATE BIRTHDAY + EXPIRING ELEMENT ===
      function createBirthdayExpiringElement(match, index) {
        const div = document.createElement("div");
        div.className = "customer-item combo-highlight";
        
        const birthdayDate = new Date(match.customer.birthday).toLocaleDateString("en-IN", {
          day: "numeric",
          month: "long",
        });

        // Format expiry dates
        const expiringProductsList = match.expiringProducts
          .slice(0, 2) // Show only first 2 products
          .map(product => {
            const expiryDate = new Date(product.expiryDate).toLocaleDateString("en-IN", {
              day: "numeric",
              month: "short"
            });
            const diffDays = Math.ceil((product.expiryDate - new Date()) / (1000 * 60 * 60 * 24));
            return `${product.name} (expires ${expiryDate}, ${diffDays} days left)`;
          })
          .join(", ");

        const hasPhone = match.customer.hasPhone;
        const escapedName = match.customer.name.replace(/'/g, "\\'");
        const escapedPhone = match.customer.phone.replace(/'/g, "\\'");
        const escapedBirthday = birthdayDate.replace(/'/g, "\\'");
        
        // Create product list for message
        const productList = match.expiringProducts.map(p => p.name).join(", ");
        const escapedProductList = productList.replace(/'/g, "\\'");

        // Get the first (most urgent) expiring product
        const mainProduct = match.expiringProducts[0];
        const escapedMainProduct = mainProduct.name.replace(/'/g, "\\'");
        const expiryDateStr = new Date(mainProduct.expiryDate).toLocaleDateString("en-IN", {
          day: "numeric",
          month: "long",
          year: "numeric"
        });
        const escapedExpiryDate = expiryDateStr.replace(/'/g, "\\'");

        div.innerHTML = `
          <div class="combo-tag">${match.expiringProducts.length} expiring products</div>
          <div class="customer-info">
            <h4 style="color: #ff6b6b;">${match.customer.name}</h4>
            <div class="customer-phone ${!hasPhone ? "no-phone" : ""}">
              ${match.customer.phone}
            </div>
            <div class="customer-type">
              <span class="type-badge" style="background: rgba(255, 107, 107, 0.1); color: #ff6b6b;">
                <i class="fas fa-birthday-cake"></i> Birthday on ${birthdayDate}
              </span>
            </div>
          </div>
          <div class="customer-date">
            <i class="fas fa-fire" style="color: #ff6b6b;"></i>
            Expiring products: ${expiringProductsList}
            ${match.expiringProducts.length > 2 ? `+${match.expiringProducts.length - 2} more` : ''}
          </div>
          <div class="action-buttons">
            ${
              hasPhone
                ? `<button class="btn-whatsapp double-offer-btn" onclick="sendBirthdayExpiringComboOffer('${escapedPhone}', '${escapedName}', '${escapedBirthday}', '${escapedMainProduct}', '${escapedExpiryDate}', '${escapedProductList}')">
                    <i class="fab fa-whatsapp"></i> Send Combo Offer
                  </button>`
                : `<button class="btn-whatsapp" disabled title="No phone number available">
                    <i class="fas fa-ban"></i> No Phone
                  </button>`
            }
          </div>
        `;

        return div;
      }

      async function viewProductCustomers(
        productId,
        productName,
        stock,
        expiryDate
      ) {
        try {
          document.getElementById("expiringModalTitle").textContent =
            productName;
          document.getElementById("expiringModalSubtitle").textContent =
            "Previous customers who purchased this product";
          document.getElementById(
            "expiringProductInfo"
          ).innerHTML = `Stock: ${stock} units | Expires: ${expiryDate}`;

          const container = document.getElementById("expiringCustomersList");
          container.innerHTML =
            '<div class="loading"><i class="fas fa-spinner fa-spin"></i> Loading previous buyers...</div>';
          document.getElementById("expiringModal").style.display = "flex";

          const { data: productData, error: productError } =
            await supabaseClient
              .from("products")
              .select("product_code, product_name, category")
              .eq("id", productId)
              .single();

          if (productError) throw productError;

          const productCode = productData.product_code;
          const actualProductName = productData.product_name;
          const category = productData.category;

          const { data: bills, error: billsError } = await supabaseClient
            .from("cake_bills")
            .select("*")
            .order("created_at", { ascending: false });

          if (billsError) throw billsError;

          const uniqueCustomers = new Map();

          if (bills && bills.length > 0) {
            bills.forEach((bill) => {
              const customerPhone =
                bill.purchaser_phone || bill.customer_phone || bill.phone;
              const customerName =
                bill.purchaser_name ||
                bill.customer_name ||
                bill.name ||
                "Unknown Customer";

              if (!customerPhone || customerPhone.trim() === "") return;

              let itemsFound = [];
              const possibleItemFields = [
                "items",
                "products",
                "products_list",
                "order_items",
              ];

              possibleItemFields.forEach((field) => {
                if (bill[field]) {
                  try {
                    let items = [];
                    if (typeof bill[field] === "string") {
                      items = JSON.parse(bill[field]);
                    } else if (Array.isArray(bill[field])) {
                      items = bill[field];
                    }
                    if (Array.isArray(items)) {
                      itemsFound = itemsFound.concat(items);
                    }
                  } catch (e) {}
                }
              });

              if (bill.product_name || bill.product_code) {
                itemsFound.push({
                  name: bill.product_name,
                  code: bill.product_code,
                  quantity: bill.quantity || 1,
                  price: bill.unit_price || bill.total_price,
                });
              }

              let productFound = false;
              itemsFound.forEach((item) => {
                if (!item) return;
                const itemName = (
                  item.name ||
                  item.product_name ||
                  item.productName ||
                  item.description ||
                  ""
                ).toLowerCase();
                const itemCode = (
                  item.productCode ||
                  item.code ||
                  item.product_code ||
                  item.id ||
                  ""
                )
                  .toString()
                  .toLowerCase();
                const searchName = actualProductName.toLowerCase();
                const searchCode = productCode.toLowerCase();

                const matches =
                  itemCode === searchCode ||
                  itemName === searchName ||
                  itemName.includes(searchName) ||
                  searchName
                    .split(" ")
                    .some(
                      (word) => word.length > 3 && itemName.includes(word)
                    ) ||
                  itemName.includes(searchCode.replace(/-/g, " ")) ||
                  (category &&
                    category.toLowerCase() === "cakes" &&
                    (itemName.includes("cake") || itemName.includes("pastry")));

                if (matches) productFound = true;
              });

              if (productFound) {
                if (!uniqueCustomers.has(customerPhone)) {
                  uniqueCustomers.set(customerPhone, {
                    name: customerName,
                    phone: customerPhone,
                    lastPurchase: bill.created_at,
                    totalSpent: parseFloat(bill.total_price) || 0,
                    purchaseDate: new Date(
                      bill.created_at
                    ).toLocaleDateString(),
                  });
                } else {
                  const existing = uniqueCustomers.get(customerPhone);
                  if (
                    new Date(bill.created_at) > new Date(existing.lastPurchase)
                  ) {
                    existing.lastPurchase = bill.created_at;
                    existing.totalSpent = parseFloat(bill.total_price) || 0;
                    existing.purchaseDate = new Date(
                      bill.created_at
                    ).toLocaleDateString();
                  }
                }
              }
            });
          }

          const customers = Array.from(uniqueCustomers.values()).sort(
            (a, b) => new Date(b.lastPurchase) - new Date(a.lastPurchase)
          );

          if (customers.length === 0) {
            const alternativeCustomers = await searchCustomersByProductName(
              actualProductName,
              bills
            );
            if (alternativeCustomers.length > 0) {
              container.innerHTML = "";
              alternativeCustomers.forEach((customer) => {
                const customerElement = createExpiringCustomerElement(
                  customer,
                  actualProductName,
                  expiryDate,
                  stock
                );
                container.appendChild(customerElement);
              });
              return;
            }

            container.innerHTML = `
          <div class="empty-state">
            <i class="fas fa-users-slash"></i>
            <p>No previous buyers found for "${actualProductName}"</p>
          </div>
        `;
            return;
          }

          container.innerHTML = "";
          customers.forEach((customer) => {
            const customerElement = createExpiringCustomerElement(
              customer,
              actualProductName,
              expiryDate,
              stock
            );
            container.appendChild(customerElement);
          });
        } catch (error) {
          console.error("Error loading product customers:", error);
          const container = document.getElementById("expiringCustomersList");
          container.innerHTML = `
        <div class="empty-state">
          <i class="fas fa-exclamation-triangle"></i>
          <p>Error loading customers</p>
        </div>
      `;
        }
      }

      async function searchCustomersByProductName(productName, bills) {
        const uniqueCustomers = new Map();
        const searchName = productName.toLowerCase();

        bills.forEach((bill) => {
          const customerPhone = bill.purchaser_phone;
          const customerName = bill.purchaser_name;

          if (!customerPhone || customerPhone.trim() === "") return;

          const billString = JSON.stringify(bill).toLowerCase();
          if (
            billString.includes(searchName) ||
            (searchName.includes("cake") && billString.includes("cake"))
          ) {
            if (!uniqueCustomers.has(customerPhone)) {
              uniqueCustomers.set(customerPhone, {
                name: customerName,
                phone: customerPhone,
                lastPurchase: bill.created_at,
                totalSpent: parseFloat(bill.total_price) || 0,
                purchaseDate: new Date(bill.created_at).toLocaleDateString(),
              });
            }
          }
        });

        return Array.from(uniqueCustomers.values());
      }

      function createExpiringCustomerElement(
        customer,
        productName,
        expiryDate,
        stock
      ) {
        const div = document.createElement("div");
        div.className = "customer-item";

        const lastPurchaseDate = new Date(
          customer.lastPurchase
        ).toLocaleDateString("en-IN");
        const hasPhone = customer.phone && customer.phone.trim() !== "";

        const escapedCustomerName = customer.name.replace(/'/g, "\\'");
        const escapedCustomerPhone = customer.phone
          ? customer.phone.replace(/'/g, "\\'")
          : "";
        const escapedProductName = productName.replace(/'/g, "\\'");
        const escapedExpiryDate = expiryDate.replace(/'/g, "\\'");

        div.innerHTML = `
      <div class="customer-info">
        <h4>${customer.name}</h4>
        <div class="customer-phone ${!hasPhone ? "no-phone" : ""}">
          ${
            hasPhone
              ? customer.phone
              : '<i class="fas fa-phone-slash"></i> No phone number'
          }
        </div>
      </div>
      <div class="customer-date">
        <i class="fas fa-shopping-cart"></i>
        Last bought: ${lastPurchaseDate}
      </div>
      <div class="customer-amount">
        ‚Çπ${customer.totalSpent.toFixed(0)}
      </div>
      <div class="action-buttons">
        ${
          hasPhone
            ? `<button class="btn-whatsapp" onclick="sendExpiringProductOffer('${escapedCustomerPhone}', '${escapedCustomerName}', '${escapedProductName}', '${escapedExpiryDate}', ${stock})">
                <i class="fab fa-whatsapp"></i> Send Offer
              </button>`
            : `<button class="btn-whatsapp" disabled title="No phone number available">
                <i class="fas fa-ban"></i> No Phone
              </button>`
        }
      </div>
    `;

        return div;
      }

      // === MESSAGE SENDING FUNCTIONS ===
      function sendBirthdayOffer(phone, name, birthday, type) {
        if (!phone || phone.trim() === "") {
          showNotification(
            "Cannot send: No phone number available for " + name,
            "error"
          );
          return;
        }

        if (dailySendCount >= MAX_DAILY_SENDS) {
          showNotification(
            `Daily limit reached (${MAX_DAILY_SENDS} messages). Try again tomorrow.`,
            "warning"
          );
          return;
        }

        const cleanPhone = phone.replace(/\D/g, "");
        const phoneWithCountryCode = cleanPhone.startsWith("91")
          ? cleanPhone
          : "91" + cleanPhone;

        let message = "";
        if (type === "birthday") {
          message = `üéÇ *Happy Birthday ${name}!* üéÇ

We noticed your birthday is coming up on *${birthday}*!

To make your celebration sweeter, here's a special offer just for you:

*üéÅ 20% OFF on any cake*
*üéâ Free personalized message*
*üöÄ Priority delivery*

Use code: BDAY20

Valid until: ${new Date(
            new Date().setDate(new Date().getDate() + 7)
          ).toLocaleDateString("en-IN")}

Visit us or call to place your order!

With love,
Cake Bliss Team üç∞

_To unsubscribe from birthday offers, reply STOP_`;
        } else if (type === "highTicket") {
          message = `üëë *Exclusive Offer for Our Valued Customer!* üëë

Hello ${name}! 

As one of our most valued customers, we want to thank you for your continued support with this exclusive offer:

*üéÅ 25% OFF your next order*
*‚ú® Free cake upgrade*
*‚≠ê Priority booking*

Use code: VIP25

This offer is specially curated for our premium customers like you!

Valid for 30 days.

Thank you for choosing Cake Bliss! üéÇ

Best regards,
Cake Bliss Team

_To unsubscribe, reply STOP_`;
        }

        sendWhatsAppMessage(phoneWithCountryCode, message, name, type);
      }

      function sendGiftingReminder(
        phone,
        recipientName,
        gifterName,
        gifterBirthday
      ) {
        if (dailySendCount >= MAX_DAILY_SENDS) {
          showNotification(
            `Daily limit reached (${MAX_DAILY_SENDS} messages). Try again tomorrow.`,
            "warning"
          );
          return;
        }

        const cleanPhone = phone.replace(/\D/g, "");
        const phoneWithCountryCode = cleanPhone.startsWith("91")
          ? cleanPhone
          : "91" + cleanPhone;
        const gifterBirthdayDate = new Date(gifterBirthday);
        const formattedValidUntil = gifterBirthdayDate.toLocaleDateString(
          "en-IN",
          { day: "2-digit", month: "long" }
        );

        const message = `üéÅ *Gifting Reminder* üéÅ

Hello ${recipientName}! 

We noticed that *${gifterName}* gifted you a cake on your special day! ‚ù§Ô∏è

Now it's your chance to return the love! ü•∞

*${gifterName}'s birthday is on ${gifterBirthday}*

Make their day special with a delicious cake from Cake Bliss!

*Special Return Gift Offer:*
üéÇ 15% OFF any cake for ${gifterName}
üéâ Free "Happy Birthday" message card
üöÄ Same-day delivery available

Use code: RETURNLOVE15

Valid until: ${formattedValidUntil}

Spread the love! üíï

Cake Bliss Team üç∞

_This is a one-time gifting reminder_`;

        sendWhatsAppMessage(
          phoneWithCountryCode,
          message,
          recipientName,
          "gifting"
        );
      }

      function sendExpiringProductOffer(
        phone,
        customerName,
        productName,
        expiryDate,
        stock
      ) {
        if (dailySendCount >= MAX_DAILY_SENDS) {
          showNotification(
            `Daily limit reached (${MAX_DAILY_SENDS} messages). Try again tomorrow.`,
            "warning"
          );
          return;
        }

        const cleanPhone = phone.replace(/\D/g, "");
        const phoneWithCountryCode = cleanPhone.startsWith("91")
          ? cleanPhone
          : "91" + cleanPhone;

        const message = `üèÉ‚Äç‚ôÇÔ∏è *HURRY! Limited Time Offer!* üèÉ‚Äç‚ôÇÔ∏è

Hello ${customerName}! 

Remember the delicious *${productName}* you enjoyed? 

We have a limited time offer specially for you that expires on *${expiryDate}*!

*üî• EXCLUSIVE OFFER FOR YOU:*
üéØ **30% OFF** on ${productName}
‚ö° **Same-day delivery available**

This is a special offer for our valued customers who have purchased this product before!

*Hurry, offer valid until stock lasts!*

Use code: RECURRING30

Order now before it's gone! ‚è∞

Best regards,
Cake Bliss Team üç∞

_To unsubscribe, reply STOP_`;

        sendWhatsAppMessage(
          phoneWithCountryCode,
          message,
          customerName,
          "expiring"
        );
      }

      // === NEW FUNCTION: SEND BIRTHDAY + EXPIRING COMBO MESSAGE ===
      function sendBirthdayExpiringComboOffer(phone, name, birthday, mainProduct, expiryDate, productList) {
        if (dailySendCount >= MAX_DAILY_SENDS) {
          showNotification(
            `Daily limit reached (${MAX_DAILY_SENDS} messages). Try again tomorrow.`,
            "warning"
          );
          return;
        }

        const cleanPhone = phone.replace(/\D/g, "");
        const phoneWithCountryCode = cleanPhone.startsWith("91")
          ? cleanPhone
          : "91" + cleanPhone;

        const message = `üéÇüî• *DOUBLE CELEBRATION OFFER!* üî•üéÇ

Happy Birthday ${name}! ü•≥

We noticed your birthday is coming up on *${birthday}*!
AND we have something special for you...

*üéÅ EXCLUSIVE BIRTHDAY + CLEARANCE COMBO OFFER! üéÅ*

To celebrate your birthday, we're offering you:
1. *üéÇ 25% BIRTHDAY DISCOUNT* on any order
2. *üî• EXTRA 15% OFF* on expiring products you love!

*Products that need your attention:*
${productList.split(', ').map(p => `‚Ä¢ ${p}`).join('\n')}

*üî• ULTIMATE COMBO DEAL:*
üéØ **40% OFF TOTAL** when you buy expiring products
‚ö° **Priority birthday delivery**
üéÅ **Free birthday card & candles**

*Main Product Alert:*
${mainProduct} expires on ${expiryDate}

*üéâ TOTAL SAVINGS: UP TO 40% OFF! üéâ*

Use code: BDAYEXP40

This exclusive combo offer is valid for 48 hours only!
Don't miss this birthday treat! üç∞

Make your birthday extra special with Cake Bliss!
Order now: üìû [Your Phone Number]

With love,
Cake Bliss Team ‚ù§Ô∏è

_To unsubscribe, reply STOP_`;

        sendWhatsAppMessage(phoneWithCountryCode, message, name, "combo");
        
        // Special success notification for combo offers
        showNotification(
          `üéÇüî• Birthday + Expiring combo offer sent to ${name}!`,
          "success"
        );
      }

      function closeExpiringModal() {
        document.getElementById("expiringModal").style.display = "none";
      }

      function sendWhatsAppMessage(phone, message, name, type) {
        const encodedMessage = encodeURIComponent(message);
        const whatsappUrl = `https://wa.me/${phone}?text=${encodedMessage}`;

        // Check if we're on mobile
        const isMobile = /iPhone|iPad|iPod|Android/i.test(navigator.userAgent);

        if (isMobile) {
          // For mobile: Use window.location (opens in same tab)
          window.location.href = whatsappUrl;

          // After a delay, try to come back to the app
          setTimeout(() => {
            // Try to show a back button notification
            showNotification("Message sent! Tap here to return.", "info", true);
          }, 1000);
        } else {
          // For desktop: Open in new tab
          const newWindow = window.open(
            whatsappUrl,
            "_blank",
            "noopener,noreferrer"
          );

          if (!newWindow) {
            showNotification(
              "Popup blocked. Please allow popups for this site.",
              "error"
            );
            return;
          }
        }

        // Update send count and UI
        dailySendCount++;
        updateDailyCount();

        let campaignType = "";
        switch (type) {
          case "birthday":
            campaignType = "birthday offer";
            break;
          case "highTicket":
            campaignType = "VIP offer";
            break;
          case "gifting":
            campaignType = "gifting reminder";
            break;
          case "expiring":
            campaignType = "expiring product offer";
            break;
          case "combo":
            campaignType = "birthday-expiring combo offer";
            break;
        }

        showNotification(`${campaignType} sent to ${name}`, "success");
        document.getElementById("totalSent").textContent = dailySendCount;

        // Update button state
        const buttons = document.querySelectorAll(".btn-whatsapp");
        buttons.forEach((button) => {
          if (
            button.textContent.includes(name) ||
            button.closest(".customer-item")?.querySelector("h4")
              ?.textContent === name
          ) {
            button.disabled = true;
            button.innerHTML = '<i class="fas fa-check"></i> Sent';
            button.classList.add("sent");

            setTimeout(() => {
              button.disabled = false;
              button.innerHTML = '<i class="fab fa-whatsapp"></i> Send Offer';
              button.classList.remove("sent");
            }, 5000);
          }
        });
      }

      // === UTILITY FUNCTIONS ===
      function updateTotalStats() {
        const birthdayCount =
          parseInt(document.getElementById("birthdayCount").textContent) || 0;
        const highTicketCount =
          parseInt(document.getElementById("highTicketCount").textContent) || 0;
        const giftingCount =
          parseInt(document.getElementById("giftingCount").textContent) || 0;
        const totalCustomers = birthdayCount + highTicketCount + giftingCount;
        document.getElementById("totalCustomers").textContent = totalCustomers;
      }

      function loadDailyCount() {
        const today = new Date().toDateString();
        const storedData = localStorage.getItem("cakeBlissWhatsAppStats");

        if (storedData) {
          const data = JSON.parse(storedData);
          if (data.date === today) {
            dailySendCount = data.count || 0;
          } else {
            dailySendCount = 0;
          }
        }

        document.getElementById("totalSent").textContent = dailySendCount;
      }

      function updateDailyCount() {
        const today = new Date().toDateString();
        const data = { date: today, count: dailySendCount };
        localStorage.setItem("cakeBlissWhatsAppStats", JSON.stringify(data));
      }

      function setupEventListeners() {
        document
          .getElementById("daysFilter")
          .addEventListener("change", function () {
            const days = parseInt(this.value);
            loadUpcomingBirthdays(days);
            loadGiftingOpportunities(days);
            loadBirthdayExpiringCombo(days);
          });

        document
          .getElementById("amountFilter")
          .addEventListener("change", function () {
            const minAmount = parseInt(this.value);
            loadHighTicketCustomers(minAmount);
          });

        document
          .getElementById("refreshBtn")
          .addEventListener("click", function () {
            this.innerHTML =
              '<i class="fas fa-spinner fa-spin"></i> Refreshing...';
            this.disabled = true;

            loadAllCampaigns().finally(() => {
              this.innerHTML = '<i class="fas fa-sync-alt"></i> Refresh Data';
              this.disabled = false;
              showNotification("Data refreshed successfully", "success");
            });
          });

        document.addEventListener("keydown", function (e) {
          if (e.key === "Escape") closeExpiringModal();
          if (e.ctrlKey && e.key === "r") {
            e.preventDefault();
            document.getElementById("refreshBtn").click();
          }
        });
      }

      function showNotification(message, type = "success") {
        const notification = document.getElementById("notification");
        const icon = notification.querySelector("i");
        const text = notification.querySelector("span");

        notification.className = `notification ${type}`;
        text.textContent = message;

        switch (type) {
          case "success":
            icon.className = "fas fa-check-circle";
            break;
          case "error":
            icon.className = "fas fa-exclamation-circle";
            break;
          case "warning":
            icon.className = "fas fa-exclamation-triangle";
            break;
          case "info":
            icon.className = "fas fa-info-circle";
            break;
        }

        notification.classList.add("show");
        setTimeout(() => notification.classList.remove("show"), 3000);
      }

      // Close mobile menu when clicking outside
      document.addEventListener("click", function (event) {
        const mobileNav = document.getElementById("mobileNav");
        const menuToggle = document.querySelector(".mobile-menu-toggle");

        if (
          mobileNav &&
          menuToggle &&
          !mobileNav.contains(event.target) &&
          !menuToggle.contains(event.target)
        ) {
          mobileNav.classList.remove("show");
          const menuIcon = document.querySelector(".mobile-menu-toggle i");
          menuIcon.className = "fas fa-bars";
          document.body.style.overflow = "";
        }
      });
    </script>
  </body>
</html>
